// UniQdata v4 ERD
// https://dbdiagram.io

// ============================================================
// ðŸ”— XRPL ì•µì»¤ë§ ì‹œì  (anchor_logsì— ê¸°ë¡)
// ============================================================
// 1. ê³„ì • ìƒì„±: accounts + owners ìƒì„± ì‹œ â†’ anchor_type: 'account_created'
// 2. ì§€ê°‘ ìƒì„±: wallets ìƒì„± ì‹œ â†’ anchor_type: 'wallet_created'
// 3. ë™ì˜ ë¶€ì—¬/ì² íšŒ: consents ìƒì„±/ìˆ˜ì • ì‹œ â†’ anchor_type: 'consent_granted' | 'consent_revoked'
// 4. ì—°êµ¬ ì°¸ì—¬: agreements ìƒì„± ì‹œ â†’ anchor_type: 'agreement_signed'
// 5. íŒ€ì› ë³€ê²½: team_members ì¶”ê°€/ì œê±° ì‹œ â†’ anchor_type: 'team_member_added' | 'team_member_removed'
// 6. ì •ì‚° ì™„ë£Œ: settlements ìƒì„± ì‹œ â†’ anchor_type: 'settlement_completed'
// 7. ë°ì´í„° ì ‘ê·¼: audit_logs ë¯¼ê° ë°ì´í„° ì¡°íšŒ ì‹œ â†’ anchor_type: 'data_accessed'
//
// ============================================================
// ðŸ“ ê³„ì • ìƒì„± í”Œë¡œìš°
// ============================================================
// 1. accounts ìƒì„± (email, type)
// 2. account_logins ìƒì„± (provider: apple/google/email)
// 3. owners ìƒì„± (ìµëª… ID, 1:1 with accounts)
// 4. passkey_credentials ìƒì„± (WebAuthn ë“±ë¡)
// 5. wallets ìƒì„± (XRPL ì£¼ì†Œ ë°œê¸‰)
// 6. wallet_secrets ìƒì„± (PRF ì•”í˜¸í™”ëœ ì‹œë“œ)
// 7. anchor_logs ê¸°ë¡ (ê³„ì • ìƒì„± ì¦ëª…)
//
// ============================================================
// ðŸ’¾ ë°ì´í„° ì €ìž¥ í”Œë¡œìš°
// ============================================================
// 1. ì•±ì—ì„œ data_points ì „ì†¡ (category, metric, value)
// 2. idempotency_keyë¡œ ì¤‘ë³µ ì²´í¬
// 3. sensitivity_level ìžë™ ë¶„ë¥˜ (1-4)
// 4. ì•”í˜¸í™” í›„ ì €ìž¥ (L3-L4ëŠ” í•„ë“œ ì•”í˜¸í™”)
// 5. audit_logs ê¸°ë¡ (write ì•¡ì…˜)
//
// ============================================================
// ðŸ“– ë°ì´í„° ì¡°íšŒ í”Œë¡œìš°
// ============================================================
// 1. ìš”ì²­ìž ì¸ì¦ (ì„¸ì…˜ or íŒ¨ìŠ¤í‚¤)
// 2. consents í™•ì¸ (scope, status, expires_at)
// 3. agreements í™•ì¸ (ì—°êµ¬ìš© ì ‘ê·¼ ì‹œ)
// 4. data_points ì¡°íšŒ (owner_id + category + timestamp)
// 5. audit_logs ê¸°ë¡ (read ì•¡ì…˜)
// 6. L4 ë°ì´í„°ëŠ” anchor_logsì—ë„ ê¸°ë¡
//
// ===== TABLE GROUPS =====
TableGroup auth [color: #3498db] {
  accounts
  account_logins
  owners
  passkey_credentials
  sessions
}

TableGroup wallet [color: #f39c12] {
  wallets
  wallet_secrets
}

TableGroup data [color: #2ecc71] {
  data_points
  consents
}

TableGroup research [color: #9b59b6] {
  research_projects
  data_collection_configs
  participation_criteria
  team_members
  agreements
  project_wallets
}

TableGroup settlement [color: #e74c3c] {
  escrows
  settlements
}

TableGroup audit [color: #95a5a6] {
  audit_logs
  anchor_logs
}

TableGroup org [color: #1abc9c] {
  institutions
  workspaces
  workspace_members
}

// ===== ì¸ì¦ & ê³„ì • =====
Table accounts {
  id uuid [pk]
  email varchar
  type varchar [note: 'individual | enterprise']
  status varchar
  created_at timestamp
}

Table account_logins {
  id uuid [pk]
  account_id uuid [ref: > accounts.id]
  provider varchar [note: 'apple | google | email']
  provider_user_id varchar
  email varchar
}

Table owners {
  id uuid [pk]
  account_id uuid [ref: - accounts.id, note: '1:1']
  created_at timestamp
}

Table passkey_credentials {
  id uuid [pk]
  owner_id uuid [ref: > owners.id]
  credential_id varchar
  public_key bytea
  counter int
  device_name varchar
}

Table sessions {
  id uuid [pk]
  owner_id uuid [ref: > owners.id]
  expires_at timestamp
}

// ===== ì§€ê°‘ =====
Table wallets {
  id uuid [pk]
  owner_id uuid [ref: > owners.id]
  address varchar [unique, note: 'XRPL rXXX...']
  public_key varchar
  wallet_type varchar
  status varchar

  indexes {
    (owner_id, wallet_type) [unique, note: 'ì‚¬ìš©ìžë‹¹ ì§€ê°‘ íƒ€ìž… 1ê°œ']
    address [unique, note: 'ì£¼ì†Œë¡œ ì¡°íšŒ']
  }
}

Table wallet_secrets {
  id uuid [pk]
  wallet_id uuid [ref: - wallets.id, note: '1:1']
  encrypted_seed_prf bytea
  prf_salt bytea
}

// ===== ë°ì´í„° =====
Table data_points {
  id uuid [pk]
  owner_id uuid [ref: > owners.id]
  category varchar
  metric varchar
  value jsonb
  unit varchar
  timestamp timestamp
  sensitivity_level int [note: '1-4']
  idempotency_key varchar [unique]

  indexes {
    (owner_id, category, metric, timestamp) [note: 'ì‹œê³„ì—´ ì¡°íšŒ']
    (owner_id, sensitivity_level) [note: 'ë¯¼ê°ë„ë³„ í•„í„°']
    idempotency_key [unique, note: 'ì¤‘ë³µ ë°©ì§€']
  }
}

Table consents {
  id uuid [pk]
  owner_id uuid [ref: > owners.id]
  scope varchar
  status varchar
  purpose varchar
  project_id uuid [ref: > research_projects.id]
  granted_at timestamp
  expires_at timestamp

  indexes {
    (owner_id, status) [note: 'í™œì„± ë™ì˜ ì¡°íšŒ']
    (project_id, status) [note: 'í”„ë¡œì íŠ¸ë³„ ë™ì˜']
  }
}

// ===== ì—°êµ¬ =====
Table research_projects {
  id uuid [pk]
  owner_id uuid [ref: > owners.id, note: 'PI']
  title varchar
  status varchar
  escrow_tx_hash varchar
}

Table data_collection_configs {
  id uuid [pk]
  project_id uuid [ref: - research_projects.id]
  passive_data jsonb
  active_data jsonb
}

Table participation_criteria {
  id uuid [pk]
  project_id uuid [ref: - research_projects.id]
  age_range jsonb
}

Table team_members {
  id uuid [pk]
  project_id uuid [ref: > research_projects.id]
  owner_id uuid [ref: > owners.id]
  role varchar [note: 'owner | admin | member']
  anchor_tx varchar
}

Table agreements {
  id uuid [pk]
  project_id uuid [ref: > research_projects.id]
  owner_id uuid [ref: > owners.id]
  status varchar
  data_scopes jsonb
  anchor_tx varchar

  indexes {
    (project_id, status) [note: 'í”„ë¡œì íŠ¸ë³„ ì°¸ì—¬ìž']
    (owner_id, status) [note: 'ë‚´ ì°¸ì—¬ í˜„í™©']
  }
}

Table project_wallets {
  id uuid [pk]
  project_id uuid [ref: - research_projects.id]
  address varchar
}

// ===== ì •ì‚° =====
Table escrows {
  id uuid [pk]
  project_id uuid [ref: > research_projects.id]
  amount decimal
  status varchar
  tx_hash varchar
}

Table settlements {
  id uuid [pk]
  agreement_id uuid [ref: > agreements.id]
  amount decimal
  tx_hash varchar
}

// ===== ê°ì‚¬ =====
Table audit_logs {
  id uuid [pk]
  action varchar
  category varchar
  owner_id uuid [ref: > owners.id]
  user_id uuid [ref: > owners.id, note: 'ìš”ì²­ìž']
  record_count int
  created_at timestamp

  indexes {
    (owner_id, created_at) [note: 'ì‚¬ìš©ìžë³„ ë¡œê·¸ ì¡°íšŒ']
    (category, created_at) [note: 'ì¹´í…Œê³ ë¦¬ë³„ ì¡°íšŒ']
  }
}

Table anchor_logs {
  id uuid [pk]
  anchor_type varchar
  owner_id uuid [ref: > owners.id]
  data_hash varchar
  tx_hash varchar [unique]
  ledger_index int
  created_at timestamp

  indexes {
    (owner_id, anchor_type) [note: 'ì‚¬ìš©ìžë³„ ì•µì»¤ ì¡°íšŒ']
    tx_hash [unique, note: 'TX ê²€ì¦ìš©']
  }
}

// ===== ê¸°ê´€ =====
Table institutions {
  id uuid [pk]
  name varchar
}

Table workspaces {
  id uuid [pk]
  institution_id uuid [ref: > institutions.id]
  name varchar
}

Table workspace_members {
  id uuid [pk]
  workspace_id uuid [ref: > workspaces.id]
  account_id uuid [ref: > accounts.id]
  role varchar
}
