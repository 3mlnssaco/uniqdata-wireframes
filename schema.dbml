// UniQdata v4 Complete ERD â€” 40 Entities (Layout-Optimized)
// ì„  ê¼¬ì„ ìµœì†Œí™”ë¥¼ ìœ„í•´ ì˜ì¡´ì„± ìˆœì„œ + TableGroup ì ìš©

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TableGroup ì„ ì–¸ (ë ˆì´ì•„ì›ƒ ê·¸ë£¹í•‘)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

TableGroup core_auth {
  accounts
  account_logins
  owners
  users
}

TableGroup session_auth {
  sessions
  refresh_tokens
  passkey_credentials
}

TableGroup wallet_group {
  wallets
  wallet_secrets
  wallet_credential_bindings
  wallet_recovery_requests
}

TableGroup org_group {
  institutions
  workspaces
  workspace_members
}

TableGroup app_group {
  apps
  app_keys
  consents
}

TableGroup data_group {
  data_points
  data_attachments
  data_sources
  data_accesses
}

TableGroup research_group {
  research_projects
  participation_criteria
  data_collection_configs
  team_members
  agreements
}

TableGroup finance_group {
  project_wallets
  project_wallet_deposits
  project_wallet_withdrawals
  escrows
  settlements
}

TableGroup medication_group {
  drug_info_cache
  user_medications
  medication_logs
  medication_proofs
}

TableGroup analytics_group {
  ai_analyses
  features
  notifications
}

TableGroup audit_group {
  audit_logs
  anchor_logs
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 1. ğŸ“± App (ë…ë¦½ â€” ìµœìƒë‹¨ ì¢Œì¸¡)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Table apps {
  id uuid [pk]
  slug varchar [unique, note: 'bodab|ready-q|medi-q|uniqdata']
  name varchar
  description varchar
  allowed_scopes text [note: 'health:heart_rate:read:30d']
  allowed_origins text
  status enum [note: 'active|inactive|suspended']
  created_at timestamp
  updated_at timestamp
}

Table app_keys {
  id uuid [pk]
  app_id uuid [ref: > apps.id]
  key_type enum [note: 'public|secret|admin']
  key_prefix varchar [note: 'uq_pub_test_kr_']
  key_hash varchar [note: 'SHA-256']
  name varchar
  status enum [note: 'active|revoked|expired']
  expires_at timestamp
  last_used_at timestamp
  created_at timestamp
  revoked_at timestamp
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 2. ğŸ¢ Organization (ë…ë¦½ â€” ìµœìƒë‹¨ ìš°ì¸¡)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Table institutions {
  id uuid [pk]
  name varchar
  type enum [note: 'university|research_institute|hospital|company|government|other']
  domains text [note: 'ë„ë©”ì¸ ë°°ì—´: snu.ac.kr']
  status enum [note: 'pending|active|suspended']
  logo_url varchar
  website varchar
  created_at timestamp
  updated_at timestamp
}

Table workspaces {
  id uuid [pk]
  name varchar
  type enum [note: 'individual|team|enterprise']
  status enum [note: 'pending|active|suspended|archived']
  institution_id uuid [ref: > institutions.id]
  description text
  max_members int
  created_at timestamp
  updated_at timestamp
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 3. ğŸ”‘ Core Auth (ì¤‘ì‹¬ í—ˆë¸Œ)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Table accounts {
  id uuid [pk]
  type enum [note: 'user|enterprise|researcher|admin|auditor']
  status enum [note: 'active|suspended|deleted']
  identity_hash varchar [unique, note: 'KYCìš© 1ì¸1ê³„ì •']
  kyc_verified_at timestamp
  kyc_provider varchar
  created_at timestamp
  updated_at timestamp
}

Table account_logins {
  id uuid [pk]
  account_id uuid [ref: > accounts.id]
  provider enum [note: 'apple|google|kakao|email|phone']
  provider_user_id varchar
  email varchar
  phone varchar
  email_verified boolean
  phone_verified boolean
  password_hash varchar
  created_at timestamp

  indexes {
    (provider, provider_user_id) [unique]
  }
}

Table owners {
  id uuid [pk]
  account_id uuid [ref: - accounts.id, unique, note: '1:1']
  created_at timestamp
}

Table users {
  id uuid [pk]
  account_id uuid [ref: - accounts.id, note: '1:1 í”„ë¡œí•„']
  name varchar
  birth_date date
  gender varchar
  height decimal
  weight decimal
  blood_type varchar
  allergies text
  created_at timestamp
  updated_at timestamp

  indexes {
    account_id [unique]
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 4. ğŸ¢ Org Members (accounts + workspaces ì˜ì¡´)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Table workspace_members {
  id uuid [pk]
  workspace_id uuid [ref: > workspaces.id]
  account_id uuid [ref: > accounts.id]
  role enum [note: 'owner|admin|member|auditor']
  status enum [note: 'pending|active|suspended|rejected|left']
  display_name varchar
  created_at timestamp
  updated_at timestamp

  indexes {
    (workspace_id, account_id) [unique]
  }
}

Table data_accesses {
  id uuid [pk]
  workspace_id uuid [ref: > workspaces.id]
  account_id uuid [ref: > accounts.id]
  data_product_id varchar
  status enum [note: 'active|expired|revoked']
  granted_by uuid [ref: > accounts.id]
  granted_at timestamp
  expires_at timestamp

  indexes {
    (workspace_id, account_id)
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 5. ğŸ” Session & Passkey (users + apps ì˜ì¡´)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Table sessions {
  id uuid [pk]
  user_id uuid [ref: > users.id]
  app_id uuid [ref: > apps.id]
  started_at timestamp
  ended_at timestamp
  metadata jsonb
}

Table refresh_tokens {
  id uuid [pk]
  token varchar [unique]
  user_id uuid [ref: > users.id]
  session_id uuid [ref: > sessions.id]
  expires_at timestamp
  revoked_at timestamp
  created_at timestamp
}

Table passkey_credentials {
  id uuid [pk]
  user_id uuid [ref: > users.id]
  credential_id varchar [unique]
  public_key text
  counter int
  transports text
  device_name varchar
  created_at timestamp
  last_used_at timestamp
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 6. ğŸ‘› Wallet (owners + passkey ì˜ì¡´)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Table wallets {
  id uuid [pk]
  owner_id uuid [ref: > owners.id]
  user_id uuid [note: '@deprecated']
  address varchar [unique, note: 'XRPL rXXX...']
  public_key varchar
  wallet_type enum [note: 'main|sub']
  status enum [note: 'active|suspended|recovery']
  created_at timestamp

  indexes {
    (owner_id, wallet_type) [unique]
  }
}

Table wallet_secrets {
  id uuid [pk]
  wallet_id uuid [ref: - wallets.id, unique, note: '1:1']
  encrypted_seed_prf bytea [note: 'Passkey PRF ì•”í˜¸í™”']
  prf_salt bytea
  encrypted_seed_hsm bytea [note: 'HSM ë³µêµ¬ìš©']
  hsm_key_id varchar
  encrypted_seed text [note: '@deprecated']
  key_id varchar [note: '@deprecated']
  created_at timestamp
  updated_at timestamp
}

Table wallet_credential_bindings {
  id uuid [pk]
  wallet_id uuid [ref: > wallets.id]
  credential_id uuid [ref: > passkey_credentials.id]
  encrypted_seed_prf bytea [note: 'ê¸°ê¸°ë³„ PRF ì•”í˜¸í™”']
  prf_salt bytea
  binding_signature text
  xrpl_tx_hash varchar
  status enum [note: 'active|revoked']
  created_at timestamp
  revoked_at timestamp

  indexes {
    (wallet_id, credential_id) [unique]
  }
}

Table wallet_recovery_requests {
  id uuid [pk]
  wallet_id uuid [ref: > wallets.id]
  owner_id uuid [ref: > owners.id]
  kyc_verified boolean
  kyc_verified_at timestamp
  kyc_identity_hash varchar
  sms_verified boolean
  sms_verified_at timestamp
  status enum [note: 'pending|kyc_required|waiting|admin_review|approved|completed|cancelled|rejected']
  created_at timestamp
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 7. ğŸ“Š Data (users ì˜ì¡´)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Table data_points {
  id uuid [pk]
  user_id uuid [ref: > users.id]
  category varchar
  metric varchar
  value jsonb
  unit varchar
  timestamp timestamp
  source_id varchar
  source_type varchar
  metadata jsonb
  sensitivity_level int [note: '1-4']
  created_at timestamp

  indexes {
    (user_id, category, metric, timestamp)
    (user_id, timestamp)
  }
}

Table data_attachments {
  id uuid [pk]
  data_point_id uuid [ref: > data_points.id]
  user_id uuid [ref: > users.id]
  storage_key varchar
  file_name varchar
  file_type varchar [note: 'MIME type']
  file_size bigint
  thumbnail_key varchar
  metadata jsonb [note: 'DICOM íƒœê·¸ ë“±']
  storage_provider varchar [note: 'local|s3|minio']
  sensitivity_level int [default: 4]
  created_at timestamp
}

Table data_sources {
  id uuid [pk]
  user_id uuid [ref: > users.id]
  name varchar
  type varchar [note: 'wearable|app|manual|integration']
  is_active boolean
  config jsonb
  created_at timestamp
  last_sync_at timestamp
}

Table consents {
  id uuid [pk]
  user_id uuid [ref: > users.id]
  app_id uuid [ref: > apps.id]
  scopes text [note: 'ë™ì˜ ë²”ìœ„ ë°°ì—´']
  purpose varchar
  status enum [note: 'pending|approved|denied|revoked|expired']
  created_at timestamp
  approved_at timestamp
  revoked_at timestamp
  expires_at timestamp
  xrpl_tx_hash varchar
  revocation_tx_hash varchar
  metadata jsonb
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 8. ğŸ”¬ Research (owners + institutions ì˜ì¡´)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Table research_projects {
  id uuid [pk]
  owner_id uuid [ref: > owners.id, note: 'PI']
  institution_id uuid [ref: > institutions.id]
  title varchar
  description text
  methodology varchar [note: 'longitudinal|cross_sectional|cohort|case_control']
  status enum [note: 'draft|recruiting|collecting|analyzing|completed|cancelled']
  created_at timestamp
  updated_at timestamp

  indexes {
    (owner_id, status)
  }
}

Table participation_criteria {
  id uuid [pk]
  project_id uuid [ref: - research_projects.id, unique, note: '1:1']
  age_min int
  age_max int
  conditions jsonb [note: 'í•„ìˆ˜ ì¡°ê±´']
  exclusions jsonb [note: 'ì œì™¸ ì¡°ê±´']
  required_data jsonb [note: 'í•„ìˆ˜ ë°ì´í„°']
  regions jsonb [note: 'ì§€ì—­ ì œí•œ']
  created_at timestamp
}

Table data_collection_configs {
  id uuid [pk]
  project_id uuid [ref: - research_projects.id, unique, note: '1:1']
  passive_data jsonb [note: 'heart_rate, steps...']
  active_data jsonb [note: 'mood, pain_level...']
  biomarkers jsonb [note: 'voice_analysis, cgm...']
  collection_frequency jsonb
  created_at timestamp
}

Table team_members {
  id uuid [pk]
  project_id uuid [ref: > research_projects.id]
  owner_id uuid [ref: > owners.id]
  role enum [note: 'owner|admin|member']
  invited_by uuid [ref: > owners.id]
  joined_at timestamp
  created_at timestamp

  indexes {
    (project_id, owner_id) [unique]
  }
}

Table agreements {
  id uuid [pk]
  project_id uuid [ref: > research_projects.id]
  owner_id uuid [ref: > owners.id, note: 'ì°¸ì—¬ì']
  status enum [note: 'pending|active|completed|withdrawn|expired']
  data_scopes jsonb [note: 'ë™ì˜í•œ ë°ì´í„° ë²”ìœ„']
  start_date date
  end_date date
  created_at timestamp

  indexes {
    (project_id, owner_id) [unique]
    (owner_id, status)
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 9. ğŸ’° Finance (research ì˜ì¡´)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Table project_wallets {
  id uuid [pk]
  project_id uuid [ref: - research_projects.id, unique, note: '1:1']
  wallet_address varchar [unique]
  encrypted_seed bytea [note: 'KMS ì•”í˜¸í™”']
  kms_key_id varchar
  total_deposited decimal
  total_spent decimal
  status enum [note: 'active|suspended|closed']
  created_at timestamp
}

Table project_wallet_deposits {
  id uuid [pk]
  project_id uuid [ref: > research_projects.id]
  depositor_owner_id uuid [ref: > owners.id]
  amount decimal
  tx_hash varchar [unique]
  deposited_at timestamp
}

Table project_wallet_withdrawals {
  id uuid [pk]
  project_id uuid [ref: > research_projects.id]
  withdrawer_owner_id uuid [ref: > owners.id]
  amount decimal
  tx_hash varchar [unique]
  withdrawn_at timestamp
}

Table escrows {
  id uuid [pk]
  project_id uuid [ref: > research_projects.id]
  owner_address varchar
  amount decimal
  condition varchar [note: 'Crypto-Condition']
  fulfillment varchar
  sequence int
  tx_hash varchar [unique]
  status enum [note: 'created|partial_released|completed|cancelled']
  created_at timestamp
}

Table settlements {
  id uuid [pk]
  agreement_id uuid [ref: > agreements.id]
  amount decimal
  tx_hash varchar [unique]
  type varchar [note: 'data_submit|bonus|completion']
  memo text
  settled_at timestamp
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 10. ğŸ’Š Medication (users ì˜ì¡´)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Table drug_info_cache {
  drug_code varchar [pk]
  name varchar
  category varchar
  manufacturer varchar
  ingredients jsonb
  effects text
  side_effects text
  interactions jsonb
  category_hash varchar [note: 'ZKPìš©']
  fetched_at timestamp
  expires_at timestamp
}

Table user_medications {
  id uuid [pk]
  user_id uuid [ref: > users.id]
  name_encrypted text [note: 'L4 ì•”í˜¸í™”']
  dosage_encrypted text
  purpose_encrypted text
  category_hash varchar [note: 'ZKPìš©']
  name_hash varchar
  schedule_times text [note: 'morning,noon,evening,bedtime']
  drug_code varchar
  is_active boolean
  medication_type varchar [note: 'regular|as_needed']
  start_date date
  end_date date
  xrpl_tx_hash varchar
  created_at timestamp
  updated_at timestamp

  indexes {
    (user_id, name_hash) [unique]
    (user_id, is_active)
  }
}

Table medication_logs {
  id uuid [pk]
  user_id uuid [ref: > users.id]
  medication_id uuid [ref: > user_medications.id]
  scheduled_time varchar [note: 'morning|noon|evening|bedtime']
  taken boolean
  taken_at timestamp
  skipped_reason text
  recorded_at timestamp
  xrpl_tx_hash varchar
  created_at timestamp

  indexes {
    (user_id, recorded_at)
    (medication_id, recorded_at)
  }
}

Table medication_proofs {
  id uuid [pk]
  user_id uuid [ref: > users.id]
  proof_type varchar [note: 'category_membership|adherence_rate']
  category_hash varchar
  commitment bytea [note: 'Pedersen commitment']
  proof_data jsonb
  valid_from timestamp
  valid_until timestamp
  created_at timestamp
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 11. ğŸ¤– AI & Analytics (users ì˜ì¡´)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Table ai_analyses {
  id uuid [pk]
  user_id uuid [ref: > users.id]
  type varchar
  status enum [note: 'pending|processing|completed|failed']
  input jsonb
  result jsonb
  error_message varchar
  requested_at timestamp
  completed_at timestamp
}

Table features {
  id uuid [pk]
  user_id uuid [ref: > users.id]
  category varchar
  feature_type varchar
  value jsonb
  period_start timestamp
  period_end timestamp
  source_metrics varchar
  created_at timestamp
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 12. ğŸ”” Notifications (users + apps ì˜ì¡´)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Table notifications {
  id uuid [pk]
  user_id uuid [ref: > users.id]
  app_id uuid [ref: > apps.id]
  type varchar [note: 'data_access|recovery_started|medication_reminder...']
  title varchar
  body varchar
  metadata jsonb
  read_at timestamp
  created_at timestamp

  indexes {
    (user_id, created_at)
    (user_id, read_at)
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 13. ğŸ” Audit (users + apps ì˜ì¡´)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Table audit_logs {
  id uuid [pk]
  user_id uuid [ref: > users.id]
  app_id uuid [ref: > apps.id]
  action varchar [note: 'read|write|delete|export']
  category varchar
  metric varchar
  data_point_id uuid
  record_count int
  xrpl_tx_hash varchar
  xrpl_anchor_status varchar
  xrpl_ledger_index int
  timestamp timestamp
  ip_address varchar
  user_agent varchar
  metadata jsonb

  indexes {
    (user_id, timestamp)
    (app_id, timestamp)
  }
}

Table anchor_logs {
  id uuid [pk]
  user_id uuid [ref: > users.id]
  anchor_type enum [note: 'wallet_binding|consent_grant|escrow_create|settlement...']
  tx_hash varchar [unique]
  from_address varchar
  to_address varchar
  created_at timestamp

  indexes {
    (user_id, created_at)
  }
}
