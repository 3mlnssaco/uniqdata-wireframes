// UniQdata v6 Complete ERD — 31 Tables (2-Server Architecture)
// health_db (Core, 15 tables) + uniqdata_db (Business, 16 tables)
// 2026-02-12 전면 리뉴얼

// ═══════════════════════════════════════
// TableGroup 선언 (레이아웃 그룹핑)
// ═══════════════════════════════════════

TableGroup health_auth [headercolor: #7c3aed] {
  users
  passkey_credentials
  user_profiles
  refresh_tokens
}

TableGroup health_wallet [headercolor: #7c3aed] {
  user_wallets
  wallet_recovery_configs
}

TableGroup health_data [headercolor: #7c3aed] {
  data_points
  data_point_tags
  data_access_logs
}

TableGroup health_consent [headercolor: #7c3aed] {
  consents
  consent_scopes
  consent_audit_trail
}

TableGroup health_xrpl [headercolor: #7c3aed] {
  xrpl_transactions
}

TableGroup health_notification [headercolor: #7c3aed] {
  notifications
  notification_preferences
}

TableGroup biz_enterprise [headercolor: #059669] {
  enterprises
  enterprise_members
}

TableGroup biz_research [headercolor: #059669] {
  projects
  project_milestones
  participants
  participation_criteria
  data_requests
}

TableGroup biz_irb [headercolor: #059669] {
  irb_submissions
  irb_documents
  irb_review_comments
  irb_workflow_history
}

TableGroup biz_settlement [headercolor: #059669] {
  settlement_batches
  settlement_items
}

TableGroup biz_phase2 [headercolor: #6b7280] {
  synthetic_datasets
  fl_rounds
}

TableGroup biz_system [headercolor: #059669] {
  webhook_events
}

// ═══════════════════════════════════════════════
// ░░░ health_db — Core Server (NestJS:3000) ░░░
// 15 Tables · PostgreSQL 15 · 2GB
// ═══════════════════════════════════════════════

// ─── 1. 사용자/인증 ───

Table users [headercolor: #7c3aed] {
  id uuid [pk]
  email varchar(255) [unique, not null]
  phone varchar(20)
  display_name varchar(100)
  role varchar(20) [not null, default: 'PATIENT', note: 'PATIENT|RESEARCHER|IRB_MEMBER|ADMIN']
  kyc_level smallint [not null, default: 0, note: '0:미인증 1:이메일 2:전화 3:신분증']
  status varchar(20) [not null, default: 'ACTIVE']
  last_login_at timestamp
  created_at timestamp [not null, default: `NOW()`]
  updated_at timestamp [not null, default: `NOW()`]
}

Table passkey_credentials [headercolor: #7c3aed] {
  id uuid [pk]
  user_id uuid [ref: > users.id, not null]
  credential_id text [unique, not null]
  public_key text [not null, note: 'COSE 공개키']
  sign_count bigint [default: 0]
  device_type varchar(30) [note: 'platform|cross-platform']
  device_name varchar(100)
  prf_supported boolean [default: false]
  prf_salt bytea [note: 'PRF용 salt (32바이트)']
  created_at timestamp [not null, default: `NOW()`]
}

Table user_profiles [headercolor: #7c3aed] {
  id uuid [pk]
  user_id uuid [unique, ref: - users.id, note: '1:1']
  birth_date date [note: '암호화 저장']
  gender varchar(10)
  height_cm decimal(5,1)
  weight_kg decimal(5,1)
  blood_type varchar(5)
  chronic_conditions text [note: 'TEXT[] 배열']
  medications jsonb
  encrypted_fields jsonb
  created_at timestamp [not null, default: `NOW()`]
}

Table refresh_tokens [headercolor: #7c3aed] {
  id uuid [pk]
  user_id uuid [ref: > users.id]
  token_hash varchar(64) [unique]
  device_info jsonb
  expires_at timestamp [not null]
  revoked boolean [default: false]
  created_at timestamp [default: `NOW()`]
}

// ─── 2. XRPL/지갑 ───

Table user_wallets [headercolor: #7c3aed] {
  id uuid [pk]
  user_id uuid [ref: > users.id]
  xrpl_address varchar(60) [unique, note: 'rXXXXX...']
  xrpl_public_key varchar(130) [note: 'ed25519 공개키 (hex)']
  wallet_type varchar(20) [default: 'USER', note: 'USER|SERVICE|ESCROW']
  derivation_method varchar(20) [default: 'PASSKEY_PRF']
  uqd_balance decimal(18,6) [default: 0]
  xrp_balance decimal(18,6) [default: 0]
  status varchar(20) [default: 'ACTIVE']

  Note: '⚠️ private_key, seed는 절대 저장하지 않음!'
}

Table wallet_recovery_configs [headercolor: #7c3aed] {
  id uuid [pk]
  user_id uuid [ref: > users.id]
  recovery_method varchar(30) [note: 'SSS|SOCIAL|HSM_BACKUP']
  config jsonb [note: '{threshold, shares, guardians, ...}']
  created_at timestamp [default: `NOW()`]
}

// ─── 3. 건강 데이터 ───

Table data_points [headercolor: #7c3aed] {
  id uuid [pk]
  user_id uuid [ref: > users.id, not null]
  category varchar(30) [not null, note: 'VITALS|LAB_RESULT|MEDICATION|SYMPTOM|ACTIVITY|SLEEP|DIET|MENTAL_HEALTH|WEARABLE|MY_HEALTHWAY']
  sub_category varchar(50) [note: 'blood_pressure, heart_rate, glucose']
  value jsonb [not null, note: 'AES-256-GCM 암호화']
  value_encrypted boolean [default: true]
  source varchar(30) [not null, note: 'MANUAL|WEARABLE|MY_HEALTHWAY|EMR_IMPORT|FHIR']
  measured_at timestamp [not null]
  data_hash varchar(64) [not null, note: 'SHA-256(raw + ts)']
  xrpl_tx_hash varchar(64) [note: 'XRPL 앵커링 tx']
  xrpl_anchored boolean [default: false]
  quality_score decimal(3,2)
  created_at timestamp [not null, default: `NOW()`]

  indexes {
    (user_id, category)
    (user_id, measured_at)
    data_hash
  }
}

Table data_point_tags [headercolor: #7c3aed] {
  id uuid [pk]
  data_point_id uuid [ref: > data_points.id]
  tag_key varchar(50)
  tag_value varchar(200)
}

Table data_access_logs [headercolor: #7c3aed] {
  id uuid [pk]
  data_point_ids text [note: 'UUID[] 배열']
  accessor_type varchar(20) [note: 'SELF|RESEARCHER|SYSTEM|AI']
  accessor_id uuid
  project_id uuid [note: '⚠️ cross-DB 논리참조 → uniqdata_db.projects.id (API로만 조회)']
  irb_number varchar(50)
  consent_id uuid [ref: > consents.id]
  access_purpose varchar(50)
  record_count int [not null]
  pseudonymized boolean [default: false]
  xrpl_tx_hash varchar(64)
  accessed_at timestamp [default: `NOW()`]
}

// ─── 4. 동의 ───

Table consents [headercolor: #7c3aed] {
  id uuid [pk]
  user_id uuid [ref: > users.id, not null]
  consent_type varchar(30) [not null, note: 'SERVICE_TERMS|PRIVACY_POLICY|RESEARCH_PARTICIPATION|DATA_SHARING|SENSITIVE_DATA|MARKETING']
  status varchar(20) [default: 'ACTIVE', note: 'PENDING|ACTIVE|REVOKED|EXPIRED']
  signature_hash varchar(64) [note: 'ed25519 서명 해시']
  signature_method varchar(30) [note: 'PASSKEY_PRF|E_SIGNATURE|MANUAL']
  grant_tx_hash varchar(64) [note: 'CONSENT_GRANT XRPL tx']
  revoke_tx_hash varchar(64) [note: 'CONSENT_REVOKE XRPL tx']
  project_id uuid [note: '⚠️ cross-DB 논리참조 → uniqdata_db.projects.id (API로만 조회)']
  irb_number varchar(50)
  version int [default: 1]
  created_at timestamp [default: `NOW()`]
}

Table consent_scopes [headercolor: #7c3aed] {
  id uuid [pk]
  consent_id uuid [ref: > consents.id]
  scope_type varchar(30) [note: 'DATA_CATEGORY|PURPOSE|RECIPIENT|DURATION|GEOGRAPHY']
  scope_key varchar(50) [note: 'vitals, drug_research, enterprise_id:xxxx']
  scope_value text
}

Table consent_audit_trail [headercolor: #7c3aed] {
  id uuid [pk]
  consent_id uuid [ref: > consents.id]
  action varchar(20) [note: 'CREATED|SIGNED|MODIFIED|REVOKED']
  actor_id uuid
  changes jsonb
  xrpl_tx_hash varchar(64)
  created_at timestamp [default: `NOW()`]
}

// ─── 5. XRPL 트랜잭션 ───

Table xrpl_transactions [headercolor: #7c3aed] {
  id uuid [pk]
  tx_hash varchar(64) [unique]
  tx_type varchar(30) [note: 'DATA_INPUT|DATA_ACCESS|CONSENT_GRANT|CONSENT_REVOKE|ESCROW_CREATE|ESCROW_FINISH|ESCROW_CANCEL|SYNTH_SALE|FL_ROUND|UQD_TRANSFER']
  from_address varchar(60)
  to_address varchar(60)
  amount decimal(18,6)
  currency varchar(10) [note: 'XRP|UQD']
  memo_type varchar(30)
  memo_data jsonb
  ledger_index bigint
  status varchar(20) [note: 'SUBMITTED|VALIDATED|FAILED']
  related_user_id uuid
  related_consent_id uuid
  created_at timestamp [default: `NOW()`]
}

// ─── 6. 알림 ───

Table notifications [headercolor: #7c3aed] {
  id uuid [pk]
  user_id uuid [ref: > users.id]
  type varchar(50)
  title varchar(200)
  body text
  channel varchar(20) [note: 'PUSH|EMAIL|IN_APP']
  read boolean [default: false]
  metadata jsonb
  created_at timestamp [default: `NOW()`]

  indexes {
    (user_id, created_at)
  }
}

Table notification_preferences [headercolor: #7c3aed] {
  id uuid [pk]
  user_id uuid [unique, ref: - users.id]
  push_enabled boolean [default: true]
  email_enabled boolean [default: true]
  health_alerts boolean [default: true]
  research_updates boolean [default: true]
  quiet_hours_start time
  quiet_hours_end time
}

// ╔══════════════════════════════════════════════════════════════════════════════╗
// ║                                                                            ║
// ║   ⚠️  여기서부터 별도 DB — 직접 JOIN 불가 — Internal API로만 통신           ║
// ║                                                                            ║
// ║   Core (health_db:3000)  ←──  REST API / Webhook  ──→  Business (uniqdata_db:8080)  ║
// ║                                                                            ║
// ║   • Business → Core 호출: GET /internal/users/{id}                         ║
// ║   • Business → Core 호출: POST /internal/consents/verify                   ║
// ║   • Business → Core 호출: POST /internal/data/query                        ║
// ║   • Business → Core 호출: POST /internal/xrpl/escrow/*                     ║
// ║   • Core → Business 웹훅: data.submitted, consent.granted, escrow.*        ║
// ║                                                                            ║
// ║   cross-DB FK는 없음. user_id, project_id 등은 값만 저장 (논리적 참조)      ║
// ║                                                                            ║
// ╚══════════════════════════════════════════════════════════════════════════════╝

// ═══════════════════════════════════════════════════
// ░░░ uniqdata_db — Business Server (Spring:8080) ░░░
// 16 Tables · PostgreSQL 15 · 1GB
// ═══════════════════════════════════════════════════

// ─── 7. 기관 ───

Table enterprises [headercolor: #059669] {
  id uuid [pk]
  name varchar(200) [not null]
  enterprise_type varchar(30) [note: 'HOSPITAL|PHARMA|CRO|UNIVERSITY|INSURANCE|GOVERNMENT']
  business_number varchar(20)
  irb_committee_id uuid
  status varchar(20) [default: 'ACTIVE']
  created_at timestamp [default: `NOW()`]
}

Table enterprise_members [headercolor: #059669] {
  id uuid [pk]
  enterprise_id uuid [ref: > enterprises.id]
  user_id uuid [not null, note: '⚠️ cross-DB 논리참조 → health_db.users.id (API로만 조회)']
  role varchar(20) [note: 'OWNER|PI|IRB_MEMBER|STAFF|VIEWER']
  status varchar(20) [default: 'ACTIVE']
  created_at timestamp [default: `NOW()`]

  indexes {
    (enterprise_id, user_id) [unique]
  }
}

// ─── 8. 연구 프로젝트 ───

Table projects [headercolor: #059669] {
  id uuid [pk]
  enterprise_id uuid [ref: > enterprises.id]
  title varchar(300) [not null]
  project_type varchar(30) [note: 'CLINICAL_TRIAL|OBSERVATIONAL|RETROSPECTIVE|REGISTRY|DATA_ANALYSIS|FL_STUDY|SYNTHETIC_DATA']
  status varchar(30) [default: 'DRAFT', note: 'DRAFT|IRB_PENDING|IRB_APPROVED|RECRUITING|ACTIVE|DATA_LOCKED|ANALYSIS|COMPLETED']
  pi_user_id uuid [not null, note: '⚠️ cross-DB 논리참조 → health_db.users.id (연구책임자)']
  irb_number varchar(50)
  target_participant_count int
  required_data_categories text [note: 'TEXT[] 배열']
  reward_per_participant decimal(18,6)
  total_reward_budget decimal(18,6)
  escrow_xrpl_tx_hash varchar(64)
  created_at timestamp [default: `NOW()`]
}

Table project_milestones [headercolor: #059669] {
  id uuid [pk]
  project_id uuid [ref: > projects.id]
  milestone_type varchar(30) [note: 'IRB_SUBMISSION|IRB_APPROVAL|RECRUITMENT_START|RECRUITMENT_COMPLETE|DATA_COLLECTION|CLOSURE']
  status varchar(20) [default: 'PENDING']
  target_date date
  completed_at timestamp
  sequence_order int
}

Table participants [headercolor: #059669] {
  id uuid [pk]
  project_id uuid [ref: > projects.id]
  user_id uuid [not null, note: '⚠️ cross-DB 논리참조 → health_db.users.id']
  consent_id uuid [note: '⚠️ cross-DB 논리참조 → health_db.consents.id']
  status varchar(20) [default: 'INVITED', note: 'INVITED|CONSENTED|ENROLLED|ACTIVE|COMPLETED|WITHDRAWN|EXCLUDED']
  reward_earned decimal(18,6) [default: 0]
  reward_paid decimal(18,6) [default: 0]
  created_at timestamp [default: `NOW()`]

  indexes {
    (project_id, user_id) [unique]
  }
}

Table participation_criteria [headercolor: #059669] {
  id uuid [pk]
  project_id uuid [ref: > projects.id]
  criteria_type varchar(20) [note: 'INCLUSION|EXCLUSION']
  field varchar(50) [note: 'age, gender, chronic_conditions']
  operator varchar(20) [note: 'EQUALS|BETWEEN|IN|NOT_IN|GTE|LTE']
  value jsonb
}

Table data_requests [headercolor: #059669] {
  id uuid [pk]
  project_id uuid [ref: > projects.id]
  requester_id uuid
  request_type varchar(30) [note: 'PARTICIPANT_DATA|AGGREGATE|EXPORT']
  data_categories text [note: 'TEXT[] 배열']
  status varchar(20) [default: 'PENDING']
  core_request_id uuid [note: 'Core Internal API 요청 ID']
  created_at timestamp [default: `NOW()`]
}

// ─── 9. IRB ───

Table irb_submissions [headercolor: #059669] {
  id uuid [pk]
  project_id uuid [ref: > projects.id]
  enterprise_id uuid [ref: > enterprises.id]
  submission_type varchar(30) [note: 'INITIAL|AMENDMENT|CONTINUING_REVIEW|CLOSURE']
  status varchar(30) [default: 'DRAFT', note: 'DRAFT|SUBMITTED|PRELIMINARY_REVIEW|FULL_BOARD_REVIEW|REVISION_REQUESTED|APPROVED|CONDITIONALLY_APPROVED|REJECTED']
  version int [default: 1]
  ai_generated boolean [default: false]
  ai_model_used varchar(50) [note: 'claude-sonnet-4-5']
  approval_valid_until date
  created_at timestamp [default: `NOW()`]
}

Table irb_documents [headercolor: #059669] {
  id uuid [pk]
  submission_id uuid [ref: > irb_submissions.id]
  doc_type varchar(50) [note: 'PROTOCOL|CONSENT_FORM|INVESTIGATOR_BROCHURE|CASE_REPORT_FORM|AMENDMENT_REPORT|SAFETY_REPORT']
  title varchar(300)
  content text [note: '마크다운/HTML']
  version int [default: 1]
  generated_by varchar(20) [note: 'AI|MANUAL|TEMPLATE']
  previous_version_id uuid [ref: > irb_documents.id]
  created_at timestamp [default: `NOW()`]
}

Table irb_review_comments [headercolor: #059669] {
  id uuid [pk]
  submission_id uuid [ref: > irb_submissions.id]
  reviewer_id uuid
  review_type varchar(20) [note: 'PRIMARY|SECONDARY|FULL_BOARD']
  decision varchar(20) [note: 'APPROVE|MINOR_REVISION|REJECT']
  comment text
  target_document_id uuid
  target_section varchar(100)
  is_confidential boolean [default: false]
  created_at timestamp [default: `NOW()`]
}

Table irb_workflow_history [headercolor: #059669] {
  id uuid [pk]
  submission_id uuid [ref: > irb_submissions.id]
  from_status varchar(30)
  to_status varchar(30)
  changed_by uuid
  reason text
  created_at timestamp [default: `NOW()`]
}

// ─── 10. 정산 ───

Table settlement_batches [headercolor: #059669] {
  id uuid [pk]
  project_id uuid [ref: > projects.id]
  batch_type varchar(30) [note: 'PARTICIPANT_REWARD|DATA_PURCHASE|FL_CONTRIBUTION']
  status varchar(20) [default: 'PENDING', note: 'PENDING|CALCULATING|CALCULATED|CORE_REQUESTED|ESCROW_PROCESSING|COMPLETED']
  total_amount decimal(18,6)
  currency varchar(10) [default: 'UQD']
  item_count int
  escrow_tx_hash varchar(64)
  created_at timestamp [default: `NOW()`]
}

Table settlement_items [headercolor: #059669] {
  id uuid [pk]
  batch_id uuid [ref: > settlement_batches.id]
  recipient_user_id uuid [note: '⚠️ cross-DB 논리참조 → health_db.users.id']
  recipient_wallet_address varchar(60)
  amount decimal(18,6)
  calculation_basis jsonb [note: '{data_points_count: 150, quality_avg: 0.85, days: 90}']
  status varchar(20) [default: 'PENDING', note: 'PENDING|PAID|FAILED|REFUNDED']
  paid_tx_hash varchar(64)
  paid_at timestamp
}

// ─── 11. Phase 2 ───

Table synthetic_datasets [headercolor: #6b7280] {
  id uuid [pk]
  project_id uuid [ref: > projects.id]
  generation_method varchar(30) [note: 'GAN|VAE|CTGAN|RULE_BASED']
  source_data_summary jsonb
  row_count int
  quality_score decimal(3,2)
  reidentification_risk decimal(5,4)
  status varchar(20) [default: 'GENERATING']
  created_at timestamp [default: `NOW()`]

  Note: 'Phase 2'
}

Table fl_rounds [headercolor: #6b7280] {
  id uuid [pk]
  project_id uuid [ref: > projects.id]
  round_number int
  participating_nodes int
  dp_epsilon decimal(5,2) [note: 'Differential Privacy']
  aggregation_method varchar(30) [note: 'FedAvg|FedProx']
  status varchar(20) [default: 'PENDING']
  created_at timestamp [default: `NOW()`]

  Note: 'Phase 2'
}

// ─── 12. 시스템 ───

Table webhook_events [headercolor: #059669] {
  id uuid [pk]
  event_type varchar(50) [note: 'data.submitted|consent.granted|consent.revoked|escrow.deposited|escrow.finished|escrow.cancelled|user.kyc_updated|wallet.created']
  source varchar(20) [default: 'CORE']
  payload jsonb
  status varchar(20) [default: 'RECEIVED', note: 'RECEIVED|PROCESSED|FAILED|RETRYING']
  retry_count int [default: 0]
  error_message text
  created_at timestamp [default: `NOW()`]
}
