<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UniQData ERD v6 ‚Äî 2-Server Architecture</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', -apple-system, sans-serif; background: #0a0a12; color: #e2e8f0; overflow: hidden; }
    .app { display: flex; flex-direction: column; height: 100vh; }

    .header {
      padding: 14px 24px;
      background: linear-gradient(180deg, #0f0f1a 0%, #0a0a12 100%);
      border-bottom: 1px solid #1e293b;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }
    .logo { font-size: 20px; font-weight: 700; letter-spacing: -0.5px; }
    .logo .primary { color: #818cf8; }
    .logo .secondary { color: #64748b; }
    .header-stats { font-size: 12px; color: #64748b; margin-left: 16px; }

    .zoom-controls { display: flex; align-items: center; gap: 8px; }
    .zoom-btn {
      width: 32px; height: 32px; border-radius: 8px; border: 1px solid #334155;
      background: #1e293b; color: #94a3b8; font-size: 16px; cursor: pointer;
      display: flex; align-items: center; justify-content: center; transition: all 0.15s;
    }
    .zoom-btn:hover { background: #334155; color: #fff; }
    .zoom-level { font-size: 12px; color: #64748b; width: 44px; text-align: center; }

    .tabs-wrapper {
      background: #0f0f1a;
      border-bottom: 1px solid #1e293b;
      padding: 0 24px;
      flex-shrink: 0;
    }
    .tabs-row {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 10px 0;
      overflow-x: auto;
      scrollbar-width: thin;
      scrollbar-color: #334155 transparent;
    }
    .tabs-row::-webkit-scrollbar { height: 4px; }
    .tabs-row::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }
    .tabs-row:first-child { border-bottom: 1px solid #1e293b20; }
    .tabs-label {
      font-size: 11px;
      color: #475569;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-right: 8px;
      min-width: 60px;
    }
    .tab {
      padding: 7px 14px;
      border-radius: 8px;
      border: 1px solid transparent;
      background: transparent;
      color: #64748b;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .tab:hover { background: #1e293b; color: #94a3b8; }
    .tab.active {
      background: var(--tab-bg, #334155);
      color: var(--tab-color, #fff);
      border-color: var(--tab-border, transparent);
    }
    .tab .icon { font-size: 14px; }
    .tab .count {
      font-size: 10px;
      background: rgba(255,255,255,0.15);
      padding: 2px 6px;
      border-radius: 10px;
    }

    .canvas-wrapper {
      flex: 1;
      overflow: hidden;
      position: relative;
      cursor: grab;
    }
    .canvas-wrapper.dragging { cursor: grabbing; }
    .canvas-wrapper::before {
      content: '';
      position: absolute;
      inset: 0;
      background-image: radial-gradient(circle, #1e293b 1px, transparent 1px);
      background-size: 24px 24px;
      pointer-events: none;
    }
    .canvas {
      position: absolute;
      top: 0;
      left: 0;
      transform-origin: 0 0;
    }

    .table-card {
      position: absolute;
      background: #12121a;
      border: 1px solid #252535;
      border-radius: 8px;
      overflow: hidden;
      transition: box-shadow 0.15s, border-color 0.15s;
      cursor: pointer;
    }
    .table-card:hover {
      border-color: #3b3b55;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .table-card.highlighted {
      border-color: #60a5fa;
      box-shadow: 0 0 0 1px #60a5fa50;
    }
    .table-card.ghost { opacity: 0.5; }
    .table-card.ghost:hover { opacity: 0.8; }

    .table-header {
      padding: 8px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .table-name {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      font-weight: 600;
      color: #fff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .table-meta { font-size: 10px; color: rgba(255,255,255,0.6); }

    .table-cols { padding: 6px 0; }
    .col-row {
      padding: 4px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
    }
    .col-row:hover { background: #1e1e2e; }
    .col-icon { width: 16px; font-size: 11px; flex-shrink: 0; }
    .col-icon.pk { color: #fbbf24; }
    .col-icon.fk { color: #60a5fa; }
    .col-name { font-family: 'JetBrains Mono', monospace; flex: 1; white-space: nowrap; }
    .col-name.pk { color: #fbbf24; }
    .col-name.fk { color: #60a5fa; }
    .col-name.normal { color: #94a3b8; }
    .col-type { font-family: 'JetBrains Mono', monospace; font-size: 11px; color: #475569; }
    .table-more { padding: 6px 16px; font-size: 10px; color: #475569; border-top: 1px solid #1e293b; }

    .relations-layer { position: absolute; top: 0; left: 0; pointer-events: none; overflow: visible; }
    .relation-path { fill: none; stroke: #4b5563; stroke-width: 1; opacity: 0.3; }
    .relation-path.highlighted { stroke: #60a5fa; stroke-width: 1.5; opacity: 0.9; }
    .relation-dot { fill: #4b5563; opacity: 0.3; }
    .relation-dot.highlighted { fill: #60a5fa; opacity: 0.9; }

    .col-header {
      position: absolute;
      top: -35px;
      width: 210px;
      text-align: center;
      font-size: 11px;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 6px 0;
      border-bottom: 2px solid;
    }

    .legend {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: #151521f0;
      backdrop-filter: blur(12px);
      border: 1px solid #2a2a3e;
      border-radius: 12px;
      padding: 14px 18px;
      font-size: 11px;
      z-index: 100;
    }
    .legend-title { font-weight: 600; margin-bottom: 10px; color: #94a3b8; font-size: 12px; }
    .legend-item { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; color: #64748b; }
    .legend-icon { width: 14px; text-align: center; }

    .detail-panel {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #151521f0;
      backdrop-filter: blur(12px);
      border: 1px solid #2a2a3e;
      border-radius: 14px;
      padding: 18px 20px;
      min-width: 280px;
      max-width: 340px;
      z-index: 100;
    }
    .detail-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    .detail-name { font-family: 'JetBrains Mono', monospace; font-size: 15px; font-weight: 600; }
    .detail-badge { font-size: 10px; padding: 3px 8px; border-radius: 10px; color: #fff; }
    .detail-stats { font-size: 12px; color: #64748b; margin-bottom: 12px; }
    .detail-relations { display: flex; flex-direction: column; gap: 4px; }
    .detail-rel {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: #60a5fa;
      padding: 5px 10px;
      background: #1e293b;
      border-radius: 6px;
    }
    .detail-close { margin-top: 12px; font-size: 10px; color: #475569; cursor: pointer; }
    .detail-close:hover { color: #94a3b8; }

    .server-badge {
      display: inline-block;
      font-size: 9px;
      padding: 1px 5px;
      border-radius: 4px;
      margin-left: 6px;
      font-weight: 600;
    }
    .server-core { background: #7c3aed30; color: #a78bfa; border: 1px solid #7c3aed50; }
    .server-biz { background: #05966930; color: #34d399; border: 1px solid #05966950; }
  </style>
</head>
<body>
  <div class="app" id="app"></div>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script type="text/babel">
const { useState, useEffect, useCallback, useRef } = React;

// ============================================================
// DATA DEFINITIONS ‚Äî v6 2-Server Architecture (31 Tables)
// ============================================================

const SERVERS = {
  all: { label: "Ï†ÑÏ≤¥ UniQData", icon: "üóÑÔ∏è", color: "#64748b", desc: "31 tables" },
  health_db: { label: "Core (health_db)", icon: "üü£", color: "#7c3aed", desc: "NestJS:3000 ¬∑ 15 tables" },
  uniqdata_db: { label: "Business (uniqdata_db)", icon: "üü¢", color: "#059669", desc: "Spring Boot:8080 ¬∑ 16 tables" },
};

const DOMAINS = {
  all: { label: "Ï†ÑÏ≤¥", color: "#64748b" },
  auth: { label: "Auth / Profile", color: "#818cf8" },
  wallet: { label: "Wallet / XRPL", color: "#f59e0b" },
  health: { label: "Health Data", color: "#a855f7" },
  consent: { label: "Consent", color: "#ec4899" },
  notify: { label: "Notification", color: "#06b6d4" },
  org: { label: "Enterprise", color: "#10b981" },
  research: { label: "Research", color: "#3b82f6" },
  irb: { label: "IRB", color: "#f97316" },
  finance: { label: "Settlement", color: "#ef4444" },
  phase2: { label: "Phase 2", color: "#6b7280" },
  system: { label: "System", color: "#475569" },
};

// Server ‚Üí Table mapping
const SERVER_TABLES = {
  all: null,
  health_db: [
    "users", "passkey_credentials", "user_profiles", "refresh_tokens",
    "user_wallets", "wallet_recovery_configs",
    "data_points", "data_point_tags", "data_access_logs",
    "consents", "consent_scopes", "consent_audit_trail",
    "xrpl_transactions",
    "notifications", "notification_preferences"
  ],
  uniqdata_db: [
    "enterprises", "enterprise_members",
    "projects", "project_milestones", "participants", "participation_criteria", "data_requests",
    "irb_submissions", "irb_documents", "irb_review_comments", "irb_workflow_history",
    "settlement_batches", "settlement_items",
    "synthetic_datasets", "fl_rounds",
    "webhook_events"
  ],
};

// API Endpoints
const API_ENDPOINTS = {
  health_db: {
    all: { label: "Ï†ÑÏ≤¥ API", tables: null, method: "", color: "#64748b", desc: "Core Server Ï†ÑÏ≤¥ ÌÖåÏù¥Î∏î" },
    get_user: {
      label: "GET /internal/users/:id",
      tables: ["users", "user_profiles", "passkey_credentials"],
      method: "GET", color: "#3b82f6",
      desc: "ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ + ÌîÑÎ°úÌïÑ + Ìå®Ïä§ÌÇ§ Î™©Î°ù Ï°∞Ìöå"
    },
    verify_kyc: {
      label: "POST /internal/users/:id/verify-kyc",
      tables: ["users"],
      method: "POST", color: "#22c55e",
      desc: "KYC Î†àÎ≤® ÏóÖÎç∞Ïù¥Ìä∏"
    },
    get_wallet: {
      label: "GET /internal/wallets/by-user/:id",
      tables: ["user_wallets"],
      method: "GET", color: "#3b82f6",
      desc: "ÏÇ¨Ïö©Ïûê ÏßÄÍ∞ë Ï°∞Ìöå (ÏûîÏï°, Ï£ºÏÜå)"
    },
    create_escrow: {
      label: "POST /internal/wallets/:id/escrow",
      tables: ["user_wallets", "xrpl_transactions"],
      method: "POST", color: "#22c55e",
      desc: "XRPL ÏóêÏä§ÌÅ¨Î°ú ÏÉùÏÑ±"
    },
    release_escrow: {
      label: "POST /internal/wallets/:id/release",
      tables: ["user_wallets", "xrpl_transactions"],
      method: "POST", color: "#22c55e",
      desc: "ÏóêÏä§ÌÅ¨Î°ú Ìï¥Ï†ú (Ï†ïÏÇ∞)"
    },
    query_data: {
      label: "POST /internal/data/query",
      tables: ["data_points", "data_point_tags", "data_access_logs", "consents"],
      method: "POST", color: "#22c55e",
      desc: "Í±¥Í∞ï Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå (ÎèôÏùò Í≤ÄÏ¶ù ÌõÑ)"
    },
    pseudonymize: {
      label: "POST /internal/data/pseudonymize",
      tables: ["data_points", "data_access_logs"],
      method: "POST", color: "#22c55e",
      desc: "Îç∞Ïù¥ÌÑ∞ ÎπÑÏãùÎ≥ÑÌôî Ï≤òÎ¶¨"
    },
    create_consent: {
      label: "POST /internal/consents",
      tables: ["consents", "consent_scopes", "consent_audit_trail", "xrpl_transactions"],
      method: "POST", color: "#22c55e",
      desc: "Ïó∞Íµ¨ Ï∞∏Ïó¨ ÎèôÏùò ÏÉùÏÑ± + XRPL ÏïµÏª§ÎßÅ"
    },
    check_consent: {
      label: "GET /internal/consents/check",
      tables: ["consents", "consent_scopes"],
      method: "GET", color: "#3b82f6",
      desc: "ÎèôÏùò Ïú†Ìö®ÏÑ± Í≤ÄÏ¶ù"
    },
    revoke_consent: {
      label: "PUT /internal/consents/:id/revoke",
      tables: ["consents", "consent_audit_trail", "xrpl_transactions"],
      method: "PUT", color: "#f59e0b",
      desc: "ÎèôÏùò Ï≤†Ìöå + XRPL ÏïµÏª§ÎßÅ"
    },
    send_notification: {
      label: "POST /internal/notifications",
      tables: ["notifications", "notification_preferences"],
      method: "POST", color: "#22c55e",
      desc: "ÏïåÎ¶º Î∞úÏÜ° (Push/Email/In-App)"
    },
  },
  uniqdata_db: {
    all: { label: "Ï†ÑÏ≤¥ API", tables: null, method: "", color: "#64748b", desc: "Business Server Ï†ÑÏ≤¥ ÌÖåÏù¥Î∏î" },
    create_project: {
      label: "POST /api/projects",
      tables: ["projects", "project_milestones", "participation_criteria", "enterprises"],
      method: "POST", color: "#22c55e",
      desc: "Ïó∞Íµ¨ ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ± + ÎßàÏùºÏä§ÌÜ§ + Ï∞∏Ïó¨ Í∏∞Ï§Ä"
    },
    list_projects: {
      label: "GET /api/projects",
      tables: ["projects", "enterprises", "enterprise_members"],
      method: "GET", color: "#3b82f6",
      desc: "ÎÇ¥Í∞Ä ÏÜçÌïú ÌîÑÎ°úÏ†ùÌä∏ Î™©Î°ù Ï°∞Ìöå"
    },
    request_data: {
      label: "POST /api/data-requests",
      tables: ["data_requests", "projects", "participants"],
      method: "POST", color: "#22c55e",
      desc: "Îç∞Ïù¥ÌÑ∞ ÏöîÏ≤≠ ‚Üí Core Internal API Ìò∏Ï∂ú"
    },
    submit_irb: {
      label: "POST /api/irb/submissions",
      tables: ["irb_submissions", "irb_documents", "projects", "enterprises"],
      method: "POST", color: "#22c55e",
      desc: "IRB Ïã¨Ïùò Ï†úÏ∂ú (AI ÏûêÎèô ÏÉùÏÑ± Ìè¨Ìï®)"
    },
    review_irb: {
      label: "PUT /api/irb/:id/review",
      tables: ["irb_submissions", "irb_review_comments", "irb_workflow_history"],
      method: "PUT", color: "#f59e0b",
      desc: "IRB Ïã¨Ïùò Í≤∞Ï†ï (ÏäπÏù∏/ÏàòÏ†ï/Î∞òÎ†§)"
    },
    create_settlement: {
      label: "POST /api/settlements/batch",
      tables: ["settlement_batches", "settlement_items", "participants", "projects"],
      method: "POST", color: "#22c55e",
      desc: "Ï†ïÏÇ∞ Î∞∞Ïπò ÏÉùÏÑ± ‚Üí Core ÏóêÏä§ÌÅ¨Î°ú Ìï¥Ï†ú ÏöîÏ≤≠"
    },
    wh_data_submitted: {
      label: "üîî data.submitted",
      tables: ["webhook_events", "data_requests"],
      method: "WEBHOOK", color: "#a855f7",
      desc: "Core ‚Üí Business: ÏÉà Îç∞Ïù¥ÌÑ∞ Ï†úÏ∂ú ÏïåÎ¶º"
    },
    wh_consent_granted: {
      label: "üîî consent.granted",
      tables: ["webhook_events", "participants", "projects"],
      method: "WEBHOOK", color: "#a855f7",
      desc: "Core ‚Üí Business: Ïó∞Íµ¨ ÎèôÏùò ÏôÑÎ£å ‚Üí Ï∞∏Ïó¨Ïûê Îì±Î°ù"
    },
  },
};

// ============================================================
// TABLE DEFINITIONS (31 Tables)
// ============================================================

const TABLES = [
  // ‚îÄ‚îÄ‚îÄ health_db: Auth / Profile ‚îÄ‚îÄ‚îÄ
  { name: "users", domain: "auth", server: "health_db", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "email", t: "varchar", }, { n: "phone", t: "varchar" },
    { n: "display_name", t: "varchar" }, { n: "role", t: "enum" }, { n: "kyc_level", t: "smallint" },
    { n: "status", t: "varchar" }, { n: "last_login_at", t: "ts" }, { n: "created_at", t: "ts" }
  ]},
  { name: "passkey_credentials", domain: "auth", server: "health_db", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "user_id", t: "uuid", fk: "users" },
    { n: "credential_id", t: "text" }, { n: "public_key", t: "text" },
    { n: "sign_count", t: "bigint" }, { n: "prf_supported", t: "bool" }, { n: "prf_salt", t: "bytea" }
  ]},
  { name: "user_profiles", domain: "auth", server: "health_db", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "user_id", t: "uuid", fk: "users" },
    { n: "birth_date", t: "date" }, { n: "gender", t: "varchar" },
    { n: "height_cm", t: "decimal" }, { n: "weight_kg", t: "decimal" },
    { n: "chronic_conditions", t: "text" }, { n: "medications", t: "jsonb" }
  ]},
  { name: "refresh_tokens", domain: "auth", server: "health_db", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "user_id", t: "uuid", fk: "users" },
    { n: "token_hash", t: "varchar" }, { n: "device_info", t: "jsonb" },
    { n: "expires_at", t: "ts" }, { n: "revoked", t: "bool" }
  ]},

  // ‚îÄ‚îÄ‚îÄ health_db: Wallet / XRPL ‚îÄ‚îÄ‚îÄ
  { name: "user_wallets", domain: "wallet", server: "health_db", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "user_id", t: "uuid", fk: "users" },
    { n: "xrpl_address", t: "varchar" }, { n: "xrpl_public_key", t: "varchar" },
    { n: "wallet_type", t: "enum" }, { n: "derivation_method", t: "varchar" },
    { n: "uqd_balance", t: "decimal" }, { n: "xrp_balance", t: "decimal" }, { n: "status", t: "varchar" }
  ]},
  { name: "wallet_recovery_configs", domain: "wallet", server: "health_db", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "user_id", t: "uuid", fk: "users" },
    { n: "recovery_method", t: "varchar" }, { n: "config", t: "jsonb" }, { n: "created_at", t: "ts" }
  ]},
  { name: "xrpl_transactions", domain: "wallet", server: "health_db", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "tx_hash", t: "varchar" },
    { n: "tx_type", t: "enum" }, { n: "from_address", t: "varchar" }, { n: "to_address", t: "varchar" },
    { n: "amount", t: "decimal" }, { n: "currency", t: "varchar" },
    { n: "memo_data", t: "jsonb" }, { n: "status", t: "varchar" },
    { n: "related_user_id", t: "uuid" }, { n: "related_consent_id", t: "uuid" }
  ]},

  // ‚îÄ‚îÄ‚îÄ health_db: Health Data ‚îÄ‚îÄ‚îÄ
  { name: "data_points", domain: "health", server: "health_db", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "user_id", t: "uuid", fk: "users" },
    { n: "category", t: "varchar" }, { n: "sub_category", t: "varchar" },
    { n: "value", t: "jsonb" }, { n: "source", t: "varchar" },
    { n: "measured_at", t: "ts" }, { n: "data_hash", t: "varchar" },
    { n: "xrpl_anchored", t: "bool" }, { n: "quality_score", t: "decimal" }
  ]},
  { name: "data_point_tags", domain: "health", server: "health_db", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "data_point_id", t: "uuid", fk: "data_points" },
    { n: "tag_key", t: "varchar" }, { n: "tag_value", t: "varchar" }
  ]},
  { name: "data_access_logs", domain: "health", server: "health_db", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "data_point_ids", t: "text" },
    { n: "accessor_type", t: "varchar" }, { n: "accessor_id", t: "uuid" },
    { n: "project_id", t: "uuid" }, { n: "consent_id", t: "uuid", fk: "consents" },
    { n: "record_count", t: "int" }, { n: "pseudonymized", t: "bool" }
  ]},

  // ‚îÄ‚îÄ‚îÄ health_db: Consent ‚îÄ‚îÄ‚îÄ
  { name: "consents", domain: "consent", server: "health_db", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "user_id", t: "uuid", fk: "users" },
    { n: "consent_type", t: "varchar" }, { n: "status", t: "varchar" },
    { n: "signature_hash", t: "varchar" }, { n: "grant_tx_hash", t: "varchar" },
    { n: "revoke_tx_hash", t: "varchar" }, { n: "project_id", t: "uuid" },
    { n: "irb_number", t: "varchar" }, { n: "version", t: "int" }
  ]},
  { name: "consent_scopes", domain: "consent", server: "health_db", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "consent_id", t: "uuid", fk: "consents" },
    { n: "scope_type", t: "varchar" }, { n: "scope_key", t: "varchar" }, { n: "scope_value", t: "text" }
  ]},
  { name: "consent_audit_trail", domain: "consent", server: "health_db", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "consent_id", t: "uuid", fk: "consents" },
    { n: "action", t: "varchar" }, { n: "actor_id", t: "uuid" },
    { n: "changes", t: "jsonb" }, { n: "xrpl_tx_hash", t: "varchar" }
  ]},

  // ‚îÄ‚îÄ‚îÄ health_db: Notification ‚îÄ‚îÄ‚îÄ
  { name: "notifications", domain: "notify", server: "health_db", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "user_id", t: "uuid", fk: "users" },
    { n: "type", t: "varchar" }, { n: "title", t: "varchar" },
    { n: "body", t: "text" }, { n: "channel", t: "varchar" },
    { n: "read", t: "bool" }, { n: "metadata", t: "jsonb" }
  ]},
  { name: "notification_preferences", domain: "notify", server: "health_db", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "user_id", t: "uuid", fk: "users" },
    { n: "push_enabled", t: "bool" }, { n: "email_enabled", t: "bool" },
    { n: "health_alerts", t: "bool" }, { n: "research_updates", t: "bool" }
  ]},

  // ‚ïê‚ïê‚ïê uniqdata_db: Enterprise ‚ïê‚ïê‚ïê
  { name: "enterprises", domain: "org", server: "uniqdata_db", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "name", t: "varchar" },
    { n: "enterprise_type", t: "enum" }, { n: "business_number", t: "varchar" },
    { n: "irb_committee_id", t: "uuid" }, { n: "status", t: "varchar" }
  ]},
  { name: "enterprise_members", domain: "org", server: "uniqdata_db", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "enterprise_id", t: "uuid", fk: "enterprises" },
    { n: "user_id", t: "uuid" }, { n: "role", t: "enum" }, { n: "status", t: "varchar" }
  ]},

  // ‚ïê‚ïê‚ïê uniqdata_db: Research ‚ïê‚ïê‚ïê
  { name: "projects", domain: "research", server: "uniqdata_db", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "enterprise_id", t: "uuid", fk: "enterprises" },
    { n: "title", t: "varchar" }, { n: "project_type", t: "enum" },
    { n: "status", t: "varchar" }, { n: "pi_user_id", t: "uuid" },
    { n: "irb_number", t: "varchar" }, { n: "target_participant_count", t: "int" },
    { n: "reward_per_participant", t: "decimal" }, { n: "total_reward_budget", t: "decimal" }
  ]},
  { name: "project_milestones", domain: "research", server: "uniqdata_db", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "project_id", t: "uuid", fk: "projects" },
    { n: "milestone_type", t: "varchar" }, { n: "status", t: "varchar" },
    { n: "target_date", t: "date" }, { n: "completed_at", t: "ts" }
  ]},
  { name: "participants", domain: "research", server: "uniqdata_db", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "project_id", t: "uuid", fk: "projects" },
    { n: "user_id", t: "uuid" }, { n: "consent_id", t: "uuid" },
    { n: "status", t: "varchar" }, { n: "reward_earned", t: "decimal" }, { n: "reward_paid", t: "decimal" }
  ]},
  { name: "participation_criteria", domain: "research", server: "uniqdata_db", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "project_id", t: "uuid", fk: "projects" },
    { n: "criteria_type", t: "varchar" }, { n: "field", t: "varchar" },
    { n: "operator", t: "varchar" }, { n: "value", t: "jsonb" }
  ]},
  { name: "data_requests", domain: "research", server: "uniqdata_db", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "project_id", t: "uuid", fk: "projects" },
    { n: "requester_id", t: "uuid" }, { n: "request_type", t: "varchar" },
    { n: "data_categories", t: "text" }, { n: "status", t: "varchar" },
    { n: "core_request_id", t: "uuid" }
  ]},

  // ‚ïê‚ïê‚ïê uniqdata_db: IRB ‚ïê‚ïê‚ïê
  { name: "irb_submissions", domain: "irb", server: "uniqdata_db", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "project_id", t: "uuid", fk: "projects" },
    { n: "enterprise_id", t: "uuid", fk: "enterprises" },
    { n: "submission_type", t: "varchar" }, { n: "status", t: "varchar" },
    { n: "version", t: "int" }, { n: "ai_generated", t: "bool" },
    { n: "approval_valid_until", t: "date" }
  ]},
  { name: "irb_documents", domain: "irb", server: "uniqdata_db", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "submission_id", t: "uuid", fk: "irb_submissions" },
    { n: "doc_type", t: "varchar" }, { n: "title", t: "varchar" },
    { n: "content", t: "text" }, { n: "version", t: "int" },
    { n: "generated_by", t: "varchar" }, { n: "previous_version_id", t: "uuid", fk: "irb_documents" }
  ]},
  { name: "irb_review_comments", domain: "irb", server: "uniqdata_db", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "submission_id", t: "uuid", fk: "irb_submissions" },
    { n: "reviewer_id", t: "uuid" }, { n: "review_type", t: "varchar" },
    { n: "decision", t: "varchar" }, { n: "comment", t: "text" },
    { n: "is_confidential", t: "bool" }
  ]},
  { name: "irb_workflow_history", domain: "irb", server: "uniqdata_db", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "submission_id", t: "uuid", fk: "irb_submissions" },
    { n: "from_status", t: "varchar" }, { n: "to_status", t: "varchar" },
    { n: "changed_by", t: "uuid" }, { n: "reason", t: "text" }
  ]},

  // ‚ïê‚ïê‚ïê uniqdata_db: Settlement ‚ïê‚ïê‚ïê
  { name: "settlement_batches", domain: "finance", server: "uniqdata_db", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "project_id", t: "uuid", fk: "projects" },
    { n: "batch_type", t: "varchar" }, { n: "status", t: "varchar" },
    { n: "total_amount", t: "decimal" }, { n: "currency", t: "varchar" },
    { n: "item_count", t: "int" }, { n: "escrow_tx_hash", t: "varchar" }
  ]},
  { name: "settlement_items", domain: "finance", server: "uniqdata_db", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "batch_id", t: "uuid", fk: "settlement_batches" },
    { n: "recipient_user_id", t: "uuid" }, { n: "recipient_wallet_address", t: "varchar" },
    { n: "amount", t: "decimal" }, { n: "calculation_basis", t: "jsonb" },
    { n: "status", t: "varchar" }, { n: "paid_tx_hash", t: "varchar" }
  ]},

  // ‚ïê‚ïê‚ïê uniqdata_db: Phase 2 ‚ïê‚ïê‚ïê
  { name: "synthetic_datasets", domain: "phase2", server: "uniqdata_db", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "project_id", t: "uuid", fk: "projects" },
    { n: "generation_method", t: "varchar" }, { n: "row_count", t: "int" },
    { n: "quality_score", t: "decimal" }, { n: "reidentification_risk", t: "decimal" },
    { n: "status", t: "varchar" }
  ]},
  { name: "fl_rounds", domain: "phase2", server: "uniqdata_db", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "project_id", t: "uuid", fk: "projects" },
    { n: "round_number", t: "int" }, { n: "participating_nodes", t: "int" },
    { n: "dp_epsilon", t: "decimal" }, { n: "aggregation_method", t: "varchar" },
    { n: "status", t: "varchar" }
  ]},

  // ‚ïê‚ïê‚ïê uniqdata_db: System ‚ïê‚ïê‚ïê
  { name: "webhook_events", domain: "system", server: "uniqdata_db", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "event_type", t: "varchar" },
    { n: "source", t: "varchar" }, { n: "payload", t: "jsonb" },
    { n: "status", t: "varchar" }, { n: "retry_count", t: "int" }, { n: "error_message", t: "text" }
  ]},
];

// 1:1 relations
const ONE_TO_ONE = new Set([
  "user_profiles‚Üíusers",
  "notification_preferences‚Üíusers",
]);

// Build relations
const RELATIONS = [];
TABLES.forEach(t => {
  t.cols.forEach(c => {
    if (c.fk) {
      const key = `${t.name}‚Üí${c.fk}`;
      const card = ONE_TO_ONE.has(key) ? "1:1" : "N:1";
      RELATIONS.push({ from: t.name, fromCol: c.n, to: c.fk, toCol: "id", card });
    }
  });
});

// ============================================================
// LAYOUT
// ============================================================

const AREA_LAYOUT = {
  // === Col 0: Auth ===
  users:                    { col: 0, row: 0 },
  passkey_credentials:      { col: 0, row: 1 },
  user_profiles:            { col: 0, row: 2 },
  refresh_tokens:           { col: 0, row: 3 },

  // === Col 1: Wallet / XRPL ===
  user_wallets:             { col: 1, row: 0 },
  wallet_recovery_configs:  { col: 1, row: 1 },
  xrpl_transactions:        { col: 1, row: 2 },

  // === Col 2: Health Data ===
  data_points:              { col: 2, row: 0 },
  data_point_tags:          { col: 2, row: 1 },
  data_access_logs:         { col: 2, row: 2 },

  // === Col 3: Consent ===
  consents:                 { col: 3, row: 0 },
  consent_scopes:           { col: 3, row: 1 },
  consent_audit_trail:      { col: 3, row: 2 },

  // === Col 4: Notification ===
  notifications:            { col: 4, row: 0 },
  notification_preferences: { col: 4, row: 1 },

  // === Col 5: Enterprise ===
  enterprises:              { col: 5, row: 0 },
  enterprise_members:       { col: 5, row: 1 },

  // === Col 6: Research ===
  projects:                 { col: 6, row: 0 },
  project_milestones:       { col: 6, row: 1 },
  participants:             { col: 6, row: 2 },
  participation_criteria:   { col: 6, row: 3 },
  data_requests:            { col: 6, row: 4 },

  // === Col 7: IRB ===
  irb_submissions:          { col: 7, row: 0 },
  irb_documents:            { col: 7, row: 1 },
  irb_review_comments:      { col: 7, row: 2 },
  irb_workflow_history:     { col: 7, row: 3 },

  // === Col 8: Settlement / Phase2 / System ===
  settlement_batches:       { col: 8, row: 0 },
  settlement_items:         { col: 8, row: 1 },
  synthetic_datasets:       { col: 8, row: 2 },
  fl_rounds:                { col: 8, row: 3 },
  webhook_events:           { col: 8, row: 4 },
};

function calculateLayout(server, domain, api = "all") {
  let serverTables = SERVER_TABLES[server];
  let tables = serverTables ? TABLES.filter(t => serverTables.includes(t.name)) : TABLES;

  const serverApis = API_ENDPOINTS[server];
  if (api !== "all" && serverApis && serverApis[api]) {
    const apiTables = serverApis[api].tables;
    if (apiTables) {
      tables = TABLES.filter(t => apiTables.includes(t.name));
    }
  }

  const visible = domain === "all"
    ? tables
    : tables.filter(t => {
        if (t.domain === domain) return true;
        const domainTables = tables.filter(tt => tt.domain === domain);
        for (const dt of domainTables) {
          for (const c of dt.cols) {
            if (c.fk === t.name && tables.some(x => x.name === t.name)) return true;
          }
        }
        return false;
      });

  const positions = {};
  const CARD_W = 210;
  const ROW_H = 22;
  const HEADER_H = 36;
  const COL_WIDTH = 250;
  const CARD_GAP = 28;

  if (api !== "all") {
    const GRID_COLS = 3;
    const GRID_GAP_X = 260;
    const GRID_GAP_Y = 30;

    visible.forEach((t, idx) => {
      const col = idx % GRID_COLS;
      const row = Math.floor(idx / GRID_COLS);
      const h = HEADER_H + t.cols.length * ROW_H + 16;

      let y = 0;
      for (let r = 0; r < row; r++) {
        let maxH = 0;
        for (let c = 0; c < GRID_COLS; c++) {
          const prevIdx = r * GRID_COLS + c;
          if (prevIdx < visible.length) {
            const prevT = visible[prevIdx];
            const prevH = HEADER_H + prevT.cols.length * ROW_H + 16;
            maxH = Math.max(maxH, prevH);
          }
        }
        y += maxH + GRID_GAP_Y;
      }

      positions[t.name] = { x: col * GRID_GAP_X, y, w: CARD_W + 20, h, ghost: false };
    });
  } else if (domain === "all") {
    const colHeights = {};
    for (let i = 0; i < 9; i++) colHeights[i] = 0;

    const sortedTables = [...visible].sort((a, b) => {
      const posA = AREA_LAYOUT[a.name] || { col: 4, row: 5 };
      const posB = AREA_LAYOUT[b.name] || { col: 4, row: 5 };
      if (posA.col !== posB.col) return posA.col - posB.col;
      return posA.row - posB.row;
    });

    sortedTables.forEach(t => {
      const pos = AREA_LAYOUT[t.name] || { col: 4, row: 5 };
      const h = HEADER_H + t.cols.length * ROW_H + 16;
      positions[t.name] = { x: pos.col * COL_WIDTH, y: colHeights[pos.col], w: CARD_W, h, ghost: false };
      colHeights[pos.col] += h + CARD_GAP;
    });
  } else {
    const primary = visible.filter(t => t.domain === domain);
    const refs = visible.filter(t => t.domain !== domain);

    let primaryY = 0;
    primary.forEach(t => {
      const h = HEADER_H + t.cols.length * ROW_H + 16;
      positions[t.name] = { x: 250, y: primaryY, w: CARD_W + 20, h, ghost: false };
      primaryY += h + 32;
    });

    let refY = 0;
    refs.forEach(t => {
      const h = HEADER_H + Math.min(t.cols.length, 3) * ROW_H + 16;
      positions[t.name] = { x: 0, y: refY, w: 160, h, ghost: true };
      refY += h + 20;
    });
  }

  return { visible, positions };
}

// ============================================================
// COMPONENTS
// ============================================================

function TableCard({ table, pos, hovered, selected, onHover, onClick }) {
  const domain = DOMAINS[table.domain];
  const maxCols = pos.ghost ? 4 : table.cols.length;
  const visibleCols = table.cols.slice(0, maxCols);
  const isHighlighted = hovered === table.name || selected === table.name;

  return (
    <div
      className={`table-card ${isHighlighted ? 'highlighted' : ''} ${pos.ghost ? 'ghost' : ''}`}
      style={{ left: pos.x, top: pos.y, width: pos.w }}
      onMouseEnter={() => onHover(table.name)}
      onMouseLeave={() => onHover(null)}
      onClick={() => onClick(table.name)}
    >
      <div className="table-header" style={{ background: domain.color }}>
        <span className="table-name">
          {pos.ghost ? `‚Üó ${table.name}` : table.name}
        </span>
        <span className="table-meta">
          {table.cols.length} cols
          <span className={`server-badge ${table.server === 'health_db' ? 'server-core' : 'server-biz'}`}>
            {table.server === 'health_db' ? 'Core' : 'Biz'}
          </span>
        </span>
      </div>
      <div className="table-cols">
        {visibleCols.map(col => (
          <div key={col.n} className="col-row">
            <span className={`col-icon ${col.pk ? 'pk' : col.fk ? 'fk' : ''}`}>
              {col.pk ? 'üîë' : col.fk ? '‚Üí' : ''}
            </span>
            <span className={`col-name ${col.pk ? 'pk' : col.fk ? 'fk' : 'normal'}`}>{col.n}</span>
            <span className="col-type">{col.t}</span>
          </div>
        ))}
      </div>
      {pos.ghost && table.cols.length > 4 && (
        <div className="table-more">+{table.cols.length - 4} more</div>
      )}
    </div>
  );
}

function App() {
  const [server, setServer] = useState("all");
  const [domain, setDomain] = useState("all");
  const [api, setApi] = useState("all");
  const [hovered, setHovered] = useState(null);
  const [selected, setSelected] = useState(null);
  const [zoom, setZoom] = useState(0.85);
  const [pan, setPan] = useState({ x: 50, y: 40 });
  const [dragging, setDragging] = useState(false);
  const [dragStart, setDragStart] = useState({ x: 0, y: 0 });

  const { visible, positions } = calculateLayout(server, domain, api);

  const serverTablesSet = SERVER_TABLES[server];
  const filteredTables = serverTablesSet ? TABLES.filter(t => serverTablesSet.includes(t.name)) : TABLES;
  const domainCounts = {};
  Object.keys(DOMAINS).forEach(d => {
    domainCounts[d] = d === "all" ? filteredTables.length : filteredTables.filter(t => t.domain === d).length;
  });

  const activeTable = hovered || selected;
  const relatedTables = new Set();
  if (activeTable) {
    RELATIONS.forEach(r => {
      if (r.from === activeTable) relatedTables.add(r.to);
      if (r.to === activeTable) relatedTables.add(r.from);
    });
  }

  const visibleRelations = RELATIONS.filter(r =>
    visible.some(t => t.name === r.from) && visible.some(t => t.name === r.to)
  );

  useEffect(() => {
    const isAll = server === "all" && domain === "all" && api === "all";
    const isApiView = api !== "all";
    setZoom(isAll ? 0.55 : isApiView ? 1.0 : 0.95);
    setPan(isAll ? { x: 20, y: 50 } : { x: 50, y: 40 });
    setSelected(null);
  }, [server, domain, api]);

  const handleWheel = useCallback(e => {
    e.preventDefault();
    setZoom(z => Math.max(0.3, Math.min(2, z + (e.deltaY > 0 ? -0.05 : 0.05))));
  }, []);

  const handleMouseDown = e => {
    if (e.target.closest('.table-card')) return;
    setDragging(true);
    setDragStart({ x: e.clientX - pan.x, y: e.clientY - pan.y });
  };
  const handleMouseMove = e => {
    if (dragging) setPan({ x: e.clientX - dragStart.x, y: e.clientY - dragStart.y });
  };
  const handleMouseUp = () => setDragging(false);

  let maxX = 1200, maxY = 800;
  Object.values(positions).forEach(p => {
    if (p.x !== undefined) {
      maxX = Math.max(maxX, p.x + p.w + 100);
      maxY = Math.max(maxY, p.y + p.h + 100);
    }
  });

  const COL_HEADERS = [
    { col: 0, label: "Auth", color: "#818cf8" },
    { col: 1, label: "Wallet/XRPL", color: "#f59e0b" },
    { col: 2, label: "Health Data", color: "#a855f7" },
    { col: 3, label: "Consent", color: "#ec4899" },
    { col: 4, label: "Notification", color: "#06b6d4" },
    { col: 5, label: "Enterprise", color: "#10b981" },
    { col: 6, label: "Research", color: "#3b82f6" },
    { col: 7, label: "IRB", color: "#f97316" },
    { col: 8, label: "Settlement", color: "#ef4444" },
  ];

  return (
    <div className="app">
      <div className="header">
        <div style={{ display: 'flex', alignItems: 'center' }}>
          <div className="logo">
            <span className="primary">UniQ</span>
            <span className="secondary">Data</span>
          </div>
          <span className="header-stats">
            ERD v6 ¬∑ {visible.length} tables
            {server !== "all" && ` ¬∑ ${SERVERS[server].desc}`}
            {api !== "all" && API_ENDPOINTS[server] && API_ENDPOINTS[server][api] && ` ¬∑ ${API_ENDPOINTS[server][api].label}`}
          </span>
        </div>
        <div className="zoom-controls">
          <button className="zoom-btn" onClick={() => setZoom(z => Math.max(0.3, z - 0.1))}>‚àí</button>
          <span className="zoom-level">{Math.round(zoom * 100)}%</span>
          <button className="zoom-btn" onClick={() => setZoom(z => Math.min(2, z + 0.1))}>+</button>
        </div>
      </div>

      <div className="tabs-wrapper">
        <div className="tabs-row">
          <span className="tabs-label">ÏÑúÎ≤Ñ</span>
          {Object.entries(SERVERS).map(([key, s]) => (
            <button
              key={key}
              className={`tab ${server === key ? 'active' : ''}`}
              style={{ '--tab-bg': s.color, '--tab-color': '#fff' }}
              onClick={() => { setServer(key); setDomain("all"); setApi("all"); }}
            >
              <span className="icon">{s.icon}</span>
              {s.label}
            </button>
          ))}
        </div>
        <div className="tabs-row">
          <span className="tabs-label">ÎèÑÎ©îÏù∏</span>
          {Object.entries(DOMAINS).filter(([k]) => domainCounts[k] > 0).map(([key, d]) => (
            <button
              key={key}
              className={`tab ${domain === key ? 'active' : ''}`}
              style={{ '--tab-bg': d.color, '--tab-color': '#fff' }}
              onClick={() => { setDomain(key); setApi("all"); }}
            >
              {d.label}
              <span className="count">{domainCounts[key]}</span>
            </button>
          ))}
        </div>
        {API_ENDPOINTS[server] && (
          <div className="tabs-row">
            <span className="tabs-label">{server === 'health_db' ? 'Internal API' : 'API / Webhook'}</span>
            {Object.entries(API_ENDPOINTS[server]).map(([key, ep]) => (
              <button
                key={key}
                className={`tab ${api === key ? 'active' : ''}`}
                style={{ '--tab-bg': ep.color, '--tab-color': '#fff' }}
                onClick={() => { setApi(key); setDomain("all"); }}
              >
                {ep.label}
                {ep.tables && <span className="count">{ep.tables.length}</span>}
              </button>
            ))}
          </div>
        )}
      </div>

      <div
        className={`canvas-wrapper ${dragging ? 'dragging' : ''}`}
        onWheel={handleWheel}
        onMouseDown={handleMouseDown}
        onMouseMove={handleMouseMove}
        onMouseUp={handleMouseUp}
        onMouseLeave={handleMouseUp}
      >
        <div className="canvas" style={{ transform: `translate(${pan.x}px, ${pan.y}px) scale(${zoom})` }}>
          <svg className="relations-layer" width={maxX} height={maxY}>
            {visibleRelations.map((r, i) => {
              const fp = positions[r.from];
              const tp = positions[r.to];
              if (!fp || !tp) return null;

              const fromTable = TABLES.find(t => t.name === r.from);
              const fromColIdx = fromTable ? fromTable.cols.findIndex(c => c.n === r.fromCol) : 0;

              const fx = fp.x + fp.w;
              const fy = fp.y + 30 + fromColIdx * 20 + 10;
              const tx = tp.x;
              const ty = tp.y + 15;

              const midX = (fx + tx) / 2;
              const d = `M ${fx} ${fy} C ${midX} ${fy}, ${midX} ${ty}, ${tx} ${ty}`;

              const isHighlighted = activeTable && (r.from === activeTable || r.to === activeTable);

              return (
                <g key={i}>
                  <path d={d} className={`relation-path ${isHighlighted ? 'highlighted' : ''}`} />
                  <circle cx={tx} cy={ty} r={3} className={`relation-dot ${isHighlighted ? 'highlighted' : ''}`} />
                </g>
              );
            })}
          </svg>
          {domain === "all" && api === "all" && COL_HEADERS.map(h => (
            <div key={h.col} className="col-header" style={{ left: h.col * 250, borderColor: h.color, color: h.color }}>
              {h.label}
            </div>
          ))}
          {api !== "all" && API_ENDPOINTS[server] && API_ENDPOINTS[server][api] && (
            <div style={{
              position: 'absolute',
              top: -70,
              left: 0,
              background: '#151521f0',
              border: `2px solid ${API_ENDPOINTS[server][api].color}`,
              color: '#fff',
              padding: '12px 20px',
              borderRadius: 10,
              maxWidth: 500,
            }}>
              <div style={{ fontSize: 15, fontWeight: 600, marginBottom: 6, color: API_ENDPOINTS[server][api].color }}>
                {API_ENDPOINTS[server][api].method && API_ENDPOINTS[server][api].method !== 'WEBHOOK'
                  ? `${API_ENDPOINTS[server][api].method} ${API_ENDPOINTS[server][api].label.split(' ').slice(1).join(' ')}`
                  : API_ENDPOINTS[server][api].label
                }
              </div>
              <div style={{ fontSize: 12, color: '#94a3b8', lineHeight: 1.4 }}>
                {API_ENDPOINTS[server][api].desc}
              </div>
            </div>
          )}
          {visible.map(t => (
            <TableCard key={t.name} table={t} pos={positions[t.name]} hovered={hovered} selected={selected} onHover={setHovered} onClick={setSelected} />
          ))}
        </div>
      </div>

      <div className="legend">
        <div className="legend-title">Î≤îÎ°Ä</div>
        <div className="legend-item"><span className="legend-icon" style={{color:'#fbbf24'}}>üîë</span> Primary Key</div>
        <div className="legend-item"><span className="legend-icon" style={{color:'#60a5fa'}}>‚Üí</span> Foreign Key</div>
        <div className="legend-item"><span className="legend-icon" style={{color:'#a78bfa'}}>‚ñ†</span> Core (health_db)</div>
        <div className="legend-item"><span className="legend-icon" style={{color:'#34d399'}}>‚ñ†</span> Business (uniqdata_db)</div>
      </div>

      {selected && (() => {
        const t = TABLES.find(t => t.name === selected);
        if (!t) return null;
        const d = DOMAINS[t.domain];
        const rels = RELATIONS.filter(r => r.from === t.name || r.to === t.name);
        return (
          <div className="detail-panel">
            <div className="detail-header">
              <span className="detail-name" style={{color: d.color}}>{t.name}</span>
              <span className="detail-badge" style={{background: d.color}}>{d.label}</span>
              <span className={`server-badge ${t.server === 'health_db' ? 'server-core' : 'server-biz'}`}>
                {t.server === 'health_db' ? 'health_db' : 'uniqdata_db'}
              </span>
            </div>
            <div className="detail-stats">{t.cols.length} columns ¬∑ {rels.length} relations</div>
            {rels.length > 0 && (
              <div className="detail-relations">
                {rels.slice(0, 6).map((r, i) => (
                  <div key={i} className="detail-rel">
                    {r.from === t.name ? `‚Üí ${r.to}` : `‚Üê ${r.from}`}
                  </div>
                ))}
                {rels.length > 6 && <div className="detail-rel" style={{color:'#475569'}}>+{rels.length - 6} more</div>}
              </div>
            )}
            <div className="detail-close" onClick={() => setSelected(null)}>ÌÅ¥Î¶≠ÌïòÏó¨ Îã´Í∏∞</div>
          </div>
        );
      })()}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('app')).render(<App />);
  </script>
</body>
</html>
