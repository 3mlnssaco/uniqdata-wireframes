<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UniQData ERD v4</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', -apple-system, sans-serif; background: #0a0a12; color: #e2e8f0; overflow: hidden; }
    .app { display: flex; flex-direction: column; height: 100vh; }

    .header {
      padding: 14px 24px;
      background: linear-gradient(180deg, #0f0f1a 0%, #0a0a12 100%);
      border-bottom: 1px solid #1e293b;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }
    .logo { font-size: 20px; font-weight: 700; letter-spacing: -0.5px; }
    .logo .primary { color: #818cf8; }
    .logo .secondary { color: #64748b; }
    .header-stats { font-size: 12px; color: #64748b; margin-left: 16px; }

    .zoom-controls { display: flex; align-items: center; gap: 8px; }
    .zoom-btn {
      width: 32px; height: 32px; border-radius: 8px; border: 1px solid #334155;
      background: #1e293b; color: #94a3b8; font-size: 16px; cursor: pointer;
      display: flex; align-items: center; justify-content: center; transition: all 0.15s;
    }
    .zoom-btn:hover { background: #334155; color: #fff; }
    .zoom-level { font-size: 12px; color: #64748b; width: 44px; text-align: center; }

    /* Two-row tabs */
    .tabs-wrapper {
      background: #0f0f1a;
      border-bottom: 1px solid #1e293b;
      padding: 0 24px;
      flex-shrink: 0;
    }
    .tabs-row {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 10px 0;
    }
    .tabs-row:first-child { border-bottom: 1px solid #1e293b20; }
    .tabs-label {
      font-size: 11px;
      color: #475569;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-right: 8px;
      min-width: 60px;
    }
    .tab {
      padding: 7px 14px;
      border-radius: 8px;
      border: 1px solid transparent;
      background: transparent;
      color: #64748b;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .tab:hover { background: #1e293b; color: #94a3b8; }
    .tab.active {
      background: var(--tab-bg, #334155);
      color: var(--tab-color, #fff);
      border-color: var(--tab-border, transparent);
    }
    .tab .icon { font-size: 14px; }
    .tab .count {
      font-size: 10px;
      background: rgba(255,255,255,0.15);
      padding: 2px 6px;
      border-radius: 10px;
    }

    /* Canvas */
    .canvas-wrapper {
      flex: 1;
      overflow: hidden;
      position: relative;
      cursor: grab;
    }
    .canvas-wrapper.dragging { cursor: grabbing; }
    .canvas-wrapper::before {
      content: '';
      position: absolute;
      inset: 0;
      background-image: radial-gradient(circle, #1e293b 1px, transparent 1px);
      background-size: 24px 24px;
      pointer-events: none;
    }
    .canvas {
      position: absolute;
      top: 0;
      left: 0;
      transform-origin: 0 0;
    }

    /* Table Card */
    .table-card {
      position: absolute;
      background: #151521;
      border: 1px solid #2a2a3e;
      border-radius: 12px;
      overflow: hidden;
      transition: box-shadow 0.2s, border-color 0.2s, transform 0.2s;
      cursor: pointer;
    }
    .table-card:hover {
      border-color: #4f46e5;
      box-shadow: 0 0 0 1px #4f46e5, 0 8px 24px rgba(0,0,0,0.4);
      transform: translateY(-2px);
    }
    .table-card.highlighted {
      border-color: #60a5fa;
      box-shadow: 0 0 0 2px #60a5fa40;
    }
    .table-card.ghost { opacity: 0.6; }
    .table-card.ghost:hover { opacity: 1; }

    .table-header {
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .table-name {
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      font-weight: 600;
      color: #fff;
    }
    .table-meta { font-size: 10px; color: rgba(255,255,255,0.5); }

    .table-cols { padding: 6px 0; }
    .col-row {
      padding: 5px 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
    }
    .col-row:hover { background: #1e1e2e; }
    .col-icon { width: 14px; font-size: 10px; flex-shrink: 0; }
    .col-icon.pk { color: #fbbf24; }
    .col-icon.fk { color: #60a5fa; }
    .col-name { font-family: 'JetBrains Mono', monospace; flex: 1; }
    .col-name.pk { color: #fbbf24; }
    .col-name.fk { color: #60a5fa; }
    .col-name.normal { color: #94a3b8; }
    .col-type { font-family: 'JetBrains Mono', monospace; font-size: 10px; color: #475569; }
    .table-more { padding: 6px 16px; font-size: 10px; color: #475569; border-top: 1px solid #1e293b; }

    /* Relations */
    .relations-layer { position: absolute; top: 0; left: 0; pointer-events: none; overflow: visible; }
    .relation-path { fill: none; stroke: #334155; stroke-width: 1.5; opacity: 0.4; }
    .relation-path.highlighted { stroke: #60a5fa; stroke-width: 2; opacity: 1; }
    .relation-dot { fill: #334155; opacity: 0.4; }
    .relation-dot.highlighted { fill: #60a5fa; opacity: 1; }

    /* Column Headers */
    .col-header {
      position: absolute;
      top: -40px;
      width: 200px;
      text-align: center;
      font-size: 11px;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 6px 0;
      border-bottom: 2px solid;
    }

    /* Info Panels */
    .legend {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: #151521f0;
      backdrop-filter: blur(12px);
      border: 1px solid #2a2a3e;
      border-radius: 12px;
      padding: 14px 18px;
      font-size: 11px;
      z-index: 100;
    }
    .legend-title { font-weight: 600; margin-bottom: 10px; color: #94a3b8; font-size: 12px; }
    .legend-item { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; color: #64748b; }
    .legend-icon { width: 14px; text-align: center; }

    .detail-panel {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #151521f0;
      backdrop-filter: blur(12px);
      border: 1px solid #2a2a3e;
      border-radius: 14px;
      padding: 18px 20px;
      min-width: 280px;
      max-width: 340px;
      z-index: 100;
    }
    .detail-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    .detail-name { font-family: 'JetBrains Mono', monospace; font-size: 15px; font-weight: 600; }
    .detail-badge { font-size: 10px; padding: 3px 8px; border-radius: 10px; color: #fff; }
    .detail-stats { font-size: 12px; color: #64748b; margin-bottom: 12px; }
    .detail-relations { display: flex; flex-direction: column; gap: 4px; }
    .detail-rel {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: #60a5fa;
      padding: 5px 10px;
      background: #1e293b;
      border-radius: 6px;
    }
    .detail-close { margin-top: 12px; font-size: 10px; color: #475569; cursor: pointer; }
    .detail-close:hover { color: #94a3b8; }

    /* Client badge colors */
    .client-all { --c: #64748b; }
    .client-enterprise { --c: #8b5cf6; }
    .client-userapp { --c: #10b981; }
    .client-bodab { --c: #f59e0b; }
  </style>
</head>
<body>
  <div class="app" id="app"></div>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script type="text/babel">
const { useState, useEffect, useCallback, useRef } = React;

// ============================================================
// DATA DEFINITIONS
// ============================================================

const CLIENTS = {
  all: { label: "Ï†ÑÏ≤¥ UniQData", icon: "üóÑÔ∏è", color: "#64748b", desc: "40 tables" },
  enterprise: { label: "Enterprise Portal", icon: "üè¢", color: "#8b5cf6", desc: "Ïó∞Íµ¨Ïûê Ïõπ" },
  userapp: { label: "User App", icon: "üì±", color: "#10b981", desc: "Í∞úÏù∏ Ïï±" },
  bodab: { label: "Î≥¥Îãµ", icon: "üë¥", color: "#f59e0b", desc: "ÎÖ∏Ïù∏ÏºÄÏñ¥" },
};

const DOMAINS = {
  all: { label: "Ï†ÑÏ≤¥", color: "#64748b" },
  core: { label: "Core Auth", color: "#818cf8" },
  wallet: { label: "Wallet", color: "#f59e0b" },
  org: { label: "Organization", color: "#10b981" },
  app: { label: "App & Session", color: "#3b82f6" },
  data: { label: "Data", color: "#a855f7" },
  research: { label: "Research", color: "#ec4899" },
  finance: { label: "Finance", color: "#f97316" },
  medication: { label: "Medication", color: "#14b8a6" },
  analytics: { label: "AI & Audit", color: "#6366f1" },
};

// Client ‚Üí Table mapping
const CLIENT_TABLES = {
  all: null, // null = all tables
  enterprise: [
    "accounts", "account_logins", "owners", "users",
    "institutions", "workspaces", "workspace_members",
    "apps", "app_keys", "sessions", "passkey_credentials",
    "research_projects", "participation_criteria", "data_collection_configs", "team_members", "agreements",
    "project_wallets", "project_wallet_deposits", "project_wallet_withdrawals", "escrows", "settlements",
    "data_accesses", "consents",
    "audit_logs", "anchor_logs"
  ],
  userapp: [
    "accounts", "account_logins", "owners", "users",
    "wallets", "wallet_secrets", "wallet_credential_bindings", "wallet_recovery_requests",
    "passkey_credentials", "sessions", "refresh_tokens",
    "data_points", "data_sources", "data_attachments", "consents",
    "agreements",
    "ai_analyses", "features", "notifications",
    "audit_logs", "anchor_logs"
  ],
  bodab: [
    "accounts", "account_logins", "owners", "users",
    "wallets", "wallet_secrets", "passkey_credentials",
    "data_points", "data_sources", "consents",
    "user_medications", "medication_logs", "medication_proofs", "drug_info_cache",
    "ai_analyses", "notifications",
    "audit_logs", "anchor_logs"
  ],
};

const TABLES = [
  // Core Auth
  { name: "accounts", domain: "core", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "type", t: "enum" }, { n: "status", t: "enum" },
    { n: "identity_hash", t: "varchar" }, { n: "kyc_verified_at", t: "ts" }, { n: "created_at", t: "ts" }
  ]},
  { name: "account_logins", domain: "core", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "account_id", t: "uuid", fk: "accounts" },
    { n: "provider", t: "enum" }, { n: "email", t: "varchar" }, { n: "phone", t: "varchar" }
  ]},
  { name: "owners", domain: "core", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "account_id", t: "uuid", fk: "accounts" }, { n: "created_at", t: "ts" }
  ]},
  { name: "users", domain: "core", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "account_id", t: "uuid", fk: "accounts" },
    { n: "name", t: "varchar" }, { n: "birth_date", t: "date" }, { n: "gender", t: "varchar" }
  ]},
  // Wallet
  { name: "wallets", domain: "wallet", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "owner_id", t: "uuid", fk: "owners" },
    { n: "address", t: "varchar" }, { n: "wallet_type", t: "enum" }, { n: "status", t: "enum" }
  ]},
  { name: "wallet_secrets", domain: "wallet", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "wallet_id", t: "uuid", fk: "wallets" },
    { n: "encrypted_seed_prf", t: "bytea" }, { n: "prf_salt", t: "bytea" }
  ]},
  { name: "wallet_credential_bindings", domain: "wallet", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "wallet_id", t: "uuid", fk: "wallets" },
    { n: "credential_id", t: "uuid", fk: "passkey_credentials" }, { n: "xrpl_tx_hash", t: "varchar" }
  ]},
  { name: "wallet_recovery_requests", domain: "wallet", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "wallet_id", t: "uuid", fk: "wallets" },
    { n: "owner_id", t: "uuid", fk: "owners" }, { n: "status", t: "enum" }
  ]},
  // App
  { name: "apps", domain: "app", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "slug", t: "varchar" }, { n: "name", t: "varchar" },
    { n: "allowed_scopes", t: "text" }, { n: "status", t: "enum" }
  ]},
  { name: "app_keys", domain: "app", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "app_id", t: "uuid", fk: "apps" },
    { n: "key_type", t: "enum" }, { n: "key_hash", t: "varchar" }, { n: "status", t: "enum" }
  ]},
  { name: "sessions", domain: "app", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "user_id", t: "uuid", fk: "users" },
    { n: "app_id", t: "uuid", fk: "apps" }, { n: "started_at", t: "ts" }
  ]},
  { name: "refresh_tokens", domain: "app", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "user_id", t: "uuid", fk: "users" },
    { n: "session_id", t: "uuid", fk: "sessions" }, { n: "expires_at", t: "ts" }
  ]},
  { name: "passkey_credentials", domain: "app", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "user_id", t: "uuid", fk: "users" },
    { n: "credential_id", t: "varchar" }, { n: "public_key", t: "text" }, { n: "counter", t: "int" }
  ]},
  // Org
  { name: "institutions", domain: "org", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "name", t: "varchar" }, { n: "type", t: "enum" },
    { n: "domains", t: "text" }, { n: "status", t: "enum" }
  ]},
  { name: "workspaces", domain: "org", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "name", t: "varchar" }, { n: "type", t: "enum" },
    { n: "institution_id", t: "uuid", fk: "institutions" }, { n: "max_members", t: "int" }
  ]},
  { name: "workspace_members", domain: "org", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "workspace_id", t: "uuid", fk: "workspaces" },
    { n: "account_id", t: "uuid", fk: "accounts" }, { n: "role", t: "enum" }
  ]},
  // Data
  { name: "data_points", domain: "data", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "user_id", t: "uuid", fk: "users" },
    { n: "category", t: "varchar" }, { n: "metric", t: "varchar" }, { n: "value", t: "jsonb" }
  ]},
  { name: "data_attachments", domain: "data", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "data_point_id", t: "uuid", fk: "data_points" },
    { n: "storage_key", t: "varchar" }, { n: "file_name", t: "varchar" }
  ]},
  { name: "data_sources", domain: "data", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "user_id", t: "uuid", fk: "users" },
    { n: "name", t: "varchar" }, { n: "type", t: "varchar" }, { n: "is_active", t: "bool" }
  ]},
  { name: "data_accesses", domain: "data", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "workspace_id", t: "uuid", fk: "workspaces" },
    { n: "account_id", t: "uuid", fk: "accounts" }, { n: "status", t: "enum" }
  ]},
  { name: "consents", domain: "data", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "user_id", t: "uuid", fk: "users" },
    { n: "app_id", t: "uuid", fk: "apps" }, { n: "scopes", t: "text" }, { n: "status", t: "enum" }
  ]},
  // Research
  { name: "research_projects", domain: "research", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "owner_id", t: "uuid", fk: "owners" },
    { n: "institution_id", t: "uuid", fk: "institutions" }, { n: "title", t: "varchar" }, { n: "status", t: "enum" }
  ]},
  { name: "participation_criteria", domain: "research", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "project_id", t: "uuid", fk: "research_projects" },
    { n: "age_min", t: "int" }, { n: "age_max", t: "int" }, { n: "conditions", t: "jsonb" }
  ]},
  { name: "data_collection_configs", domain: "research", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "project_id", t: "uuid", fk: "research_projects" },
    { n: "passive_data", t: "jsonb" }, { n: "active_data", t: "jsonb" }
  ]},
  { name: "team_members", domain: "research", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "project_id", t: "uuid", fk: "research_projects" },
    { n: "owner_id", t: "uuid", fk: "owners" }, { n: "role", t: "enum" }
  ]},
  { name: "agreements", domain: "research", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "project_id", t: "uuid", fk: "research_projects" },
    { n: "owner_id", t: "uuid", fk: "owners" }, { n: "status", t: "enum" }
  ]},
  // Finance
  { name: "project_wallets", domain: "finance", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "project_id", t: "uuid", fk: "research_projects" },
    { n: "wallet_address", t: "varchar" }, { n: "total_deposited", t: "decimal" }
  ]},
  { name: "project_wallet_deposits", domain: "finance", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "project_id", t: "uuid", fk: "research_projects" },
    { n: "depositor_owner_id", t: "uuid", fk: "owners" }, { n: "amount", t: "decimal" }
  ]},
  { name: "project_wallet_withdrawals", domain: "finance", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "project_id", t: "uuid", fk: "research_projects" },
    { n: "withdrawer_owner_id", t: "uuid", fk: "owners" }, { n: "amount", t: "decimal" }
  ]},
  { name: "escrows", domain: "finance", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "project_id", t: "uuid", fk: "research_projects" },
    { n: "amount", t: "decimal" }, { n: "tx_hash", t: "varchar" }, { n: "status", t: "enum" }
  ]},
  { name: "settlements", domain: "finance", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "agreement_id", t: "uuid", fk: "agreements" },
    { n: "amount", t: "decimal" }, { n: "tx_hash", t: "varchar" }
  ]},
  // Medication
  { name: "drug_info_cache", domain: "medication", cols: [
    { n: "drug_code", t: "varchar", pk: true }, { n: "name", t: "varchar" },
    { n: "category", t: "varchar" }, { n: "ingredients", t: "jsonb" }
  ]},
  { name: "user_medications", domain: "medication", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "user_id", t: "uuid", fk: "users" },
    { n: "name_encrypted", t: "text" }, { n: "category_hash", t: "varchar" }, { n: "is_active", t: "bool" }
  ]},
  { name: "medication_logs", domain: "medication", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "user_id", t: "uuid", fk: "users" },
    { n: "medication_id", t: "uuid", fk: "user_medications" }, { n: "taken", t: "bool" }
  ]},
  { name: "medication_proofs", domain: "medication", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "user_id", t: "uuid", fk: "users" },
    { n: "proof_type", t: "varchar" }, { n: "commitment", t: "bytea" }
  ]},
  // Analytics
  { name: "ai_analyses", domain: "analytics", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "user_id", t: "uuid", fk: "users" },
    { n: "project_id", t: "uuid", fk: "research_projects" }, { n: "app_id", t: "uuid", fk: "apps" },
    { n: "type", t: "varchar" }, { n: "status", t: "enum" }, { n: "result", t: "jsonb" }
  ]},
  { name: "features", domain: "analytics", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "user_id", t: "uuid", fk: "users" },
    { n: "project_id", t: "uuid", fk: "research_projects" },
    { n: "category", t: "varchar" }, { n: "feature_type", t: "varchar" }
  ]},
  { name: "notifications", domain: "analytics", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "user_id", t: "uuid", fk: "users" },
    { n: "app_id", t: "uuid", fk: "apps" }, { n: "type", t: "varchar" }
  ]},
  { name: "audit_logs", domain: "analytics", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "user_id", t: "uuid", fk: "users" },
    { n: "app_id", t: "uuid", fk: "apps" }, { n: "action", t: "varchar" }
  ]},
  { name: "anchor_logs", domain: "analytics", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "user_id", t: "uuid", fk: "users" },
    { n: "anchor_type", t: "enum" }, { n: "tx_hash", t: "varchar" }
  ]},
];

// Build relations
const RELATIONS = [];
TABLES.forEach(t => {
  t.cols.forEach(c => {
    if (c.fk) RELATIONS.push({ from: t.name, fromCol: c.n, to: c.fk, toCol: "id" });
  });
});

// ============================================================
// LAYOUT - Tree structure from accounts
// ============================================================

// Clean grouped layout by functional area
const AREA_LAYOUT = {
  // === AUTH (col 0) ===
  accounts:        { col: 0, row: 0 },
  account_logins:  { col: 0, row: 1 },
  owners:          { col: 0, row: 2 },
  users:           { col: 0, row: 3 },

  // === WALLET (col 1) ===
  wallets:                     { col: 1, row: 0 },
  wallet_secrets:              { col: 1, row: 1 },
  wallet_credential_bindings:  { col: 1, row: 2 },
  wallet_recovery_requests:    { col: 1, row: 3 },

  // === APP & SESSION (col 2) ===
  apps:                 { col: 2, row: 0 },
  app_keys:             { col: 2, row: 1 },
  passkey_credentials:  { col: 2, row: 2 },
  sessions:             { col: 2, row: 3 },
  refresh_tokens:       { col: 2, row: 4 },

  // === ORG (col 3) ===
  institutions:       { col: 3, row: 0 },
  workspaces:         { col: 3, row: 1 },
  workspace_members:  { col: 3, row: 2 },
  data_accesses:      { col: 3, row: 3 },

  // === RESEARCH (col 4) ===
  research_projects:       { col: 4, row: 0 },
  participation_criteria:  { col: 4, row: 1 },
  data_collection_configs: { col: 4, row: 2 },
  team_members:            { col: 4, row: 3 },
  agreements:              { col: 4, row: 4 },

  // === FINANCE (col 5) ===
  project_wallets:            { col: 5, row: 0 },
  project_wallet_deposits:    { col: 5, row: 1 },
  project_wallet_withdrawals: { col: 5, row: 2 },
  escrows:                    { col: 5, row: 3 },
  settlements:                { col: 5, row: 4 },

  // === DATA (col 6) ===
  data_sources:      { col: 6, row: 0 },
  data_points:       { col: 6, row: 1 },
  data_attachments:  { col: 6, row: 2 },
  consents:          { col: 6, row: 3 },

  // === MEDICATION (col 7) ===
  drug_info_cache:    { col: 7, row: 0 },
  user_medications:   { col: 7, row: 1 },
  medication_logs:    { col: 7, row: 2 },
  medication_proofs:  { col: 7, row: 3 },

  // === ANALYTICS (col 8) ===
  ai_analyses:    { col: 8, row: 0 },
  features:       { col: 8, row: 1 },
  notifications:  { col: 8, row: 2 },
  audit_logs:     { col: 8, row: 3 },
  anchor_logs:    { col: 8, row: 4 },
};

function calculateLayout(client, domain) {
  let clientTables = CLIENT_TABLES[client];
  let tables = clientTables ? TABLES.filter(t => clientTables.includes(t.name)) : TABLES;

  const visible = domain === "all"
    ? tables
    : tables.filter(t => {
        if (t.domain === domain) return true;
        const domainTables = tables.filter(tt => tt.domain === domain);
        for (const dt of domainTables) {
          for (const c of dt.cols) {
            if (c.fk === t.name && tables.some(x => x.name === t.name)) return true;
          }
        }
        return false;
      });

  const positions = {};
  const CARD_W = 200;
  const ROW_H = 22;
  const HEADER_H = 32;
  const COL_WIDTH = 240;
  const ROW_HEIGHT = 160;

  if (domain === "all") {
    visible.forEach(t => {
      const pos = AREA_LAYOUT[t.name] || { row: 5, col: 4 };
      const h = HEADER_H + t.cols.length * ROW_H + 6;
      positions[t.name] = {
        x: pos.col * COL_WIDTH,
        y: pos.row * ROW_HEIGHT,
        w: CARD_W,
        h,
        ghost: false
      };
    });
  } else {
    // Domain view - primary on right, refs on left
    const primary = visible.filter(t => t.domain === domain);
    const refs = visible.filter(t => t.domain !== domain);

    let primaryY = 0;
    primary.forEach(t => {
      const h = HEADER_H + t.cols.length * ROW_H + 6;
      positions[t.name] = { x: 280, y: primaryY, w: CARD_W, h, ghost: false };
      primaryY += h + 30;
    });

    let refY = 0;
    refs.forEach(t => {
      const h = HEADER_H + Math.min(t.cols.length, 4) * ROW_H + 6;
      positions[t.name] = { x: 0, y: refY, w: 180, h, ghost: true };
      refY += h + 20;
    });
  }

  return { visible, positions };
}

// ============================================================
// COMPONENTS
// ============================================================

function TableCard({ table, pos, hovered, selected, onHover, onClick }) {
  const domain = DOMAINS[table.domain];
  const maxCols = pos.ghost ? 4 : table.cols.length;
  const visibleCols = table.cols.slice(0, maxCols);
  const isHighlighted = hovered === table.name || selected === table.name;

  return (
    <div
      className={`table-card ${isHighlighted ? 'highlighted' : ''} ${pos.ghost ? 'ghost' : ''}`}
      style={{ left: pos.x, top: pos.y, width: pos.w }}
      onMouseEnter={() => onHover(table.name)}
      onMouseLeave={() => onHover(null)}
      onClick={() => onClick(table.name)}
    >
      <div className="table-header" style={{ background: domain.color }}>
        <span className="table-name">{pos.ghost ? `‚Üó ${table.name}` : table.name}</span>
        <span className="table-meta">{table.cols.length} cols</span>
      </div>
      <div className="table-cols">
        {visibleCols.map(col => (
          <div key={col.n} className="col-row">
            <span className={`col-icon ${col.pk ? 'pk' : col.fk ? 'fk' : ''}`}>
              {col.pk ? 'üîë' : col.fk ? '‚Üí' : ''}
            </span>
            <span className={`col-name ${col.pk ? 'pk' : col.fk ? 'fk' : 'normal'}`}>{col.n}</span>
            <span className="col-type">{col.t}</span>
          </div>
        ))}
      </div>
      {pos.ghost && table.cols.length > 4 && (
        <div className="table-more">+{table.cols.length - 4} more</div>
      )}
    </div>
  );
}

function App() {
  const [client, setClient] = useState("all");
  const [domain, setDomain] = useState("all");
  const [hovered, setHovered] = useState(null);
  const [selected, setSelected] = useState(null);
  const [zoom, setZoom] = useState(0.85);
  const [pan, setPan] = useState({ x: 50, y: 40 });
  const [dragging, setDragging] = useState(false);
  const [dragStart, setDragStart] = useState({ x: 0, y: 0 });

  const { visible, positions } = calculateLayout(client, domain);

  // Count tables per domain for current client
  const domainCounts = {};
  const clientTables = CLIENT_TABLES[client];
  const filteredTables = clientTables ? TABLES.filter(t => clientTables.includes(t.name)) : TABLES;
  Object.keys(DOMAINS).forEach(d => {
    domainCounts[d] = d === "all" ? filteredTables.length : filteredTables.filter(t => t.domain === d).length;
  });

  const activeTable = hovered || selected;
  const relatedTables = new Set();
  if (activeTable) {
    RELATIONS.forEach(r => {
      if (r.from === activeTable) relatedTables.add(r.to);
      if (r.to === activeTable) relatedTables.add(r.from);
    });
  }

  const visibleRelations = RELATIONS.filter(r =>
    visible.some(t => t.name === r.from) && visible.some(t => t.name === r.to)
  );

  useEffect(() => {
    const isAll = client === "all" && domain === "all";
    setZoom(isAll ? 0.65 : 0.9);
    setPan(isAll ? { x: 30, y: 30 } : { x: 50, y: 40 });
    setSelected(null);
  }, [client, domain]);

  const handleWheel = useCallback(e => {
    e.preventDefault();
    setZoom(z => Math.max(0.3, Math.min(2, z + (e.deltaY > 0 ? -0.05 : 0.05))));
  }, []);

  const handleMouseDown = e => {
    if (e.target.closest('.table-card')) return;
    setDragging(true);
    setDragStart({ x: e.clientX - pan.x, y: e.clientY - pan.y });
  };
  const handleMouseMove = e => {
    if (dragging) setPan({ x: e.clientX - dragStart.x, y: e.clientY - dragStart.y });
  };
  const handleMouseUp = () => setDragging(false);

  let maxX = 1200, maxY = 800;
  Object.values(positions).forEach(p => {
    if (p.x !== undefined) {
      maxX = Math.max(maxX, p.x + p.w + 100);
      maxY = Math.max(maxY, p.y + p.h + 100);
    }
  });

  return (
    <div className="app">
      <div className="header">
        <div style={{ display: 'flex', alignItems: 'center' }}>
          <div className="logo">
            <span className="primary">UniQ</span>
            <span className="secondary">Data</span>
          </div>
          <span className="header-stats">ERD v4 ¬∑ {visible.length} tables</span>
        </div>
        <div className="zoom-controls">
          <button className="zoom-btn" onClick={() => setZoom(z => Math.max(0.3, z - 0.1))}>‚àí</button>
          <span className="zoom-level">{Math.round(zoom * 100)}%</span>
          <button className="zoom-btn" onClick={() => setZoom(z => Math.min(2, z + 0.1))}>+</button>
        </div>
      </div>

      <div className="tabs-wrapper">
        <div className="tabs-row">
          <span className="tabs-label">ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏</span>
          {Object.entries(CLIENTS).map(([key, c]) => (
            <button
              key={key}
              className={`tab ${client === key ? 'active' : ''}`}
              style={{ '--tab-bg': c.color, '--tab-color': '#fff' }}
              onClick={() => { setClient(key); setDomain("all"); }}
            >
              <span className="icon">{c.icon}</span>
              {c.label}
            </button>
          ))}
        </div>
        <div className="tabs-row">
          <span className="tabs-label">ÎèÑÎ©îÏù∏</span>
          {Object.entries(DOMAINS).filter(([k]) => domainCounts[k] > 0).map(([key, d]) => (
            <button
              key={key}
              className={`tab ${domain === key ? 'active' : ''}`}
              style={{ '--tab-bg': d.color, '--tab-color': '#fff' }}
              onClick={() => setDomain(key)}
            >
              {d.label}
              <span className="count">{domainCounts[key]}</span>
            </button>
          ))}
        </div>
      </div>

      <div
        className={`canvas-wrapper ${dragging ? 'dragging' : ''}`}
        onWheel={handleWheel}
        onMouseDown={handleMouseDown}
        onMouseMove={handleMouseMove}
        onMouseUp={handleMouseUp}
        onMouseLeave={handleMouseUp}
      >
        <div className="canvas" style={{ transform: `translate(${pan.x}px, ${pan.y}px) scale(${zoom})` }}>
          <svg className="relations-layer" width={maxX} height={maxY}>
            {visibleRelations.map((r, i) => {
              const fp = positions[r.from];
              const tp = positions[r.to];
              if (!fp || !tp) return null;

              const fromTable = TABLES.find(t => t.name === r.from);
              const fromColIdx = fromTable ? fromTable.cols.findIndex(c => c.n === r.fromCol) : 0;

              // Simple: from right edge of FK row to left edge of target header
              const fx = fp.x + fp.w;
              const fy = fp.y + 32 + fromColIdx * 22 + 11;
              const tx = tp.x;
              const ty = tp.y + 16;

              // Simple bezier curve
              const midX = (fx + tx) / 2;
              const d = `M ${fx} ${fy} C ${midX} ${fy}, ${midX} ${ty}, ${tx} ${ty}`;

              const isHighlighted = activeTable && (r.from === activeTable || r.to === activeTable);

              return (
                <g key={i}>
                  <path d={d} className={`relation-path ${isHighlighted ? 'highlighted' : ''}`} />
                  <circle cx={tx} cy={ty} r={3} className={`relation-dot ${isHighlighted ? 'highlighted' : ''}`} />
                </g>
              );
            })}
          </svg>
          {domain === "all" && [
            { col: 0, label: "Auth", color: "#818cf8" },
            { col: 1, label: "Wallet", color: "#f59e0b" },
            { col: 2, label: "App", color: "#3b82f6" },
            { col: 3, label: "Org", color: "#10b981" },
            { col: 4, label: "Research", color: "#ec4899" },
            { col: 5, label: "Finance", color: "#f97316" },
            { col: 6, label: "Data", color: "#a855f7" },
            { col: 7, label: "Medication", color: "#14b8a6" },
            { col: 8, label: "Analytics", color: "#6366f1" },
          ].map(h => (
            <div key={h.col} className="col-header" style={{ left: h.col * 240, borderColor: h.color, color: h.color }}>
              {h.label}
            </div>
          ))}
          {visible.map(t => (
            <TableCard key={t.name} table={t} pos={positions[t.name]} hovered={hovered} selected={selected} onHover={setHovered} onClick={setSelected} />
          ))}
        </div>
      </div>

      <div className="legend">
        <div className="legend-title">Î≤îÎ°Ä</div>
        <div className="legend-item"><span className="legend-icon" style={{color:'#fbbf24'}}>üîë</span> Primary Key</div>
        <div className="legend-item"><span className="legend-icon" style={{color:'#60a5fa'}}>‚Üí</span> Foreign Key</div>
      </div>

      {selected && (() => {
        const t = TABLES.find(t => t.name === selected);
        if (!t) return null;
        const d = DOMAINS[t.domain];
        const rels = RELATIONS.filter(r => r.from === t.name || r.to === t.name);
        return (
          <div className="detail-panel">
            <div className="detail-header">
              <span className="detail-name" style={{color: d.color}}>{t.name}</span>
              <span className="detail-badge" style={{background: d.color}}>{d.label}</span>
            </div>
            <div className="detail-stats">{t.cols.length} columns ¬∑ {rels.length} relations</div>
            {rels.length > 0 && (
              <div className="detail-relations">
                {rels.slice(0, 6).map((r, i) => (
                  <div key={i} className="detail-rel">
                    {r.from === t.name ? `‚Üí ${r.to}` : `‚Üê ${r.from}`}
                  </div>
                ))}
                {rels.length > 6 && <div className="detail-rel" style={{color:'#475569'}}>+{rels.length - 6} more</div>}
              </div>
            )}
            <div className="detail-close" onClick={() => setSelected(null)}>ÌÅ¥Î¶≠ÌïòÏó¨ Îã´Í∏∞</div>
          </div>
        );
      })()}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('app')).render(<App />);
  </script>
</body>
</html>
