<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UniQData ERD v4</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', -apple-system, sans-serif; background: #0a0a12; color: #e2e8f0; overflow: hidden; }
    .app { display: flex; flex-direction: column; height: 100vh; }

    .header {
      padding: 14px 24px;
      background: linear-gradient(180deg, #0f0f1a 0%, #0a0a12 100%);
      border-bottom: 1px solid #1e293b;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }
    .logo { font-size: 20px; font-weight: 700; letter-spacing: -0.5px; }
    .logo .primary { color: #818cf8; }
    .logo .secondary { color: #64748b; }
    .header-stats { font-size: 12px; color: #64748b; margin-left: 16px; }

    .zoom-controls { display: flex; align-items: center; gap: 8px; }
    .zoom-btn {
      width: 32px; height: 32px; border-radius: 8px; border: 1px solid #334155;
      background: #1e293b; color: #94a3b8; font-size: 16px; cursor: pointer;
      display: flex; align-items: center; justify-content: center; transition: all 0.15s;
    }
    .zoom-btn:hover { background: #334155; color: #fff; }
    .zoom-level { font-size: 12px; color: #64748b; width: 44px; text-align: center; }

    /* Two-row tabs */
    .tabs-wrapper {
      background: #0f0f1a;
      border-bottom: 1px solid #1e293b;
      padding: 0 24px;
      flex-shrink: 0;
    }
    .tabs-row {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 10px 0;
      overflow-x: auto;
      scrollbar-width: thin;
      scrollbar-color: #334155 transparent;
    }
    .tabs-row::-webkit-scrollbar { height: 4px; }
    .tabs-row::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }
    .tabs-row:first-child { border-bottom: 1px solid #1e293b20; }
    .tabs-label {
      font-size: 11px;
      color: #475569;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-right: 8px;
      min-width: 60px;
    }
    .tab {
      padding: 7px 14px;
      border-radius: 8px;
      border: 1px solid transparent;
      background: transparent;
      color: #64748b;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .tab:hover { background: #1e293b; color: #94a3b8; }
    .tab.active {
      background: var(--tab-bg, #334155);
      color: var(--tab-color, #fff);
      border-color: var(--tab-border, transparent);
    }
    .tab .icon { font-size: 14px; }
    .tab .count {
      font-size: 10px;
      background: rgba(255,255,255,0.15);
      padding: 2px 6px;
      border-radius: 10px;
    }

    /* Canvas */
    .canvas-wrapper {
      flex: 1;
      overflow: hidden;
      position: relative;
      cursor: grab;
    }
    .canvas-wrapper.dragging { cursor: grabbing; }
    .canvas-wrapper::before {
      content: '';
      position: absolute;
      inset: 0;
      background-image: radial-gradient(circle, #1e293b 1px, transparent 1px);
      background-size: 24px 24px;
      pointer-events: none;
    }
    .canvas {
      position: absolute;
      top: 0;
      left: 0;
      transform-origin: 0 0;
    }

    /* Table Card */
    .table-card {
      position: absolute;
      background: #12121a;
      border: 1px solid #252535;
      border-radius: 8px;
      overflow: hidden;
      transition: box-shadow 0.15s, border-color 0.15s;
      cursor: pointer;
    }
    .table-card:hover {
      border-color: #3b3b55;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .table-card.highlighted {
      border-color: #60a5fa;
      box-shadow: 0 0 0 1px #60a5fa50;
    }
    .table-card.ghost { opacity: 0.5; }
    .table-card.ghost:hover { opacity: 0.8; }

    .table-header {
      padding: 8px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .table-name {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      font-weight: 600;
      color: #fff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .table-meta { font-size: 10px; color: rgba(255,255,255,0.6); }

    .table-cols { padding: 6px 0; }
    .col-row {
      padding: 4px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
    }
    .col-row:hover { background: #1e1e2e; }
    .col-icon { width: 16px; font-size: 11px; flex-shrink: 0; }
    .col-icon.pk { color: #fbbf24; }
    .col-icon.fk { color: #60a5fa; }
    .col-name { font-family: 'JetBrains Mono', monospace; flex: 1; white-space: nowrap; }
    .col-name.pk { color: #fbbf24; }
    .col-name.fk { color: #60a5fa; }
    .col-name.normal { color: #94a3b8; }
    .col-type { font-family: 'JetBrains Mono', monospace; font-size: 11px; color: #475569; }
    .table-more { padding: 6px 16px; font-size: 10px; color: #475569; border-top: 1px solid #1e293b; }

    /* Relations - cleaner lines */
    .relations-layer { position: absolute; top: 0; left: 0; pointer-events: none; overflow: visible; }
    .relation-path { fill: none; stroke: #4b5563; stroke-width: 1; opacity: 0.3; }
    .relation-path.highlighted { stroke: #60a5fa; stroke-width: 1.5; opacity: 0.9; }
    .relation-dot { fill: #4b5563; opacity: 0.3; }
    .relation-dot.highlighted { fill: #60a5fa; opacity: 0.9; }

    /* Column Headers */
    .col-header {
      position: absolute;
      top: -35px;
      width: 200px;
      text-align: center;
      font-size: 11px;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 6px 0;
      border-bottom: 2px solid;
    }

    /* Info Panels */
    .legend {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: #151521f0;
      backdrop-filter: blur(12px);
      border: 1px solid #2a2a3e;
      border-radius: 12px;
      padding: 14px 18px;
      font-size: 11px;
      z-index: 100;
    }
    .legend-title { font-weight: 600; margin-bottom: 10px; color: #94a3b8; font-size: 12px; }
    .legend-item { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; color: #64748b; }
    .legend-icon { width: 14px; text-align: center; }

    .detail-panel {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #151521f0;
      backdrop-filter: blur(12px);
      border: 1px solid #2a2a3e;
      border-radius: 14px;
      padding: 18px 20px;
      min-width: 280px;
      max-width: 340px;
      z-index: 100;
    }
    .detail-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    .detail-name { font-family: 'JetBrains Mono', monospace; font-size: 15px; font-weight: 600; }
    .detail-badge { font-size: 10px; padding: 3px 8px; border-radius: 10px; color: #fff; }
    .detail-stats { font-size: 12px; color: #64748b; margin-bottom: 12px; }
    .detail-relations { display: flex; flex-direction: column; gap: 4px; }
    .detail-rel {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: #60a5fa;
      padding: 5px 10px;
      background: #1e293b;
      border-radius: 6px;
    }
    .detail-close { margin-top: 12px; font-size: 10px; color: #475569; cursor: pointer; }
    .detail-close:hover { color: #94a3b8; }

    /* Client badge colors */
    .client-all { --c: #64748b; }
    .client-enterprise { --c: #8b5cf6; }
    .client-userapp { --c: #10b981; }
    .client-bodab { --c: #f59e0b; }
  </style>
</head>
<body>
  <div class="app" id="app"></div>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script type="text/babel">
const { useState, useEffect, useCallback, useRef } = React;

// ============================================================
// DATA DEFINITIONS
// ============================================================

const CLIENTS = {
  all: { label: "Ï†ÑÏ≤¥ UniQData", icon: "üóÑÔ∏è", color: "#64748b", desc: "40 tables" },
  enterprise: { label: "Enterprise Portal", icon: "üè¢", color: "#8b5cf6", desc: "Ïó∞Íµ¨Ïûê Ïõπ" },
  userapp: { label: "User App", icon: "üì±", color: "#10b981", desc: "Í∞úÏù∏ Ïï±" },
  bodab: { label: "Î≥¥Îãµ", icon: "üë¥", color: "#f59e0b", desc: "ÎÖ∏Ïù∏ÏºÄÏñ¥" },
};

const DOMAINS = {
  all: { label: "Ï†ÑÏ≤¥", color: "#64748b" },
  core: { label: "Core Auth", color: "#818cf8" },
  wallet: { label: "Wallet", color: "#f59e0b" },
  org: { label: "Organization", color: "#10b981" },
  app: { label: "App & Session", color: "#3b82f6" },
  data: { label: "Data", color: "#a855f7" },
  research: { label: "Research", color: "#ec4899" },
  finance: { label: "Finance", color: "#f97316" },
  medication: { label: "Medication", color: "#14b8a6" },
  analytics: { label: "AI & Audit", color: "#6366f1" },
};

// Client ‚Üí Table mapping
const CLIENT_TABLES = {
  all: null, // null = all tables
  enterprise: [
    "accounts", "account_logins", "owners", "users",
    "institutions", "workspaces", "workspace_members",
    "apps", "app_keys", "sessions", "passkey_credentials",
    "research_projects", "participation_criteria", "data_collection_configs", "team_members", "agreements",
    "project_wallets", "project_wallet_deposits", "project_wallet_withdrawals", "escrows", "settlements",
    "data_accesses", "consents",
    "audit_logs", "anchor_logs"
  ],
  userapp: [
    "accounts", "account_logins", "owners", "users",
    "wallets", "wallet_secrets", "wallet_credential_bindings", "wallet_recovery_requests",
    "passkey_credentials", "sessions", "refresh_tokens",
    "data_points", "data_sources", "data_attachments", "consents",
    "agreements",
    "ai_analyses", "features", "notifications",
    "audit_logs", "anchor_logs"
  ],
  bodab: [
    "accounts", "account_logins", "owners", "users",
    "wallets", "wallet_secrets", "passkey_credentials",
    "data_points", "data_sources", "consents",
    "user_medications", "medication_logs", "medication_proofs", "drug_info_cache",
    "ai_analyses", "notifications",
    "audit_logs", "anchor_logs"
  ],
};

// API Endpoints ‚Üí Tables (by client)
const API_ENDPOINTS = {
  enterprise: {
    all: { label: "Ï†ÑÏ≤¥ API", tables: null, method: "", color: "#64748b", desc: "Enterprise Portal Ï†ÑÏ≤¥ ÌÖåÏù¥Î∏î" },
    auth_login: {
      label: "POST /auth/login",
      tables: ["accounts", "account_logins", "sessions", "passkey_credentials", "owners", "institutions"],
      method: "POST", color: "#22c55e",
      desc: "Ïó∞Íµ¨Ïûê Î°úÍ∑∏Ïù∏. Passkey Ïù∏Ï¶ù ÌõÑ ÏÑ∏ÏÖò ÏÉùÏÑ±, Í∏∞Í¥Ä Îß§Ïπ≠"
    },
    auth_logout: {
      label: "POST /auth/logout",
      tables: ["sessions"],
      method: "POST", color: "#22c55e",
      desc: "ÏÑ∏ÏÖò Ï¢ÖÎ£å"
    },
    projects_create: {
      label: "POST /projects",
      tables: ["research_projects", "participation_criteria", "data_collection_configs", "project_wallets", "owners", "institutions"],
      method: "POST", color: "#22c55e",
      desc: "Ïó∞Íµ¨ ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ±. Ï∞∏Ïó¨ Ï°∞Í±¥, ÏàòÏßë ÏÑ§Ï†ï, ÌîÑÎ°úÏ†ùÌä∏ ÏßÄÍ∞ë Ìï®Íªò ÏÉùÏÑ±"
    },
    projects_list: {
      label: "GET /projects",
      tables: ["research_projects", "team_members", "owners", "institutions"],
      method: "GET", color: "#3b82f6",
      desc: "ÎÇ¥Í∞Ä ÏÜçÌïú ÌîÑÎ°úÏ†ùÌä∏ Î™©Î°ù Ï°∞Ìöå"
    },
    projects_data: {
      label: "GET /projects/:id/data",
      tables: ["research_projects", "agreements", "consents", "data_points", "users", "audit_logs"],
      method: "GET", color: "#3b82f6",
      desc: "ÌîÑÎ°úÏ†ùÌä∏ Ï∞∏Ïó¨Ïûê Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå. ÎèôÏùò Í≤ÄÏ¶ù ‚Üí Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå ‚Üí Í∞êÏÇ¨ Î°úÍ∑∏"
    },
    projects_participants: {
      label: "GET /projects/:id/participants",
      tables: ["research_projects", "agreements", "users", "participation_criteria"],
      method: "GET", color: "#3b82f6",
      desc: "ÌîÑÎ°úÏ†ùÌä∏ Ï∞∏Ïó¨Ïûê Î™©Î°ù Î∞è ÌÜµÍ≥Ñ"
    },
    projects_team: {
      label: "POST /projects/:id/team",
      tables: ["research_projects", "team_members", "owners", "accounts"],
      method: "POST", color: "#22c55e",
      desc: "ÌîÑÎ°úÏ†ùÌä∏ ÌåÄÏõê Ï¥àÎåÄ"
    },
    projects_deposit: {
      label: "POST /projects/:id/deposit",
      tables: ["project_wallets", "project_wallet_deposits", "owners", "anchor_logs"],
      method: "POST", color: "#22c55e",
      desc: "ÌîÑÎ°úÏ†ùÌä∏ ÏòàÏÇ∞ ÏûÖÍ∏à. XRPL Ìä∏ÎûúÏû≠ÏÖò ÏïµÏª§ÎßÅ"
    },
    settlements_create: {
      label: "POST /settlements",
      tables: ["escrows", "settlements", "agreements", "project_wallet_withdrawals", "anchor_logs"],
      method: "POST", color: "#22c55e",
      desc: "Ï∞∏Ïó¨Ïûê Î≥¥ÏÉÅ Ï†ïÏÇ∞. ÏóêÏä§ÌÅ¨Î°ú Ìï¥Ï†ú ‚Üí Ï†ïÏÇ∞ Í∏∞Î°ù ‚Üí XRPL ÏïµÏª§ÎßÅ"
    },
    agreements_request: {
      label: "POST /agreements",
      tables: ["agreements", "research_projects", "owners", "users"],
      method: "POST", color: "#22c55e",
      desc: "ÏÇ¨Ïö©ÏûêÏóêÍ≤å Ïó∞Íµ¨ Ï∞∏Ïó¨ ÎèôÏùò ÏöîÏ≤≠"
    },
    agreements_accept: {
      label: "PUT /agreements/:id/accept",
      tables: ["agreements", "consents", "anchor_logs"],
      method: "PUT", color: "#f59e0b",
      desc: "ÏÇ¨Ïö©Ïûê ÎèôÏùò ÏàòÎùΩ Ï≤òÎ¶¨. Consent ÏÉùÏÑ± Î∞è XRPL ÏïµÏª§ÎßÅ"
    },
    analyses_create: {
      label: "POST /analyses",
      tables: ["ai_analyses", "features", "data_points", "users", "research_projects"],
      method: "POST", color: "#22c55e",
      desc: "AI Î∂ÑÏÑù ÏöîÏ≤≠. ÌîÑÎ°úÏ†ùÌä∏ Ïª®ÌÖçÏä§Ìä∏ Ìè¨Ìï®"
    },
  },
  userapp: {
    all: { label: "Ï†ÑÏ≤¥ API", tables: null, method: "", color: "#64748b", desc: "User App Ï†ÑÏ≤¥ ÌÖåÏù¥Î∏î" },
    auth_login: {
      label: "POST /auth/login",
      tables: ["accounts", "account_logins", "sessions", "passkey_credentials", "users"],
      method: "POST", color: "#22c55e",
      desc: "ÏÇ¨Ïö©Ïûê Î°úÍ∑∏Ïù∏. Passkey Ïù∏Ï¶ù"
    },
    auth_passkey: {
      label: "POST /auth/passkey",
      tables: ["passkey_credentials", "users", "accounts"],
      method: "POST", color: "#22c55e",
      desc: "ÏÉà Passkey Îì±Î°ù"
    },
    wallet_create: {
      label: "POST /wallet",
      tables: ["wallets", "wallet_secrets", "wallet_credential_bindings", "owners", "anchor_logs"],
      method: "POST", color: "#22c55e",
      desc: "XRPL ÏßÄÍ∞ë ÏÉùÏÑ±. PRFÎ°ú ÏïîÌò∏ÌôîÎêú ÏãúÎìú Ï†ÄÏû•"
    },
    wallet_get: {
      label: "GET /wallet",
      tables: ["wallets", "owners"],
      method: "GET", color: "#3b82f6",
      desc: "ÎÇ¥ ÏßÄÍ∞ë Ï†ïÎ≥¥ Ï°∞Ìöå"
    },
    wallet_recover: {
      label: "POST /wallet/recover",
      tables: ["wallets", "wallet_recovery_requests", "wallet_secrets", "owners"],
      method: "POST", color: "#22c55e",
      desc: "ÏßÄÍ∞ë Î≥µÍµ¨ ÏöîÏ≤≠"
    },
    data_sync: {
      label: "POST /data/sync",
      tables: ["data_points", "data_sources", "data_attachments", "users", "audit_logs"],
      method: "POST", color: "#22c55e",
      desc: "Í±¥Í∞ï Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî. HealthKit/Health Connect ‚Üí ÏÑúÎ≤Ñ"
    },
    data_get: {
      label: "GET /data",
      tables: ["data_points", "data_sources", "users", "consents"],
      method: "GET", color: "#3b82f6",
      desc: "ÎÇ¥ Í±¥Í∞ï Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå"
    },
    consents_list: {
      label: "GET /consents",
      tables: ["consents", "users", "agreements"],
      method: "GET", color: "#3b82f6",
      desc: "ÎÇ¥Í∞Ä Î∂ÄÏó¨Ìïú ÎèôÏùò Î™©Î°ù"
    },
    consents_revoke: {
      label: "DELETE /consents/:id",
      tables: ["consents", "anchor_logs"],
      method: "DELETE", color: "#ef4444",
      desc: "ÎèôÏùò Ï≤†Ìöå. XRPL ÏïµÏª§ÎßÅ"
    },
    agreements_list: {
      label: "GET /agreements",
      tables: ["agreements", "users", "research_projects"],
      method: "GET", color: "#3b82f6",
      desc: "ÎÇòÏóêÍ≤å Ïò® Ïó∞Íµ¨ Ï∞∏Ïó¨ ÏöîÏ≤≠ Î™©Î°ù"
    },
    agreements_respond: {
      label: "PUT /agreements/:id",
      tables: ["agreements", "consents", "anchor_logs"],
      method: "PUT", color: "#f59e0b",
      desc: "Ïó∞Íµ¨ Ï∞∏Ïó¨ ÏàòÎùΩ/Í±∞Ï†à"
    },
    ai_request: {
      label: "POST /ai/analyze",
      tables: ["ai_analyses", "features", "data_points", "users"],
      method: "POST", color: "#22c55e",
      desc: "ÎÇ¥ Îç∞Ïù¥ÌÑ∞ AI Î∂ÑÏÑù ÏöîÏ≤≠"
    },
    ai_results: {
      label: "GET /ai/results",
      tables: ["ai_analyses", "features", "users"],
      method: "GET", color: "#3b82f6",
      desc: "AI Î∂ÑÏÑù Í≤∞Í≥º Ï°∞Ìöå"
    },
    notifications: {
      label: "GET /notifications",
      tables: ["notifications", "users"],
      method: "GET", color: "#3b82f6",
      desc: "ÏïåÎ¶º Î™©Î°ù"
    },
  },
  bodab: {
    all: { label: "Ï†ÑÏ≤¥ API", tables: null, method: "", color: "#64748b", desc: "Î≥¥Îãµ Ïï± Ï†ÑÏ≤¥ ÌÖåÏù¥Î∏î" },
    auth_login: {
      label: "POST /auth/login",
      tables: ["accounts", "account_logins", "sessions", "passkey_credentials", "users"],
      method: "POST", color: "#22c55e",
      desc: "ÏÇ¨Ïö©Ïûê/Î≥¥Ìò∏Ïûê Î°úÍ∑∏Ïù∏"
    },
    data_sync: {
      label: "POST /data/sync",
      tables: ["data_points", "data_sources", "users", "audit_logs"],
      method: "POST", color: "#22c55e",
      desc: "ÏùºÏÉÅ Îç∞Ïù¥ÌÑ∞, ÏùåÏÑ± Î∞îÏù¥Ïò§ÎßàÏª§ ÎèôÍ∏∞Ìôî"
    },
    meds_list: {
      label: "GET /medications",
      tables: ["user_medications", "drug_info_cache", "users"],
      method: "GET", color: "#3b82f6",
      desc: "Î≥µÏö© Ï§ëÏù∏ ÏïΩ Î™©Î°ù"
    },
    meds_add: {
      label: "POST /medications",
      tables: ["user_medications", "drug_info_cache", "users"],
      method: "POST", color: "#22c55e",
      desc: "ÏÉà ÏïΩ Îì±Î°ù"
    },
    meds_log: {
      label: "POST /medications/:id/log",
      tables: ["medication_logs", "user_medications", "users", "audit_logs"],
      method: "POST", color: "#22c55e",
      desc: "Î≥µÏïΩ Í∏∞Î°ù (Î≥µÏö©/ÎØ∏Î≥µÏö©)"
    },
    meds_proof: {
      label: "POST /medications/proof",
      tables: ["medication_proofs", "user_medications", "anchor_logs"],
      method: "POST", color: "#22c55e",
      desc: "Î≥µÏïΩ Ï¶ùÎ™Ö (ZKP Ïª§Î∞ãÎ®ºÌä∏)"
    },
    consents_manage: {
      label: "GET /consents",
      tables: ["consents", "users"],
      method: "GET", color: "#3b82f6",
      desc: "Î≥¥Ìò∏Ïûê/Ïó∞Íµ¨ ÎèôÏùò Í¥ÄÎ¶¨"
    },
    ai_analyze: {
      label: "POST /ai/analyze",
      tables: ["ai_analyses", "data_points", "users"],
      method: "POST", color: "#22c55e",
      desc: "Í±¥Í∞ï Ìå®ÌÑ¥ AI Î∂ÑÏÑù ÏöîÏ≤≠"
    },
    notifications: {
      label: "GET /notifications",
      tables: ["notifications", "users"],
      method: "GET", color: "#3b82f6",
      desc: "Î≥µÏïΩ ÏïåÎ¶º, Ïù¥ÏÉÅ ÏßïÌõÑ ÏïåÎ¶º"
    },
  },
};

const TABLES = [
  // Core Auth
  { name: "accounts", domain: "core", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "type", t: "enum" }, { n: "status", t: "enum" },
    { n: "identity_hash", t: "varchar" }, { n: "kyc_verified_at", t: "ts" }, { n: "created_at", t: "ts" }
  ]},
  { name: "account_logins", domain: "core", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "account_id", t: "uuid", fk: "accounts" },
    { n: "provider", t: "enum" }, { n: "email", t: "varchar" }, { n: "phone", t: "varchar" }
  ]},
  { name: "owners", domain: "core", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "account_id", t: "uuid", fk: "accounts" }, { n: "created_at", t: "ts" }
  ]},
  { name: "users", domain: "core", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "account_id", t: "uuid", fk: "accounts" },
    { n: "name", t: "varchar" }, { n: "birth_date", t: "date" }, { n: "gender", t: "varchar" }
  ]},
  // Wallet
  { name: "wallets", domain: "wallet", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "owner_id", t: "uuid", fk: "owners" },
    { n: "address", t: "varchar" }, { n: "wallet_type", t: "enum" }, { n: "status", t: "enum" }
  ]},
  { name: "wallet_secrets", domain: "wallet", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "wallet_id", t: "uuid", fk: "wallets" },
    { n: "encrypted_seed_prf", t: "bytea" }, { n: "prf_salt", t: "bytea" }
  ]},
  { name: "wallet_credential_bindings", domain: "wallet", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "wallet_id", t: "uuid", fk: "wallets" },
    { n: "credential_id", t: "uuid", fk: "passkey_credentials" }, { n: "xrpl_tx_hash", t: "varchar" }
  ]},
  { name: "wallet_recovery_requests", domain: "wallet", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "wallet_id", t: "uuid", fk: "wallets" },
    { n: "owner_id", t: "uuid", fk: "owners" }, { n: "status", t: "enum" }
  ]},
  // App
  { name: "apps", domain: "app", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "slug", t: "varchar" }, { n: "name", t: "varchar" },
    { n: "allowed_scopes", t: "text" }, { n: "status", t: "enum" }
  ]},
  { name: "app_keys", domain: "app", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "app_id", t: "uuid", fk: "apps" },
    { n: "key_type", t: "enum" }, { n: "key_hash", t: "varchar" }, { n: "status", t: "enum" }
  ]},
  { name: "sessions", domain: "app", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "user_id", t: "uuid", fk: "users" },
    { n: "app_id", t: "uuid", fk: "apps" }, { n: "started_at", t: "ts" }
  ]},
  { name: "refresh_tokens", domain: "app", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "user_id", t: "uuid", fk: "users" },
    { n: "session_id", t: "uuid", fk: "sessions" }, { n: "expires_at", t: "ts" }
  ]},
  { name: "passkey_credentials", domain: "app", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "user_id", t: "uuid", fk: "users" },
    { n: "credential_id", t: "varchar" }, { n: "public_key", t: "text" }, { n: "counter", t: "int" }
  ]},
  // Org
  { name: "institutions", domain: "org", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "name", t: "varchar" }, { n: "type", t: "enum" },
    { n: "domains", t: "text" }, { n: "status", t: "enum" }
  ]},
  { name: "workspaces", domain: "org", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "name", t: "varchar" }, { n: "type", t: "enum" },
    { n: "institution_id", t: "uuid", fk: "institutions" }, { n: "max_members", t: "int" }
  ]},
  { name: "workspace_members", domain: "org", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "workspace_id", t: "uuid", fk: "workspaces" },
    { n: "account_id", t: "uuid", fk: "accounts" }, { n: "role", t: "enum" }
  ]},
  // Data
  { name: "data_points", domain: "data", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "user_id", t: "uuid", fk: "users" },
    { n: "category", t: "varchar" }, { n: "metric", t: "varchar" }, { n: "value", t: "jsonb" }
  ]},
  { name: "data_attachments", domain: "data", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "data_point_id", t: "uuid", fk: "data_points" },
    { n: "storage_key", t: "varchar" }, { n: "file_name", t: "varchar" }
  ]},
  { name: "data_sources", domain: "data", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "user_id", t: "uuid", fk: "users" },
    { n: "name", t: "varchar" }, { n: "type", t: "varchar" }, { n: "is_active", t: "bool" }
  ]},
  { name: "data_accesses", domain: "data", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "workspace_id", t: "uuid", fk: "workspaces" },
    { n: "account_id", t: "uuid", fk: "accounts" }, { n: "status", t: "enum" }
  ]},
  { name: "consents", domain: "data", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "user_id", t: "uuid", fk: "users" },
    { n: "app_id", t: "uuid", fk: "apps" }, { n: "scopes", t: "text" }, { n: "status", t: "enum" }
  ]},
  // Research
  { name: "research_projects", domain: "research", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "owner_id", t: "uuid", fk: "owners" },
    { n: "institution_id", t: "uuid", fk: "institutions" }, { n: "title", t: "varchar" }, { n: "status", t: "enum" }
  ]},
  { name: "participation_criteria", domain: "research", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "project_id", t: "uuid", fk: "research_projects" },
    { n: "age_min", t: "int" }, { n: "age_max", t: "int" }, { n: "conditions", t: "jsonb" }
  ]},
  { name: "data_collection_configs", domain: "research", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "project_id", t: "uuid", fk: "research_projects" },
    { n: "passive_data", t: "jsonb" }, { n: "active_data", t: "jsonb" }
  ]},
  { name: "team_members", domain: "research", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "project_id", t: "uuid", fk: "research_projects" },
    { n: "owner_id", t: "uuid", fk: "owners" }, { n: "role", t: "enum" }
  ]},
  { name: "agreements", domain: "research", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "project_id", t: "uuid", fk: "research_projects" },
    { n: "owner_id", t: "uuid", fk: "owners" }, { n: "status", t: "enum" }
  ]},
  // Finance
  { name: "project_wallets", domain: "finance", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "project_id", t: "uuid", fk: "research_projects" },
    { n: "wallet_address", t: "varchar" }, { n: "total_deposited", t: "decimal" }
  ]},
  { name: "project_wallet_deposits", domain: "finance", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "project_id", t: "uuid", fk: "research_projects" },
    { n: "depositor_owner_id", t: "uuid", fk: "owners" }, { n: "amount", t: "decimal" }
  ]},
  { name: "project_wallet_withdrawals", domain: "finance", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "project_id", t: "uuid", fk: "research_projects" },
    { n: "withdrawer_owner_id", t: "uuid", fk: "owners" }, { n: "amount", t: "decimal" }
  ]},
  { name: "escrows", domain: "finance", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "project_id", t: "uuid", fk: "research_projects" },
    { n: "amount", t: "decimal" }, { n: "tx_hash", t: "varchar" }, { n: "status", t: "enum" }
  ]},
  { name: "settlements", domain: "finance", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "agreement_id", t: "uuid", fk: "agreements" },
    { n: "amount", t: "decimal" }, { n: "tx_hash", t: "varchar" }
  ]},
  // Medication
  { name: "drug_info_cache", domain: "medication", cols: [
    { n: "drug_code", t: "varchar", pk: true }, { n: "name", t: "varchar" },
    { n: "category", t: "varchar" }, { n: "ingredients", t: "jsonb" }
  ]},
  { name: "user_medications", domain: "medication", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "user_id", t: "uuid", fk: "users" },
    { n: "name_encrypted", t: "text" }, { n: "category_hash", t: "varchar" }, { n: "is_active", t: "bool" }
  ]},
  { name: "medication_logs", domain: "medication", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "user_id", t: "uuid", fk: "users" },
    { n: "medication_id", t: "uuid", fk: "user_medications" }, { n: "taken", t: "bool" }
  ]},
  { name: "medication_proofs", domain: "medication", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "user_id", t: "uuid", fk: "users" },
    { n: "proof_type", t: "varchar" }, { n: "commitment", t: "bytea" }
  ]},
  // Analytics
  { name: "ai_analyses", domain: "analytics", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "user_id", t: "uuid", fk: "users" },
    { n: "project_id", t: "uuid", fk: "research_projects" }, { n: "app_id", t: "uuid", fk: "apps" },
    { n: "type", t: "varchar" }, { n: "status", t: "enum" }, { n: "result", t: "jsonb" }
  ]},
  { name: "features", domain: "analytics", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "user_id", t: "uuid", fk: "users" },
    { n: "project_id", t: "uuid", fk: "research_projects" },
    { n: "category", t: "varchar" }, { n: "feature_type", t: "varchar" }
  ]},
  { name: "notifications", domain: "analytics", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "user_id", t: "uuid", fk: "users" },
    { n: "app_id", t: "uuid", fk: "apps" }, { n: "type", t: "varchar" }
  ]},
  { name: "audit_logs", domain: "analytics", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "user_id", t: "uuid", fk: "users" },
    { n: "app_id", t: "uuid", fk: "apps" }, { n: "action", t: "varchar" }
  ]},
  { name: "anchor_logs", domain: "analytics", cols: [
    { n: "id", t: "uuid", pk: true }, { n: "user_id", t: "uuid", fk: "users" },
    { n: "anchor_type", t: "enum" }, { n: "tx_hash", t: "varchar" }
  ]},
];

// Build relations
const RELATIONS = [];
TABLES.forEach(t => {
  t.cols.forEach(c => {
    if (c.fk) RELATIONS.push({ from: t.name, fromCol: c.n, to: c.fk, toCol: "id" });
  });
});

// ============================================================
// LAYOUT - Tree structure from accounts
// ============================================================

// Clean grouped layout by functional area
const AREA_LAYOUT = {
  // === AUTH (col 0) ===
  accounts:        { col: 0, row: 0 },
  account_logins:  { col: 0, row: 1 },
  owners:          { col: 0, row: 2 },
  users:           { col: 0, row: 3 },

  // === WALLET (col 1) ===
  wallets:                     { col: 1, row: 0 },
  wallet_secrets:              { col: 1, row: 1 },
  wallet_credential_bindings:  { col: 1, row: 2 },
  wallet_recovery_requests:    { col: 1, row: 3 },

  // === APP & SESSION (col 2) ===
  apps:                 { col: 2, row: 0 },
  app_keys:             { col: 2, row: 1 },
  passkey_credentials:  { col: 2, row: 2 },
  sessions:             { col: 2, row: 3 },
  refresh_tokens:       { col: 2, row: 4 },

  // === ORG (col 3) ===
  institutions:       { col: 3, row: 0 },
  workspaces:         { col: 3, row: 1 },
  workspace_members:  { col: 3, row: 2 },
  data_accesses:      { col: 3, row: 3 },

  // === RESEARCH (col 4) ===
  research_projects:       { col: 4, row: 0 },
  participation_criteria:  { col: 4, row: 1 },
  data_collection_configs: { col: 4, row: 2 },
  team_members:            { col: 4, row: 3 },
  agreements:              { col: 4, row: 4 },

  // === FINANCE (col 5) ===
  project_wallets:            { col: 5, row: 0 },
  project_wallet_deposits:    { col: 5, row: 1 },
  project_wallet_withdrawals: { col: 5, row: 2 },
  escrows:                    { col: 5, row: 3 },
  settlements:                { col: 5, row: 4 },

  // === DATA (col 6) ===
  data_sources:      { col: 6, row: 0 },
  data_points:       { col: 6, row: 1 },
  data_attachments:  { col: 6, row: 2 },
  consents:          { col: 6, row: 3 },

  // === MEDICATION (col 7) ===
  drug_info_cache:    { col: 7, row: 0 },
  user_medications:   { col: 7, row: 1 },
  medication_logs:    { col: 7, row: 2 },
  medication_proofs:  { col: 7, row: 3 },

  // === ANALYTICS (col 8) ===
  ai_analyses:    { col: 8, row: 0 },
  features:       { col: 8, row: 1 },
  notifications:  { col: 8, row: 2 },
  audit_logs:     { col: 8, row: 3 },
  anchor_logs:    { col: 8, row: 4 },
};

function calculateLayout(client, domain, api = "all") {
  let clientTables = CLIENT_TABLES[client];
  let tables = clientTables ? TABLES.filter(t => clientTables.includes(t.name)) : TABLES;

  // API filter takes priority when selected
  const clientApis = API_ENDPOINTS[client];
  if (api !== "all" && clientApis && clientApis[api]) {
    const apiTables = clientApis[api].tables;
    if (apiTables) {
      tables = TABLES.filter(t => apiTables.includes(t.name));
    }
  }

  const visible = domain === "all"
    ? tables
    : tables.filter(t => {
        if (t.domain === domain) return true;
        const domainTables = tables.filter(tt => tt.domain === domain);
        for (const dt of domainTables) {
          for (const c of dt.cols) {
            if (c.fk === t.name && tables.some(x => x.name === t.name)) return true;
          }
        }
        return false;
      });

  const positions = {};
  const CARD_W = 200;
  const ROW_H = 20;
  const HEADER_H = 30;
  const COL_WIDTH = 240;
  const CARD_GAP = 20;

  // API view - simple grid layout (no overlap)
  if (api !== "all") {
    const GRID_COLS = 3;
    const GRID_GAP_X = 250;
    const GRID_GAP_Y = 30;

    visible.forEach((t, idx) => {
      const col = idx % GRID_COLS;
      const row = Math.floor(idx / GRID_COLS);
      const h = HEADER_H + t.cols.length * ROW_H + 6;

      // Calculate Y based on max height in previous rows
      let y = 0;
      for (let r = 0; r < row; r++) {
        let maxH = 0;
        for (let c = 0; c < GRID_COLS; c++) {
          const prevIdx = r * GRID_COLS + c;
          if (prevIdx < visible.length) {
            const prevT = visible[prevIdx];
            const prevH = HEADER_H + prevT.cols.length * ROW_H + 6;
            maxH = Math.max(maxH, prevH);
          }
        }
        y += maxH + GRID_GAP_Y;
      }

      positions[t.name] = {
        x: col * GRID_GAP_X,
        y,
        w: CARD_W + 20,
        h,
        ghost: false
      };
    });
  } else if (domain === "all") {
    // Stack cards vertically in each column - no overlapping
    const colHeights = {};
    for (let i = 0; i < 9; i++) colHeights[i] = 0;

    // Sort by column then row to maintain order
    const sortedTables = [...visible].sort((a, b) => {
      const posA = AREA_LAYOUT[a.name] || { col: 4, row: 5 };
      const posB = AREA_LAYOUT[b.name] || { col: 4, row: 5 };
      if (posA.col !== posB.col) return posA.col - posB.col;
      return posA.row - posB.row;
    });

    sortedTables.forEach(t => {
      const pos = AREA_LAYOUT[t.name] || { col: 4, row: 5 };
      const h = HEADER_H + t.cols.length * ROW_H + 6;
      positions[t.name] = {
        x: pos.col * COL_WIDTH,
        y: colHeights[pos.col],
        w: CARD_W,
        h,
        ghost: false
      };
      colHeights[pos.col] += h + CARD_GAP;
    });
  } else {
    // Domain view - primary center, refs left
    const primary = visible.filter(t => t.domain === domain);
    const refs = visible.filter(t => t.domain !== domain);

    // Primary tables in center
    let primaryY = 0;
    primary.forEach(t => {
      const h = HEADER_H + t.cols.length * ROW_H + 6;
      positions[t.name] = { x: 250, y: primaryY, w: CARD_W + 20, h, ghost: false };
      primaryY += h + 25;
    });

    // Refs on left, compact
    let refY = 0;
    refs.forEach(t => {
      const h = HEADER_H + Math.min(t.cols.length, 3) * ROW_H + 6;
      positions[t.name] = { x: 0, y: refY, w: 160, h, ghost: true };
      refY += h + 15;
    });
  }

  return { visible, positions };
}

// ============================================================
// COMPONENTS
// ============================================================

function TableCard({ table, pos, hovered, selected, onHover, onClick }) {
  const domain = DOMAINS[table.domain];
  const maxCols = pos.ghost ? 4 : table.cols.length;
  const visibleCols = table.cols.slice(0, maxCols);
  const isHighlighted = hovered === table.name || selected === table.name;

  return (
    <div
      className={`table-card ${isHighlighted ? 'highlighted' : ''} ${pos.ghost ? 'ghost' : ''}`}
      style={{ left: pos.x, top: pos.y, width: pos.w }}
      onMouseEnter={() => onHover(table.name)}
      onMouseLeave={() => onHover(null)}
      onClick={() => onClick(table.name)}
    >
      <div className="table-header" style={{ background: domain.color }}>
        <span className="table-name">{pos.ghost ? `‚Üó ${table.name}` : table.name}</span>
        <span className="table-meta">{table.cols.length} cols</span>
      </div>
      <div className="table-cols">
        {visibleCols.map(col => (
          <div key={col.n} className="col-row">
            <span className={`col-icon ${col.pk ? 'pk' : col.fk ? 'fk' : ''}`}>
              {col.pk ? 'üîë' : col.fk ? '‚Üí' : ''}
            </span>
            <span className={`col-name ${col.pk ? 'pk' : col.fk ? 'fk' : 'normal'}`}>{col.n}</span>
            <span className="col-type">{col.t}</span>
          </div>
        ))}
      </div>
      {pos.ghost && table.cols.length > 4 && (
        <div className="table-more">+{table.cols.length - 4} more</div>
      )}
    </div>
  );
}

function App() {
  const [client, setClient] = useState("all");
  const [domain, setDomain] = useState("all");
  const [api, setApi] = useState("all");
  const [hovered, setHovered] = useState(null);
  const [selected, setSelected] = useState(null);
  const [zoom, setZoom] = useState(0.85);
  const [pan, setPan] = useState({ x: 50, y: 40 });
  const [dragging, setDragging] = useState(false);
  const [dragStart, setDragStart] = useState({ x: 0, y: 0 });

  const { visible, positions } = calculateLayout(client, domain, api);

  // Count tables per domain for current client
  const domainCounts = {};
  const clientTables = CLIENT_TABLES[client];
  const filteredTables = clientTables ? TABLES.filter(t => clientTables.includes(t.name)) : TABLES;
  Object.keys(DOMAINS).forEach(d => {
    domainCounts[d] = d === "all" ? filteredTables.length : filteredTables.filter(t => t.domain === d).length;
  });

  const activeTable = hovered || selected;
  const relatedTables = new Set();
  if (activeTable) {
    RELATIONS.forEach(r => {
      if (r.from === activeTable) relatedTables.add(r.to);
      if (r.to === activeTable) relatedTables.add(r.from);
    });
  }

  const visibleRelations = RELATIONS.filter(r =>
    visible.some(t => t.name === r.from) && visible.some(t => t.name === r.to)
  );

  useEffect(() => {
    const isAll = client === "all" && domain === "all" && api === "all";
    const isApiView = api !== "all";
    setZoom(isAll ? 0.6 : isApiView ? 1.0 : 0.95);
    setPan(isAll ? { x: 20, y: 50 } : { x: 50, y: 40 });
    setSelected(null);
  }, [client, domain, api]);

  const handleWheel = useCallback(e => {
    e.preventDefault();
    setZoom(z => Math.max(0.3, Math.min(2, z + (e.deltaY > 0 ? -0.05 : 0.05))));
  }, []);

  const handleMouseDown = e => {
    if (e.target.closest('.table-card')) return;
    setDragging(true);
    setDragStart({ x: e.clientX - pan.x, y: e.clientY - pan.y });
  };
  const handleMouseMove = e => {
    if (dragging) setPan({ x: e.clientX - dragStart.x, y: e.clientY - dragStart.y });
  };
  const handleMouseUp = () => setDragging(false);

  let maxX = 1200, maxY = 800;
  Object.values(positions).forEach(p => {
    if (p.x !== undefined) {
      maxX = Math.max(maxX, p.x + p.w + 100);
      maxY = Math.max(maxY, p.y + p.h + 100);
    }
  });

  return (
    <div className="app">
      <div className="header">
        <div style={{ display: 'flex', alignItems: 'center' }}>
          <div className="logo">
            <span className="primary">UniQ</span>
            <span className="secondary">Data</span>
          </div>
          <span className="header-stats">
            ERD v4 ¬∑ {visible.length} tables
            {api !== "all" && API_ENDPOINTS[client] && API_ENDPOINTS[client][api] && ` ¬∑ ${API_ENDPOINTS[client][api].label}`}
          </span>
        </div>
        <div className="zoom-controls">
          <button className="zoom-btn" onClick={() => setZoom(z => Math.max(0.3, z - 0.1))}>‚àí</button>
          <span className="zoom-level">{Math.round(zoom * 100)}%</span>
          <button className="zoom-btn" onClick={() => setZoom(z => Math.min(2, z + 0.1))}>+</button>
        </div>
      </div>

      <div className="tabs-wrapper">
        <div className="tabs-row">
          <span className="tabs-label">ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏</span>
          {Object.entries(CLIENTS).map(([key, c]) => (
            <button
              key={key}
              className={`tab ${client === key ? 'active' : ''}`}
              style={{ '--tab-bg': c.color, '--tab-color': '#fff' }}
              onClick={() => { setClient(key); setDomain("all"); setApi("all"); }}
            >
              <span className="icon">{c.icon}</span>
              {c.label}
            </button>
          ))}
        </div>
        <div className="tabs-row">
          <span className="tabs-label">ÎèÑÎ©îÏù∏</span>
          {Object.entries(DOMAINS).filter(([k]) => domainCounts[k] > 0).map(([key, d]) => (
            <button
              key={key}
              className={`tab ${domain === key ? 'active' : ''}`}
              style={{ '--tab-bg': d.color, '--tab-color': '#fff' }}
              onClick={() => { setDomain(key); setApi("all"); }}
            >
              {d.label}
              <span className="count">{domainCounts[key]}</span>
            </button>
          ))}
        </div>
        {API_ENDPOINTS[client] && (
          <div className="tabs-row">
            <span className="tabs-label">API</span>
            {Object.entries(API_ENDPOINTS[client]).map(([key, ep]) => (
              <button
                key={key}
                className={`tab ${api === key ? 'active' : ''}`}
                style={{ '--tab-bg': ep.color, '--tab-color': '#fff' }}
                onClick={() => { setApi(key); setDomain("all"); }}
              >
                {ep.label}
                {ep.tables && <span className="count">{ep.tables.length}</span>}
              </button>
            ))}
          </div>
        )}
      </div>

      <div
        className={`canvas-wrapper ${dragging ? 'dragging' : ''}`}
        onWheel={handleWheel}
        onMouseDown={handleMouseDown}
        onMouseMove={handleMouseMove}
        onMouseUp={handleMouseUp}
        onMouseLeave={handleMouseUp}
      >
        <div className="canvas" style={{ transform: `translate(${pan.x}px, ${pan.y}px) scale(${zoom})` }}>
          <svg className="relations-layer" width={maxX} height={maxY}>
            {visibleRelations.map((r, i) => {
              const fp = positions[r.from];
              const tp = positions[r.to];
              if (!fp || !tp) return null;

              const fromTable = TABLES.find(t => t.name === r.from);
              const fromColIdx = fromTable ? fromTable.cols.findIndex(c => c.n === r.fromCol) : 0;

              // Simple: from right edge of FK row to left edge of target header
              const fx = fp.x + fp.w;
              const fy = fp.y + 30 + fromColIdx * 20 + 10;
              const tx = tp.x;
              const ty = tp.y + 15;

              // Simple bezier curve
              const midX = (fx + tx) / 2;
              const d = `M ${fx} ${fy} C ${midX} ${fy}, ${midX} ${ty}, ${tx} ${ty}`;

              const isHighlighted = activeTable && (r.from === activeTable || r.to === activeTable);

              return (
                <g key={i}>
                  <path d={d} className={`relation-path ${isHighlighted ? 'highlighted' : ''}`} />
                  <circle cx={tx} cy={ty} r={3} className={`relation-dot ${isHighlighted ? 'highlighted' : ''}`} />
                </g>
              );
            })}
          </svg>
          {domain === "all" && api === "all" && [
            { col: 0, label: "Auth", color: "#818cf8" },
            { col: 1, label: "Wallet", color: "#f59e0b" },
            { col: 2, label: "App", color: "#3b82f6" },
            { col: 3, label: "Org", color: "#10b981" },
            { col: 4, label: "Research", color: "#ec4899" },
            { col: 5, label: "Finance", color: "#f97316" },
            { col: 6, label: "Data", color: "#a855f7" },
            { col: 7, label: "Meds", color: "#14b8a6" },
            { col: 8, label: "Analytics", color: "#6366f1" },
          ].map(h => (
            <div key={h.col} className="col-header" style={{ left: h.col * 240, borderColor: h.color, color: h.color }}>
              {h.label}
            </div>
          ))}
          {api !== "all" && API_ENDPOINTS[client] && API_ENDPOINTS[client][api] && (
            <div style={{
              position: 'absolute',
              top: -70,
              left: 0,
              background: '#151521f0',
              border: `2px solid ${API_ENDPOINTS[client][api].color}`,
              color: '#fff',
              padding: '12px 20px',
              borderRadius: 10,
              maxWidth: 500,
            }}>
              <div style={{ fontSize: 15, fontWeight: 600, marginBottom: 6, color: API_ENDPOINTS[client][api].color }}>
                {API_ENDPOINTS[client][api].method} {API_ENDPOINTS[client][api].label.split(' ').slice(1).join(' ')}
              </div>
              <div style={{ fontSize: 12, color: '#94a3b8', lineHeight: 1.4 }}>
                {API_ENDPOINTS[client][api].desc}
              </div>
            </div>
          )}
          {visible.map(t => (
            <TableCard key={t.name} table={t} pos={positions[t.name]} hovered={hovered} selected={selected} onHover={setHovered} onClick={setSelected} />
          ))}
        </div>
      </div>

      <div className="legend">
        <div className="legend-title">Î≤îÎ°Ä</div>
        <div className="legend-item"><span className="legend-icon" style={{color:'#fbbf24'}}>üîë</span> Primary Key</div>
        <div className="legend-item"><span className="legend-icon" style={{color:'#60a5fa'}}>‚Üí</span> Foreign Key</div>
      </div>

      {selected && (() => {
        const t = TABLES.find(t => t.name === selected);
        if (!t) return null;
        const d = DOMAINS[t.domain];
        const rels = RELATIONS.filter(r => r.from === t.name || r.to === t.name);
        return (
          <div className="detail-panel">
            <div className="detail-header">
              <span className="detail-name" style={{color: d.color}}>{t.name}</span>
              <span className="detail-badge" style={{background: d.color}}>{d.label}</span>
            </div>
            <div className="detail-stats">{t.cols.length} columns ¬∑ {rels.length} relations</div>
            {rels.length > 0 && (
              <div className="detail-relations">
                {rels.slice(0, 6).map((r, i) => (
                  <div key={i} className="detail-rel">
                    {r.from === t.name ? `‚Üí ${r.to}` : `‚Üê ${r.from}`}
                  </div>
                ))}
                {rels.length > 6 && <div className="detail-rel" style={{color:'#475569'}}>+{rels.length - 6} more</div>}
              </div>
            )}
            <div className="detail-close" onClick={() => setSelected(null)}>ÌÅ¥Î¶≠ÌïòÏó¨ Îã´Í∏∞</div>
          </div>
        );
      })()}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('app')).render(<App />);
  </script>
</body>
</html>
