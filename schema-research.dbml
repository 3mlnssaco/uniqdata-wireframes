// UniQdata ERD - ğŸ”¬ Research & Finance
// https://dbdiagram.io

// Reference tables (ì™¸ë¶€ ì°¸ì¡°ìš©)
Table owners {
  id uuid [pk]
  account_id uuid
  created_at timestamp
}

Table institutions {
  id uuid [pk]
  name varchar
  type enum [note: 'university|research_institute|hospital|company|government|other']
  domains text [note: 'ë„ë©”ì¸ ë°°ì—´: snu.ac.kr']
  status enum [note: 'pending|active|suspended']
  logo_url varchar
  website varchar
  created_at timestamp
  updated_at timestamp
}

// ===== ğŸ”¬ Research =====
Table research_projects {
  id uuid [pk]
  owner_id uuid [ref: > owners.id, note: 'PI']
  institution_id uuid [ref: > institutions.id]
  title varchar
  description text
  methodology varchar [note: 'longitudinal|cross_sectional|cohort|case_control']
  status enum [note: 'draft|recruiting|collecting|analyzing|completed|cancelled']
  created_at timestamp
  updated_at timestamp

  indexes {
    (owner_id, status)
  }
}

Table participation_criteria {
  id uuid [pk]
  project_id uuid [ref: - research_projects.id, unique, note: '1:1']
  age_min int
  age_max int
  conditions jsonb [note: 'í•„ìˆ˜ ì¡°ê±´']
  exclusions jsonb [note: 'ì œì™¸ ì¡°ê±´']
  required_data jsonb [note: 'í•„ìˆ˜ ë°ì´í„°']
  regions jsonb [note: 'ì§€ì—­ ì œí•œ']
  created_at timestamp
}

Table data_collection_configs {
  id uuid [pk]
  project_id uuid [ref: - research_projects.id, unique, note: '1:1']
  passive_data jsonb [note: 'heart_rate, steps...']
  active_data jsonb [note: 'mood, pain_level...']
  biomarkers jsonb [note: 'voice_analysis, cgm...']
  collection_frequency jsonb
  created_at timestamp
}

Table team_members {
  id uuid [pk]
  project_id uuid [ref: > research_projects.id]
  owner_id uuid [ref: > owners.id]
  role enum [note: 'owner|admin|member']
  invited_by uuid [ref: > owners.id]
  joined_at timestamp
  created_at timestamp

  indexes {
    (project_id, owner_id) [unique]
  }
}

Table agreements {
  id uuid [pk]
  project_id uuid [ref: > research_projects.id]
  owner_id uuid [ref: > owners.id, note: 'ì°¸ì—¬ì']
  status enum [note: 'pending|active|completed|withdrawn|expired']
  data_scopes jsonb [note: 'ë™ì˜í•œ ë°ì´í„° ë²”ìœ„']
  start_date date
  end_date date
  created_at timestamp

  indexes {
    (project_id, owner_id) [unique]
    (owner_id, status)
  }
}

// ===== ğŸ’° Project Wallet & Finance =====
Table project_wallets {
  id uuid [pk]
  project_id uuid [ref: - research_projects.id, unique, note: '1:1']
  wallet_address varchar [unique]
  encrypted_seed bytea [note: 'KMS ì•”í˜¸í™”']
  kms_key_id varchar
  total_deposited decimal
  total_spent decimal
  status enum [note: 'active|suspended|closed']
  created_at timestamp
}

Table project_wallet_deposits {
  id uuid [pk]
  project_id uuid [ref: > research_projects.id]
  depositor_owner_id uuid [ref: > owners.id]
  amount decimal
  tx_hash varchar [unique]
  deposited_at timestamp
}

Table project_wallet_withdrawals {
  id uuid [pk]
  project_id uuid [ref: > research_projects.id]
  withdrawer_owner_id uuid [ref: > owners.id]
  amount decimal
  tx_hash varchar [unique]
  withdrawn_at timestamp
}

Table escrows {
  id uuid [pk]
  project_id uuid [ref: > research_projects.id]
  owner_address varchar
  amount decimal
  condition varchar [note: 'Crypto-Condition']
  fulfillment varchar
  sequence int
  tx_hash varchar [unique]
  status enum [note: 'created|partial_released|completed|cancelled']
  created_at timestamp
}

Table settlements {
  id uuid [pk]
  agreement_id uuid [ref: > agreements.id]
  amount decimal
  tx_hash varchar [unique]
  type varchar [note: 'data_submit|bonus|completion']
  memo text
  settled_at timestamp
}

// ===== ğŸ“‹ IRB (ìƒëª…ìœ¤ë¦¬ì‹¬ì˜) =====
// uniqdata-aiê°€ íŒë‹¨/ì„œë¥˜ ìƒì„±, Business Engineì´ ë°ì´í„° ì €ì¥/ìƒíƒœ ê´€ë¦¬

// IRB íŒë‹¨ ê²°ê³¼ â€” uniqdata-ai ì—ì´ì „íŠ¸ê°€ ëŒ€í™”ë¥¼ í†µí•´ ë„ì¶œ
Table irb_determinations {
  id uuid [pk]
  project_id uuid [ref: - research_projects.id, unique, note: '1:1']

  // [1ë‹¨ê³„] ì—°êµ¬ ì—¬ë¶€
  is_research boolean [note: 'ì²´ê³„ì  ì¡°ì‚¬ì¸ê°€?']

  // [2ë‹¨ê³„] ì—°êµ¬ ìœ í˜• (ì‹œí–‰ê·œì¹™ ì œ2ì¡°)
  research_type varchar [note: 'human_subject|human_material|none']
  involves_physical_intervention boolean [note: 'ë¬¼ë¦¬ì  ê°œì…?']
  involves_interaction boolean [note: 'ì˜ì‚¬ì†Œí†µ/ëŒ€ì¸ì ‘ì´‰ ìƒí˜¸ì‘ìš©?']
  uses_identifiable_info boolean [note: 'ê°œì¸ì‹ë³„ì •ë³´ ì´ìš©?']

  // [3ë‹¨ê³„] ì‹¬ì˜ë©´ì œ ì—¬ë¶€
  is_exempt boolean [note: 'ì‹¬ì˜ë©´ì œ í•´ë‹¹?']
  exemption_basis varchar [note: 'article_13 (ì¸ê°„ëŒ€ìƒ) | article_33 (ì¸ì²´ìœ ë˜ë¬¼)']
  exemption_criteria jsonb [note: 'ì¶©ì¡±í•œ ë©´ì œ ì¡°ê±´ ë²ˆí˜¸ ë°°ì—´ (ì˜ˆ: [1, 6])']
  involves_vulnerable_subjects boolean [note: 'ì·¨ì•½ í™˜ê²½ ì—°êµ¬ëŒ€ìƒì í¬í•¨?']

  // [4ë‹¨ê³„] ì„œë©´ë™ì˜ë©´ì œ (ì œ16ì¡°3í•­)
  consent_exemption_eligible boolean [note: 'ì„œë©´ë™ì˜ ë©´ì œ ê°€ëŠ¥?']
  consent_impractical boolean [note: 'ë™ì˜ê°€ í˜„ì‹¤ì ìœ¼ë¡œ ë¶ˆê°€ëŠ¥?']
  consent_affects_validity boolean [note: 'íƒ€ë‹¹ì„±ì— ì‹¬ê°í•œ ì˜í–¥?']
  minimal_risk boolean [note: 'ìœ„í—˜ì´ ê·¹íˆ ë‚®ìŒ?']
  no_refusal_reason boolean [note: 'ê±°ë¶€ ì¶”ì • ì‚¬ìœ  ì—†ìŒ?']
  excludes_minors boolean [note: '18ì„¸ ë¯¸ë§Œ ë¯¸í¬í•¨?']

  // íŒë‹¨ ê²°ê³¼
  determination_result varchar [note: 'exempt_confirmed|review_required|not_applicable|voluntary_review']
  submission_type_required varchar [note: 'initial|exempt_confirmation|none']

  // AI ì—ì´ì „íŠ¸ ëŒ€í™” ì´ë ¥
  ai_conversation_id varchar [note: 'ëŒ€í™” ì„¸ì…˜ ID']
  ai_reasoning text [note: 'AI íŒë‹¨ ê·¼ê±° ìš”ì•½']
  referenced_papers jsonb [note: 'ì°¸ê³ í•œ ë…¼ë¬¸/ì‚¬ë¡€ ëª©ë¡']

  determined_by uuid [ref: > owners.id, note: 'ì—°êµ¬ì']
  created_at timestamp
  updated_at timestamp
}

// IRB ì œì¶œë¬¼
Table irb_submissions {
  id uuid [pk]
  project_id uuid [ref: > research_projects.id]
  determination_id uuid [ref: > irb_determinations.id]
  submission_type varchar [note: 'initial|amendment|renewal|closure|exempt_confirmation|result_report']
  status varchar [note: 'draft|submitted|under_review|revision_requested|approved|rejected|exempt_confirmed']
  submitted_at timestamp
  irb_comment_summary text
  xrpl_tx_hash varchar [note: 'APPROVED ì‹œ XRPL ì•µì»¤ë§']
  created_at timestamp
  updated_at timestamp

  indexes {
    (project_id, status)
  }
}

// IRB ì„œë¥˜ â€” uniqdata-aiê°€ ìƒì„± + ìˆ˜ë™ ì—…ë¡œë“œ
Table irb_documents {
  id uuid [pk]
  submission_id uuid [ref: > irb_submissions.id]
  doc_type varchar [note: 'self_checklist|review_application|research_protocol|bioethics_pledge|bioethics_certificate|consent_form|consent_explanation|consent_exemption_reason|human_material_consent|human_material_ledger|recruitment_notice|survey_instrument|result_report|final_report']
  title varchar
  content text [note: 'ë§ˆí¬ë‹¤ìš´ ë˜ëŠ” HTML']
  file_url varchar [note: 'íŒŒì¼ ì—…ë¡œë“œ URL (PDF ë“±)']
  version int [default: 1]
  generated_by varchar [note: 'ai|manual']
  is_required boolean [default: true]
  status varchar [note: 'draft|ready|submitted']
  created_at timestamp
}

// IRB ì‹¬ì˜ ì˜ê²¬
Table irb_review_comments {
  id uuid [pk]
  submission_id uuid [ref: > irb_submissions.id]
  reviewer_id uuid [ref: > owners.id, note: 'IRB ìœ„ì›']
  comment text
  decision varchar [note: 'approve|revise|reject|abstain']
  created_at timestamp
}

// í˜„ì¥ ì ê²€ (ì°¸ê³ ìë£Œ 7 íë¦„ë„)
Table irb_inspections {
  id uuid [pk]
  project_id uuid [ref: > research_projects.id]
  submission_id uuid [ref: > irb_submissions.id]
  status varchar [note: 'selected|scheduled|notified|documents_submitted|inspected|checklist_done|objection_filed|reviewed|discussed|completed']
  inspector_id uuid [ref: > owners.id]
  scheduled_at timestamp
  inspection_checklist jsonb [note: 'ë‚´ë¶€ì ê²€ì ê²€í‘œ']
  objection text [note: 'ì´ì˜ì‹ ì²­ ë‚´ìš©']
  result_summary text [note: 'ì ê²€ ê²°ê³¼']
  created_at timestamp
  updated_at timestamp
}
