<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UniQdata — v11 CDM-Aligned Dynamic Demo</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#f5f5f5;color:#1f2937;font-size:13px;}
.layout{display:flex;height:100vh;overflow:hidden;}

/* Sidebar */
.sidebar{width:210px;background:linear-gradient(180deg,#0f172a,#1e293b);color:white;display:flex;flex-direction:column;flex-shrink:0;}
.logo{padding:14px 18px;font-size:17px;font-weight:700;border-bottom:1px solid rgba(255,255,255,.1);display:flex;align-items:center;gap:8px;}
.logo-icon{width:26px;height:26px;background:linear-gradient(135deg,#3b82f6,#8b5cf6);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:13px;}
.nav-section{padding:10px;border-bottom:1px solid rgba(255,255,255,.05);}
.nav-item{display:flex;align-items:center;gap:8px;padding:7px 10px;border-radius:5px;color:#94a3b8;cursor:pointer;font-size:12px;}
.rn-header{display:flex;align-items:center;gap:5px;padding:5px 8px;border-radius:5px;font-size:11px;color:#94a3b8;cursor:pointer;transition:all .12s;}
.rn-header:hover{background:rgba(255,255,255,.05);}
.rn-header.active{color:#60a5fa;background:rgba(59,130,246,.1);}
.rn-sub{padding-left:14px;margin-top:2px;border-left:2px solid rgba(255,255,255,.1);margin-left:12px;}
.ns-item{display:flex;align-items:center;gap:5px;padding:5px 8px;border-radius:4px;color:#94a3b8;font-size:10px;cursor:pointer;margin-bottom:1px;}
.ns-item:hover{background:rgba(255,255,255,.05);}
.ns-item.active{background:rgba(59,130,246,.15);color:#60a5fa;}
.sidebar-footer{margin-top:auto;padding:10px;border-top:1px solid rgba(255,255,255,.05);}
.u-av{width:28px;height:28px;background:linear-gradient(135deg,#3b82f6,#8b5cf6);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;}

.main{flex:1;overflow:hidden;display:flex;flex-direction:column;}
.content{padding:16px 20px;flex:1;display:flex;flex-direction:column;overflow:hidden;min-height:0;}
.page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-shrink:0;padding-bottom:8px;border-bottom:1px solid #e5e7eb;}
.page-title{font-size:18px;font-weight:700;color:#111827;}
.page-sub{color:#6b7280;font-size:11px;margin-top:3px;letter-spacing:-0.1px;}
.study-status{display:flex;align-items:center;gap:6px;padding:5px 10px;background:white;border:1px solid #e5e7eb;border-radius:6px;font-size:11px;}
.st-dot{width:8px;height:8px;border-radius:50%;}.st-dot.active{background:#22c55e;}

/* Tabs */
.tabs{display:flex;border-bottom:2px solid #e5e7eb;margin-bottom:12px;flex-shrink:0;gap:2px;}
.tab{padding:8px 20px;font-size:12px;color:#6b7280;cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;font-weight:600;user-select:none;transition:all .15s;border-radius:6px 6px 0 0;}
.tab:hover{color:#374151;background:#f9fafb;}.tab.active{color:#0072B2;border-bottom-color:#0072B2;background:rgba(0,114,178,.03);}
.tab-content{display:none;flex:1;min-height:0;overflow:hidden;}
.tab-content.active{display:flex;flex-direction:column;flex:1;min-height:0;}
#tc-ov.active{position:relative;}

/* Overview */
.ov-scroll{flex:1;overflow-y:auto;overflow-x:hidden;min-width:0;}

/* Research Type Sub-tabs — 전향적/하이브리드/후향적 병렬 뷰 */
.rt-tabs{display:flex;gap:0;margin-bottom:10px;background:#f1f5f9;border-radius:8px;padding:3px;width:fit-content;}
.rt-tab{padding:6px 16px;font-size:11px;font-weight:600;color:#64748b;cursor:pointer;border-radius:6px;transition:all .15s;border:none;background:none;white-space:nowrap;display:flex;align-items:center;gap:5px;}
.rt-tab:hover{color:#374151;background:rgba(255,255,255,.5);}
.rt-tab.active{color:#fff;box-shadow:0 1px 3px rgba(0,0,0,.12);}
.rt-tab.active[data-rt="prospective"]{background:#0072B2;}
.rt-tab.active[data-rt="hybrid"]{background:#8b5cf6;}
.rt-tab.active[data-rt="retrospective"]{background:#6366f1;}
.rt-tab .rt-icon{font-size:10px;}
.rt-tab .rt-desc{font-size:9px;color:inherit;opacity:.8;margin-left:2px;}
.rt-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;}
.rt-header-info{font-size:10px;color:#9ca3af;}

/* Cohort Comparison Strip — 코호트 간 비교 */
.cohort-compare{background:white;border:1px solid #e5e7eb;border-radius:10px;padding:14px 16px;margin-bottom:10px;box-shadow:0 1px 3px rgba(0,0,0,.04);}
.cc-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.cc-title{font-size:13px;font-weight:700;color:#111827;display:flex;align-items:center;gap:6px;}
.cc-subtitle{font-size:10px;color:#6b7280;}
.cc-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:8px;}
.cc-card{background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:10px 12px;position:relative;}
.cc-card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;}
.cc-arm-label{font-size:11px;font-weight:600;display:flex;align-items:center;gap:4px;}
.cc-arm-dot{width:8px;height:8px;border-radius:50%;}
.cc-arm-n{font-size:9px;color:#9ca3af;font-weight:400;}
.cc-stat{display:flex;gap:8px;flex-wrap:wrap;}
.cc-stat-item{font-size:10px;color:#6b7280;}
.cc-stat-val{font-weight:600;color:#111827;}
.cc-chart{height:48px;margin-top:6px;position:relative;}
.cc-bar{height:6px;border-radius:3px;position:absolute;bottom:0;}
.cc-diff{position:absolute;right:0;top:0;font-size:18px;font-weight:700;opacity:.15;}

/* Verdict Strip — TD-2 해결: study_type 기반 어댑터 */
/* Verdict Badges — 타임라인 헤더 내 가독성 높은 뱃지 */
.tl-verdict-badges{display:flex;gap:6px;flex-wrap:wrap;align-items:center;flex:1;justify-content:center;}
.vb{display:flex;align-items:center;gap:5px;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:600;border:1px solid #e5e7eb;background:#f9fafb;white-space:nowrap;cursor:default;position:relative;}
.vb .vb-label{color:#6b7280;font-weight:500;font-size:10px;}
.vb .vb-val{font-weight:700;font-size:12px;}
.vb.ok{background:#f0fdf4;border-color:#bbf7d0;}.vb.ok .vb-val{color:#166534;}
.vb.warn{background:#fffbeb;border-color:#fde68a;}.vb.warn .vb-val{color:#92400e;}
.vb.primary{background:#eff6ff;border-color:#bfdbfe;}.vb.primary .vb-val{color:#1e40af;}
.vb.danger{background:#fef2f2;border-color:#fecaca;}.vb.danger .vb-val{color:#991b1b;}
.vb.retro{background:#eef2ff;border-color:#c7d2fe;}.vb.retro .vb-val{color:#4338ca;}
.vb-bar{width:36px;height:4px;background:#e5e7eb;border-radius:2px;overflow:hidden;margin-left:3px;}
.vb-bar-fill{height:100%;border-radius:2px;}
.vb-tooltip{display:none;position:absolute;top:100%;left:50%;transform:translateX(-50%);margin-top:4px;background:#1f2937;color:white;font-size:9px;padding:4px 8px;border-radius:4px;white-space:nowrap;z-index:50;font-weight:400;}
.vb:hover .vb-tooltip{display:block;}

/* Density Row — 타임라인 바 바로 아래 얇은 밀도 표시 */
.tl-density{display:flex;gap:2px;align-items:center;margin:3px 0 1px;height:12px;}
.td-chip{display:flex;align-items:center;gap:2px;padding:1px 5px;border-radius:3px;font-size:7px;font-weight:600;background:#f3f4f6;white-space:nowrap;}
.td-chip .td-bar{width:16px;height:2px;background:#e5e7eb;border-radius:1px;overflow:hidden;}
.td-chip .td-fill{height:100%;border-radius:1px;}

/* Timeline — TD-1 해결: semantic zoom + visit window */
.timeline-section{background:white;border:1px solid #e5e7eb;border-radius:10px;padding:12px 16px;margin-bottom:10px;box-shadow:0 1px 3px rgba(0,0,0,.04);}
.tl-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:6px;}
.tl-title{font-size:13px;font-weight:700;color:#111827;}
.tl-controls{display:flex;gap:8px;align-items:center;}
.tl-toggle{display:flex;gap:3px;font-size:10px;}
.tl-toggle button{padding:2px 8px;border:1px solid #e5e7eb;border-radius:4px;background:white;color:#6b7280;cursor:pointer;font-size:10px;min-width:24px;min-height:24px;}
.tl-toggle button.active{background:#0072B2;color:white;border-color:#0072B2;}
.zoom-ctrl{display:flex;align-items:center;gap:2px;padding:2px 4px;background:#f9fafb;border:1px solid #e5e7eb;border-radius:4px;}
.zoom-ctrl button{background:none;border:none;cursor:pointer;font-size:12px;color:#0072B2;min-width:24px;min-height:24px;display:flex;align-items:center;justify-content:center;}
.zoom-ctrl .zoom-label{font-size:9px;color:#6b7280;min-width:50px;text-align:center;}
.tl-bar{position:relative;height:36px;background:#f9fafb;border-radius:6px;overflow:visible;margin-bottom:4px;}
.tl-phase{position:absolute;top:0;height:100%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600;color:white;border-radius:4px;transition:all .2s;}
.tl-phase.screening{background:#94a3b8;}.tl-phase.enrollment{background:#6366f1;}
.tl-phase.baseline{background:#0072B2;}.tl-phase.treatment{background:#0ea5e9;}
.tl-phase.followup{background:#009E73;}.tl-phase.analysis{background:#8b5cf6;}
.tl-phase.observation{background:#94a3b8;}.tl-phase.index{background:#6366f1;}.tl-phase.outcome{background:#0ea5e9;}
.tl-phase.future{opacity:.4;border:2px dashed;background:transparent;color:#6b7280;}
.tl-phase.future.treatment{border-color:#0ea5e9;}
.tl-phase.future.followup{border-color:#009E73;}
.tl-phase.future.analysis{border-color:#8b5cf6;}
.tl-bar{cursor:default;}
/* tl-now — "오늘" 분기선: 깔끔한 세로선 + 상단 라벨 */
.tl-now{position:absolute;top:0;height:100%;width:0;z-index:10;pointer-events:none;}
.tl-now-line{position:absolute;top:-4px;left:0;width:2px;height:calc(100% + 8px);background:#D55E00;border-radius:1px;transform:translateX(-50%);}
.tl-now-label{position:absolute;top:-22px;left:50%;transform:translateX(-50%);font-size:10px;color:white;font-weight:700;background:#D55E00;padding:2px 7px;border-radius:4px;white-space:nowrap;line-height:1.3;}
.tl-now-label::after{content:'';position:absolute;bottom:-3px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:3px solid transparent;border-right:3px solid transparent;border-top:3px solid #D55E00;}
/* 과거/미래 존 배경 — 미묘하지만 확실한 구분 */
.tl-zone-past{position:absolute;top:0;left:0;height:100%;background:rgba(0,114,178,.03);border-radius:6px 0 0 6px;z-index:1;pointer-events:none;}
.tl-zone-future{position:absolute;top:0;height:100%;background:rgba(156,163,175,.06);border-radius:0 6px 6px 0;z-index:1;pointer-events:none;}
.tl-zone-future-stripe{position:absolute;top:0;height:100%;background:repeating-linear-gradient(90deg,rgba(156,163,175,.08) 0px,rgba(156,163,175,.08) 1px,transparent 1px,transparent 5px);z-index:2;pointer-events:none;border-radius:0 6px 6px 0;}
/* 드래그 핸들 — 오늘 선 위에 겹침, 핸들이 주 인터랙션 */
.tl-handle{position:absolute;top:-8px;width:16px;height:calc(100% + 16px);z-index:20;cursor:ew-resize;display:flex;align-items:center;justify-content:center;transform:translateX(-50%);}
.tl-handle-grip{width:10px;height:22px;background:#D55E00;border-radius:5px;border:2px solid white;box-shadow:0 1px 4px rgba(213,94,0,.4);transition:transform .1s;}
.tl-handle:hover .tl-handle-grip,.tl-handle.dragging .tl-handle-grip{transform:scale(1.2);box-shadow:0 2px 8px rgba(213,94,0,.5);}
.tl-handle .tl-day-tooltip{position:absolute;top:-22px;left:50%;transform:translateX(-50%);background:#1f2937;color:white;font-size:9px;padding:2px 6px;border-radius:4px;white-space:nowrap;opacity:0;transition:opacity .15s;pointer-events:none;}
.tl-handle:hover .tl-day-tooltip,.tl-handle.dragging .tl-day-tooltip{opacity:1;}
/* Visit 마커 */
.tl-visit-dots{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:5;}
.tl-vdot{position:absolute;top:50%;width:6px;height:6px;border-radius:50%;background:white;border:1.5px solid #0072B2;transform:translate(-50%,-50%);opacity:.7;z-index:6;}
.tl-vdot.future{opacity:.3;border-color:#9ca3af;}
.tl-vwindow{position:absolute;top:2px;height:calc(100% - 4px);background:rgba(0,114,178,.08);border-radius:3px;pointer-events:none;z-index:3;}
.tl-vwindow.future{background:rgba(0,0,0,.02);}
.tl-labels{display:flex;justify-content:space-between;font-size:11px;color:#6b7280;padding:2px 2px;font-weight:500;}
.tl-milestones{display:flex;gap:8px;margin-top:3px;flex-wrap:wrap;}
.ms{display:flex;align-items:center;gap:3px;font-size:9px;color:#9ca3af;}
.ms-dot{width:6px;height:6px;border-radius:50%;}
.ms-dot.done{background:#009E73;}.ms-dot.now{background:#D55E00;}.ms-dot.future{background:#d1d5db;}

/* Safety Notification — 콤팩트 알림 배너 */
.safety-notif{display:flex;align-items:center;gap:10px;padding:6px 14px;background:#fffbeb;border:1px solid #fde68a;border-radius:8px;margin-bottom:10px;font-size:11px;color:#92400e;cursor:pointer;transition:all .15s;}
.safety-notif:hover{background:#fef3c7;border-color:#fbbf24;}
.safety-notif.clean{background:#f0fdf4;border-color:#bbf7d0;color:#166534;}
.safety-notif.retro{background:#eef2ff;border-color:#c7d2fe;color:#4338ca;}
.safety-notif .sn-icon{font-size:14px;flex-shrink:0;}
.safety-notif .sn-stats{display:flex;gap:12px;align-items:center;}
.safety-notif .sn-stat{display:flex;align-items:center;gap:3px;font-size:10px;white-space:nowrap;}
.safety-notif .sn-val{font-weight:700;font-size:12px;}
.safety-notif .sn-label{color:inherit;opacity:.7;}
.safety-notif .sn-divider{width:1px;height:14px;background:currentColor;opacity:.15;}
.safety-notif .sn-dsmb{margin-left:auto;font-size:9px;opacity:.6;white-space:nowrap;}
.safety-notif .sn-expand{font-size:10px;opacity:.4;margin-left:4px;}
/* Safety expanded popup */
.safety-popup{display:none;position:absolute;top:100%;left:0;right:0;z-index:50;background:white;border:1px solid #e5e7eb;border-radius:10px;padding:12px 16px;box-shadow:0 8px 24px rgba(0,0,0,.12);margin-top:4px;}
.safety-popup.open{display:block;}
.safety-popup .sp-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
.safety-popup .sp-title{font-size:10px;font-weight:600;color:#D55E00;text-transform:uppercase;letter-spacing:.5px;}
.safety-popup .sp-close{border:none;background:none;cursor:pointer;font-size:12px;color:#9ca3af;padding:2px;}
.safety-popup .sp-body{display:flex;gap:12px;flex-wrap:wrap;align-items:center;}
.safety-popup .sp-stat{text-align:center;min-width:60px;}
.safety-popup .sp-stat .sv{font-size:16px;font-weight:700;}.safety-popup .sp-stat .sl{font-size:9px;color:#6b7280;}
.ae-timeline{display:flex;gap:3px;align-items:end;height:20px;}
.ae-bar{width:12px;border-radius:2px 2px 0 0;background:#fed7aa;min-height:2px;}
.ae-bar.serious{background:#fecaca;}

/* Arm Split Table View */
.arm-tabs{display:flex;gap:4px;align-items:center;}
.arm-tab{padding:3px 10px;border:1px solid #e5e7eb;border-radius:5px;background:white;color:#6b7280;cursor:pointer;font-size:10px;font-weight:600;min-width:24px;min-height:24px;display:flex;align-items:center;justify-content:center;gap:4px;transition:all .12s;}
.arm-tab:hover{border-color:#0072B2;color:#0072B2;}
.arm-tab.active{background:#0072B2;color:white;border-color:#0072B2;}
.arm-tab .arm-dot{width:5px;height:5px;border-radius:50%;}
.arm-tab.active .arm-dot{background:rgba(255,255,255,.6);}
.split-toggle{padding:3px 8px;border:1px solid #e5e7eb;border-radius:5px;background:white;color:#6b7280;cursor:pointer;font-size:10px;min-width:24px;min-height:24px;display:flex;align-items:center;gap:3px;}
.split-toggle.active{background:#eff6ff;border-color:#93c5fd;color:#1d4ed8;}
.split-container{display:flex;gap:0;flex:1;min-height:0;overflow:hidden;}
.split-pane{flex:1;min-width:0;display:flex;flex-direction:column;overflow:hidden;transition:flex .3s ease,opacity .3s ease;}
.split-pane:first-child{border-right:none;}
.split-pane.hidden-arm{flex:0;min-width:0;overflow:hidden;opacity:0;pointer-events:none;}
/* Split-mode inline detail panel (not overlay) */
.split-detail-inline{flex:1;min-width:0;display:flex;flex-direction:column;overflow:hidden;background:white;border-left:1px solid #e5e7eb;}
.split-diff{width:52px;flex-shrink:0;background:linear-gradient(180deg,#f0f4ff 0%,#fafbfc 100%);border-left:1px solid #dbeafe;border-right:1px solid #dbeafe;display:flex;flex-direction:column;overflow-y:auto;overflow-x:hidden;padding:0;transition:width .3s ease,opacity .3s ease;}
.split-diff .sd-head{padding:6px 4px;text-align:center;font-size:7px;font-weight:700;color:#0072B2;text-transform:uppercase;letter-spacing:.3px;border-bottom:1px solid #dbeafe;background:rgba(0,114,178,.05);white-space:nowrap;}
.split-diff .sd-spacer{height:29px;flex-shrink:0;border-bottom:1px solid #e5e7eb;}
.split-diff .sd-cell{padding:4px 3px;text-align:center;font-size:9px;font-weight:700;border-bottom:1px solid #f0f0f0;white-space:nowrap;line-height:1.1;min-height:33px;display:flex;flex-direction:column;align-items:center;justify-content:center;}
.sd-cell .sd-abs{font-size:9px;}.sd-cell .sd-pct{font-size:7px;color:#6b7280;font-weight:400;}
.sd-better{color:#009E73;}.sd-worse{color:#D55E00;}.sd-neutral{color:#6b7280;}.sd-sig{font-size:6px;color:#0072B2;font-weight:700;}
.split-pane .sp-header{padding:6px 12px;background:#f9fafb;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;flex-shrink:0;}
.split-pane .sp-title{font-size:11px;font-weight:700;display:flex;align-items:center;gap:6px;}
.split-pane .sp-count{font-size:9px;color:#9ca3af;}
.split-pane .sp-mean{font-size:9px;color:#6b7280;margin-top:2px;}
.split-pane .tbl-wrap{overflow-y:auto;overflow-x:auto;flex:1;min-height:0;}
.split-pane table.pt-tbl thead th{position:sticky;top:0;}
/* Comparison mode badge */
.cmp-badge{font-size:8px;padding:1px 5px;border-radius:3px;font-weight:600;margin-left:4px;}
.cmp-badge.better{background:#dcfce7;color:#166534;}
.cmp-badge.worse{background:#fef2f2;color:#991b1b;}
.cmp-badge.same{background:#f3f4f6;color:#6b7280;}
/* dose_bar renderer */
.dose-bar-strip{display:flex;gap:2px;height:100%;align-items:end;padding:2px 0;}
.dose-bar{flex:1;border-radius:2px 2px 0 0;min-height:2px;transition:height .2s;}
.dose-bar-label{font-size:7px;color:#9ca3af;text-align:center;margin-top:1px;}


/* Metrics Grid — TD-3 해결: 렌더러 타입 표시 */
.metrics-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:12px;}
.metric-card{background:white;border:1px solid #e5e7eb;border-radius:10px;padding:14px;position:relative;cursor:pointer;transition:all .2s;min-height:130px;box-shadow:0 1px 3px rgba(0,0,0,.04);overflow:hidden;}
.metric-card:hover{border-color:#0072B2;box-shadow:0 2px 8px rgba(0,114,178,.1);}
.metric-card .expand-hint{position:absolute;top:6px;right:6px;font-size:8px;color:#d1d5db;transition:color .2s;}
.metric-card:hover .expand-hint{color:#0072B2;}
.mc-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px;}
.mc-name{font-size:11px;font-weight:600;color:#374151;display:flex;align-items:center;gap:4px;}
.mc-name .dot{width:5px;height:5px;border-radius:50%;}
.mc-badge{font-size:8px;font-weight:600;padding:1px 5px;border-radius:3px;min-width:24px;min-height:24px;display:flex;align-items:center;justify-content:center;}
.mc-badge.sig{background:#dcfce7;color:#166534;}
.mc-badge.ns{background:#f3f4f6;color:#6b7280;}
.mc-badge.alert{background:#fef3c7;color:#92400e;}
.mc-badge.derived{background:#ede9fe;color:#5b21b6;}
.mc-renderer{font-size:7px;color:#9ca3af;position:absolute;bottom:4px;right:8px;left:8px;font-family:'SF Mono',Monaco,monospace;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-align:right;}
.mc-chart{height:80px;position:relative;}
.mc-chart canvas{width:100%;height:100%;}
.mc-footer{display:flex;justify-content:space-between;align-items:center;margin-top:4px;}
.mc-delta{font-size:11px;font-weight:700;font-family:'SF Mono',Monaco,monospace;}
.mc-delta.good{color:#009E73;}.mc-delta.bad{color:#D55E00;}.mc-delta.neutral{color:#6b7280;}
.mc-range{font-size:9px;color:#9ca3af;}

/* Chart Modal */
.chart-modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.4);z-index:100;align-items:center;justify-content:center;}
.chart-modal-overlay.open{display:flex;}
.chart-modal{background:white;border-radius:12px;padding:20px;width:700px;max-width:90vw;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3);}
.cm-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
.cm-title{font-size:15px;font-weight:700;color:#1f2937;display:flex;align-items:center;gap:6px;}
.cm-close{padding:4px 10px;border:1px solid #e5e7eb;border-radius:6px;background:white;cursor:pointer;font-size:13px;color:#6b7280;min-width:24px;min-height:24px;}
.cm-chart{height:250px;position:relative;margin-bottom:12px;}
.cm-chart canvas{width:100%;height:100%;}
.cm-legend{display:flex;gap:16px;font-size:11px;color:#6b7280;margin-bottom:8px;flex-wrap:wrap;}
.cm-legend span{display:flex;align-items:center;gap:4px;}
.cm-legend .ln{width:20px;height:2px;border-radius:1px;}
.cm-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;}
.cm-stat{background:#f9fafb;border:1px solid #f3f4f6;border-radius:6px;padding:8px 10px;}
.cm-stat-label{font-size:9px;color:#6b7280;margin-bottom:2px;}
.cm-stat-value{font-size:14px;font-weight:700;color:#1f2937;}

/* Chart Guide — 모달 하단 해석 가이드 */
.cm-guide{margin-top:12px;display:flex;flex-direction:column;gap:8px;}
.cm-guide-section{background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:10px 14px;}
.cm-guide-section.interpret{border-left:3px solid #0072B2;}
.cm-guide-section.reading{border-left:3px solid #94a3b8;}
.cm-guide-section.action{border-left:3px solid #009E73;}
.cm-guide-section.caution{border-left:3px solid #E69F00;}
.cm-guide-title{font-size:10px;font-weight:700;color:#374151;text-transform:uppercase;letter-spacing:.3px;margin-bottom:4px;display:flex;align-items:center;gap:5px;}
.cm-guide-text{font-size:11px;color:#4b5563;line-height:1.5;}

/* TD-3: 비숫자 렌더러 스타일 */
.img-strip{display:flex;gap:4px;height:100%;align-items:end;padding:2px 0;}
.img-thumb{flex:1;border-radius:4px;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;gap:2px;position:relative;}
.img-thumb .ph{width:100%;aspect-ratio:1;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:16px;border:1px solid #e5e7eb;}
.img-thumb .ph-label{font-size:7px;color:#9ca3af;}
.severity-strip{display:flex;gap:2px;height:100%;align-items:end;}
.sev-col{flex:1;display:flex;flex-direction:column;justify-content:flex-end;gap:1px;height:100%;}
.sev-seg{border-radius:2px;min-height:2px;transition:height .2s;}
.sev-legend{display:flex;gap:8px;font-size:8px;color:#6b7280;margin-top:2px;}
.sev-legend span{display:flex;align-items:center;gap:3px;}
.sev-legend .sq{width:6px;height:6px;border-radius:1px;}

/* TD-6: 파생 지표 뱃지 */
.mc-derived{position:absolute;top:6px;left:8px;font-size:7px;color:#7c3aed;background:#ede9fe;padding:1px 4px;border-radius:3px;font-weight:600;}
.cm-guide-text b{color:#111827;}
.cm-guide-chips{display:flex;flex-wrap:wrap;gap:4px;margin-top:6px;}
.cm-guide-chip{font-size:9px;padding:2px 8px;border-radius:10px;background:white;border:1px solid #e5e7eb;color:#6b7280;}
.cm-guide-chip.good{background:#ecfdf5;border-color:#86efac;color:#065f46;}
.cm-guide-chip.warn{background:#fffbeb;border-color:#fcd34d;color:#92400e;}
.cm-guide-chip.info{background:#eff6ff;border-color:#93c5fd;color:#1e40af;}

/* Side Panel — 오버레이 슬라이드 패널 (Action Center + AI) */
.side-panel{position:absolute;top:0;right:0;bottom:0;width:320px;background:white;border-left:1px solid #d1d5db;display:flex;flex-direction:column;transition:transform .25s ease,box-shadow .25s ease;flex-shrink:0;z-index:40;transform:translateX(100%);box-shadow:none;pointer-events:none;}
.side-panel.open{transform:translateX(0);box-shadow:-4px 0 20px rgba(0,0,0,.1);pointer-events:auto;}
.sp-toggle{position:absolute;left:-36px;top:12px;width:32px;height:32px;background:white;border:1px solid #d1d5db;border-right:none;border-radius:6px 0 0 6px;display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:41;box-shadow:-2px 0 6px rgba(0,0,0,.06);font-size:14px;color:#6b7280;transition:all .15s;pointer-events:auto;}
.sp-toggle:hover{background:#eff6ff;color:#0072B2;}
.sp-toggle .sp-badge{position:absolute;top:-4px;right:-4px;width:16px;height:16px;background:#D55E00;color:white;font-size:8px;font-weight:700;border-radius:50%;display:flex;align-items:center;justify-content:center;}
.sp-tabs{display:flex;border-bottom:1px solid #e5e7eb;flex-shrink:0;}
.sp-tab-btn{flex:1;padding:8px 4px;font-size:10px;font-weight:600;color:#6b7280;background:none;border:none;border-bottom:2px solid transparent;cursor:pointer;transition:all .15s;text-align:center;}
.sp-tab-btn.active{color:#0072B2;border-bottom-color:#0072B2;}
.sp-tab-btn:hover{background:#f9fafb;}
.sp-body{flex:1;overflow-y:auto;padding:10px 12px;}
.sp-pane{display:none;}
.sp-pane.active{display:block;}

/* Action cards inside panel — stacked vertically */
.ac-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
.ac-title{font-size:10px;font-weight:600;color:#374151;text-transform:uppercase;letter-spacing:.5px;display:flex;align-items:center;gap:5px;}
.ac-title .ac-icon{font-size:12px;}
.ac-badge{font-size:9px;background:#fef3c7;color:#92400e;padding:1px 6px;border-radius:3px;font-weight:500;}
.ac-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;}
.ac-card{border:1px solid #e5e7eb;border-radius:8px;padding:8px 10px;cursor:pointer;transition:all .15s;position:relative;}
.ac-card:hover{border-color:#0072B2;box-shadow:0 2px 8px rgba(0,114,178,.08);}
.ac-card.urgent{border-left:3px solid #D55E00;}
.ac-card.warning{border-left:3px solid #E69F00;}
.ac-card.info{border-left:3px solid #0072B2;}
.ac-card.success{border-left:3px solid #009E73;}
.ac-card-icon{font-size:12px;margin-bottom:2px;}
.ac-card-title{font-size:9px;font-weight:600;color:#1f2937;margin-bottom:1px;}
.ac-card-desc{font-size:8px;color:#6b7280;line-height:1.3;}
.ac-card-count{position:absolute;top:4px;right:6px;font-size:7px;font-weight:700;background:#fef3c7;color:#92400e;padding:1px 4px;border-radius:8px;}
.ac-card-count.zero{background:#f3f4f6;color:#9ca3af;}
.ac-sub{display:flex;gap:4px;margin-top:6px;flex-wrap:wrap;}
.ac-quick{display:flex;align-items:center;gap:3px;padding:3px 7px;background:#f9fafb;border:1px solid #e5e7eb;border-radius:4px;font-size:8px;color:#374151;cursor:pointer;transition:all .12s;}
.ac-quick:hover{background:#eff6ff;border-color:#93c5fd;color:#1d4ed8;}
.ac-quick .aq-icon{font-size:9px;}

/* AI items inside panel */
.ai-strip-inner{padding:0;}
.ai-title{font-size:10px;font-weight:600;color:#6b7280;text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px;}
.ai-items{display:flex;flex-direction:column;gap:3px;}
.ai-item{display:flex;align-items:flex-start;gap:6px;padding:5px 8px;border-radius:6px;font-size:10px;line-height:1.4;cursor:pointer;transition:all .15s;min-height:22px;}
.ai-item:hover{filter:brightness(.95);}
.ai-item.alert{background:#fef3c7;color:#92400e;}
.ai-item.finding{background:#f0fdf4;color:#166534;}
.ai-item.info{background:#eff6ff;color:#1e40af;}
.ai-item.safety-alert{background:#fef2f2;color:#991b1b;}
.ai-icon{font-size:11px;flex-shrink:0;margin-top:1px;}
.ai-text b{font-weight:600;}
.ai-time{font-size:8px;color:#9ca3af;margin-left:auto;flex-shrink:0;white-space:nowrap;}
.ai-action{font-size:8px;margin-left:auto;flex-shrink:0;opacity:.6;white-space:nowrap;}

/* Table Tab */
.table-area-wrap{display:flex;flex:1;min-height:0;overflow:hidden;position:relative;}
.table-area{flex:1;min-width:0;overflow-y:auto;overflow-x:auto;display:flex;flex-direction:column;}

/* Mini-timeline — 테이블 탭 상단 인터랙티브 타임라인 */
/* 미니 타임라인 — 테이블 탭 상단, 디자이너 가독성 우선 */
.tb-mini-tl{background:white;border:1px solid #e5e7eb;border-radius:10px;padding:14px 18px 8px;margin-bottom:6px;flex-shrink:0;display:flex;flex-direction:column;gap:4px;}
.tb-mini-tl .mtl-top-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:2px;}
.tb-mini-tl .mtl-label{font-size:11px;color:#374151;font-weight:700;white-space:nowrap;flex-shrink:0;}
.tb-mini-tl .mtl-info{font-size:11px;color:#374151;font-weight:600;white-space:nowrap;flex-shrink:0;}
.tb-mini-tl .mtl-bar{position:relative;width:100%;height:28px;background:#f3f4f6;border-radius:6px;overflow:visible;cursor:pointer;}
.tb-mini-tl .mtl-phase{position:absolute;top:0;height:100%;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:600;color:white;border-radius:4px;overflow:hidden;letter-spacing:-0.2px;}
.tb-mini-tl .mtl-phase.future{opacity:.35;border:1.5px dashed;background:transparent;color:#6b7280;}
/* 기준점 마커 (오늘/M0/BL) — 바 전체 높이 + 점 영역까지 연장 */
.tb-mini-tl .mtl-now{position:absolute;top:0;height:calc(100% + 30px);width:0;z-index:8;pointer-events:none;}
.tb-mini-tl .mtl-now-line{position:absolute;top:-4px;left:0;width:2px;height:calc(100% + 8px);background:#D55E00;border-radius:1px;transform:translateX(-50%);}
.tb-mini-tl .mtl-now-label{position:absolute;top:-18px;left:50%;transform:translateX(-50%);font-size:9px;color:white;font-weight:700;background:#D55E00;padding:1px 6px;border-radius:3px;white-space:nowrap;line-height:1.4;}
.tb-mini-tl .mtl-now-label::after{content:'';position:absolute;bottom:-3px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:3px solid transparent;border-right:3px solid transparent;border-top:3px solid #D55E00;}
/* 과거/미래 배경 zone */
.tb-mini-tl .mtl-zone-past{position:absolute;top:0;left:0;height:100%;background:rgba(0,114,178,.05);border-radius:4px 0 0 4px;z-index:1;pointer-events:none;}
.tb-mini-tl .mtl-zone-future{position:absolute;top:0;height:100%;right:0;background:repeating-linear-gradient(135deg,transparent,transparent 2px,rgba(156,163,175,.05) 2px,rgba(156,163,175,.05) 4px);border-radius:0 4px 4px 0;z-index:1;pointer-events:none;}
/* 드래그 핸들 */
.tb-mini-tl .mtl-handle{position:absolute;top:-6px;width:16px;height:calc(100% + 12px);z-index:20;cursor:ew-resize;display:flex;align-items:center;justify-content:center;transform:translateX(-50%);}
.tb-mini-tl .mtl-handle-grip{width:10px;height:22px;background:#D55E00;border-radius:5px;border:2px solid white;box-shadow:0 1px 4px rgba(213,94,0,.4);transition:transform .1s;}
.tb-mini-tl .mtl-handle:hover .mtl-handle-grip{transform:scale(1.15);}
.tb-mini-tl .mtl-handle .mtl-tooltip{position:absolute;top:-24px;left:50%;transform:translateX(-50%);background:#1f2937;color:white;font-size:10px;padding:3px 7px;border-radius:4px;white-space:nowrap;opacity:0;transition:opacity .15s;pointer-events:none;}
.tb-mini-tl .mtl-handle:hover .mtl-tooltip,.tb-mini-tl .mtl-handle.dragging .mtl-tooltip{opacity:1;}
/* 방문 점 — 바 아래에 별도 행으로 배치 (겹침 방지) */
.tb-mini-tl .mtl-vdot{position:absolute;top:calc(100% + 10px);width:10px;height:10px;border-radius:50%;background:white;border:2.5px solid #0072B2;transform:translateX(-50%);z-index:6;cursor:pointer;transition:all .15s;}
.tb-mini-tl .mtl-vdot:hover{transform:translateX(-50%) scale(1.3);box-shadow:0 0 0 4px rgba(0,114,178,.12);}
.tb-mini-tl .mtl-vdot.active{background:#0072B2;border-color:#0072B2;transform:translateX(-50%) scale(1.2);box-shadow:0 0 0 4px rgba(0,114,178,.18);}
.tb-mini-tl .mtl-vdot.future{opacity:.3;border-color:#9ca3af;}
/* 방문 라벨 — 점 아래 */
.tb-mini-tl .mtl-vlabel{position:absolute;top:calc(100% + 4px);left:50%;transform:translateX(-50%);font-size:10px;color:#6b7280;white-space:nowrap;pointer-events:none;font-weight:600;text-align:center;}
.tb-mini-tl .mtl-vdot.active .mtl-vlabel{color:#0072B2;font-weight:700;font-size:11px;}
.ctrl-section{background:white;border:1px solid #e5e7eb;border-radius:8px;padding:8px 14px;margin-bottom:6px;flex-shrink:0;}
.ctrl-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
.ctrl-group{display:flex;align-items:center;gap:5px;}
.ctrl-group label{font-size:10px;color:#6b7280;font-weight:600;}
.t-btn{padding:3px 7px;border:1px solid #e5e7eb;border-radius:4px;background:white;color:#6b7280;cursor:pointer;font-size:10px;min-width:24px;min-height:24px;display:flex;align-items:center;justify-content:center;}
.t-btn.active{background:#0072B2;color:white;border-color:#0072B2;}
.sel-sm{padding:3px 5px;border:1px solid #e5e7eb;border-radius:4px;font-size:10px;background:white;min-height:24px;}
.dn-ctrl{display:flex;align-items:center;gap:4px;padding:3px 6px;background:#f9fafb;border:1px solid #e5e7eb;border-radius:4px;font-size:10px;}
.dn-ctrl button{background:none;border:none;cursor:pointer;font-size:11px;color:#0072B2;min-width:24px;min-height:24px;}
.search-in{padding:3px 5px;border:1px solid #e5e7eb;border-radius:4px;font-size:10px;width:110px;min-height:24px;}
.src-legend{display:flex;gap:8px;align-items:center;margin-bottom:3px;font-size:9px;color:#6b7280;flex-shrink:0;}
.sd{width:6px;height:6px;border-radius:2px;display:inline-block;}
.sd.emr{background:#0072B2;}.sd.wear{background:#009E73;}.sd.ema{background:#CC79A7;}
.tbl-section{background:white;border:1px solid #e5e7eb;border-radius:8px;overflow:hidden;flex:1;display:flex;flex-direction:column;min-height:0;}
.tbl-wrap{overflow-y:auto;overflow-x:auto;flex:1;min-height:0;}
table.pt-tbl{width:100%;border-collapse:collapse;font-size:11px;}
table.pt-tbl thead th{text-align:left;font-size:9px;color:#6b7280;font-weight:600;padding:6px 5px;border-bottom:2px solid #e5e7eb;background:#f9fafb;position:sticky;top:0;z-index:10;white-space:nowrap;}
table.pt-tbl thead th:first-child{position:sticky;left:0;z-index:11;background:#f9fafb;}
table.pt-tbl thead th .cs{display:inline-block;width:4px;height:4px;border-radius:2px;margin-right:2px;vertical-align:middle;}
table.pt-tbl thead th .sort-icon{font-size:8px;color:#d1d5db;margin-left:2px;}
table.pt-tbl tbody td{padding:6px 5px;border-bottom:1px solid #f1f5f9;font-size:10px;}
table.pt-tbl tbody td:first-child{position:sticky;left:0;background:white;z-index:5;}
table.pt-tbl tbody tr{cursor:pointer;transition:background .1s;}
table.pt-tbl tbody tr:hover{background:#f8fafc;}
table.pt-tbl tbody tr:hover td:first-child{background:#f8fafc;}
table.pt-tbl tbody tr.selected{background:#eff6ff;}
table.pt-tbl tbody tr.selected td:first-child{background:#eff6ff;}
table.pt-tbl tbody tr.alert-row{background:#fffbeb;}
table.pt-tbl tbody tr.alert-row td:first-child{background:#fffbeb;}
.pid{font-weight:600;color:#374151;white-space:nowrap;}
.gb{display:inline-block;padding:1px 3px;border-radius:3px;font-size:8px;font-weight:600;margin-left:3px;}
.gb.exp{background:#dbeafe;color:#0072B2;}.gb.ctrl{background:#fce7f3;color:#CC79A7;}
.sv{display:inline-block;width:4px;height:4px;border-radius:50%;margin-right:3px;}
.sv.good{background:#009E73;}.sv.warn{background:#E69F00;}.sv.bad{background:#D55E00;}
.status-badge{font-size:7px;padding:1px 4px;border-radius:3px;font-weight:600;margin-left:4px;}
.status-badge.verified{background:#dcfce7;color:#166534;}
.status-badge.query{background:#fef3c7;color:#92400e;}
.status-badge.review{background:#dbeafe;color:#1d4ed8;}
.status-badge.missing-visit{background:#fef2f2;color:#991b1b;}
.cd{font-weight:700;font-family:'SF Mono',Monaco,monospace;font-size:10px;}
.cd.good{color:#009E73;}.cd.bad{color:#D55E00;}.cd.neutral{color:#6b7280;}
.cr-cell{font-size:9px;color:#9ca3af;display:block;}.ce{color:#d1d5db;font-style:italic;}
/* 테이블 셀 스파크라인 */
.cell-spark{display:flex;align-items:center;gap:4px;}
.cell-spark svg{flex-shrink:0;}
.cell-vals{display:flex;flex-direction:column;gap:0;min-width:0;}
.cell-cur{font-size:10px;font-weight:600;color:#374151;font-family:'SF Mono',Monaco,monospace;white-space:nowrap;}
.cell-delta{font-size:9px;font-weight:700;font-family:'SF Mono',Monaco,monospace;white-space:nowrap;}
.cell-delta.good{color:#009E73;}.cell-delta.bad{color:#D55E00;}.cell-delta.neutral{color:#6b7280;}
/* 데이터 주기 배지 */
.freq-badge{display:inline-flex;align-items:center;gap:2px;padding:1px 4px;border-radius:3px;font-size:7px;font-weight:600;margin-left:3px;vertical-align:middle;}
.freq-badge.continuous{background:#dcfce7;color:#166534;}
.freq-badge.daily{background:#dbeafe;color:#1d4ed8;}
.freq-badge.weekly{background:#fef3c7;color:#92400e;}
.freq-badge.per_visit{background:#f3f4f6;color:#6b7280;}
/* 집계 기간 선택기 */
.agg-selector{display:flex;align-items:center;gap:0;background:#f1f5f9;border-radius:5px;padding:2px;}
.agg-btn{padding:3px 8px;font-size:9px;font-weight:600;color:#64748b;cursor:pointer;border:none;background:none;border-radius:4px;transition:all .12s;white-space:nowrap;}
.agg-btn:hover{color:#374151;background:rgba(255,255,255,.5);}
.agg-btn.active{background:white;color:#0072B2;box-shadow:0 1px 2px rgba(0,0,0,.08);}
/* 스크럽 변화 하이라이트 */
@keyframes cellFlash{0%{background:#eff6ff;}100%{background:transparent;}}
.cell-changed{animation:cellFlash .8s ease-out;}
/* 시간 단위 그리드 — 집계 기간별 셀 행 */
.mtl-grid-row{display:flex;gap:1px;margin-top:4px;overflow-x:auto;padding-bottom:2px;}
.mtl-grid-cell{flex-shrink:0;min-height:18px;border-radius:3px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:7px;font-weight:600;color:#94a3b8;transition:all .12s;border:1px solid transparent;position:relative;flex-direction:column;line-height:1.2;padding:1px 2px;}
.mtl-grid-cell .gc-date{font-size:6.5px;font-weight:500;opacity:.7;}
.mtl-grid-cell:hover{border-color:#0072B2;color:#0072B2;z-index:2;}
.mtl-grid-cell.active{background:#0072B2;color:white;border-color:#0072B2;box-shadow:0 1px 3px rgba(0,114,178,.3);}
.mtl-grid-cell.has-data{background:#e0f2fe;}
.mtl-grid-cell.active.has-data{background:#0072B2;}
.mtl-grid-cell.no-data{background:#f9fafb;}
/* 스냅샷 라벨 */
.snapshot-label{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;background:#eff6ff;border:1px solid #bfdbfe;border-radius:4px;}
.pag-row{display:flex;align-items:center;justify-content:space-between;padding:6px 12px;background:white;border:1px solid #e5e7eb;border-radius:8px;font-size:10px;color:#6b7280;flex-shrink:0;margin-top:6px;}

/* Detail Panel */
.detail-panel{position:absolute;top:0;right:0;bottom:0;width:38%;background:white;border-left:1px solid #e5e7eb;display:flex;flex-direction:column;max-height:100%;z-index:30;transform:translateX(100%);transition:transform .3s ease,box-shadow .3s ease;box-shadow:none;}
.detail-panel.open{transform:translateX(0);box-shadow:-4px 0 16px rgba(0,0,0,.1);}
.dp-header{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;border-bottom:1px solid #e5e7eb;background:#f9fafb;flex-shrink:0;}
.dp-title{font-size:13px;font-weight:700;color:#374151;display:flex;align-items:center;gap:4px;}
.dp-close{padding:3px 7px;border:1px solid #e5e7eb;border-radius:4px;background:white;cursor:pointer;font-size:11px;color:#6b7280;min-width:24px;min-height:24px;}
.dp-nav{display:flex;gap:3px;}
.dp-nav button{padding:2px 5px;border:1px solid #e5e7eb;border-radius:4px;background:white;cursor:pointer;font-size:10px;min-width:24px;min-height:24px;}
.dp-body{flex:1;overflow-y:auto;padding:12px;}
.chart-card{background:#f9fafb;border:1px solid #e5e7eb;border-radius:6px;padding:10px;margin-bottom:10px;}
.chart-card-title{font-size:10px;font-weight:600;color:#374151;margin-bottom:4px;}
.mini-chart{height:75px;position:relative;}
.mini-chart canvas{width:100%;height:100%;}
.chart-x{display:flex;justify-content:space-between;font-size:7px;color:#9ca3af;margin-top:1px;}
.chart-sum{display:flex;gap:8px;margin-top:3px;font-size:9px;color:#6b7280;}
.chart-sum strong{color:#374151;}
.fs-title{font-size:10px;font-weight:600;color:#374151;margin:10px 0 4px;}
.fs-table{width:100%;border-collapse:collapse;font-size:9px;}
.fs-table th{font-size:8px;color:#9ca3af;font-weight:600;padding:3px;border-bottom:1px solid #e5e7eb;text-align:center;}
.fs-table th:first-child{text-align:left;}
.fs-table td{padding:3px;text-align:center;border-bottom:1px solid #f1f5f9;font-family:'SF Mono',Monaco,monospace;font-size:8px;}
.fs-table td:first-child{text-align:left;font-weight:600;color:#374151;font-family:-apple-system,sans-serif;}
.fg{color:#009E73;background:rgba(0,158,115,.05);}.fb{color:#D55E00;background:rgba(213,94,0,.05);}.fc{font-weight:700;outline:1.5px solid #0072B2;border-radius:2px;}

/* Clean Room Tab */
.cr-session{display:flex;align-items:center;gap:12px;padding:6px 14px;background:#0f172a;border-radius:8px;margin-bottom:8px;flex-shrink:0;flex-wrap:wrap;}
.cr-live{display:flex;align-items:center;gap:4px;}
.cr-dot{width:6px;height:6px;background:#009E73;border-radius:50%;animation:crpulse 2s infinite;}
@keyframes crpulse{0%,100%{opacity:1;}50%{opacity:.3;}}
.cr-live-label{font-size:10px;color:#009E73;font-weight:600;}
.cr-meta{font-size:10px;color:#64748b;}.cr-meta b{color:#94a3b8;}
.cr-chip{padding:2px 6px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:4px;font-size:9px;color:#94a3b8;}
.cr-chip.privacy{color:#009E73;border-color:rgba(0,158,115,.3);}
.cr-right{margin-left:auto;display:flex;align-items:center;gap:8px;}
.cr-audit{font-size:9px;color:#E69F00;display:flex;align-items:center;gap:3px;}
.cr-body{display:flex;flex:1;min-height:0;gap:8px;overflow:hidden;}
.schema-panel{width:220px;background:white;border:1px solid #e5e7eb;border-radius:8px;display:flex;flex-direction:column;flex-shrink:0;overflow:hidden;}
.sp-header{padding:8px 12px;border-bottom:1px solid #e5e7eb;font-size:10px;font-weight:600;color:#374151;display:flex;justify-content:space-between;align-items:center;}
.sp-search{width:100%;padding:4px 8px;border:1px solid #e5e7eb;border-radius:4px;font-size:10px;margin:6px 8px;width:calc(100% - 16px);}
.sp-list{flex:1;overflow-y:auto;padding:4px;}
.sp-server{padding:4px 8px;font-size:9px;font-weight:600;color:#6b7280;text-transform:uppercase;letter-spacing:.5px;margin-top:6px;}
.sp-table{display:flex;align-items:center;gap:6px;padding:5px 10px;border-radius:4px;font-size:11px;color:#374151;cursor:pointer;margin-bottom:1px;}
.sp-table:hover{background:#f3f4f6;}
.sp-table.active{background:#eff6ff;color:#0072B2;font-weight:600;}
.sp-table .sp-icon{font-size:12px;width:16px;text-align:center;}
.sp-table .sp-count{margin-left:auto;font-size:9px;color:#9ca3af;font-family:'SF Mono',Monaco,monospace;}
.data-grid{flex:1;display:flex;flex-direction:column;min-width:0;overflow:hidden;}
.dg-toolbar{display:flex;align-items:center;gap:8px;padding:8px 12px;background:white;border:1px solid #e5e7eb;border-radius:8px;margin-bottom:6px;flex-shrink:0;flex-wrap:wrap;}
.dg-title{font-size:12px;font-weight:700;color:#1f2937;display:flex;align-items:center;gap:6px;}
.dg-title .t-icon{font-size:14px;}
.dg-pills{display:flex;gap:4px;}
.dg-pill{padding:2px 6px;border:1px solid #e5e7eb;border-radius:4px;font-size:9px;color:#6b7280;cursor:pointer;min-width:24px;min-height:24px;display:flex;align-items:center;}
.dg-pill.active{background:#0072B2;color:white;border-color:#0072B2;}
.dg-filter{display:flex;align-items:center;gap:4px;margin-left:auto;}
.dg-privacy{display:flex;align-items:center;gap:4px;padding:3px 8px;background:rgba(0,158,115,.06);border:1px solid rgba(0,158,115,.2);border-radius:4px;font-size:9px;color:#166534;}
/* TD-4 해결: 계층 집계 티어 선택 */
.agg-tier{display:flex;gap:2px;margin-left:8px;}
.agg-tier button{padding:2px 6px;border:1px solid #e5e7eb;border-radius:3px;background:white;font-size:8px;color:#6b7280;cursor:pointer;}
.agg-tier button.active{background:#6366f1;color:white;border-color:#6366f1;}
.dg-table-wrap{flex:1;overflow:auto;background:white;border:1px solid #e5e7eb;border-radius:8px;}
table.dg-tbl{width:100%;border-collapse:collapse;font-size:10px;}
table.dg-tbl thead th{position:sticky;top:0;z-index:10;background:#f9fafb;border-bottom:2px solid #e5e7eb;padding:6px 8px;text-align:left;font-size:9px;color:#6b7280;font-weight:600;white-space:nowrap;}
table.dg-tbl thead th .col-type{font-size:8px;color:#9ca3af;font-weight:400;font-family:'SF Mono',Monaco,monospace;display:block;}
table.dg-tbl tbody td{padding:5px 8px;border-bottom:1px solid #f1f5f9;font-family:'SF Mono',Monaco,monospace;font-size:9px;white-space:nowrap;}
table.dg-tbl tbody tr:hover{background:#f8fafc;}
.masked{color:#d1d5db;font-style:italic;letter-spacing:1px;}
.pseudo{color:#8b5cf6;font-weight:600;}
.hash-val{color:#9ca3af;font-size:8px;max-width:80px;overflow:hidden;text-overflow:ellipsis;display:inline-block;}
.json-val{color:#0ea5e9;cursor:pointer;max-width:180px;overflow:hidden;text-overflow:ellipsis;display:inline-block;}
.json-val:hover{text-decoration:underline;}
.ts-val{color:#374151;}.null-val{color:#d1d5db;font-style:italic;}
.bool-val.true{color:#009E73;}.bool-val.false{color:#D55E00;}
.num-val{color:#0072B2;}
.dg-footer{display:flex;align-items:center;justify-content:space-between;padding:6px 12px;background:white;border:1px solid #e5e7eb;border-radius:8px;font-size:10px;color:#6b7280;flex-shrink:0;margin-top:6px;}
.dg-footer-privacy{display:flex;align-items:center;gap:10px;}
.privacy-badge{display:flex;align-items:center;gap:3px;font-size:9px;}
.privacy-badge.ok{color:#009E73;}.privacy-badge.warn{color:#E69F00;}
.json-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:200;align-items:center;justify-content:center;}
.json-modal.open{display:flex;}
.json-box{background:#1e293b;border-radius:10px;padding:16px;max-width:500px;width:90%;max-height:60vh;overflow-y:auto;}
.json-box-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.json-box-title{color:#e2e8f0;font-size:12px;font-weight:600;}
.json-box-close{color:#94a3b8;cursor:pointer;font-size:13px;padding:2px 6px;border:1px solid #334155;border-radius:4px;background:transparent;min-width:24px;min-height:24px;}
.json-box pre{font-family:'SF Mono',Monaco,monospace;font-size:10px;color:#94a3b8;line-height:1.5;white-space:pre-wrap;}
.json-box .jk{color:#7dd3fc;}.json-box .js{color:#86efac;}.json-box .jn{color:#fbbf24;}.json-box .jb{color:#f472b6;}

/* Study Scenario Switcher — 사이드바에서 연구 전환 (모드 아님!) */
.study-scenarios{padding:8px;border-top:1px solid rgba(255,255,255,.05);margin-top:4px;}
.study-scenarios .sc-label{font-size:8px;color:#64748b;padding:3px 8px;text-transform:uppercase;letter-spacing:.5px;}
.sc-item{display:flex;align-items:center;gap:6px;padding:5px 8px;border-radius:4px;color:#94a3b8;font-size:10px;cursor:pointer;margin-bottom:1px;transition:all .12s;}
.sc-item:hover{background:rgba(255,255,255,.05);}
.sc-item.active{background:rgba(59,130,246,.15);color:#60a5fa;}
.sc-item .sc-dot{width:5px;height:5px;border-radius:50%;flex-shrink:0;}
.sc-item .sc-type{font-size:8px;color:#64748b;margin-left:auto;}
/* 타임라인 자동 컨텍스트 배지 */
.tl-auto-badge{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;background:rgba(0,114,178,.06);border:1px solid rgba(0,114,178,.15);border-radius:4px;font-size:9px;color:#0072B2;font-weight:500;}
.tl-auto-badge .ab-icon{font-size:10px;}
.tl-config-info{font-size:9px;color:#9ca3af;white-space:nowrap;}


/* v11: binary_strip renderer */
.binary-strip{display:flex;gap:3px;height:100%;align-items:center;padding:2px 0;}
.bin-dot{width:10px;height:10px;border-radius:50%;border:1.5px solid #e5e7eb;}
.bin-dot.on{background:#009E73;border-color:#009E73;}
.bin-dot.off{background:white;border-color:#d1d5db;}
.bin-dot.null{background:#f3f4f6;border-color:#e5e7eb;}

/* v11: event_strip renderer */
.event-strip{display:flex;gap:2px;height:100%;align-items:end;padding:2px 0;}
.evt-marker{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;gap:1px;}
.evt-marker .evt-icon{font-size:12px;}
.evt-marker .evt-label{font-size:7px;color:#9ca3af;}

/* v11: Retro mode styles */
.retro-badge{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;background:rgba(99,102,241,.06);border:1px solid rgba(99,102,241,.15);border-radius:4px;font-size:9px;color:#6366f1;font-weight:500;}
.retro-analysis-marker{position:absolute;top:-4px;height:calc(100% + 8px);width:2px;background:#6366f1;z-index:10;pointer-events:none;}
.retro-analysis-marker::after{content:'분석 기준일';position:absolute;top:-14px;left:50%;transform:translateX(-50%);font-size:8px;color:#6366f1;font-weight:600;white-space:nowrap;}
.ac-retro-card{border:1px solid #e5e7eb;border-radius:8px;padding:10px 12px;cursor:pointer;transition:all .15s;position:relative;border-left:3px solid #6366f1;}
.ac-retro-card:hover{border-color:#6366f1;box-shadow:0 2px 8px rgba(99,102,241,.08);}

.version-tag{position:fixed;bottom:4px;right:8px;font-size:9px;color:#d1d5db;z-index:1;}

/* 임시저장 섹션 */
.draft-section{padding:6px 10px;border-bottom:1px solid rgba(255,255,255,.05);}
.draft-label{font-size:9px;color:#64748b;padding:2px 8px 4px;display:flex;align-items:center;gap:4px;}
.draft-item{display:flex;align-items:center;gap:6px;padding:5px 8px;border-radius:4px;color:#94a3b8;font-size:10px;cursor:pointer;margin-bottom:1px;transition:all .12s;position:relative;}
.draft-item:hover{background:rgba(255,255,255,.05);}
.draft-item .draft-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.draft-item .draft-dot.red{background:#ef4444;box-shadow:0 0 4px rgba(239,68,68,.4);}
.draft-item .draft-dot.yellow{background:#eab308;box-shadow:0 0 4px rgba(234,179,8,.4);}
.draft-item .draft-status{font-size:8px;margin-left:auto;padding:1px 5px;border-radius:3px;font-weight:500;}
.draft-item .draft-status.red{color:#fca5a5;background:rgba(239,68,68,.12);}
.draft-item .draft-status.yellow{color:#fde68a;background:rgba(234,179,8,.12);}

/* 연구 유형 칩 */
.rtype-chip{display:inline-flex;align-items:center;padding:1px 6px;border-radius:3px;font-size:8px;font-weight:600;margin-left:auto;letter-spacing:-.2px;}
.rtype-chip.prospective{color:#0ea5e9;background:rgba(14,165,233,.12);border:1px solid rgba(14,165,233,.2);}
.rtype-chip.hybrid{color:#a78bfa;background:rgba(167,139,250,.12);border:1px solid rgba(167,139,250,.2);}
.rtype-chip.retrospective{color:#818cf8;background:rgba(129,140,248,.12);border:1px solid rgba(129,140,248,.2);}

/* 내 지갑 네비 */
.nav-wallet{display:flex;align-items:center;gap:8px;padding:7px 10px;border-radius:5px;color:#94a3b8;cursor:pointer;font-size:12px;transition:all .12s;}
.nav-wallet:hover{background:rgba(255,255,255,.05);color:#e2e8f0;}
</style>
</head>
<body>

<!-- v10 HTML Structure — Part 1 complete, JS in Part 2 -->
<div class="layout">
  <nav class="sidebar">
    <div class="logo"><div class="logo-icon">U</div>UniQdata</div>
    <div class="nav-section">
      <a class="nav-item" href="list.html">🏠 연구 허브</a>
      <a class="nav-item" href="create.html">➕ 새 연구</a>
      <a class="nav-item" style="position:relative;">🔔 알림 <span style="margin-left:auto;background:#ef4444;color:white;font-size:9px;padding:1px 5px;border-radius:8px;">3</span></a>
    </div>
    <div class="nav-section" style="flex:1;overflow-y:auto;">
      <!-- 임시저장 섹션 -->
      <div class="draft-section" id="draftSection">
        <div class="draft-label">📝 임시저장 <span style="background:rgba(239,68,68,.15);color:#fca5a5;padding:0 4px;border-radius:3px;font-size:8px;font-weight:600;" id="draftCount">2</span></div>
        <div class="draft-item" data-draft="draft1">
          <span class="draft-dot red"></span>
          <span>당뇨 환자 관찰 연구</span>
          <span class="draft-status red">미완료</span>
        </div>
        <div class="draft-item" data-draft="draft2">
          <span class="draft-dot yellow"></span>
          <span>간기능 바이오마커</span>
          <span class="draft-status yellow">IRB 대기</span>
        </div>
      </div>
      <div style="font-size:9px;color:#64748b;padding:5px 8px;">내 연구</div>
      <!-- 전향적 연구 -->
      <div class="rn-header study-nav active" data-study="visit" id="studyNav-visit">
        <span style="color:#0072B2;">●</span> <span>대사개선 약물 연구</span>
        <span class="rtype-chip prospective">전향적</span>
      </div>
      <div class="rn-sub study-sub active" id="studySub-visit">
        <a class="ns-item active" data-nav="ov" data-study="visit">개요</a>
        <a class="ns-item" data-nav="tb" data-study="visit">테이블</a>
        <a class="ns-item" data-nav="cr" data-study="visit">🔒 클린룸</a>
        <a class="ns-item" data-nav="wl" data-study="visit">💰 프로젝트 지갑</a>
      </div>
      <!-- 하이브리드 연구 -->
      <div class="rn-header study-nav" data-study="hybrid" id="studyNav-hybrid">
        <span style="color:#8b5cf6;">●</span> <span>약물안전성 하이브리드</span>
        <span class="rtype-chip hybrid">하이브리드</span>
      </div>
      <div class="rn-sub study-sub" id="studySub-hybrid" style="display:none;">
        <a class="ns-item" data-nav="ov" data-study="hybrid">개요</a>
        <a class="ns-item" data-nav="tb" data-study="hybrid">테이블</a>
        <a class="ns-item" data-nav="cr" data-study="hybrid">🔒 클린룸</a>
        <a class="ns-item" data-nav="wl" data-study="hybrid">💰 프로젝트 지갑</a>
      </div>
      <!-- 후향적 연구 -->
      <div class="rn-header study-nav" data-study="retro_cdm" id="studyNav-retro_cdm">
        <span style="color:#6366f1;">●</span> <span>CDM 후향적 코호트</span>
        <span class="rtype-chip retrospective">후향적</span>
      </div>
      <div class="rn-sub study-sub" id="studySub-retro_cdm" style="display:none;">
        <a class="ns-item" data-nav="ov" data-study="retro_cdm">개요</a>
        <a class="ns-item" data-nav="tb" data-study="retro_cdm">테이블</a>
        <a class="ns-item" data-nav="cr" data-study="retro_cdm">🔒 클린룸</a>
        <a class="ns-item" data-nav="wl" data-study="retro_cdm">💰 프로젝트 지갑</a>
      </div>
    </div>
    <div class="study-scenarios" id="studyScenarios" style="display:none;">
      <div class="sc-label">데모 시나리오</div>
      <div class="sc-item active" data-scenario="visit"><span class="sc-dot" style="background:#0072B2;"></span>대사개선 약물<span class="sc-type">RCT</span></div>
      <div class="sc-item" data-scenario="week"><span class="sc-dot" style="background:#009E73;"></span>체중관리 코호트<span class="sc-type">코호트</span></div>
      <div class="sc-item" data-scenario="phase"><span class="sc-dot" style="background:#8b5cf6;"></span>항암 용량탐색<span class="sc-type">Phase I/II</span></div>
      <div class="sc-item" data-scenario="day"><span class="sc-dot" style="background:#D55E00;"></span>ICU 모니터링<span class="sc-type">관찰</span></div>
      <div class="sc-item" data-scenario="retro_cdm"><span class="sc-dot" style="background:#6366f1;"></span>CDM 후향적 분석<span class="sc-type">Retro</span></div>
    </div>
    <div class="nav-section" style="padding:6px 10px;border-top:1px solid rgba(255,255,255,.05);">
      <a class="nav-item" style="font-size:11px;color:#64748b;">👥 팀</a>
      <a class="nav-wallet" id="navMyWallet" href="../billing.html">💳 내 지갑</a>
      <a class="nav-item" style="font-size:11px;color:#64748b;">⚙️ 설정</a>
    </div>
    <div class="sidebar-footer"><div style="display:flex;align-items:center;gap:8px;padding:4px;"><div class="u-av">김</div><div><div style="font-size:12px;color:#e2e8f0;">김연구</div><div style="font-size:10px;color:#64748b;">서울대학교병원</div></div></div></div>
  </nav>

  <main class="main">
    <div class="content">
      <div class="page-header">
        <div>
          <div class="page-title" id="pageTitle">대사개선 약물 연구</div>
          <div class="page-sub" id="pageSub">처방 약물(2.4mg) · RCT · 실험 40 / 대조 40 · 12주(84일) · IRB 2025-0847</div>
        </div>
        <div class="study-status"><span class="st-dot active"></span><b id="statusText">진행 중</b> · <span id="statusDetail">V3 / V7</span></div>
      </div>

      <div class="tabs">
        <a class="tab" href="data-overview.html" style="text-decoration:none;color:inherit;">개요</a>
        <div class="tab active" data-tab="table" id="tab-tb">테이블</div>
        <a class="tab" href="clean-room.html" style="text-decoration:none;color:inherit;">🔒 클린룸</a>
        <a class="tab" href="project-wallet.html" style="text-decoration:none;color:inherit;">💰 프로젝트 지갑</a>
      </div>

      <!-- ===== 개요 탭 ===== -->
      <div class="tab-content" id="tc-ov">
        <div class="ov-scroll">
          <div style="position:relative;" id="safetyWrap">
            <div id="safetyStrip"></div>
            <div class="safety-popup" id="safetyPopup"></div>
          </div>
          <div class="timeline-section">
            <div class="tl-header">
              <div style="display:flex;align-items:center;gap:8px;flex-shrink:0;">
                <div class="tl-title">타임라인</div>
                <div class="tl-auto-badge" id="tlAutoBadge"><span class="ab-icon">⏱</span><span id="tlAutoLabel">방문 기반</span></div>
              </div>
              <div class="tl-verdict-badges" id="verdictBadges"></div>
              <div class="tl-controls" style="flex-shrink:0;">
                <span class="tl-config-info" id="tlConfigInfo"></span>
                <div class="zoom-ctrl">
                  <button id="zoomOut">−</button>
                  <span class="zoom-label" id="zoomLabel">Epoch</span>
                  <button id="zoomIn">+</button>
                </div>
                <div class="tl-toggle">
                  <button class="active" id="tlCal">캘린더</button>
                  <button id="tlDay">Study Day</button>
                </div>
              </div>
            </div>
            <div class="tl-bar" id="tlBar"></div>
            <div class="tl-density" id="tlDensity"></div>
            <div class="tl-labels" id="tlLabels"></div>
            <div class="tl-milestones" id="tlMilestones"></div>
          </div>
          <div class="metrics-grid" id="metricsGrid"></div>
        </div>
        <!-- Side Panel: Action Center + AI Insights -->
        <div class="side-panel" id="sidePanel">
        <div class="sp-toggle" id="spToggle" title="조치/AI 패널">⚡<span class="sp-badge" id="spBadge" style="display:none;">0</span></div>
        <div class="sp-tabs">
          <button class="sp-tab-btn active" data-sp="action">⚡ 조치</button>
          <button class="sp-tab-btn" data-sp="ai">🤖 AI</button>
        </div>
        <div class="sp-body">
          <div class="sp-pane active" id="spAction"></div>
          <div class="sp-pane" id="spAI"></div>
        </div>
      </div>
      </div><!-- closes tc-ov -->

      <!-- ===== 테이블 탭 ===== -->
      <div class="tab-content active" id="tc-tb">
        <div class="tb-mini-tl" id="tbMiniTl">
          <div class="mtl-top-row">
            <span class="mtl-label">타임라인</span>
            <span class="mtl-info" id="mtlInfo"></span>
            <div class="tl-toggle" style="margin-left:auto;">
              <button class="active" id="mtlCal">캘린더</button>
              <button id="mtlDay">Study Day</button>
            </div>
          </div>
          <div class="mtl-bar" id="mtlBar" style="margin-bottom:38px;"></div>
          <!-- 시간 단위 그리드 — 선택한 집계 기간에 따른 셀 표시 -->
          <div class="mtl-grid-row" id="mtlGridRow"></div>
        </div>
        <div class="ctrl-section">
          <div class="ctrl-row">
            <div class="ctrl-group">
              <label>집계 단위</label>
              <div class="agg-selector" id="aggSelector">
                <button class="agg-btn" data-agg="day">일간</button>
                <button class="agg-btn" data-agg="week">주간</button>
                <button class="agg-btn" data-agg="month">월간</button>
                <button class="agg-btn active" data-agg="visit">방문별</button>
              </div>
            </div>
            <div class="ctrl-group"><label>소스</label><select class="sel-sm"><option>전체</option></select></div>
            <div class="ctrl-group"><label>군</label><div class="arm-tabs" id="armTabs"></div></div>
            <div class="ctrl-group"><button class="split-toggle" id="splitToggle" title="군별 분할 보기">◫ 분할</button></div>
            <div class="ctrl-group" style="margin-left:auto;">
              <span class="snapshot-label" id="snapshotLabel" style="font-size:10px;color:#0072B2;font-weight:600;"></span>
              <input type="text" class="search-in" placeholder="환자 검색...">
            </div>
          </div>
        </div>
        <div class="src-legend">
          <span><span class="sd emr"></span> EMR</span>
          <span><span class="sd wear"></span> 웨어러블</span>
          <span><span class="sd ema"></span> EMA</span>
          <span style="margin-left:auto;color:#9ca3af;">행 클릭 → 상세</span>
        </div>
        <div class="table-area-wrap">
          <div class="table-area" id="tableArea">
            <!-- 단일 테이블 뷰 (기본) -->
            <div id="singleTableView">
              <div class="tbl-section"><div class="tbl-wrap">
                <table class="pt-tbl"><thead><tr id="tHead"></tr></thead><tbody id="tBody"></tbody></table>
              </div></div>
              <div class="pag-row"><span id="pagInfo"></span><div style="display:flex;gap:2px;"><button class="t-btn active" style="padding:2px 5px;">1</button></div></div>
            </div>
            <!-- 분할 테이블 뷰 -->
            <div id="splitTableView" style="display:none;flex:1;min-height:0;overflow:hidden;flex-direction:column;">
              <div class="split-container" id="splitContainer"></div>
              <div class="pag-row"><span id="splitPagInfo"></span></div>
            </div>
          </div>
          <div class="detail-panel" id="detailPanel">
            <div class="dp-header">
              <div class="dp-title" id="dpTitle"></div>
              <div style="display:flex;gap:3px;align-items:center;">
                <div class="dp-nav"><button id="dpPrev">▲</button><button id="dpNext">▼</button></div>
                <button class="dp-close" id="dpClose">✕</button>
              </div>
            </div>
            <div class="dp-body" id="dpBody"></div>
          </div>
        </div>
      </div>

      <!-- ===== 클린룸 탭 ===== -->
      <div class="tab-content" id="tc-cr">
        <div class="cr-session">
          <div class="cr-live"><span class="cr-dot"></span><span class="cr-live-label">세션</span></div>
          <span class="cr-meta"><b id="crElapsed">00:00</b> / 4h 00m</span>
          <span class="cr-chip" id="crIrb">IRB-2025-0847</span>
          <span class="cr-chip privacy">🛡️ k≥5 · ε 0.98 잔여</span>
          <span class="cr-chip">가명화 적용</span>
          <div class="cr-right"><span class="cr-audit">📝 감사 로그 기록 중</span></div>
        </div>
        <div class="cr-body">
          <div class="schema-panel">
            <div class="sp-header"><span>스키마 탐색기</span><span style="font-size:9px;color:#9ca3af;" id="spCount">12 테이블</span></div>
            <input type="text" class="sp-search" placeholder="테이블 검색..." id="spSearch">
            <div class="sp-list" id="spList"></div>
          </div>
          <div class="data-grid">
            <div class="dg-toolbar" id="dgToolbar"></div>
            <div class="dg-table-wrap" id="dgTableWrap">
              <table class="dg-tbl" id="dgTable"><thead id="dgHead"></thead><tbody id="dgBody"></tbody></table>
            </div>
            <div class="dg-footer">
              <span id="dgRowInfo">50 rows · 10 columns</span>
              <div class="dg-footer-privacy">
                <span class="privacy-badge ok">🛡️ k-익명성: 5 이상</span>
                <span class="privacy-badge ok">🔒 user_id: 가명 처리</span>
                <span class="privacy-badge ok" id="dgQueryBadge">📝 쿼리 #0 기록됨</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== 프로젝트 지갑 탭 ===== -->
      <div class="tab-content" id="tc-wl" style="display:none;">
        <div style="padding:16px;display:flex;flex-direction:column;gap:12px;">
          <!-- 지갑 잔액 카드 -->
          <div style="background:linear-gradient(135deg,#1a5276 0%,#2e86c1 100%);border-radius:12px;padding:20px 24px;color:white;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
              <div>
                <div style="font-size:11px;opacity:.7;margin-bottom:4px;">프로젝트 지갑 잔액</div>
                <div style="font-size:28px;font-weight:800;letter-spacing:-1px;" id="wlBalance">2,450,000 <span style="font-size:14px;font-weight:500;">KRW</span></div>
              </div>
              <div style="text-align:right;">
                <div style="font-size:10px;opacity:.6;">필요 금액</div>
                <div style="font-size:16px;font-weight:600;" id="wlRequired">3,200,000 KRW</div>
                <div style="font-size:10px;opacity:.7;margin-top:2px;" id="wlGap">⚠ 부족: 750,000 KRW</div>
              </div>
            </div>
            <div style="display:flex;gap:8px;margin-top:12px;">
              <div style="background:rgba(255,255,255,.15);border-radius:6px;padding:6px 12px;font-size:11px;display:flex;align-items:center;gap:6px;cursor:pointer;" id="wlAddr">
                <span style="font-family:monospace;font-size:10px;" id="wlAddrText">0x7a3F...b82E</span>
                <span style="opacity:.7;">📋 복사</span>
              </div>
              <button style="background:white;color:#1a5276;border:none;border-radius:6px;padding:6px 16px;font-size:11px;font-weight:700;cursor:pointer;" id="wlTransfer">이체하기 →</button>
            </div>
          </div>

          <!-- 에스크로 상태 -->
          <div style="background:white;border:1px solid #e5e7eb;border-radius:10px;padding:16px;">
            <div style="font-size:12px;font-weight:700;color:#374151;margin-bottom:10px;">에스크로 예치 현황</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;" id="wlEscrowCards">
              <div style="flex:1;min-width:120px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;padding:10px;">
                <div style="font-size:9px;color:#15803d;">예치 완료</div>
                <div style="font-size:18px;font-weight:700;color:#15803d;">1,200,000</div>
                <div style="font-size:9px;color:#6b7280;margin-top:2px;">데이터 수집 1차</div>
              </div>
              <div style="flex:1;min-width:120px;background:#fefce8;border:1px solid #fde68a;border-radius:8px;padding:10px;">
                <div style="font-size:9px;color:#a16207;">대기 중</div>
                <div style="font-size:18px;font-weight:700;color:#a16207;">1,250,000</div>
                <div style="font-size:9px;color:#6b7280;margin-top:2px;">데이터 수집 2차</div>
              </div>
              <div style="flex:1;min-width:120px;background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:10px;">
                <div style="font-size:9px;color:#6b7280;">미예치</div>
                <div style="font-size:18px;font-weight:700;color:#9ca3af;">750,000</div>
                <div style="font-size:9px;color:#6b7280;margin-top:2px;">분석 비용</div>
              </div>
            </div>
          </div>

          <!-- IRB 인증 상태 -->
          <div style="background:white;border:1px solid #e5e7eb;border-radius:10px;padding:16px;" id="wlIrbSection">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
              <div style="font-size:12px;font-weight:700;color:#374151;">IRB 심의 인증</div>
              <span style="font-size:10px;padding:3px 8px;border-radius:4px;font-weight:600;" id="wlIrbBadge"></span>
            </div>
            <div id="wlIrbContent" style="font-size:11px;color:#6b7280;"></div>
          </div>

          <!-- 견적 명세서 -->
          <div style="background:white;border:1px solid #e5e7eb;border-radius:10px;padding:16px;">
            <div style="font-size:12px;font-weight:700;color:#374151;margin-bottom:10px;">견적 명세서</div>
            <table style="width:100%;font-size:11px;border-collapse:collapse;" id="wlEstimate">
              <tr style="border-bottom:1px solid #f3f4f6;"><td style="padding:6px 0;color:#6b7280;">데이터 수집 (1차)</td><td style="text-align:right;font-weight:600;">1,200,000 KRW</td></tr>
              <tr style="border-bottom:1px solid #f3f4f6;"><td style="padding:6px 0;color:#6b7280;">데이터 수집 (2차)</td><td style="text-align:right;font-weight:600;">1,250,000 KRW</td></tr>
              <tr style="border-bottom:1px solid #f3f4f6;"><td style="padding:6px 0;color:#6b7280;">분석 비용</td><td style="text-align:right;font-weight:600;">750,000 KRW</td></tr>
              <tr style="border-top:2px solid #374151;"><td style="padding:8px 0;font-weight:700;color:#374151;">합계</td><td style="text-align:right;font-weight:800;font-size:14px;color:#1a5276;">3,200,000 KRW</td></tr>
            </table>
          </div>

          <!-- 지출 원장 -->
          <div style="background:white;border:1px solid #e5e7eb;border-radius:10px;padding:16px;">
            <div style="font-size:12px;font-weight:700;color:#374151;margin-bottom:10px;">지출 원장</div>
            <div style="display:flex;flex-direction:column;gap:6px;" id="wlLedger">
              <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 10px;background:#f9fafb;border-radius:6px;font-size:11px;">
                <div><span style="color:#15803d;font-weight:600;">입금</span> · 에스크로 예치 1차</div>
                <div style="display:flex;gap:12px;align-items:center;"><span style="font-weight:600;color:#15803d;">+1,200,000</span><span style="color:#9ca3af;font-size:10px;">2026-01-15</span></div>
              </div>
              <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 10px;background:#f9fafb;border-radius:6px;font-size:11px;">
                <div><span style="color:#15803d;font-weight:600;">입금</span> · 추가 충전</div>
                <div style="display:flex;gap:12px;align-items:center;"><span style="font-weight:600;color:#15803d;">+1,250,000</span><span style="color:#9ca3af;font-size:10px;">2026-02-01</span></div>
              </div>
              <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 10px;background:#f9fafb;border-radius:6px;font-size:11px;">
                <div><span style="color:#dc2626;font-weight:600;">출금</span> · 데이터 수집 1차 정산</div>
                <div style="display:flex;gap:12px;align-items:center;"><span style="font-weight:600;color:#dc2626;">-1,200,000</span><span style="color:#9ca3af;font-size:10px;">2026-02-10</span></div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </main>
</div>

<!-- Config Badge (숨김 — 인라인으로 이동) -->
<span id="configBadge" style="display:none;"><span id="cbType"></span></span>

<!-- Chart Modal -->
<div class="chart-modal-overlay" id="chartModal">
  <div class="chart-modal">
    <div class="cm-header"><div class="cm-title" id="cmTitle"></div><button class="cm-close" id="cmClose">✕ 닫기</button></div>
    <div class="cm-legend" id="cmLegend"></div>
    <div class="cm-chart"><canvas id="cmCanvas"></canvas></div>
    <div class="cm-stats" id="cmStats"></div>
    <div class="cm-guide" id="cmGuide"></div>
  </div>
</div>

<!-- JSON Modal -->
<div class="json-modal" id="jsonModal">
  <div class="json-box">
    <div class="json-box-header"><span class="json-box-title" id="jmTitle">JSONB 값</span><button class="json-box-close" id="jmClose">✕</button></div>
    <pre id="jmContent"></pre>
  </div>
</div>

<div class="version-tag">v11 · CDM-aligned · dynamic columns · retro/prospective</div>

<!-- Part 2: JavaScript will be appended -->
<script>
// ===============================================
// v10 CORE ENGINE — study_config drives everything
// ===============================================

// === Okabe-Ito Colorblind-Safe Palette ===
const C={blue:'#0072B2',vermillion:'#D55E00',green:'#009E73',amber:'#E69F00',pink:'#CC79A7',skyblue:'#56B4E9',yellow:'#F0E442'};

// ===============================================
// TD-1+TD-2 해결: STUDY_CONFIG — 모든 것의 근원
// ===============================================
const STUDY_CONFIG = {
  // 연구 기본 정보
  title: '대사개선 약물 연구',
  subtitle: '처방 약물(2.4mg)',
  // IRB는 옵셔널 — IRB면제/해당없음/해외 Ethics Committee 모두 지원
  regulatory: {
    type: 'irb',                 // irb | irb_exempt | ethics_committee | none
    number: 'IRB-2025-0847',     // nullable — 없으면 null
    status: 'approved',          // approved | exempt | not_required | pending
  },

  // TD-2: 연구설계 어댑터
  design: {
    study_type: 'rct',           // rct | single_arm | crossover | cluster | safety
    has_control_arm: true,
    num_arms: 2,
    arm_labels: ['실험군','대조군'],
    arm_colors: [C.blue, C.vermillion],
    primary_endpoint_type: 'efficacy',  // efficacy | safety | equivalence
    n_per_arm: 40,
  },

  // ==========================================================
  // TD-1 해결: 시간축 일반화 — CDISC 다중 축 패턴
  //
  // time_unit : 'visit'|'week'|'phase'|'day'|'cycle'
  //   → UI의 X축 라벨, 테이블 컬럼, 줌 단위 결정
  // reference_point : Day 0 기준 정의 (CDISC RFSTDTC)
  // timing_behavior : 지연 시 후속 일정 이동 여부
  // points[] : 시간축 포인트 (time_unit에 무관한 통일 구조)
  //   visit→V1,V2  week→W1,W2  phase→P1,P2  day→D1,D2
  // analysis_rule : 실제 관측 → 분석 시점 매핑 (CDISC AVISIT)
  // ==========================================================
  timeline: {
    time_unit: 'visit',        // visit | week | phase | day | cycle
    reference_point: {
      type: 'first_dose',      // first_dose | randomization | enrollment | screening_start | custom
      label: '첫 투약일',      // UI에 표시할 기준점 이름
    },
    timing_behavior: 'participant-relative', // participant-relative | calendar-fixed
    analysis_rule: 'nearest-in-window',      // nearest-in-window | nearest-after | last-before

    duration_days: 227,
    current_day: 42,

    // Epochs — 구조적 단계 (CDISC EPOCH)
    phases: [
      {name:'스크리닝',key:'screening',start:-57,end:-43,color:'#94a3b8'},
      {name:'등록',key:'enrollment',start:-42,end:-15,color:'#6366f1'},
      {name:'베이스라인',key:'baseline',start:-14,end:-1,color:C.blue},
      {name:'치료',key:'treatment',start:0,end:84,color:'#0ea5e9'},
      {name:'추적',key:'followup',start:85,end:168,color:C.green},
      {name:'분석',key:'analysis',start:169,end:227,color:'#8b5cf6'},
    ],

    // 시간축 포인트 — time_unit 무관 통일 구조
    // id/label 형식만 time_unit에 맞춰 변경
    points: [
      {id:'V1',label:'V1 (BL)',target_day:0,window:[-3,3],epoch:'baseline',planned:true},
      {id:'V2',label:'V2 (2주)',target_day:14,window:[-5,5],epoch:'treatment',planned:true},
      {id:'V3',label:'V3 (4주)',target_day:28,window:[-5,5],epoch:'treatment',planned:true},
      {id:'V4',label:'V4 (6주)',target_day:42,window:[-5,5],epoch:'treatment',planned:true},
      {id:'V5',label:'V5 (8주)',target_day:56,window:[-5,5],epoch:'treatment',planned:true},
      {id:'V6',label:'V6 (10주)',target_day:70,window:[-5,5],epoch:'treatment',planned:true},
      {id:'V7',label:'V7 (12주)',target_day:84,window:[-7,7],epoch:'treatment',planned:true},
    ],

    milestones: [
      {label:'IRB 승인',day:-57,date:'2025-11-09',status:'done',regulatory_only:true},
      {label:'첫 참여자 등록',day:-42,date:'2025-11-24',status:'done'},
      {label:'등록 완료',day:-14,date:'2025-12-22',status:'done'},
      {label:'베이스라인 완료',day:0,date:'2026-01-05',status:'done'},
      {label:'중간분석 (V4)',day:42,date:'2026-02-16',status:'now'},
      {label:'치료 종료 (V7)',day:84,date:'2026-03-31',status:'future'},
      {label:'추적 종료',day:168,date:'2026-06-22',status:'future'},
      {label:'데이터 잠금',day:210,date:'2026-08-03',status:'future'},
    ],
    zoom_levels: ['study','epoch','visit','week','day'],
    current_zoom: 1,
    base_date: '2026-01-05', // Day 0 = reference_point (전향적)
    today_day: 42,           // "오늘" 고정 위치 (D42 ≈ 2026-02-16)
  },

  // TD-3+TD-6: 지표 정의 — 렌더러 타입 + 파생 지표
  // v11: CDM-aligned metrics with domain/concept_hint/value_type/priority
  metrics: [
    {k:'wt',name:'체중',unit:'kg',domain:'measurement',concept_hint:'body_weight',value_type:'numeric',direction:'down',priority:'primary',source:'EMR',renderer:null,color:C.blue,p_value:0.0001,measurement_freq:'per_visit'},
    {k:'sbp',name:'SBP',unit:'mmHg',domain:'measurement',concept_hint:'systolic_bp',value_type:'numeric',direction:'down',priority:'secondary',source:'EMR',renderer:null,color:'#6366f1',p_value:0.012,measurement_freq:'per_visit'},
    {k:'hr',name:'심박수',unit:'bpm',domain:'measurement',concept_hint:'heart_rate',value_type:'numeric',direction:'down',priority:'secondary',source:'웨어',renderer:null,color:C.green,p_value:0.034,measurement_freq:'continuous',agg_rule:'visit_mean'},
    {k:'steps',name:'걸음수',unit:'보',domain:'device_exposure',concept_hint:'step_count',value_type:'numeric',direction:'up',priority:'exploratory',source:'웨어',renderer:null,color:'#14b8a6',p_value:0.008,measurement_freq:'daily',agg_rule:'visit_sum'},
    {k:'comp',name:'순응도',unit:'%',domain:'observation',concept_hint:'compliance_rate',value_type:'numeric',direction:'monitor',priority:'operational',source:'EMA',renderer:null,color:C.pink,p_value:0.342,measurement_freq:'daily',agg_rule:'visit_mean'},
    {k:'sleep',name:'수면',unit:'h',domain:'device_exposure',concept_hint:'sleep_duration',value_type:'numeric',direction:'up',priority:'exploratory',source:'웨어',renderer:null,color:C.amber,p_value:0.028,measurement_freq:'daily',agg_rule:'visit_mean'},
    {k:'skin',name:'피부 상태',unit:'점',domain:'observation',concept_hint:'skin_condition',value_type:'categorical',direction:'down',priority:'exploratory',source:'사진+AI',renderer:'image_gallery',color:'#a855f7',p_value:0.003,measurement_freq:'per_visit'},
    {k:'tir',name:'TIR',unit:'%',domain:'device_exposure',concept_hint:'time_in_range',value_type:'proportion',direction:'up',priority:'secondary',source:'CGM→파생',renderer:'severity_zone',color:'#10b981',p_value:0.019,measurement_freq:'continuous',agg_rule:'visit_pct',derived:{from:'cgm',fn:'time_in_range',params:{min:70,max:180}}},
  ],

  // TD-5: 안전성 프레임
  safety: {
    enabled: true,
    ae_summary: {total:12,serious:1,related:4,discontinued:0},
    ae_by_visit: [2,3,2,5,0,0,0], // V1~V7
    stopping_rule: 'O\'Brien-Fleming boundary',
    dsmb_next: '2026-03-01',
  },

  // TD-2: Verdict adapter
  research_type: 'prospective', // prospective | retrospective
  verdict_adapter: 'rct', // rct | single_arm | safety | crossover | retrospective_cohort
};

// ===============================================
// TD-1: Semantic Zoom Levels
// ===============================================
const ZOOM_NAMES = ['전체','에포크','방문','주간','일별'];
let currentZoom = STUDY_CONFIG.timeline.current_zoom;

function updateZoom(dir){
  currentZoom = Math.max(0, Math.min(4, currentZoom + dir));
  document.getElementById('zoomLabel').textContent = ZOOM_NAMES[currentZoom];
  buildTimeline();
}
document.getElementById('zoomIn').addEventListener('click',()=>updateZoom(1));
document.getElementById('zoomOut').addEventListener('click',()=>updateZoom(-1));

// ===============================================
// TD-1 해결: 시간축 포인트 (time_unit 무관 통일 API)
// points[] → VISITS 로 런타임 매핑
// time_unit_label() → UI 표시명 동적 생성
// ===============================================
let TIME_UNIT = STUDY_CONFIG.timeline.time_unit;
const VISITS = STUDY_CONFIG.timeline.points;   // ← visits→points 일반화 (배열 내용만 교체)
const PAST_VISITS = VISITS.filter(v => v.target_day <= STUDY_CONFIG.timeline.current_day);
const FUTURE_VISITS = VISITS.filter(v => v.target_day > STUDY_CONFIG.timeline.current_day);
const VISIT_LABELS = VISITS.map(v => v.id);
const PAST_LABELS = PAST_VISITS.map(v => v.id);

// time_unit 기반 UI 라벨 유틸
const TIME_UNIT_LABELS = {
  visit: {singular:'방문', plural:'방문', prefix:'V', axis:'방문 기반'},
  week:  {singular:'주차', plural:'주간', prefix:'W', axis:'주간 기반'},
  phase: {singular:'단계', plural:'단계', prefix:'P', axis:'단계 기반'},
  day:   {singular:'일차', plural:'일별', prefix:'D', axis:'일별 기반'},
  cycle: {singular:'주기', plural:'주기', prefix:'C', axis:'주기 기반'},
};
function tuLabel(key){return TIME_UNIT_LABELS[TIME_UNIT]?.[key]||key;}
function tuRefLabel(){return STUDY_CONFIG.timeline.reference_point?.label||'Day 0';}
function tuBehaviorLabel(){return STUDY_CONFIG.timeline.timing_behavior==='participant-relative'?'참여자 상대':'캘린더 고정';}

// ===============================================
// 동적 데이터 생성 엔진 — points[] 길이에 맞춤
// n = PAST_VISITS.length (현재까지 수집된 시점 수)
// ===============================================
function seededRandom(seed){let s=seed;return function(){s=(s*16807+0)%2147483647;return(s-1)/2147483646;};}

// 환자별 시계열 생성: start 값에서 slope/point 씩 변화 + noise
function genTimeSeries(n, start, slopePerPoint, noise, seed, nullIdx){
  const rng=seededRandom(seed);
  return Array.from({length:n},(_,i)=>{
    if(nullIdx!=null && i===nullIdx) return null;
    return Math.round((start + slopePerPoint*i + (rng()-0.5)*noise*2)*10)/10;
  });
}

// 참여자 프로필 정의 (시드값으로 재현성 보장)
const _DEFAULT_PATIENT_PROFILES = {};  // 기본 환자 백업 — initDefaultPatients()에서 설정
const PATIENT_PROFILES = {
  exp: [
    {id:'P001',nm:'김민수',sv:'good',st:'verified', seeds:{wt:{s:87.3,sl:-1.6,n:0.3},sbp:{s:134,sl:-2.5,n:1},hr:{s:72,sl:-1.2,n:0.5},steps:{s:7340,sl:400,n:100},comp:{s:86,sl:2,n:1},sleep:{s:6.2,sl:0.25,n:0.1},skin:{s:7.2,sl:-0.8,n:0.3},tir:{s:62,sl:4,n:2}}},
    {id:'P005',nm:'이수진',sv:'good',st:'verified', seeds:{wt:{s:88.3,sl:-1.3,n:0.4},sbp:{s:132.5,sl:-1.8,n:1.2},hr:{s:72,sl:-0.8,n:0.3},steps:{s:6800,sl:280,n:120},comp:{s:85,sl:1.5,n:1},sleep:{s:6,sl:0.22,n:0.1},skin:{s:6.8,sl:-0.7,n:0.4},tir:{s:65,sl:3.5,n:1.5}}},
    {id:'P011',nm:'박지훈',sv:'good',st:'verified', seeds:{wt:{s:88.3,sl:-1.5,n:0.2},sbp:{s:134.2,sl:-2.0,n:0.8},hr:{s:72,sl:-1.3,n:0.4},steps:{s:7000,sl:360,n:80},comp:{s:86,sl:1.8,n:0.8},sleep:{s:6.5,sl:0.18,n:0.08},skin:{s:7.0,sl:-0.9,n:0.2},tir:{s:58,sl:5,n:2}}},
    {id:'P018',nm:'최예린',sv:'warn',st:'query',al:true, seeds:{wt:{s:87.4,sl:-1.2,n:0.5},sbp:{s:137.9,sl:-0.5,n:2.5},hr:{s:70,sl:-0.5,n:0.8,nullAt:2},steps:{s:5800,sl:140,n:150},comp:{s:82,sl:2,n:1.5},sleep:{s:5.8,sl:0.12,n:0.2},skin:{s:8.1,sl:-0.3,n:0.6},tir:{s:48,sl:2,n:3}}},
    {id:'P023',nm:'정하늘',sv:'good',st:'verified', seeds:{wt:{s:87.6,sl:-1.4,n:0.3},sbp:{s:134.1,sl:-1.5,n:0.6},hr:{s:72,sl:-1.0,n:0.3},steps:{s:6900,sl:300,n:90},comp:{s:85,sl:1.6,n:0.7},sleep:{s:6.3,sl:0.2,n:0.1},skin:{s:6.5,sl:-0.85,n:0.3},tir:{s:64,sl:3.8,n:1.8}}},
  ],
  ctrl: [
    {id:'P002',nm:'윤서연',sv:'warn',st:'review', seeds:{wt:{s:87.7,sl:0.1,n:0.2},sbp:{s:135.9,sl:0.4,n:0.5},hr:{s:72,sl:-0.2,n:0.3},steps:{s:4600,sl:50,n:60},comp:{s:85,sl:0.5,n:0.5},sleep:{s:6.1,sl:-0.05,n:0.1},skin:{s:7.1,sl:-0.1,n:0.3},tir:{s:61,sl:0.5,n:2}}},
    {id:'P008',nm:'한도윤',sv:'good',st:'verified', seeds:{wt:{s:87.9,sl:-0.15,n:0.1},sbp:{s:133.1,sl:0.3,n:0.4},hr:{s:72,sl:0,n:0.2},steps:{s:4200,sl:-5,n:30},comp:{s:85,sl:0.3,n:0.3},sleep:{s:6.5,sl:-0.05,n:0.08},skin:{s:6.9,sl:-0.05,n:0.2},tir:{s:63,sl:0.3,n:1.5}}},
    {id:'P014',nm:'송지아',sv:'good',st:'verified', seeds:{wt:{s:87.9,sl:-0.03,n:0.1},sbp:{s:134.5,sl:0.2,n:0.3},hr:{s:72,sl:-0.2,n:0.2},steps:{s:4500,sl:25,n:40},comp:{s:85,sl:0.3,n:0.3},sleep:{s:6.2,sl:-0.03,n:0.05},skin:{s:7.3,sl:-0.08,n:0.25},tir:{s:59,sl:0.4,n:1.8}}},
    {id:'P031',nm:'임채원',sv:'bad',st:'query',al:true, seeds:{wt:{s:87.9,sl:0.2,n:0.3},sbp:{s:134.2,sl:0.9,n:0.8},hr:{s:73,sl:0.3,n:0.4},steps:{s:4100,sl:-80,n:70},comp:{s:84,sl:-2,n:1},sleep:{s:5.8,sl:-0.12,n:0.1},skin:{s:7.5,sl:0.2,n:0.4},tir:{s:55,sl:-1,n:2.5}}},
    {id:'P036',nm:'강시우',sv:'good',st:'verified', seeds:{wt:{s:87,sl:-0.03,n:0.1},sbp:{s:131.8,sl:0.3,n:0.3},hr:{s:74,sl:-0.3,n:0.2},steps:{s:4400,sl:25,n:35},comp:{s:85,sl:0.5,n:0.4},sleep:{s:6.4,sl:-0.05,n:0.06},skin:{s:6.7,sl:-0.06,n:0.2},tir:{s:62,sl:0.2,n:1.2}}},
  ],
};

function generatePatientData(profiles, n){
  return profiles.map((p,pi)=>{
    const past = {};
    Object.entries(p.seeds).forEach(([k,cfg])=>{
      past[k] = genTimeSeries(n, cfg.s, cfg.sl, cfg.n, (pi+1)*1000+k.charCodeAt(0), cfg.nullAt);
    });
    return {id:p.id, past};
  });
}

function generateALL(n){
  // v11: Use STUDY_CONFIG.metrics as source of truth
  const metricKeys = STUDY_CONFIG.metrics.map(m=>m.k);
  return [...PATIENT_PROFILES.exp,...PATIENT_PROFILES.ctrl].map(p=>{
    const row = {id:p.id, nm:p.nm, g:PATIENT_PROFILES.exp.includes(p)?'exp':'ctrl', sv:p.sv, st:p.st, al:p.al};
    metricKeys.forEach(k=>{
      const cfg=p.seeds[k]; if(!cfg)return;
      row[k] = genTimeSeries(n, cfg.s, cfg.sl, cfg.n, p.id.charCodeAt(1)*100+k.charCodeAt(0), cfg.nullAt);
    });
    return row;
  });
}

// 기본 환자 프로필 백업 (시나리오 전환 후 복원용)
_DEFAULT_PATIENT_PROFILES.exp = PATIENT_PROFILES.exp.map(p=>({...p}));
_DEFAULT_PATIENT_PROFILES.ctrl = PATIENT_PROFILES.ctrl.map(p=>({...p}));

// 초기 데이터 생성 — PAST_VISITS.length 기준
let EXP_DATA = generatePatientData(PATIENT_PROFILES.exp, PAST_VISITS.length);
let CTRL_DATA = generatePatientData(PATIENT_PROFILES.ctrl, PAST_VISITS.length);

// ===============================================
// UTILITY FUNCTIONS
// ===============================================
function groupAvg(patients,k){
  return PAST_VISITS.map((_,i)=>{
    const vs=patients.map(p=>p.past[k]?p.past[k][i]:null).filter(v=>v!=null);
    return vs.length?vs.reduce((a,b)=>a+b,0)/vs.length:null;
  });
}
function project(past,n){
  const l=past.length;if(l<2)return Array(n).fill(null);
  const slope=(past[l-1]-past[l-2]);
  return Array.from({length:n},(_,i)=>Math.round((past[l-1]+slope*(i+1))*10)/10);
}
function groupSE(patients,k){
  return PAST_VISITS.map((_,i)=>{
    const vs=patients.map(p=>p.past[k]?p.past[k][i]:null).filter(v=>v!=null);
    if(vs.length<2)return 0;
    const mean=vs.reduce((a,b)=>a+b,0)/vs.length;
    const variance=vs.reduce((a,b)=>a+(b-mean)**2,0)/(vs.length-1);
    return Math.sqrt(variance/vs.length)*1.96;
  });
}
function projectCI(sePast,n){
  const last=sePast[sePast.length-1];
  return Array.from({length:n},(_,i)=>last*(1+0.15*(i+1)));
}
function pStr(p){if(p<0.001)return'p<0.001***';if(p<0.01)return'p='+p.toFixed(3)+'**';if(p<0.05)return'p='+p.toFixed(3)+'*';return'p='+p.toFixed(3);}
function pCls(p){return p<0.05?'sig':'ns';}

// ===============================================
// TD-2: VERDICT ADAPTER — study_type 기반
// ===============================================
// ===============================================
// VERDICT BADGES — 타임라인 헤더 내 콤팩트 뱃지
// ===============================================
function buildVerdictBadges(){
  const el = document.getElementById('verdictBadges');
  if(!el) return;

  if(STUDY_CONFIG.research_type === 'retrospective'){
    const nExp = EXP_DATA.length, nCtrl = CTRL_DATA.length;
    const totalN = nExp + nCtrl;
    const li = PAST_VISITS.length - 1;
    const pVal = STUDY_CONFIG.metrics[0]?.p_value;
    el.innerHTML = [
      '<div class="vb retro"><span class="vb-label">코호트</span><span class="vb-val">'+totalN+'명</span><span class="vb-tooltip">노출 '+nExp+' / 비노출 '+nCtrl+'</span></div>',
      '<div class="vb retro"><span class="vb-label">시점</span><span class="vb-val">'+(li+1)+'개</span><span class="vb-tooltip">'+(PAST_VISITS[0]?.id||'—')+' ~ '+(PAST_VISITS[li]?.id||'—')+'</span></div>',
      '<div class="vb '+(pVal!=null&&pVal<0.05?'ok':'warn')+'"><span class="vb-label">1차</span><span class="vb-val">'+(pVal!=null?pStr(pVal):'—')+'</span><span class="vb-tooltip">교란변수 보정 전</span></div>',
      '<div class="vb ok"><span class="vb-label">완성도</span><span class="vb-val">100%</span><span class="vb-tooltip">후향적 전체 로딩</span></div>'
    ].join('');
    return;
  }

  // Prospective
  const cfg = STUDY_CONFIG;
  const nTotal = ALL.length;
  const li = PAST_VISITS.length - 1;
  const nActive = ALL.filter(p=>p.st!=='dropped').length;
  const power = Math.min(99, Math.round(50 + nActive/nTotal*40 + li/VISITS.length*10));
  const expChange = metricData.wt ? (metricData.wt.expPast[li] - metricData.wt.expPast[0]) : 0;
  const ctrlChange = (metricData.wt && metricData.wt.ctrlPast && metricData.wt.ctrlPast.length>li) ? (metricData.wt.ctrlPast[li] - metricData.wt.ctrlPast[0]) : 0;
  const pv = cfg.metrics[0].p_value;
  const warnCount = ALL.filter(p=>p.al).length;
  const total = nTotal * cfg.metrics.length * PAST_VISITS.length;
  const missing = Math.round(total * (seededRandom(42)()*0.08+0.02));
  const completeness = Math.round((1 - missing/total)*100);

  el.innerHTML = [
    '<div class="vb primary"><span class="vb-label">검정력</span><span class="vb-val">'+power+'%</span><div class="vb-bar"><div class="vb-bar-fill" style="width:'+power+'%;background:'+(power>=80?'#0072B2':'#D55E00')+';"></div></div><span class="vb-tooltip">활성 '+nActive+'/'+nTotal+'명</span></div>',
    '<div class="vb '+(pv<0.05?'ok':'warn')+'"><span class="vb-label">1차</span><span class="vb-val">'+(expChange>0?'+':'')+expChange.toFixed(1)+'kg</span><span class="vb-tooltip">'+pStr(pv)+' · Δ'+Math.abs(expChange-ctrlChange).toFixed(1)+'kg</span></div>',
    '<div class="vb '+(warnCount>0?'warn':'ok')+'"><span class="vb-label">주의</span><span class="vb-val">'+warnCount+'건</span><span class="vb-tooltip">'+(warnCount>0?'환자 알림 '+warnCount+'건':'이상 없음')+'</span></div>',
    '<div class="vb '+(completeness>=90?'ok':'warn')+'"><span class="vb-label">완성도</span><span class="vb-val">'+completeness+'%</span><div class="vb-bar"><div class="vb-bar-fill" style="width:'+completeness+'%;background:'+(completeness>=90?'#009E73':'#E69F00')+';"></div></div><span class="vb-tooltip">결측 '+(100-completeness).toFixed(1)+'%</span></div>'
  ].join('');
}

// ===============================================
// TD-5: SAFETY PANEL
// ===============================================
function buildSafetyStrip(){
  const strip = document.getElementById('safetyStrip');
  const popup = document.getElementById('safetyPopup');

  // v11: Retro mode — 간결한 후향적 배너
  if(STUDY_CONFIG.research_type === 'retrospective'){
    strip.innerHTML = `<div class="safety-notif retro">
      <span class="sn-icon">📊</span>
      <span style="font-weight:600;">후향적 데이터</span>
      <span class="sn-divider"></span>
      <span>AE는 CDM condition_occurrence에서 조회</span>
    </div>`;
    popup.innerHTML = '';
    popup.classList.remove('open');
    return;
  }
  const s = STUDY_CONFIG.safety;
  if(!s.enabled){strip.style.display='none';return;}
  strip.style.display='';

  const hasSAE = s.ae_summary.serious > 0;
  const cls = hasSAE ? '' : 'clean';

  strip.innerHTML = `<div class="safety-notif ${cls}" id="safetyNotifBtn">
    <span class="sn-icon">${hasSAE?'⚠️':'🛡️'}</span>
    <div class="sn-stats">
      <span class="sn-stat"><span class="sn-val">${s.ae_summary.total}</span><span class="sn-label"> AE</span></span>
      <span class="sn-divider"></span>
      <span class="sn-stat"><span class="sn-val" style="color:${hasSAE?C.vermillion:'inherit'};">${s.ae_summary.serious}</span><span class="sn-label"> SAE</span></span>
      <span class="sn-divider"></span>
      <span class="sn-stat"><span class="sn-val">${s.ae_summary.related}</span><span class="sn-label"> 약물관련</span></span>
      <span class="sn-divider"></span>
      <span class="sn-stat"><span class="sn-val">${s.ae_summary.discontinued}</span><span class="sn-label"> 중단</span></span>
    </div>
    <span class="sn-dsmb">DSMB ${s.dsmb_next}</span>
    <span class="sn-expand">▼</span>
  </div>`;

  // 확장 팝업: 방문별 AE 바 차트
  const maxAE = Math.max(...s.ae_by_visit,1);
  const bars = s.ae_by_visit.map((v,i)=>{
    const h = Math.max(2, (v/maxAE)*20);
    const barCls = i<PAST_VISITS.length ? (v>3?'serious':'') : '';
    const opacity = i<PAST_VISITS.length ? 1 : 0.3;
    return `<div class="ae-bar ${barCls}" style="height:${h}px;opacity:${opacity};" title="${VISITS[i]?.id||'V'+(i+1)}: ${v}건"></div>`;
  }).join('');

  popup.innerHTML = `
    <div class="sp-header">
      <div class="sp-title">🛡️ 안전성 상세</div>
      <button class="sp-close" id="safetyPopupClose">✕</button>
    </div>
    <div class="sp-body">
      <div class="sp-stat"><div class="sv" style="color:#374151;">${s.ae_summary.total}</div><div class="sl">총 AE</div></div>
      <div class="sp-stat"><div class="sv" style="color:${C.vermillion};">${s.ae_summary.serious}</div><div class="sl">중대 (SAE)</div></div>
      <div class="sp-stat"><div class="sv" style="color:${C.amber};">${s.ae_summary.related}</div><div class="sl">약물 관련</div></div>
      <div class="sp-stat"><div class="sv" style="color:${s.ae_summary.discontinued>0?C.vermillion:C.green};">${s.ae_summary.discontinued}</div><div class="sl">중단</div></div>
      <div style="flex:1;min-width:100px;">
        <div style="font-size:9px;color:#6b7280;margin-bottom:2px;">방문별 AE (${VISITS.map(v=>v.id).join(' ')})</div>
        <div class="ae-timeline">${bars}</div>
      </div>
    </div>`;

  // 클릭으로 토글
  document.getElementById('safetyNotifBtn').addEventListener('click',()=>{
    popup.classList.toggle('open');
    const arrow = strip.querySelector('.sn-expand');
    if(arrow) arrow.textContent = popup.classList.contains('open') ? '▲' : '▼';
  });
  document.getElementById('safetyPopupClose').addEventListener('click',(e)=>{
    e.stopPropagation();
    popup.classList.remove('open');
    const arrow = strip.querySelector('.sn-expand');
    if(arrow) arrow.textContent = '▼';
  });
}

// ===============================================
// TD-1: TIMELINE — config-driven + semantic zoom
// ===============================================
// 공통: phases 미정의 시 자동 생성
function autoPhases(tl){
  if(tl.phases && tl.phases.length > 0) return;
  const pts = tl.points;
  const firstDay = pts[0].target_day;
  const lastDay = pts[pts.length-1].target_day;
  if(STUDY_CONFIG.research_type === 'retrospective'){
    // 후향적: 기저/노출/결과 3단계
    tl.phases = [
      {name:'기저 관찰',key:'observation',start:firstDay,end:Math.floor(firstDay/2),color:'#94a3b8'},
      {name:'노출 기간',key:'index',start:Math.floor(firstDay/2)+1,end:0,color:'#6366f1'},
      {name:'결과 기간',key:'outcome',start:1,end:lastDay,color:'#0ea5e9'},
    ];
  } else {
    tl.phases = [
      {name:'관찰',key:'observation',start:firstDay,end:0,color:'#94a3b8'},
      {name:'추적',key:'followup',start:0,end:lastDay,color:'#6366f1'},
    ];
  }
}

function buildTimeline(){
  const tl = STUDY_CONFIG.timeline;
  const bar = document.getElementById('tlBar');
  const labels = document.getElementById('tlLabels');
  const milestones = document.getElementById('tlMilestones');
  // v11: retro scenarios may not have phases — autoPhases 호출
  autoPhases(tl);
  const totalSpan = tl.phases[tl.phases.length-1].end - tl.phases[0].start;
  const offset = -tl.phases[0].start;

  // Phase bars — 개요: today_day 기준으로 과거(solid)/미래(dashed) 구분
  const isRetroOv = STUDY_CONFIG.research_type === 'retrospective';
  const isHybridOv = STUDY_CONFIG.research_type === 'hybrid';
  const isProspOv = STUDY_CONFIG.research_type === 'prospective';
  const todayDay = tl.today_day; // 고정 "오늘" (null = 후향적)
  const hasToday = todayDay !== null && todayDay !== undefined;
  let barHTML = '';
  tl.phases.forEach(p=>{
    const left = ((p.start + offset)/totalSpan*100).toFixed(1);
    if(hasToday){
      // 전향적/하이브리드: today_day 기준으로 solid/dashed 분할
      const isFuturePhase = p.start > todayDay;
      if(isFuturePhase){
        const width = ((p.end - p.start)/totalSpan*100).toFixed(1);
        barHTML += `<div class="tl-phase ${p.key}" style="left:${left}%;width:${width}%;opacity:0.35;border:2px dashed currentColor;background:transparent;color:inherit;">${p.name}</div>`;
      } else if(p.end > todayDay){
        // 오늘이 이 phase 내에 있음: 과거 부분 solid + 미래 부분 dashed
        const pastW = ((todayDay - p.start)/totalSpan*100).toFixed(1);
        barHTML += `<div class="tl-phase ${p.key}" style="left:${left}%;width:${pastW}%;">${p.name}</div>`;
        const futL = ((todayDay + offset)/totalSpan*100).toFixed(1);
        const futW = ((p.end - todayDay)/totalSpan*100).toFixed(1);
        barHTML += `<div class="tl-phase ${p.key}" style="left:${futL}%;width:${futW}%;opacity:0.35;border:2px dashed currentColor;background:transparent;"></div>`;
      } else {
        // 과거 phase: 전부 solid
        const width = ((p.end - p.start)/totalSpan*100).toFixed(1);
        barHTML += `<div class="tl-phase ${p.key}" style="left:${left}%;width:${width}%;">${p.name}</div>`;
      }
    } else {
      // 후향적: 전부 solid (모든 데이터 이미 수집완료)
      const width = ((p.end - p.start)/totalSpan*100).toFixed(1);
      barHTML += `<div class="tl-phase ${p.key}" style="left:${left}%;width:${width}%;">${p.name}</div>`;
    }
  });

  // Visit windows + dots on bar
  VISITS.forEach(v=>{
    if(v.window){
      const wStart = v.target_day + v.window[0];
      const wEnd = v.target_day + v.window[1];
      const wLeft = ((wStart + offset)/totalSpan*100).toFixed(2);
      const wWidth = ((wEnd - wStart)/totalSpan*100).toFixed(2);
      barHTML += `<div class="tl-vwindow" style="left:${wLeft}%;width:${wWidth}%;" title="${v.id} window: D${wStart}~D${wEnd}"></div>`;
    }
  });
  barHTML += '<div class="tl-visit-dots">';
  VISITS.forEach(v=>{
    const vl = ((v.target_day + offset)/totalSpan*100).toFixed(1);
    const isFuture = hasToday && v.target_day > todayDay;
    barHTML += `<div class="tl-vdot${isFuture?' future':''}" style="left:${vl}%;${isFuture?'opacity:0.35;':''}" title="${v.id} (D${v.target_day})"></div>`;
  });
  barHTML += '</div>';

  // 개요: research_type별 고정 마커
  if(isRetroOv){
    // 후향적: M0 기준시점만 (오늘 없음)
    const m0Left = ((0 + offset)/totalSpan*100).toFixed(1);
    barHTML += `<div class="tl-now" style="left:${m0Left}%;"><div class="tl-now-line" style="background:#6366f1;"></div><div class="tl-now-label" style="color:#6366f1;">M0</div></div>`;
  } else if(isHybridOv){
    // 하이브리드: BL 전환점 + "오늘" 고정 마커
    const blLeft = ((0 + offset)/totalSpan*100).toFixed(1);
    barHTML += `<div class="tl-now" style="left:${blLeft}%;"><div class="tl-now-line" style="background:#8b5cf6;"></div><div class="tl-now-label" style="color:#8b5cf6;">BL (전환)</div></div>`;
    const todayLeftH = ((todayDay + offset)/totalSpan*100).toFixed(1);
    barHTML += `<div class="tl-now" style="left:${todayLeftH}%;"><div class="tl-now-line" style="background:#ea580c;"></div><div class="tl-now-label" style="background:#ea580c;color:white;">오늘</div></div>`;
  } else if(isProspOv){
    // 전향적: "오늘" 고정 마커 (today_day 기준, scrub과 무관)
    const todayLeftP = ((todayDay + offset)/totalSpan*100).toFixed(1);
    barHTML += `<div class="tl-now" style="left:${todayLeftP}%;"><div class="tl-now-line" style="background:#ea580c;"></div><div class="tl-now-label" style="background:#ea580c;color:white;">오늘</div></div>`;
  }

  // 개요 탭: 전체 프로젝트 타임라인 (드래그/시간조절 없음 — 테이블 탭에서 조작)
  bar.innerHTML = barHTML;

  // Labels based on zoom
  const isStudyDay = document.getElementById('tlDay').classList.contains('active');
  if(currentZoom <= 1){
    // Epoch/Study level — show phase boundaries
    let pts = tl.phases.map(p => ({day:p.start, label: isStudyDay ? 'D'+p.start : dayToDate(p.start)}));
    const lastEnd = tl.phases[tl.phases.length-1].end;
    pts.push({day:lastEnd, label: isStudyDay ? 'D'+lastEnd : dayToDate(lastEnd)});
    // 개요: research_type별 기준점 라벨 — day 0 중복 방지
    if(STUDY_CONFIG.research_type === 'retrospective'){
      // day 0이 이미 phase boundary에 있으면 해당 항목을 M0로 대체
      const existing0 = pts.findIndex(p=>p.day===0);
      if(existing0 >= 0){
        pts[existing0] = {day:0, label: isStudyDay ? 'D0 (M0)' : dayToDate(0)+' (M0)', isM0:true};
      } else {
        const m0Idx = pts.findIndex(p=>p.day > 0);
        if(m0Idx >= 0) pts.splice(m0Idx,0,{day:0, label: isStudyDay ? 'D0 (M0)' : dayToDate(0)+' (M0)', isM0:true});
      }
    } else if(STUDY_CONFIG.research_type === 'hybrid'){
      const existing0 = pts.findIndex(p=>p.day===0);
      if(existing0 >= 0){
        pts[existing0] = {day:0, label: isStudyDay ? 'D0 (BL)' : dayToDate(0)+' (전환)', isBL:true};
      } else {
        const blIdx = pts.findIndex(p=>p.day > 0);
        if(blIdx >= 0) pts.splice(blIdx,0,{day:0, label: isStudyDay ? 'D0 (BL)' : dayToDate(0)+' (전환)', isBL:true});
      }
    } else if(hasToday){
      // 전향적/하이브리드: "오늘" 위치 표시 (고정)
      const nowIdx = pts.findIndex(p=>p.day > todayDay);
      if(nowIdx >= 0) pts.splice(nowIdx,0,{day:todayDay, label: isStudyDay ? 'D'+todayDay+' (오늘)' : dayToDate(todayDay)+' (오늘)', isNow:true});
    }
    labels.innerHTML = pts.map(p=>`<span${p.isM0?' style="color:#6366f1;font-weight:600;"':p.isBL?' style="color:#8b5cf6;font-weight:600;"':p.isNow?' style="color:#ea580c;font-weight:600;"':''}>${p.label}</span>`).join('');
  } else {
    // Visit level — show visits (today_day 기준 past/future)
    const pts = VISITS.map(v => {
      const isFuture = hasToday && v.target_day > todayDay;
      return {day:v.target_day, label: isStudyDay ? v.id+' D'+v.target_day : v.id+' '+dayToDate(v.target_day), isFuture};
    });
    labels.innerHTML = pts.map(v=>`<span${v.isFuture?' style="opacity:0.4;"':''}>${v.label}</span>`).join('');
  }

  // Milestones — regulatory_only 마일스톤 조건부 표시
  const regType = STUDY_CONFIG.regulatory.type;
  const filteredMs = tl.milestones.filter(m=>{
    if(!m.regulatory_only) return true;
    if(regType==='none') return false; // 규제 해당없음 → 생략
    return true;
  }).map(m=>{
    if(!m.regulatory_only) return m;
    // regulatory type에 따라 라벨 동적 변경
    const label = regType==='irb'?'IRB 승인':regType==='irb_exempt'?'IRB 면제 확인':regType==='ethics_committee'?'윤리위 승인':m.label;
    return {...m, label};
  });
  milestones.innerHTML = filteredMs.map(m=>`<div class="ms"><span class="ms-dot ${m.status}"></span>${m.label} (${m.date.slice(5)})</div>`).join('');
}

// ===============================================
// TIMELINE DRAG SCRUBBER — 시간 여행
// ===============================================
let _tlDragActive = false;
// 데이터 밀도 상수 — measurement_freq별 하루당 예상 측정 횟수
const FREQ_DENSITY = {continuous:288,daily:1,per_visit:0.07,weekly:0.14};

// v11: AUTO_RENDERER — domain × value_type → renderer
const AUTO_RENDERER = {
  measurement: {numeric:'numeric_line',proportion:'severity_zone',ordinal:'severity_zone',binary:'binary_strip'},
  observation: {categorical:'image_gallery',numeric:'numeric_line',binary:'binary_strip',ordinal:'severity_zone'},
  drug_exposure: {numeric:'dose_bar',binary:'binary_strip',proportion:'severity_zone'},
  condition_occurrence: {numeric:'numeric_line',categorical:'event_strip',binary:'binary_strip',ordinal:'severity_zone'},
  device_exposure: {numeric:'numeric_line',proportion:'severity_zone',binary:'binary_strip'},
  procedure_occurrence: {binary:'binary_strip',numeric:'numeric_line',categorical:'event_strip'},
  specimen: {binary:'binary_strip',numeric:'numeric_line'},
  visit_occurrence: {numeric:'numeric_line',binary:'binary_strip'},
};
function resolveRenderer(m){
  if(m.renderer) return m.renderer;
  const dm = AUTO_RENDERER[m.domain];
  if(dm && dm[m.value_type]) return dm[m.value_type];
  return 'numeric_line';
}
// v11: Priority ordering
const PRIORITY_ORDER = ['primary','secondary','exploratory','safety','operational'];
function getOrderedMetrics(){
  return [...STUDY_CONFIG.metrics].sort((a,b)=>
    PRIORITY_ORDER.indexOf(a.priority||'exploratory') - PRIORITY_ORDER.indexOf(b.priority||'exploratory')
  );
}

function attachTimelineDrag(){
  const bar = document.getElementById('tlBar');
  const handle = document.getElementById('tlHandle');
  if(!bar || !handle) return;

  const tl = STUDY_CONFIG.timeline;
  // v11: retro scenarios may not have phases — autoPhases 호출
  autoPhases(tl);
  const totalSpan = tl.phases[tl.phases.length-1].end - tl.phases[0].start;
  const phaseStart = tl.phases[0].start;
  const minDay = VISITS[0].target_day;
  const maxDay = VISITS[VISITS.length-1].target_day;

  function pctToDay(pct){
    const raw = phaseStart + pct * totalSpan;
    // day 단위 (정수) — visit에 스냅하지 않음
    return Math.max(minDay, Math.min(maxDay, Math.round(raw)));
  }
  function getPct(e){
    const rect = bar.getBoundingClientRect();
    return Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
  }
  // 현재 day가 어느 visit window에 있는지 (또는 사이인지) 표시
  function dayContext(day){
    // 이 day가 속한 visit window 찾기
    for(const v of VISITS){
      if(day >= v.target_day + (v.window?.[0]||0) && day <= v.target_day + (v.window?.[1]||0)){
        return {in_window:v.id, msg:`${v.id} window 내`};
      }
    }
    // 두 visit 사이
    const prev = [...VISITS].reverse().find(v=>v.target_day<=day);
    const next = VISITS.find(v=>v.target_day>day);
    if(prev && next) return {between:[prev.id,next.id], msg:`${prev.id}↔${next.id} 사이`};
    return {msg:''};
  }

  let rafId = null;
  function onMove(e){
    e.preventDefault();
    if(rafId) return;
    rafId = requestAnimationFrame(()=>{
      rafId = null;
      const pct = getPct(e.touches ? e.touches[0] : e);
      const rawDay = pctToDay(pct);
      const nowPct = ((rawDay - phaseStart)/totalSpan*100).toFixed(1);
      handle.style.left = nowPct + '%';
      const nowLine = bar.querySelector('.tl-now');
      if(nowLine) nowLine.style.left = nowPct + '%';
      // 툴팁: day + visit context
      const tooltip = handle.querySelector('.tl-day-tooltip');
      const isSD = document.getElementById('tlDay').classList.contains('active');
      const ctx = dayContext(rawDay);
      if(tooltip) tooltip.textContent = (isSD ? 'D'+rawDay : dayToDate(rawDay)) + (ctx.msg ? ' · '+ctx.msg : '');
    });
  }

  let _lastScrubDay = tl.current_day;
  function onEnd(e){
    handle.classList.remove('dragging');
    document.removeEventListener('mousemove', onMove);
    document.removeEventListener('mouseup', onEnd);
    document.removeEventListener('touchmove', onMove);
    document.removeEventListener('touchend', onEnd);
    _tlDragActive = false;

    const pct = getPct(e.changedTouches ? e.changedTouches[0] : e);
    const rawDay = pctToDay(pct);
    if(rawDay === _lastScrubDay) return;
    _lastScrubDay = rawDay;
    scrubToDay(rawDay);
  }

  handle.addEventListener('mousedown', (e)=>{
    e.preventDefault(); _tlDragActive = true;
    handle.classList.add('dragging');
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onEnd);
  });
  handle.addEventListener('touchstart', (e)=>{
    _tlDragActive = true;
    handle.classList.add('dragging');
    document.addEventListener('touchmove', onMove, {passive:false});
    document.addEventListener('touchend', onEnd);
  });

  // Click on bar → day-level jump (no visit snap)
  bar.addEventListener('click', (e)=>{
    if(_tlDragActive) return;
    if(e.target.closest('.tl-handle')) return;
    const pct = getPct(e);
    const rawDay = pctToDay(pct);
    if(rawDay === tl.current_day) return;
    scrubToDay(rawDay);
  });
}

// ===============================================
// SCRUB TO DAY — day 단위 시간 이동
// visit point 기준 PAST/FUTURE 분할 + 전체 리빌드
// ===============================================
function scrubToDay(newDay){
  const tl = STUDY_CONFIG.timeline;
  tl.current_day = newDay;

  // PAST/FUTURE 재분할 — day가 visit window 사이에 있으면
  // "마지막으로 지난 visit"까지를 past로 계산
  PAST_VISITS.length = 0;
  VISITS.filter(v=>v.target_day<=newDay).forEach(p=>PAST_VISITS.push(p));
  FUTURE_VISITS.length = 0;
  VISITS.filter(v=>v.target_day>newDay).forEach(p=>FUTURE_VISITS.push(p));
  PAST_LABELS.length = 0;
  PAST_VISITS.forEach(v=>PAST_LABELS.push(v.id));

  const nPast = PAST_VISITS.length;
  if(nPast < 1) return;

  // 데이터 재생성 — today_day 기준 실제 수집된 visit까지만 데이터 생성
  // scrub이 오늘 이후로 가더라도 수집 데이터는 오늘까지만 존재
  const todayDay = tl.today_day;
  const hasToday = todayDay !== null && todayDay !== undefined;
  const nCollected = hasToday ? VISITS.filter(v=>v.target_day<=todayDay).length : nPast;
  const nData = Math.min(nPast, nCollected); // 실제 데이터가 있는 visit 수
  EXP_DATA = generatePatientData(PATIENT_PROFILES.exp, nData);
  CTRL_DATA = generatePatientData(PATIENT_PROFILES.ctrl, nData);
  ALL = generateALL(nData);
  STUDY_CONFIG.safety.ae_by_visit = VISITS.map((_,i)=>i<nData?Math.floor(seededRandom(i*7+1)()*5+1):0);

  // 마일스톤 상태 업데이트
  tl.milestones.forEach(m=>{
    m.status = m.day<=newDay ? 'done' : 'future';
  });
  const nowMs = tl.milestones.filter(m=>m.day<=newDay).pop();
  if(nowMs) nowMs.status = 'now';

  // 전체 UI 리빌드
  initPageHeader();
  buildVerdictBadges();
  buildSafetyStrip();
  buildTimeline();
  buildMetricsGrid();
  buildActionCenter();
  updateSidePanelBadge();
  rebuildTable();
  buildMiniTimeline();
  buildAIStrip();
  updateDensityStrip(newDay);
  // 집계 단위 + 시간 그리드 갱신
  if(typeof updateAggOptions === 'function') updateAggOptions();
  if(typeof buildTimeGrid === 'function') buildTimeGrid();
}

// ===============================================
// 데이터 밀도 스트립 — metric별 해당 day에서의 데이터 해상도 표시
// "이 시점에서 각 지표는 몇 건의 raw 측정이 존재하는가"
// ===============================================
function updateDensityStrip(day){
  const el = document.getElementById('tlDensity');
  if(!el) return;
  let html = '<span style="font-size:7px;color:#9ca3af;white-space:nowrap;margin-right:2px;">D'+day+'</span>';
  STUDY_CONFIG.metrics.forEach(m=>{
    const freq = m.measurement_freq || 'per_visit';
    const density = FREQ_DENSITY[freq] || 0;
    const barW = Math.min(100, Math.max(8, Math.log2(density+1)/Math.log2(289)*100));
    const barColor = density>=24 ? '#0072B2' : density>=1 ? '#009E73' : '#E69F00';
    const tip = m.name+': '+(density>=1?Math.round(density)+'건/일':density>0?Math.round(1/density)+'일/1건':'—');
    html += '<div class="td-chip" title="'+tip+'"><span style="color:'+m.color+';">'+(m.short_name||m.name.slice(0,2))+'</span><div class="td-bar"><div class="td-fill" style="width:'+barW+'%;background:'+barColor+';"></div></div></div>';
  });
  el.innerHTML = html;
}

function dayToDate(day, forceYear){
  const base = new Date(STUDY_CONFIG.timeline.base_date);
  base.setDate(base.getDate() + day);
  const m = base.getMonth()+1;
  const d = base.getDate();
  // 연구 기간이 300일 이상이면 연도 표시 (후향적/하이브리드 등 여러 해 걸치는 경우)
  const tl = STUDY_CONFIG.timeline;
  const phases = tl.phases;
  let showYear = forceYear || false;
  if(!showYear && phases && phases.length > 0){
    const span = phases[phases.length-1].end - phases[0].start;
    if(span > 300) showYear = true;
  }
  if(showYear){
    const y = String(base.getFullYear()).slice(2); // 2자리 연도
    return `'${y}.${m}/${d}`;
  }
  return m + '/' + d;
}

document.getElementById('tlCal').addEventListener('click',function(){
  this.classList.add('active');document.getElementById('tlDay').classList.remove('active');
  // 미니타임라인도 동기화
  const mc=document.getElementById('mtlCal'),md=document.getElementById('mtlDay');
  if(mc&&md){mc.classList.add('active');md.classList.remove('active');}
  buildTimeline();
});
document.getElementById('tlDay').addEventListener('click',function(){
  this.classList.add('active');document.getElementById('tlCal').classList.remove('active');
  const mc=document.getElementById('mtlCal'),md=document.getElementById('mtlDay');
  if(mc&&md){md.classList.add('active');mc.classList.remove('active');}
  buildTimeline();
});

// ===============================================
// CHART DRAWING (reused from v9, adapted for visits)
// ===============================================
let metricData={};

function drawChart(ctx,W,H,m,expPast,ctrlPast,expFuture,ctrlFuture,expSE,ctrlSE,expFutureSE,ctrlFutureSE,large){
  const nPast=expPast.length, nFuture=expFuture.length, nTotal=nPast+nFuture;
  const pad=large?{t:10,b:16,l:10,r:10}:{t:4,b:4,l:4,r:4};
  const cw=W-pad.l-pad.r,ch=H-pad.t-pad.b;
  const allV=[...expPast,...ctrlPast,...expFuture,...ctrlFuture].filter(v=>v!=null);
  let mn=Math.min(...allV),mx=Math.max(...allV);
  const mg=(mx-mn)*0.15||5;mn-=mg;mx+=mg;
  function xP(i){return pad.l+(i/(nTotal-1||1))*cw;}
  function yP(v){return pad.t+(1-(v-mn)/(mx-mn))*ch;}

  ctx.clearRect(0,0,W,H);
  const _isRetroChart = STUDY_CONFIG.research_type === 'retrospective';
  const _todayDay = STUDY_CONFIG.timeline.today_day;
  const _hasToday = _todayDay !== null && _todayDay !== undefined;
  // now-line 위치: today_day 기준 visit 인덱스
  let _todayVisitIdx = nPast - 0.5; // fallback
  if(_hasToday){
    const pastOfToday = VISITS.filter(v=>v.target_day<=_todayDay).length;
    _todayVisitIdx = pastOfToday - 0.5;
  }
  const nowX = xP(_todayVisitIdx);
  if(_hasToday && !_isRetroChart){
    // 전향적/하이브리드: today_day 기준 과거(파랑)/미래(회색) + now line
    ctx.fillStyle='rgba(0,114,178,.02)';ctx.fillRect(pad.l,pad.t,nowX-pad.l,ch);
    ctx.fillStyle='rgba(0,0,0,.01)';ctx.fillRect(nowX,pad.t,cw-(nowX-pad.l),ch);
    ctx.strokeStyle=C.vermillion;ctx.lineWidth=large?1.5:1;ctx.globalAlpha=0.3;
    ctx.beginPath();ctx.moveTo(nowX,pad.t);ctx.lineTo(nowX,pad.t+ch);ctx.stroke();ctx.globalAlpha=1;
  } else {
    // 후향적 or no today: 전체가 수집 완료 — 균일 배경
    ctx.fillStyle='rgba(0,114,178,.015)';ctx.fillRect(pad.l,pad.t,cw,ch);
  }

  // CI bands
  if(expFutureSE&&ctrlFutureSE&&expFutureSE.length>0){
    ctx.globalAlpha=0.1;
    ctx.fillStyle=C.blue;ctx.beginPath();
    if(expPast[nPast-1]!=null)ctx.moveTo(xP(nPast-1),yP(expPast[nPast-1]));
    expFuture.forEach((v,i)=>{if(v!=null)ctx.lineTo(xP(nPast+i),yP(v+expFutureSE[i]));});
    for(let i=expFuture.length-1;i>=0;i--){if(expFuture[i]!=null)ctx.lineTo(xP(nPast+i),yP(expFuture[i]-expFutureSE[i]));}
    if(expPast[nPast-1]!=null)ctx.lineTo(xP(nPast-1),yP(expPast[nPast-1]));
    ctx.closePath();ctx.fill();
    ctx.fillStyle=C.vermillion;ctx.beginPath();
    if(ctrlPast[nPast-1]!=null)ctx.moveTo(xP(nPast-1),yP(ctrlPast[nPast-1]));
    ctrlFuture.forEach((v,i)=>{if(v!=null)ctx.lineTo(xP(nPast+i),yP(v+ctrlFutureSE[i]));});
    for(let i=ctrlFuture.length-1;i>=0;i--){if(ctrlFuture[i]!=null)ctx.lineTo(xP(nPast+i),yP(ctrlFuture[i]-ctrlFutureSE[i]));}
    if(ctrlPast[nPast-1]!=null)ctx.lineTo(xP(nPast-1),yP(ctrlPast[nPast-1]));
    ctx.closePath();ctx.fill();ctx.globalAlpha=1;
  }

  // Individual patients (large only)
  if(large){
    [EXP_DATA,CTRL_DATA].forEach((group,gi)=>{
      group.forEach(p=>{const a=p.past[m.k];if(!a)return;
        ctx.beginPath();ctx.strokeStyle=gi===0?C.skyblue:C.pink;ctx.lineWidth=0.8;ctx.globalAlpha=0.35;
        let s=false;a.forEach((v,i)=>{if(v==null)return;if(!s){ctx.moveTo(xP(i),yP(v));s=true;}else ctx.lineTo(xP(i),yP(v));});
        ctx.stroke();ctx.globalAlpha=1;
      });
    });
  }

  // Group mean lines
  function drawGroupLine(past,future,color){
    ctx.beginPath();ctx.strokeStyle=color;ctx.lineWidth=large?2.5:1.8;ctx.lineJoin='round';ctx.lineCap='round';
    let s=false;
    past.forEach((v,i)=>{if(v==null)return;if(!s){ctx.moveTo(xP(i),yP(v));s=true;}else ctx.lineTo(xP(i),yP(v));});
    ctx.stroke();
    if(future&&future.length>0){
      ctx.setLineDash([large?5:3,large?4:3]);ctx.globalAlpha=0.5;
      ctx.beginPath();
      if(past[nPast-1]!=null)ctx.moveTo(xP(nPast-1),yP(past[nPast-1]));
      future.forEach((v,i)=>{if(v!=null)ctx.lineTo(xP(nPast+i),yP(v));});
      ctx.stroke();ctx.setLineDash([]);ctx.globalAlpha=1;
    }
  }
  drawGroupLine(expPast,expFuture,C.blue);
  if(STUDY_CONFIG.design.has_control_arm) drawGroupLine(ctrlPast,ctrlFuture,C.vermillion);

  // Visit labels (large)
  if(large){
    ctx.fillStyle='#9ca3af';ctx.font='10px -apple-system,sans-serif';ctx.textAlign='center';
    VISIT_LABELS.forEach((l,i)=>{ctx.fillText(l,xP(i),H-2);});
    if(_hasToday && !_isRetroChart){
      ctx.fillStyle=C.vermillion;ctx.font='bold 10px -apple-system,sans-serif';
      ctx.fillText(STUDY_CONFIG.research_type==='hybrid'?'오늘':'오늘',nowX,pad.t-2);
    }
  }
}

// ===============================================
// METRICS GRID — TD-3: renderer 타입 표시
// ===============================================
function buildMetricsGrid(){
  const grid=document.getElementById('metricsGrid');grid.innerHTML='';
  const nPast=PAST_VISITS.length, nFuture=FUTURE_VISITS.length;

  STUDY_CONFIG.metrics.forEach(m=>{
    const expPast=groupAvg(EXP_DATA,m.k);
    const ctrlPast=groupAvg(CTRL_DATA,m.k);
    const isRetroStudy = STUDY_CONFIG.research_type === 'retrospective';
    // 후향적: 예측 없음 (모든 데이터 이미 존재)
    const expFuture=isRetroStudy ? [] : project(expPast,nFuture);
    const ctrlFuture=isRetroStudy ? [] : project(ctrlPast,nFuture);
    const expSE=groupSE(EXP_DATA,m.k);
    const ctrlSE=groupSE(CTRL_DATA,m.k);
    const expFutureSE=isRetroStudy ? [] : projectCI(expSE,nFuture);
    const ctrlFutureSE=isRetroStudy ? [] : projectCI(ctrlSE,nFuture);
    metricData[m.k]={expPast,ctrlPast,expFuture,ctrlFuture,expSE,ctrlSE,expFutureSE,ctrlFutureSE};

    const li=nPast-1;
    const d=expPast[li]!=null&&expPast[0]!=null?expPast[li]-expPast[0]:0;
    const isGood=m.direction==='monitor'?true:(m.direction==='down'&&d<0)||(m.direction==='up'&&d>0);
    const dStr=m.k==='steps'?(d>0?'+':'')+Math.round(d).toLocaleString():(d>0?'+':'')+d.toFixed(1)+m.unit;
    const badgeText=m.direction==='monitor'?'모니터링':pStr(m.p_value);
    const badgeCls=m.direction==='monitor'?'ns':pCls(m.p_value);

    const card=document.createElement('div');card.className='metric-card';
    const derivedBadge = m.derived ? '<span class="mc-derived">파생</span>' : '';

    // TD-3: 렌더러별 차트 영역 분기
    let chartHTML = '';
    const effectiveRenderer = resolveRenderer(m);
    if(effectiveRenderer === 'image_gallery'){
      // 피부 사진 갤러리 — 방문별 썸네일 + 점수
      const scores = expPast.map(v => v != null ? v.toFixed(1) : '—');
      const emojis = ['🔴','🟠','🟡','🟢'];
      chartHTML = `<div class="img-strip" id="mc-${m.k}">` +
        PAST_VISITS.map((v,vi) => {
          const sc = expPast[vi];
          const ei = sc != null ? Math.min(3, Math.floor((10 - sc) / 2.5)) : 0;
          const bg = sc != null ? `hsl(${ei*40},70%,95%)` : '#f3f4f6';
          return `<div class="img-thumb"><div class="ph" style="background:${bg};">${sc!=null?emojis[ei]:'—'}</div><div class="ph-label">${v.id} ${sc!=null?sc.toFixed(1):''}</div></div>`;
        }).join('') + '</div>';
    } else if(effectiveRenderer === 'severity_zone'){
      // TIR severity zone — 스택드 바 (green=범위내, amber=위, red=아래)
      chartHTML = `<div class="severity-strip" id="mc-${m.k}">` +
        PAST_VISITS.map((v,vi) => {
          const tir = expPast[vi] || 0;
          const above = Math.min(100-tir, (100-tir)*0.6);
          const below = 100 - tir - above;
          return `<div class="sev-col">
            <div class="sev-seg" style="height:${above*0.7}px;background:#fbbf24;"></div>
            <div class="sev-seg" style="height:${tir*0.7}px;background:#10b981;"></div>
            <div class="sev-seg" style="height:${below*0.7}px;background:#ef4444;"></div>
          </div>`;
        }).join('') +
        '</div><div class="sev-legend"><span><span class="sq" style="background:#10b981;"></span>범위 내</span><span><span class="sq" style="background:#fbbf24;"></span>고혈당</span><span><span class="sq" style="background:#ef4444;"></span>저혈당</span></div>';
    } else if(effectiveRenderer === 'binary_strip'){
      // v11: binary strip — ●/○ dot map
      chartHTML = '<div class="binary-strip" id="mc-'+m.k+'">' +
        PAST_VISITS.map((v,vi) => {
          const val = expPast[vi];
          if(val==null) return '<div class="bin-dot null" title="'+v.id+': N/A"></div>';
          return '<div class="bin-dot '+(val>0.5?'on':'off')+'" title="'+v.id+': '+(val>0.5?'Y':'N')+'"></div>';
        }).join('') + '</div>';
    } else if(effectiveRenderer === 'event_strip'){
      // v11: event strip — timeline markers
      const icons = ['🔵','🟡','🔴','⚪'];
      chartHTML = '<div class="event-strip" id="mc-'+m.k+'">' +
        PAST_VISITS.map((v,vi) => {
          const val = expPast[vi];
          if(val==null) return '<div class="evt-marker"><span class="evt-icon">⚪</span><span class="evt-label">'+v.id+'</span></div>';
          const idx = Math.min(3, Math.floor(val / 3));
          return '<div class="evt-marker"><span class="evt-icon">'+icons[idx]+'</span><span class="evt-label">'+v.id+' ('+val.toFixed(0)+')</span></div>';
        }).join('') + '</div>';
    } else if(effectiveRenderer === 'dose_bar'){
      // v11: dose bar — drug dosing visualization
      const maxDose = Math.max(...expPast.filter(v=>v!=null), 1);
      chartHTML = '<div class="dose-bar-strip" id="mc-'+m.k+'">' +
        PAST_VISITS.map((v,vi) => {
          const val = expPast[vi];
          if(val==null) return '<div style="flex:1;"><div class="dose-bar" style="height:2px;background:#d1d5db;"></div><div class="dose-bar-label">'+v.id+'</div></div>';
          const h = Math.max(4, (val/maxDose)*60);
          const color = val > maxDose*0.8 ? C.vermillion : val > maxDose*0.5 ? C.amber : C.blue;
          return '<div style="flex:1;"><div class="dose-bar" style="height:'+h+'px;background:'+color+';"></div><div class="dose-bar-label">'+v.id+'</div></div>';
        }).join('') + '</div>';
    } else {
      chartHTML = `<div class="mc-chart"><canvas id="mc-${m.k}"></canvas></div>`;
    }

    card.innerHTML=`
      ${derivedBadge}
      <span class="expand-hint">🔍 클릭</span>
      <div class="mc-header">
        <div class="mc-name"><span class="dot" style="background:${m.color};"></span>${m.name} <span style="font-size:8px;color:#9ca3af;">[${m.source}${m.measurement_freq&&m.measurement_freq!=='per_visit'?' · '+({continuous:'연속',daily:'일별',weekly:'주별'}[m.measurement_freq]||m.measurement_freq)+(m.agg_rule?' → '+({visit_mean:'평균',visit_sum:'합계',visit_pct:'%'}[m.agg_rule]||m.agg_rule):''):''}]</span></div>
        <span class="mc-badge ${badgeCls}">${badgeText}</span>
      </div>
      ${chartHTML}
      <div class="mc-footer">
        <span class="mc-delta ${isGood?'good':m.direction==='monitor'?'neutral':'bad'}">${dStr}</span>
        <span class="mc-range">${PAST_VISITS[0].id}~${PAST_VISITS[li].id} ${isRetroStudy?'전체 수집완료':'실증'}${!isRetroStudy&&FUTURE_VISITS.length>0?' · '+FUTURE_VISITS[0].id+'~'+FUTURE_VISITS[FUTURE_VISITS.length-1].id+' 예측':isRetroStudy?'':' · 완료'}</span>
      </div>
      <div class="mc-renderer">${effectiveRenderer}${m.domain?' · '+m.domain:''}</div>`;
    card.addEventListener('click',()=>openChartModal(m));
    grid.appendChild(card);

    // Canvas 기반 렌더러만 setTimeout으로 그림
    if(effectiveRenderer === 'numeric_line'){
      setTimeout(()=>{
        const cv=document.getElementById('mc-'+m.k);if(!cv)return;
        const ctx=cv.getContext('2d');const dpr=window.devicePixelRatio||1;
        const rect=cv.parentElement.getBoundingClientRect();if(rect.width<10)return;
        cv.width=rect.width*dpr;cv.height=rect.height*dpr;
        cv.style.width=rect.width+'px';cv.style.height=rect.height+'px';
        ctx.setTransform(1,0,0,1,0,0);ctx.scale(dpr,dpr);
        drawChart(ctx,rect.width,rect.height,m,expPast,ctrlPast,expFuture,ctrlFuture,expSE,ctrlSE,expFutureSE,ctrlFutureSE,false);
      },80);
    }
  });
}

// ===============================================
// CHART MODAL
// ===============================================
function openChartModal(m){
  const modal=document.getElementById('chartModal');modal.classList.add('open');
  const d=metricData[m.k];const li=PAST_VISITS.length-1;
  document.getElementById('cmTitle').innerHTML=`<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${m.color};"></span> ${m.name} (${m.unit}) — 상세 뷰`;
  const armLabels = STUDY_CONFIG.design.arm_labels;
  document.getElementById('cmLegend').innerHTML=`
    <span><span class="ln" style="background:${C.blue};"></span>${armLabels[0]} 평균</span>
    ${STUDY_CONFIG.design.has_control_arm?`<span><span class="ln" style="background:${C.vermillion};"></span>${armLabels[1]} 평균</span>`:''}
    <span><span class="ln" style="background:${C.skyblue};"></span>${armLabels[0]} 개별</span>
    <span style="color:#9ca3af;">점선 = 예측 · 음영 = 95% CI</span>`;
  const expD=d.expPast[li]-d.expPast[0], ctrlD=d.ctrlPast[li]-d.ctrlPast[0];
  const fmt=v=>m.k==='steps'?Math.round(v).toLocaleString():v.toFixed(1);
  document.getElementById('cmStats').innerHTML=`
    <div class="cm-stat"><div class="cm-stat-label">${armLabels[0]} Δ (${PAST_VISITS[0].id}→${PAST_VISITS[li].id})</div><div class="cm-stat-value" style="color:${expD<0&&m.direction==='down'||expD>0&&m.direction==='up'?C.green:C.vermillion};">${expD>0?'+':''}${fmt(expD)}${m.unit}</div></div>
    <div class="cm-stat"><div class="cm-stat-label">${armLabels[1]} Δ</div><div class="cm-stat-value" style="color:#6b7280;">${ctrlD>0?'+':''}${fmt(ctrlD)}${m.unit}</div></div>
    <div class="cm-stat"><div class="cm-stat-label">군간 차이</div><div class="cm-stat-value">${fmt(expD-ctrlD)}${m.unit}</div></div>
    <div class="cm-stat"><div class="cm-stat-label">${m.direction==='monitor'?'모니터링 지표':'유의성 (interim)'}</div><div class="cm-stat-value">${m.direction==='monitor'?'—':pStr(m.p_value)}</div></div>`;
  // 가이드 생성 — 지표별 맥락 해석 + 차트 읽기 + 행동 제안
  buildChartGuide(m, d, expD, ctrlD, li);

  setTimeout(()=>{
    const cv=document.getElementById('cmCanvas');const ctx=cv.getContext('2d');const dpr=window.devicePixelRatio||1;
    const rect=cv.parentElement.getBoundingClientRect();
    cv.width=rect.width*dpr;cv.height=rect.height*dpr;
    cv.style.width=rect.width+'px';cv.style.height=rect.height+'px';
    ctx.setTransform(1,0,0,1,0,0);ctx.scale(dpr,dpr);
    drawChart(ctx,rect.width,rect.height,m,d.expPast,d.ctrlPast,d.expFuture,d.ctrlFuture,d.expSE,d.ctrlSE,d.expFutureSE,d.ctrlFutureSE,true);
  },50);
}

// ===============================================
// CHART GUIDE — 맥락 해석 + 차트 읽는 법 + 행동 제안
// ===============================================
function buildChartGuide(m, d, expD, ctrlD, li){
  const guide = document.getElementById('cmGuide');
  const betweenDiff = expD - ctrlD;
  const isGood = m.direction==='monitor' ? null : (m.direction==='down'&&expD<0)||(m.direction==='up'&&expD>0);
  const isSig = m.p_value < 0.05;
  const armLabels = STUDY_CONFIG.design.arm_labels;

  // 1) 해석 — 이 지표가 뭘 의미하는지
  let interpretHTML = '';
  if(m.direction === 'monitor'){
    interpretHTML = `<b>${m.name}</b>은 직접적 결과변수가 아닌 <b>모니터링 지표</b>입니다. 참여자의 상태 변화를 추적하며, 극단적 이탈이 없는지 확인하는 데 사용됩니다.`;
  } else {
    const dirWord = m.direction==='down' ? '감소' : '증가';
    const goodBad = isGood ? '기대 방향으로 변화' : '기대와 반대 방향';
    interpretHTML = `<b>${armLabels[0]}</b>에서 ${m.name}이 <b>${Math.abs(expD).toFixed(1)}${m.unit} ${dirWord}</b>했습니다 (${goodBad}). `;
    if(STUDY_CONFIG.design.has_control_arm){
      interpretHTML += `<b>${armLabels[1]}</b>은 ${Math.abs(ctrlD).toFixed(1)}${m.unit} ${ctrlD<0?'감소':'증가'}로, 군간 차이는 <b>${Math.abs(betweenDiff).toFixed(1)}${m.unit}</b>입니다.`;
    }
    if(isSig){
      interpretHTML += ` 현재 중간분석에서 <b>통계적 유의</b> (${pStr(m.p_value)}).`;
    } else {
      interpretHTML += ` 아직 통계적 유의 수준에 도달하지 않았습니다 (${pStr(m.p_value)}).`;
    }
  }

  // 2) 차트 읽는 법
  const readingHTML = `<b>실선</b> = 실측 평균 추이 · <b>점선</b> = 선형 예측 (95% CI 음영) · <b>얇은 선</b> = 개별 참여자 · <b>빨간 세로선</b> = 현재 시점 (${PAST_VISITS[li].id}). 왼쪽 영역은 실증 데이터, 오른쪽은 모델 예측입니다.`;

  // 3) 주의사항
  let cautionHTML = '';
  const cautions = [];
  if(isSig) cautions.push('중간분석 결과이며, 다중비교 보정(α 조정) 전입니다');
  if(STUDY_CONFIG.safety.stopping_rule) cautions.push(`${STUDY_CONFIG.safety.stopping_rule} 적용 전 — DSMB 검토 필요`);
  // 개별 환자 이상 체크
  const outliers = [];
  EXP_DATA.forEach(p=>{
    const a=p.past[m.k]; if(!a||a.length<2)return;
    if(m.direction==='down'&&a[li]>a[li-1]) outliers.push(`${p.id}: 최근 반등`);
    if(m.direction==='up'&&a[li]<a[li-1]) outliers.push(`${p.id}: 최근 감소`);
  });
  if(outliers.length>0) cautions.push(`개별 참여자 주의: ${outliers.join(', ')}`);
  if(cautions.length>0) cautionHTML = cautions.join('. ') + '.';

  // 4) 행동 제안
  let actionHTML = '';
  const actions = [];
  if(isGood && isSig){
    actions.push({text:'현재 추세 유지 확인 — 다음 방문까지 모니터링 지속', cls:'good'});
    actions.push({text:`DSMB 보고 준비 (다음: ${STUDY_CONFIG.safety.dsmb_next})`, cls:'info'});
  } else if(isGood && !isSig){
    actions.push({text:'표본 수 충분성 재검토 — 검정력 분석 업데이트', cls:'info'});
    actions.push({text:'추가 방문 데이터 수집 후 재분석', cls:'info'});
  } else if(!isGood){
    actions.push({text:'프로토콜 위반 또는 외부 요인 검토', cls:'warn'});
    actions.push({text:'해당 참여자 개별 데이터 확인 (테이블 탭)', cls:'warn'});
  }
  if(m.direction==='monitor'){
    actions.push({text:'극단값 또는 추세 변화 모니터링 — 임계치 초과 시 알림 설정', cls:'info'});
  }

  guide.innerHTML = `
    <div class="cm-guide-section interpret">
      <div class="cm-guide-title">💡 해석</div>
      <div class="cm-guide-text">${interpretHTML}</div>
    </div>
    <div class="cm-guide-section reading">
      <div class="cm-guide-title">📖 차트 읽는 법</div>
      <div class="cm-guide-text">${readingHTML}</div>
    </div>
    ${cautionHTML ? `<div class="cm-guide-section caution">
      <div class="cm-guide-title">⚠️ 주의</div>
      <div class="cm-guide-text">${cautionHTML}</div>
    </div>` : ''}
    ${actions.length>0 ? `<div class="cm-guide-section action">
      <div class="cm-guide-title">→ 다음 행동</div>
      <div class="cm-guide-chips">${actions.map(a=>`<span class="cm-guide-chip ${a.cls}">${a.text}</span>`).join('')}</div>
    </div>` : ''}`;
}

document.getElementById('cmClose').addEventListener('click',()=>document.getElementById('chartModal').classList.remove('open'));
document.getElementById('chartModal').addEventListener('click',e=>{if(e.target===e.currentTarget)e.currentTarget.classList.remove('open');});

// ===============================================
// AI INSIGHTS
// ===============================================
function buildAIStrip(){
  const strip=document.getElementById('aiStrip') || document.getElementById('spAI');
  if(!strip) return;
  try{
  const li=PAST_VISITS.length-1;
  strip.innerHTML=`
    <div class="ai-title">AI 발견 사항</div>
    <div class="ai-items">
      <div class="ai-item safety-alert" data-pid="P018">
        <span class="ai-icon">🛡️</span>
        <span class="ai-text"><b>P018 최예린:</b> SBP ${PAST_VISITS[li].id}에서 반등 (135→138mmHg). 약물 내성 가능성. 프로토콜 4.2조 확인 필요.</span>
        <span class="ai-action">▶ 상세보기</span><span class="ai-time">2시간 전</span>
      </div>
      <div class="ai-item alert" data-pid="P031">
        <span class="ai-icon">📉</span>
        <span class="ai-text"><b>P031 임채원:</b> 순응도 V1부터 지속 하락 (${CTRL_DATA[3].past.comp[0]}%→${CTRL_DATA[3].past.comp[li]}%). 탈락 위험.</span>
        <span class="ai-action">▶ 상세보기</span><span class="ai-time">1일 전</span>
      </div>
      <div class="ai-item finding">
        <span class="ai-icon">✅</span>
        <span class="ai-text"><b>1차 결과변수 유의 (interim):</b> 체중 감소 군간 차이 ${Math.abs(metricData.wt.expPast[li]-metricData.wt.expPast[0]-(metricData.wt.ctrlPast[li]-metricData.wt.ctrlPast[0])).toFixed(1)}kg. ⚠ ${STUDY_CONFIG.safety.stopping_rule} 적용 전.</span>
        <span class="ai-time">오늘</span>
      </div>
      <div class="ai-item info">
        <span class="ai-icon">📊</span>
        <span class="ai-text"><b>걸음수 2차 결과:</b> 실험군 +${Math.round(metricData.steps.expPast[li]-metricData.steps.expPast[0])}보 증가. ${pStr(STUDY_CONFIG.metrics[3].p_value)}</span>
        <span class="ai-time">오늘</span>
      </div>
    </div>`;
  strip.querySelectorAll('[data-pid]').forEach(el=>{
    el.addEventListener('click',()=>{switchTab('table');setTimeout(()=>{const idx=ALL.findIndex(p=>p.id===el.dataset.pid);if(idx>=0)openDetail(idx);},100);});
  });
  }catch(e){ strip.innerHTML='<div style="padding:10px;color:#9ca3af;font-size:11px;">AI 분석 — 데이터 로딩 중...</div>'; }
}

// ===============================================
// ACTION CENTER — 연구자 액션 레이어
// 리서치 결과 기반: 환자 레벨, 연구 레벨, 데이터 관리, 안전성, 커뮤니케이션
// ===============================================
function buildActionCenter(){
  const ac = document.getElementById('spAction');
  const li = PAST_VISITS.length - 1;
  const curVisit = PAST_VISITS[li];

  // 데이터 기반 동적 카운트
  const alertPatients = ALL.filter(p=>p.al).length;
  const queryCount = ALL.filter(p=>p.st==='query').length;
  const missingCount = ALL.filter(p=>p.st==='missing-visit').length;
  const lowCompCount = ALL.filter(p=>{const c=p.comp;return c&&c[li]!=null&&c[li]<70;}).length;

  // 안전성 AE 카운트
  const totalAE = STUDY_CONFIG.safety.ae_by_visit.reduce((a,b)=>a+b,0);
  const saeCount = STUDY_CONFIG.safety.sae_count || 0;

  // 중간분석 진행률
  const progressPct = Math.round(PAST_VISITS.length / VISITS.length * 100);

  // 액션 카드 어셈블리
  const pendingActions = alertPatients + queryCount + missingCount;

  // v11: Retro vs Prospective Action Center
  if(STUDY_CONFIG.research_type === 'retrospective'){
    ac.innerHTML = `
      <div class="ac-header">
        <div class="ac-title"><span class="ac-icon">🔍</span>분석 도구</div>
        <span class="retro-badge">📊 후향적 분석 모드</span>
      </div>
      <div class="ac-grid">
        <div class="ac-retro-card">
          <div class="ac-card-icon">🔍</div>
          <div class="ac-card-title">코호트 분류</div>
          <div class="ac-card-desc">포함/제외 기준 · 노출군/비노출군 분류</div>
        </div>
        <div class="ac-retro-card">
          <div class="ac-card-icon">📊</div>
          <div class="ac-card-title">통계 검정</div>
          <div class="ac-card-desc">t-test · χ² · Cox regression · OR/HR</div>
        </div>
        <div class="ac-retro-card">
          <div class="ac-card-icon">🧹</div>
          <div class="ac-card-title">데이터 필터</div>
          <div class="ac-card-desc">결측 처리 · 이상치 제외 · 교란변수 보정</div>
        </div>
        <div class="ac-retro-card">
          <div class="ac-card-icon">📤</div>
          <div class="ac-card-title">내보내기</div>
          <div class="ac-card-desc">CSV · 논문 표 · Figure 생성</div>
        </div>
      </div>
      <div class="ac-sub">
        <div class="ac-quick"><span class="aq-icon">📈</span>기술통계</div>
        <div class="ac-quick"><span class="aq-icon">🔗</span>상관분석</div>
        <div class="ac-quick"><span class="aq-icon">👥</span>서브그룹</div>
        <div class="ac-quick"><span class="aq-icon">📉</span>생존분석</div>
        <div class="ac-quick"><span class="aq-icon">📄</span>논문 Figure</div>
      </div>`;
    ac.querySelectorAll('.ac-quick,.ac-retro-card').forEach(card=>{
      card.addEventListener('click',()=>switchTab('table'));
    });
    return;
  }

  ac.innerHTML = `
    <div class="ac-header">
      <div class="ac-title"><span class="ac-icon">⚡</span>조치 필요 항목</div>
      ${pendingActions > 0 ? `<span class="ac-badge">${pendingActions}건 대기</span>` : '<span style="font-size:9px;color:#009E73;">✓ 모두 처리됨</span>'}
    </div>
    <div class="ac-grid">
      <div class="ac-card ${alertPatients>0?'urgent':'info'}">
        <div class="ac-card-icon">👤</div>
        <div class="ac-card-title">환자 조치</div>
        <div class="ac-card-desc">용량 조절 · 연락 · 조기종료 검토</div>
        <span class="ac-card-count ${alertPatients===0?'zero':''}">${alertPatients}</span>
      </div>
      <div class="ac-card ${queryCount>0?'warning':'info'}">
        <div class="ac-card-icon">📋</div>
        <div class="ac-card-title">데이터 쿼리</div>
        <div class="ac-card-desc">SDV · 이상치 확인 · 누락값 처리</div>
        <span class="ac-card-count ${queryCount===0?'zero':''}">${queryCount + missingCount}</span>
      </div>
      <div class="ac-card ${saeCount>0?'urgent':'success'}">
        <div class="ac-card-icon">🛡️</div>
        <div class="ac-card-title">안전성 보고</div>
        <div class="ac-card-desc">SAE ${saeCount}건 · AE 누적 ${totalAE}건</div>
        <span class="ac-card-count ${saeCount===0?'zero':''}">${saeCount}</span>
      </div>
      <div class="ac-card ${progressPct>=50?'info':'info'}">
        <div class="ac-card-icon">📊</div>
        <div class="ac-card-title">연구 진행</div>
        <div class="ac-card-desc">${curVisit.id} 완료 · ${progressPct}% 진행 · ${lowCompCount>0?lowCompCount+'명 저순응':'순응도 양호'}</div>
        <span class="ac-card-count zero">${progressPct}%</span>
      </div>
    </div>
    <div class="ac-sub">
      <div class="ac-quick" data-action="contact"><span class="aq-icon">📞</span>경고 환자 일괄 연락</div>
      <div class="ac-quick" data-action="dose-hold"><span class="aq-icon">💊</span>용량 보류 검토</div>
      <div class="ac-quick" data-action="query-resolve"><span class="aq-icon">✏️</span>미해결 쿼리 처리</div>
      <div class="ac-quick" data-action="interim"><span class="aq-icon">📈</span>${progressPct>=50?'중간분석 실행':'중간분석 대기'}</div>
      <div class="ac-quick" data-action="export"><span class="aq-icon">📤</span>DSMB 보고서 생성</div>
    </div>
  `;

  // Quick action 클릭
  ac.querySelectorAll('.ac-quick').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const action = btn.dataset.action;
      if(action==='contact' || action==='query-resolve') switchTab('table');
    });
  });
  ac.querySelectorAll('.ac-card,.ac-retro-card').forEach(card=>{
    card.addEventListener('click',()=>switchTab('table'));
  });
}

// ===============================================
// 프로젝트 지갑 탭 — 연구별 동적 데이터
// ===============================================
function updateWalletTab(){
  const cfg = STUDY_CONFIG;
  const rt = cfg.research_type;
  const isRetro = rt === 'retrospective';
  // IRB 상태
  const irbType = cfg.regulatory.type; // 'irb_required' | 'irb_exempt' | 'none'
  const badge = document.getElementById('wlIrbBadge');
  const content = document.getElementById('wlIrbContent');
  if(badge && content){
    if(irbType === 'none'){
      badge.style.background='#f0fdf4';badge.style.color='#15803d';badge.textContent='심의 불필요';
      content.innerHTML='이 연구는 IRB 심의가 필요하지 않습니다. 에스크로 결제를 바로 진행할 수 있습니다.';
    } else if(irbType === 'irb_exempt'){
      badge.style.background='#eff6ff';badge.style.color='#1d4ed8';badge.textContent='면제';
      content.innerHTML='IRB 심의 면제 대상 연구입니다. 면제 사유가 확인되었습니다.';
    } else {
      const hasNumber = cfg.regulatory.number && cfg.regulatory.number !== '심사 대기';
      if(hasNumber){
        badge.style.background='#f0fdf4';badge.style.color='#15803d';badge.textContent='인증 완료';
        content.innerHTML='<span style="font-weight:600;">승인번호:</span> '+cfg.regulatory.number+' <span style="color:#15803d;">✓ 인증됨</span>';
      } else {
        badge.style.background='#fef3c7';badge.style.color='#92400e';badge.textContent='인증 대기';
        content.innerHTML='IRB 심의가 필요합니다. 승인번호를 입력하거나 승인서를 업로드해주세요.<br><div style="margin-top:8px;display:flex;gap:8px;"><input type="text" placeholder="IRB 승인번호 입력" style="flex:1;padding:6px 10px;border:1px solid #d1d5db;border-radius:6px;font-size:11px;"><button style="padding:6px 12px;background:#1a5276;color:white;border:none;border-radius:6px;font-size:11px;cursor:pointer;">인증</button><button style="padding:6px 12px;background:#f3f4f6;border:1px solid #d1d5db;border-radius:6px;font-size:11px;cursor:pointer;">📎 이미지 업로드</button></div>';
      }
    }
  }
  // 지갑 잔액 연구별 차등
  const balEl = document.getElementById('wlBalance');
  const reqEl = document.getElementById('wlRequired');
  const gapEl = document.getElementById('wlGap');
  if(balEl){
    const bal = isRetro ? 0 : (rt==='hybrid' ? 1800000 : 2450000);
    const req = isRetro ? 0 : (rt==='hybrid' ? 2500000 : 3200000);
    const gap = req - bal;
    balEl.innerHTML = (isRetro ? '분석 완료' : bal.toLocaleString()+' <span style="font-size:14px;font-weight:500;">KRW</span>');
    if(reqEl) reqEl.textContent = isRetro ? '— ' : req.toLocaleString()+' KRW';
    if(gapEl) gapEl.textContent = isRetro ? '후향적 분석 — 에스크로 불필요' : (gap>0?'⚠ 부족: '+gap.toLocaleString()+' KRW':'✓ 잔액 충분');
    if(gapEl && gap<=0) gapEl.style.color='#bbf7d0';
  }
}

// ===============================================
// TAB SWITCHING
// ===============================================
let _currentStudy = 'visit'; // 현재 활성 연구 key
function switchTab(n){
  document.querySelectorAll('.tab[data-tab]').forEach(t=>t.classList.toggle('active',t.dataset.tab===n));
  ['ov','tb','cr','wl'].forEach(x=>{
    const key={ov:'overview',tb:'table',cr:'cleanroom',wl:'wallet'}[x];
    const el=document.getElementById('tc-'+x);
    if(el){
      if(x==='wl'){el.style.display=key===n?'block':'none';}
      else{el.classList.toggle('active',key===n);}
    }
  });
  // 사이드바 ns-item 활성 표시 (현재 연구의 서브아이템만)
  document.querySelectorAll('.study-sub .ns-item').forEach(el=>{
    const navKey = {ov:'overview',tb:'table',cr:'cleanroom',wl:'wallet'}[el.dataset.nav];
    el.classList.toggle('active', el.dataset.study===_currentStudy && navKey===n);
  });
  if(n==='overview')setTimeout(buildMetricsGrid,50);
  if(n==='wallet')updateWalletTab();
}
document.querySelectorAll('.tab[data-tab]').forEach(t=>t.addEventListener('click',()=>switchTab(t.dataset.tab)));

// 사이드바 연구 전환 — "내 연구" 클릭으로 연구 전환
function switchStudy(studyKey){
  if(!TIME_PRESETS[studyKey]) return;
  _currentStudy = studyKey;
  // 사이드바 UI 업데이트
  document.querySelectorAll('.study-nav').forEach(el=>{
    el.classList.toggle('active', el.dataset.study===studyKey);
  });
  document.querySelectorAll('.study-sub').forEach(el=>{
    el.style.display = el.id === 'studySub-'+studyKey ? '' : 'none';
    if(el.id === 'studySub-'+studyKey) el.classList.add('active');
    else el.classList.remove('active');
  });
  // 시나리오 전환 (기존 로직 재사용)
  switchStudyScenario(studyKey);
  // 현재 탭 유지하면서 사이드바 ns-item 업데이트
  const activeTab = document.querySelector('.tab.active');
  if(activeTab) switchTab(activeTab.dataset.tab);
  else switchTab('overview');
}
// 사이드바 study-nav 클릭
document.querySelectorAll('.study-nav').forEach(el=>{
  el.addEventListener('click', ()=>switchStudy(el.dataset.study));
});
// 사이드바 ns-item 클릭 (각 연구의 개요/테이블/클린룸/지갑)
document.querySelectorAll('.study-sub .ns-item').forEach(el=>{
  el.addEventListener('click', ()=>{
    // 프로젝트 지갑은 별도 페이지로 이동
    if(el.dataset.nav === 'wl'){ window.location.href='project-wallet.html'; return; }
    const studyKey = el.dataset.study;
    if(studyKey !== _currentStudy) switchStudy(studyKey);
    const tabMap = {ov:'overview',tb:'table',cr:'cleanroom'};
    switchTab(tabMap[el.dataset.nav]);
  });
});

// ===============================================
// TABLE TAB — TD-1: Visit-based columns
// ===============================================
// ALL = 테이블용 통합 배열 — PAST_VISITS.length 기준 동적 생성
let ALL = generateALL(PAST_VISITS.length);
// v11: TMET removed — STUDY_CONFIG.metrics is now Single Source of Truth
// Helper to convert metrics to table-compatible format
function getTMET(){ return getOrderedMetrics().map(m=>({k:m.k,n:m.name,u:m.unit,d:m.direction,sc:m.color})); }
const ST_LABELS={verified:'Verified',query:'Query',review:'Review','missing-visit':'Missing Visit'};

// Table body + visit selector
function dl(a){const li=PAST_VISITS.length-1;if(!a||a[0]==null||a[li]==null)return null;return a[li]-a[0];}
const tBody=document.getElementById('tBody');
const tHead=document.getElementById('tHead');
let selIdx=null;
let _splitMode = false;
let _armFilter = 'all';

// SVG 미니 스파크라인 생성 (시간별 추이 시각화)
function miniSpark(arr, color, w, h){
  if(!arr||arr.length<2) return '';
  const vals=arr.filter(v=>v!=null);
  if(vals.length<2) return '';
  const min=Math.min(...vals), max=Math.max(...vals);
  const range=max-min||1;
  const pts=arr.map((v,i)=>{
    if(v==null) return null;
    const x=(i/(arr.length-1)*w).toFixed(1);
    const y=(h - (v-min)/range*h).toFixed(1);
    return `${x},${y}`;
  }).filter(Boolean).join(' ');
  return `<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" style="display:block;"><polyline points="${pts}" fill="none" stroke="${color}" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" opacity=".7"/></svg>`;
}

// 데이터 주기 → 라벨/배지
const FREQ_LABELS = {continuous:'실시간',daily:'일간',per_visit:'방문별',weekly:'주간'};

function rebuildTable(){
  // v11: Use STUDY_CONFIG.metrics (dynamic) instead of TMET (hardcoded)
  const TMET = getTMET(); // Dynamic from config
  const allMetrics = getOrderedMetrics();

  // Table header — v11: dynamic from config + 데이터 주기 배지
  tHead.innerHTML=`<th style="width:14%;">참여자</th>${allMetrics.map((m,mi)=>{
    const freq = m.measurement_freq || 'per_visit';
    const freqLabel = FREQ_LABELS[freq] || freq;
    return `<th><span class="cs" style="background:${m.color};"></span>${m.name}<span class="freq-badge ${freq}">${freqLabel}</span><span class="sort-icon">▼</span></th>`;
  }).join('')}`;

  // Table body 재빌드
  tBody.innerHTML='';
  const filteredALL = _armFilter==='all' ? ALL : _armFilter==='exp' ? ALL.filter(p=>p.g==='exp') : ALL.filter(p=>p.g==='ctrl');
  filteredALL.forEach((p,idx)=>{
    const i = ALL.indexOf(p);
    const tr=document.createElement('tr');if(p.al)tr.className='alert-row';
    const stBadge=p.st?`<span class="status-badge ${p.st}">${ST_LABELS[p.st]||p.st}</span>`:'';
    const armLabel = p.g==='exp' ? STUDY_CONFIG.design.arm_labels[0] : (STUDY_CONFIG.design.arm_labels[1]||'대조군');
    let h=`<td class="pid"><span class="sv ${p.sv}"></span>${p.id}${p.al?'⚠️':''}<span class="gb ${p.g}">${armLabel}</span>${stBadge}<br><span style="font-size:9px;color:#9ca3af;font-weight:400;">${p.nm}</span></td>`;
    // 실제 데이터 길이 기준 (today_day 이후 visit은 데이터 없음)
    const _td = STUDY_CONFIG.timeline.today_day;
    const _htd = _td !== null && _td !== undefined;
    const _nColl = _htd ? VISITS.filter(v=>v.target_day<=_td).length : PAST_VISITS.length;
    const li = Math.min(PAST_VISITS.length, _nColl) - 1;
    allMetrics.forEach((m,mi)=>{
      const k=m.k;
      const d=dl(p[k]);const v=p[k]?p[k][li]:null;
      if(d==null||v==null){h+='<td><span class="ce">—</span></td>';return;}
      const g=(m.direction==='down'&&d<0)||(m.direction==='up'&&d>0);
      const b=(m.direction==='down'&&d>2)||(m.direction==='up'&&d<-2);
      const ar=d>0?'↑':d<0?'↓':'';const c=g?'good':b?'bad':'neutral';
      const vs=k==='steps'?(d>0?'+':'')+Math.round(d).toLocaleString():k==='comp'||k==='compliance'||k==='tir'?(d>0?'+':'')+d.toFixed(0)+'%':(d>0?'+':'')+d.toFixed(1);
      const bg=g?'background:rgba(0,158,115,.04);':b?'background:rgba(213,94,0,.04);':'';
      const rv=k==='steps'?Math.round(v).toLocaleString():k==='comp'||k==='compliance'||k==='tir'?v.toFixed(0)+'%':v.toFixed(1)+(m.unit||'');
      // 미니 스파크라인
      const spark = miniSpark(p[k], m.color, 36, 14);
      h+=`<td style="${bg}"><div class="cell-spark">${spark}<div class="cell-vals"><span class="cell-cur">${rv}</span><span class="cell-delta ${c}">${ar}${vs}</span></div></div></td>`;
    });
    tr.innerHTML=h;tr.addEventListener('click',()=>openDetail(i));tBody.appendChild(tr);
  });
  document.getElementById('pagInfo').textContent=`1-${filteredALL.length} / ${filteredALL.length}명` + (_armFilter!=='all'?' ('+(_armFilter==='exp'?STUDY_CONFIG.design.arm_labels[0]:STUDY_CONFIG.design.arm_labels[1]||'대조군')+')':'');
}
rebuildTable();

// ===============================================
// MINI-TIMELINE — 테이블 탭 상단 콤팩트 타임라인 (개요탭과 시각적 연속성)
// ===============================================
function buildMiniTimeline(){
  const tl = STUDY_CONFIG.timeline;
  const bar = document.getElementById('mtlBar');
  const info = document.getElementById('mtlInfo');
  if(!bar || !info) return;

  // Auto-generate phases for retro if needed
  if(!tl.phases || tl.phases.length === 0){
    const pts = tl.points;
    tl.phases = [
      {name:'관찰',key:'observation',start:pts[0].target_day,end:0,color:'#94a3b8'},
      {name:'추적',key:'followup',start:0,end:pts[pts.length-1].target_day,color:'#6366f1'},
    ];
  }
  const totalSpan = tl.phases[tl.phases.length-1].end - tl.phases[0].start;
  const offset = -tl.phases[0].start;

  const isRetro = STUDY_CONFIG.research_type === 'retrospective';
  const isHybrid = STUDY_CONFIG.research_type === 'hybrid';
  const todayDay = tl.today_day;  // 고정 "오늘" (retro=null)
  const hasToday = todayDay !== null && todayDay !== undefined;

  // "오늘" 마커 위치 (고정) — scrub과 별개
  const todayLeft = hasToday ? ((todayDay + offset)/totalSpan*100).toFixed(1) : '0';
  // 스크럽 핸들 위치
  const scrubLeft = ((tl.current_day + offset)/totalSpan*100).toFixed(1);
  // 미래 visit 판단은 today_day 기준
  const hasFutureVisits = hasToday && VISITS.some(v => v.target_day > todayDay);

  let html = '';

  if(isRetro){
    // 후향적: 과거/미래 zone 없음 — 전체가 이미 완료된 데이터
  } else if(hasToday){
    // 전향적/하이브리드: today_day 기준으로 과거/미래 zone
    html += `<div class="mtl-zone-past" style="width:${todayLeft}%;"></div>`;
    if(hasFutureVisits) html += `<div class="mtl-zone-future" style="left:${todayLeft}%;width:${(100-parseFloat(todayLeft)).toFixed(1)}%;"></div>`;
  }

  // Phase bars (compact) — today_day 기준으로 solid/dashed
  tl.phases.forEach(p=>{
    const left = ((p.start + offset)/totalSpan*100).toFixed(1);
    const bgColor = p.color || (p.key==='screening'?'#94a3b8':p.key==='enrollment'?'#6366f1':p.key==='baseline'?'#0072B2':p.key==='treatment'?'#0ea5e9':p.key==='followup'?'#009E73':p.key==='analysis'?'#8b5cf6':p.key==='observation'?'#94a3b8':p.key==='index'?'#6366f1':'#6b7280');
    if(!hasToday){
      // 후향적: 모든 phase solid
      const width = ((p.end - p.start)/totalSpan*100).toFixed(1);
      html += `<div class="mtl-phase" style="left:${left}%;width:${width}%;background:${bgColor};">${p.name}</div>`;
    } else {
      // today_day 기준 solid/dashed 분할
      if(p.start >= todayDay){
        // 전체가 미래
        const width = ((p.end - p.start)/totalSpan*100).toFixed(1);
        html += `<div class="mtl-phase future" style="left:${left}%;width:${width}%;border-color:${bgColor};">${p.name}</div>`;
      } else if(p.end <= todayDay){
        // 전체가 과거 → solid
        const width = ((p.end - p.start)/totalSpan*100).toFixed(1);
        html += `<div class="mtl-phase" style="left:${left}%;width:${width}%;background:${bgColor};">${p.name}</div>`;
      } else {
        // today_day에서 분할: 과거 solid + 미래 dashed
        const pastW = ((todayDay - p.start)/totalSpan*100).toFixed(1);
        html += `<div class="mtl-phase" style="left:${left}%;width:${pastW}%;background:${bgColor};">${p.name}</div>`;
        const futLeft = ((todayDay + offset)/totalSpan*100).toFixed(1);
        const futW = ((p.end - todayDay)/totalSpan*100).toFixed(1);
        html += `<div class="mtl-phase future" style="left:${futLeft}%;width:${futW}%;border-color:${bgColor};"></div>`;
      }
    }
  });

  // Visit dots — today_day 기준으로 미래 스타일링
  const activeVisitIdx = PAST_VISITS.length - 1;
  VISITS.forEach((v,vi)=>{
    const vl = ((v.target_day + offset)/totalSpan*100).toFixed(1);
    const isFuture = hasToday ? v.target_day > todayDay : false;
    const isActive = vi === activeVisitIdx;
    const dotLabel = v.label || v.id;
    const dotDate = dayToDate(v.target_day, true);
    const isMtlCal = document.getElementById('mtlCal') && document.getElementById('mtlCal').classList.contains('active');
    const showLabel = isMtlCal ? dotDate : dotLabel;
    html += `<div class="mtl-vdot${isFuture?' future':''}${isActive?' active':''}" style="left:${vl}%;" data-vi="${vi}" data-day="${v.target_day}" title="${dotLabel} (${dotDate})"><span class="mtl-vlabel">${showLabel}</span></div>`;
  });

  // Markers: "오늘" 고정 마커 (scrub과 별개)
  if(isRetro){
    // M0 = day 0 기준시점 마커
    const m0Left = ((0 + offset)/totalSpan*100).toFixed(1);
    html += `<div class="mtl-now" style="left:${m0Left}%;"><div class="mtl-now-line" style="background:#6366f1;"></div><div class="mtl-now-label" style="color:#6366f1;">M0</div></div>`;
  } else if(isHybrid){
    // BL 전환점 + 오늘(고정)
    const blLeft = ((0 + offset)/totalSpan*100).toFixed(1);
    html += `<div class="mtl-now" style="left:${blLeft}%;"><div class="mtl-now-line" style="background:#8b5cf6;"></div><div class="mtl-now-label" style="color:#8b5cf6;font-size:8px;">BL (전환)</div></div>`;
    html += `<div class="mtl-now" style="left:${todayLeft}%;"><div class="mtl-now-line"></div><div class="mtl-now-label">오늘</div></div>`;
  } else {
    // 전향적: 오늘(고정)
    html += `<div class="mtl-now" style="left:${todayLeft}%;"><div class="mtl-now-line"></div><div class="mtl-now-label">오늘</div></div>`;
  }

  // Drag handle — scrub 위치 (current_day 따라 이동, "오늘"과 별개)
  const dayLabel = isRetro ? VISITS[Math.max(0,activeVisitIdx)].id : 'D' + tl.current_day;
  html += `<div class="mtl-handle" id="mtlHandle" style="left:${scrubLeft}%;"><span class="mtl-tooltip">${dayLabel}</span><div class="mtl-handle-grip"></div></div>`;

  bar.innerHTML = html;

  // Info text — today_day 기준 실제 수집 상태 표시
  const collectedVs = hasToday ? VISITS.filter(v=>v.target_day<=todayDay) : PAST_VISITS;
  const nCollectedInfo = collectedVs.length;
  const lastCollectedV = collectedVs[nCollectedInfo-1];
  const uncollectedN = VISITS.length - nCollectedInfo;
  if(isRetro){
    info.innerHTML = `<span style="color:#6366f1;">전체 ${VISITS.length}시점</span> · M0 기준 후향적 분석`;
  } else if(isHybrid){
    const retroPts = VISITS.filter(v=>v.target_day<0).length;
    const prospPts = collectedVs.filter(v=>v.target_day>0).length;
    info.innerHTML = `<span style="color:#8b5cf6;">후향 ${retroPts} + 전향 ${prospPts}시점 수집</span> · BL 기준 하이브리드`;
  } else {
    const futureLabel = uncollectedN > 0 ? ` · <span style="color:#9ca3af;">미수집 ${uncollectedN}시점</span>` : '';
    info.innerHTML = `<span style="color:#0072B2;">${lastCollectedV.id} 수집완료</span> (${nCollectedInfo}/${VISITS.length})${futureLabel}`;
  }

  // === DRAG LOGIC — scrubToDay 연동 ===
  const phaseStart = tl.phases[0].start;
  const minDay = VISITS[0].target_day;
  const maxDay = VISITS[VISITS.length-1].target_day;
  function pctToDay(pct){ return Math.max(minDay, Math.min(maxDay, Math.round(phaseStart + pct * totalSpan))); }
  function getPct(e){ const r=bar.getBoundingClientRect(); return Math.max(0,Math.min(1,(e.clientX-r.left)/r.width)); }

  const handle = document.getElementById('mtlHandle');
  let _mtlDrag = false;
  let _mtlRaf = null;

  function mtlMove(e){
    e.preventDefault();
    if(_mtlRaf) return;
    _mtlRaf = requestAnimationFrame(()=>{
      _mtlRaf = null;
      const pct = getPct(e.touches ? e.touches[0] : e);
      const rawDay = pctToDay(pct);
      const pctLeft = ((rawDay - phaseStart)/totalSpan*100).toFixed(1);
      handle.style.left = pctLeft + '%';
      // "오늘" 마커는 고정 — 드래그 시 이동하지 않음
      const tooltip = handle.querySelector('.mtl-tooltip');
      if(tooltip) tooltip.textContent = 'D' + rawDay;
    });
  }

  let _mtlLastDay = tl.current_day;
  function mtlEnd(e){
    handle.classList.remove('dragging');
    document.removeEventListener('mousemove', mtlMove);
    document.removeEventListener('mouseup', mtlEnd);
    document.removeEventListener('touchmove', mtlMove);
    document.removeEventListener('touchend', mtlEnd);
    _mtlDrag = false;
    const pct = getPct(e.changedTouches ? e.changedTouches[0] : e);
    const rawDay = pctToDay(pct);
    if(rawDay === _mtlLastDay) return;
    _mtlLastDay = rawDay;
    scrubToDay(rawDay);
  }

  if(handle){
    handle.addEventListener('mousedown', (e)=>{
      e.preventDefault(); _mtlDrag = true;
      handle.classList.add('dragging');
      document.addEventListener('mousemove', mtlMove);
      document.addEventListener('mouseup', mtlEnd);
    });
    handle.addEventListener('touchstart', (e)=>{
      _mtlDrag = true;
      handle.classList.add('dragging');
      document.addEventListener('touchmove', mtlMove, {passive:false});
      document.addEventListener('touchend', mtlEnd);
    });
  }

  // Click on bar → jump to day
  bar.addEventListener('click', (e)=>{
    if(_mtlDrag) return;
    if(e.target.closest('.mtl-handle')) return;
    if(e.target.closest('.mtl-vdot')) return;
    const pct = getPct(e);
    const rawDay = pctToDay(pct);
    if(rawDay === tl.current_day) return;
    scrubToDay(rawDay);
  });

  // Click on visit dots → jump to that visit's day
  bar.querySelectorAll('.mtl-vdot').forEach(dot=>{
    dot.addEventListener('click',(e)=>{
      e.stopPropagation();
      const day = parseInt(dot.dataset.day);
      if(isNaN(day) || day === tl.current_day) return;
      scrubToDay(day);
    });
  });
}
buildMiniTimeline();

// 미니타임라인 캘린더/Study Day 토글 (개요 탭과 동기화)
document.getElementById('mtlCal').addEventListener('click',function(){
  this.classList.add('active');document.getElementById('mtlDay').classList.remove('active');
  // 개요 타임라인도 동기화
  const tc=document.getElementById('tlCal'),td=document.getElementById('tlDay');
  if(tc&&td){tc.classList.add('active');td.classList.remove('active');}
  buildMiniTimeline(); buildTimeGrid();
});
document.getElementById('mtlDay').addEventListener('click',function(){
  this.classList.add('active');document.getElementById('mtlCal').classList.remove('active');
  const tc=document.getElementById('tlCal'),td=document.getElementById('tlDay');
  if(tc&&td){td.classList.add('active');tc.classList.remove('active');}
  buildMiniTimeline(); buildTimeGrid();
});

// ===============================================
// 집계 단위 시스템 — 시간축 = 시간 단위 그리드
// 일간 → 365셀, 주간 → ~52셀, 월간 → 12셀, 방문별 → N셀
// ===============================================
let _aggUnit = 'visit'; // day | week | month | quarter | year | visit
let _selectedPeriodIdx = -1; // 선택된 그리드 셀 인덱스 (-1 = 최신)

// 연구 유형별 집계 옵션 업데이트
function updateAggOptions(){
  const sel = document.getElementById('aggSelector');
  if(!sel) return;
  const rt = STUDY_CONFIG.research_type;
  if(rt === 'retrospective'){
    // 후향적: 모든 집계 단위 사용 가능
    sel.innerHTML = `
      <button class="agg-btn" data-agg="day">일간</button>
      <button class="agg-btn" data-agg="week">주간</button>
      <button class="agg-btn" data-agg="month">월간</button>
      <button class="agg-btn" data-agg="quarter">분기</button>
      <button class="agg-btn" data-agg="year">연간</button>
      <button class="agg-btn active" data-agg="visit">시점별</button>`;
    _aggUnit = 'visit';
  } else if(rt === 'hybrid'){
    // 하이브리드: 후향 구간은 월간, 전향 구간은 일간/주간 가능
    sel.innerHTML = `
      <button class="agg-btn" data-agg="day">일간</button>
      <button class="agg-btn" data-agg="week">주간</button>
      <button class="agg-btn" data-agg="month">월간</button>
      <button class="agg-btn active" data-agg="visit">방문별</button>`;
    _aggUnit = 'visit';
  } else {
    // 전향적: 모든 옵션
    sel.innerHTML = `
      <button class="agg-btn" data-agg="day">일간</button>
      <button class="agg-btn" data-agg="week">주간</button>
      <button class="agg-btn" data-agg="month">월간</button>
      <button class="agg-btn active" data-agg="visit">방문별</button>`;
    _aggUnit = 'visit';
  }
  // 이벤트 재연결
  sel.querySelectorAll('.agg-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      sel.querySelectorAll('.agg-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      _aggUnit = btn.dataset.agg;
      _selectedPeriodIdx = -1;
      buildTimeGrid();
    });
  });
}

function getAggCells(){
  const tl = STUDY_CONFIG.timeline;
  const firstDay = VISITS[0].target_day;
  const lastDay = VISITS[VISITS.length-1].target_day;
  const totalDays = lastDay - firstDay;
  const isRetro = STUDY_CONFIG.research_type === 'retrospective';
  const isHybrid = STUDY_CONFIG.research_type === 'hybrid';
  const cells = [];

  if(_aggUnit === 'visit'){
    VISITS.forEach((v,i)=>{
      const isPast = isRetro ? true : v.target_day <= tl.current_day;
      const epoch = isHybrid ? (v.target_day < 0 ? 'retro' : v.target_day === 0 ? 'boundary' : 'prosp') : null;
      cells.push({label:v.label||v.id, date:dayToDate(v.target_day,true), day:v.target_day, start:v.target_day, end:v.target_day, isPast, hasData:isPast, visitIdx:i, epoch});
    });
  } else if(_aggUnit === 'day'){
    const maxCells = Math.min(totalDays+1, 120);
    const step = Math.max(1, Math.ceil((totalDays+1)/maxCells));
    for(let d=firstDay; d<=lastDay; d+=step){
      const isPast = isRetro ? true : d <= tl.current_day;
      const hasVisit = VISITS.some(v=>Math.abs(v.target_day-d)<=step/2);
      const epoch = isHybrid ? (d < 0 ? 'retro' : d === 0 ? 'boundary' : 'prosp') : null;
      cells.push({label:'D'+d, date:dayToDate(d,true), day:d, start:d, end:d+step-1, isPast, hasData:isPast&&hasVisit, epoch});
    }
  } else if(_aggUnit === 'week'){
    const weeks = Math.ceil((totalDays+1)/7);
    for(let w=0; w<weeks; w++){
      const wStart = firstDay + w*7;
      const wEnd = Math.min(wStart+6, lastDay);
      const mid = Math.floor((wStart+wEnd)/2);
      const isPast = isRetro ? true : mid <= tl.current_day;
      const hasVisit = VISITS.some(v=>v.target_day>=wStart && v.target_day<=wEnd);
      const epoch = isHybrid ? (mid < 0 ? 'retro' : 'prosp') : null;
      cells.push({label:'W'+(w+1), date:dayToDate(wStart,true)+'~'+dayToDate(wEnd,true), day:mid, start:wStart, end:wEnd, isPast, hasData:isPast&&hasVisit, epoch});
    }
  } else if(_aggUnit === 'month'){
    const months = Math.ceil((totalDays+1)/30);
    for(let m=0; m<months; m++){
      const mStart = firstDay + m*30;
      const mEnd = Math.min(mStart+29, lastDay);
      const mid = Math.floor((mStart+mEnd)/2);
      const isPast = isRetro ? true : mid <= tl.current_day;
      const hasVisit = VISITS.some(v=>v.target_day>=mStart && v.target_day<=mEnd);
      const epoch = isHybrid ? (mid < 0 ? 'retro' : 'prosp') : null;
      cells.push({label:'M'+(m+1), date:dayToDate(mStart,true)+'~'+dayToDate(mEnd,true), day:mid, start:mStart, end:mEnd, isPast, hasData:isPast&&hasVisit, epoch});
    }
  } else if(_aggUnit === 'quarter'){
    // 분기: 90일 단위
    const quarters = Math.ceil((totalDays+1)/90);
    for(let q=0; q<quarters; q++){
      const qStart = firstDay + q*90;
      const qEnd = Math.min(qStart+89, lastDay);
      const mid = Math.floor((qStart+qEnd)/2);
      const hasVisit = VISITS.some(v=>v.target_day>=qStart && v.target_day<=qEnd);
      cells.push({label:'Q'+(q+1), date:dayToDate(qStart,true)+'~'+dayToDate(qEnd,true), day:mid, start:qStart, end:qEnd, isPast:true, hasData:hasVisit});
    }
  } else if(_aggUnit === 'year'){
    // 연간: 365일 단위
    const years = Math.ceil((totalDays+1)/365);
    for(let y=0; y<years; y++){
      const yStart = firstDay + y*365;
      const yEnd = Math.min(yStart+364, lastDay);
      const mid = Math.floor((yStart+yEnd)/2);
      const hasVisit = VISITS.some(v=>v.target_day>=yStart && v.target_day<=yEnd);
      cells.push({label:'Y'+(y+1), date:dayToDate(yStart,true)+'~'+dayToDate(yEnd,true), day:mid, start:yStart, end:yEnd, isPast:true, hasData:hasVisit});
    }
  }
  return cells;
}

function buildTimeGrid(){
  const gridRow = document.getElementById('mtlGridRow');
  if(!gridRow) return;
  const cells = getAggCells();
  const totalW = gridRow.clientWidth || 500;
  const cellW = Math.max(16, Math.min(48, (totalW-cells.length)/cells.length));

  // 현재 선택: 최신 past 셀
  if(_selectedPeriodIdx < 0) _selectedPeriodIdx = cells.filter(c=>c.isPast).length - 1;

  const isHybrid = STUDY_CONFIG.research_type === 'hybrid';
  gridRow.innerHTML = cells.map((c,i)=>{
    const isActive = i === _selectedPeriodIdx;
    const cls = `mtl-grid-cell${isActive?' active':''}${c.hasData?' has-data':' no-data'}`;
    // 하이브리드: 레트로 구간 보라, 경계점 강조, 전향 구간 파랑
    let style = `min-width:${cellW}px;flex:1;`;
    if(isHybrid && !isActive){
      if(c.epoch==='retro') style += 'background:#eef2ff;color:#6366f1;';
      else if(c.epoch==='boundary') style += 'background:#f5f3ff;border:2px solid #8b5cf6;color:#8b5cf6;font-weight:700;';
      else if(c.epoch==='prosp' && c.hasData) style += 'background:#e0f2fe;';
    }
    // 후향적: 모든 셀 활성 (데이터 존재)
    const isMtlCal = document.getElementById('mtlCal') && document.getElementById('mtlCal').classList.contains('active');
    const displayLabel = (isMtlCal && c.date) ? c.date : c.label;
    return `<div class="${cls}" data-ci="${i}" data-day="${c.day}" style="${style}" title="${c.label} (${c.date||''})">${displayLabel}</div>`;
  }).join('');
  // 하이브리드: 경계점 세퍼레이터 표시
  if(isHybrid){
    const boundaryIdx = cells.findIndex(c=>c.epoch==='boundary');
    if(boundaryIdx >= 0){
      const boundaryEl = gridRow.children[boundaryIdx];
      if(boundaryEl) boundaryEl.title = '⟵ 후향적 | 전향적 ⟶ (BL 전환점)';
    }
  }

  // 스냅샷 라벨 업데이트
  const snapLabel = document.getElementById('snapshotLabel');
  if(snapLabel && cells[_selectedPeriodIdx]){
    const c = cells[_selectedPeriodIdx];
    const unitNames = {day:'일간',week:'주간',month:'월간',visit:'방문별'};
    snapLabel.textContent = `📊 ${c.label} · ${unitNames[_aggUnit]} 스냅샷`;
  }

  // 셀 클릭 → 해당 기간 선택 + 테이블 업데이트
  gridRow.querySelectorAll('.mtl-grid-cell').forEach(el=>{
    el.addEventListener('click',()=>{
      const ci = parseInt(el.dataset.ci);
      _selectedPeriodIdx = ci;
      const day = parseInt(el.dataset.day);
      // 그리드 활성 표시 업데이트
      gridRow.querySelectorAll('.mtl-grid-cell').forEach(c=>c.classList.remove('active'));
      el.classList.add('active');
      // 스냅샷 라벨
      const snapLabel = document.getElementById('snapshotLabel');
      if(snapLabel){
        const cells = getAggCells();
        const c = cells[ci];
        const unitNames = {day:'일간',week:'주간',month:'월간',visit:'방문별'};
        snapLabel.textContent = `📊 ${c.label} · ${unitNames[_aggUnit]} 스냅샷`;
      }
      // 해당 시점으로 스크럽
      if(day !== STUDY_CONFIG.timeline.current_day) scrubToDay(day);
    });
  });
}
buildTimeGrid();

// 집계 단위 전환 버튼
document.querySelectorAll('#aggSelector .agg-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('#aggSelector .agg-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    _aggUnit = btn.dataset.agg;
    _selectedPeriodIdx = -1;
    buildTimeGrid();
  });
});

// ===============================================
// ARM SPLIT TABLE VIEW
// ===============================================
function buildArmTabs(){
  const container = document.getElementById('armTabs');
  if(!container) return;
  const arms = STUDY_CONFIG.design.arm_labels;
  const hasCtrl = STUDY_CONFIG.design.has_control_arm;
  
  let html = '<button class="arm-tab active" data-arm="all">전체</button>';
  if(hasCtrl){
    html += `<button class="arm-tab" data-arm="exp"><span class="arm-dot" style="background:#0072B2;"></span>${arms[0]}</button>`;
    html += `<button class="arm-tab" data-arm="ctrl"><span class="arm-dot" style="background:#CC79A7;"></span>${arms[1]||'대조군'}</button>`;
  }
  container.innerHTML = html;
  
  container.querySelectorAll('.arm-tab').forEach(btn=>{
    btn.addEventListener('click',()=>{
      container.querySelectorAll('.arm-tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      _armFilter = btn.dataset.arm;
      if(_splitMode) renderSplitTable();
      else rebuildTable();
    });
  });
  
  // Split toggle
  const splitBtn = document.getElementById('splitToggle');
  if(!hasCtrl){
    splitBtn.style.display='none';
    return;
  }
  splitBtn.style.display='';
  splitBtn.onclick = ()=>{
    _splitMode = !_splitMode;
    splitBtn.classList.toggle('active', _splitMode);
    document.getElementById('singleTableView').style.display = _splitMode ? 'none' : '';
    const sv = document.getElementById('splitTableView');
    sv.style.display = _splitMode ? 'flex' : 'none';
    // Close any open detail panels when toggling
    panel.classList.remove('open');
    selIdx = null;
    if(_splitMode) renderSplitTable();
    else rebuildTable();
  };
}

function renderSplitTable(){
  const container = document.getElementById('splitContainer');
  const TMET = getTMET();
  const arms = [];
  
  if(STUDY_CONFIG.design.has_control_arm){
    arms.push({key:'exp', label:STUDY_CONFIG.design.arm_labels[0], color:'#0072B2', patients:ALL.filter(p=>p.g==='exp')});
    arms.push({key:'ctrl', label:STUDY_CONFIG.design.arm_labels[1]||'대조군', color:'#CC79A7', patients:ALL.filter(p=>p.g==='ctrl')});
  } else {
    arms.push({key:'exp', label:STUDY_CONFIG.design.arm_labels[0], color:'#0072B2', patients:ALL});
  }
  
  const li = PAST_VISITS.length - 1;
  
  // 각 arm pane HTML 생성
  function buildArmPane(arm){
    const means = TMET.map(m => {
      const vals = arm.patients.map(p => { const a = p[m.k]; return a && a[li] != null ? a[li] : null; }).filter(v => v != null);
      if(vals.length === 0) return null;
      return vals.reduce((a,b) => a+b, 0) / vals.length;
    });
    const meanRow = '<tr style="background:#f9fafb;font-weight:600;border-bottom:2px solid #e5e7eb;"><td class="pid" style="color:#6b7280;">평균</td>' +
      TMET.map((m,mi) => {
        const mv = means[mi]; if(mv == null) return '<td><span class="ce">—</span></td>';
        const d = dl2(arm.patients, m.k, li); const ds = d != null ? (d>0?'+':'') + d.toFixed(1) : '—';
        const cls = (m.d==='down'&&d<0)||(m.d==='up'&&d>0) ? 'good' : (m.d==='down'&&d>2)||(m.d==='up'&&d<-2) ? 'bad' : 'neutral';
        return '<td><span class="cd '+cls+'">'+ds+'</span><span class="cr-cell">'+mv.toFixed(1)+m.u+'</span></td>';
      }).join('') + '</tr>';
    const rows = arm.patients.map(p => {
      const stBadge = p.st ? '<span class="status-badge '+p.st+'">'+(ST_LABELS[p.st]||p.st)+'</span>' : '';
      let h = '<td class="pid"><span class="sv '+p.sv+'"></span>'+p.id+(p.al?'⚠️':'')+stBadge+'</td>';
      TMET.forEach(m => {
        const d = dl(p[m.k]); const v = p[m.k] ? p[m.k][li] : null;
        if(d==null||v==null){h+='<td><span class="ce">—</span></td>';return;}
        const g=(m.d==='down'&&d<0)||(m.d==='up'&&d>0);const b=(m.d==='down'&&d>2)||(m.d==='up'&&d<-2);
        const ar=d>0?'↑':d<0?'↓':'';const c=g?'good':b?'bad':'neutral';
        h+='<td><span class="cd '+c+'">'+ar+(d>0?'+':'')+d.toFixed(1)+'</span><span class="cr-cell">'+v.toFixed(1)+m.u+'</span></td>';
      });
      return '<tr data-idx="'+ALL.indexOf(p)+'" style="cursor:pointer;">'+h+'</tr>';
    }).join('');
    return `<div class="split-pane">
      <div class="sp-header"><div><div class="sp-title"><span style="width:8px;height:8px;border-radius:50%;background:${arm.color};display:inline-block;"></span>${arm.label}</div><div class="sp-count">n=${arm.patients.length}</div></div></div>
      <div class="tbl-wrap"><table class="pt-tbl"><thead><tr><th style="width:20%;">ID</th>${TMET.map(m=>'<th><span class="cs" style="background:'+m.sc+';"></span>'+m.n+'</th>').join('')}</tr></thead><tbody>${meanRow}${rows}</tbody></table></div>
    </div>`;
  }

  // 군 간 차이 세로 스트립 (2군 이상)
  function buildDiffStrip(){
    if(arms.length < 2) return '';
    const expArm = arms[0], ctrlArm = arms[1];
    let cells = '';
    TMET.forEach(m => {
      const expVals = expArm.patients.map(p=>{ const a=p[m.k]; return a&&a[li]!=null?a[li]:null; }).filter(v=>v!=null);
      const ctrlVals = ctrlArm.patients.map(p=>{ const a=p[m.k]; return a&&a[li]!=null?a[li]:null; }).filter(v=>v!=null);
      if(!expVals.length || !ctrlVals.length){ cells+='<div class="sd-cell sd-neutral">—</div>'; return; }
      const expM = expVals.reduce((a,b)=>a+b,0)/expVals.length;
      const ctrlM = ctrlVals.reduce((a,b)=>a+b,0)/ctrlVals.length;
      const diff = expM - ctrlM;
      const pct = ctrlM !== 0 ? ((diff/Math.abs(ctrlM))*100) : null;
      const better = (m.d==='down'&&diff<0)||(m.d==='up'&&diff>0);
      const worse = (m.d==='down'&&diff>0)||(m.d==='up'&&diff<0);
      const expSD = Math.sqrt(expVals.reduce((s,v)=>s+Math.pow(v-expM,2),0)/expVals.length)||1;
      const ctrlSD = Math.sqrt(ctrlVals.reduce((s,v)=>s+Math.pow(v-ctrlM,2),0)/ctrlVals.length)||1;
      const pooledSE = Math.sqrt((expSD*expSD/expVals.length)+(ctrlSD*ctrlSD/ctrlVals.length));
      const sig = pooledSE>0 && Math.abs(diff)/pooledSE > 1.96;
      const cls = better?'sd-better':worse?'sd-worse':'sd-neutral';
      const sign = diff>0?'+':'';
      const sigMk = sig?'<span class="sd-sig">*</span>':'';
      const pctStr = pct!=null ? '<span class="sd-pct">'+(pct>0?'+':'')+pct.toFixed(0)+'%</span>' : '';
      cells += '<div class="sd-cell '+cls+'"><span class="sd-abs">'+sign+diff.toFixed(1)+m.u+sigMk+'</span>'+pctStr+'</div>';
    });
    return `<div class="split-diff"><div class="sd-head">Δ 차이</div><div class="sd-spacer"></div>${cells}</div>`;
  }

  // 조립: 실험군 | 차이 스트립 | 대조군
  container.innerHTML = buildArmPane(arms[0]) + buildDiffStrip() + (arms[1] ? buildArmPane(arms[1]) : '');

  document.getElementById('splitPagInfo').textContent = arms.map(a=>a.label+' '+a.patients.length+'명').join(' · ');

  // 행 클릭 이벤트
  container.querySelectorAll('tr[data-idx]').forEach(tr=>{
    tr.addEventListener('click',()=>openDetail(parseInt(tr.dataset.idx)));
  });
}

// 군 평균 delta 계산
function dl2(patients, metricKey, lastIdx){
  const vals = patients.map(p=>{
    const a = p[metricKey];
    if(!a || a[0]==null || a[lastIdx]==null) return null;
    return a[lastIdx] - a[0];
  }).filter(v=>v!=null);
  if(vals.length===0) return null;
  return vals.reduce((a,b)=>a+b,0)/vals.length;
}

buildArmTabs();

// Detail Panel
const panel=document.getElementById('detailPanel'),tableArea=document.getElementById('tableArea'),dpTitle=document.getElementById('dpTitle'),dpBody=document.getElementById('dpBody');

// Shared detail content renderer — used by both overlay panel and split-inline panel
function _renderDetailContent(p, li, targetEl){
  const stBadge=p.st?`<span class="status-badge ${p.st}">${ST_LABELS[p.st]||p.st}</span>`:'';
  const headerHTML=`<div class="dp-header" style="padding:10px 14px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;flex-shrink:0;">
    <div class="dp-title"><span class="sv ${p.sv}"></span>${p.id} ${p.nm} <span class="gb ${p.g}">${p.g==='exp'?STUDY_CONFIG.design.arm_labels[0]:(STUDY_CONFIG.design.arm_labels[1]||'대조군')}</span>${stBadge}</div>
    <div style="display:flex;gap:3px;align-items:center;">
      <div class="dp-nav"><button class="split-dp-prev">▲</button><button class="split-dp-next">▼</button></div>
      <button class="dp-close split-dp-close" style="background:none;border:1px solid #e5e7eb;border-radius:4px;cursor:pointer;padding:2px 6px;font-size:11px;">✕</button>
    </div>
  </div>`;

  const dpMetrics=getTMET().slice(0,3);
  const idx = ALL.indexOf(p);
  let ch='';
  dpMetrics.forEach(m=>{
    const a=p[m.k]||[];const d=dl(a);
    const ds=d!=null?(d>0?'+':'')+(m.k==='steps'?Math.round(d).toLocaleString():d.toFixed(1)+m.u):'—';
    ch+=`<div class="chart-card">
      <div class="chart-card-title">${m.n} (${PAST_VISITS[0].id}→${PAST_VISITS[li].id}: ${ds})</div>
      <div class="mini-chart"><canvas id="sdp-${m.k}-${idx}"></canvas></div>
      <div class="chart-x">${VISIT_LABELS.map((l,vi)=>'<span'+(vi===li?' style="color:'+C.vermillion+';font-weight:600;"':vi>li?' style="color:#d1d5db;"':'')+'>'+l+'</span>').join('')}</div>
    </div>`;
  });

  let fs=`<div class="fs-title">📋 플로우시트 (${PAST_VISITS[0].id}~${PAST_VISITS[li].id})</div><table class="fs-table"><thead><tr><th>지표</th>`;
  PAST_VISITS.forEach(v=>fs+=`<th>${v.id}<br><span style="font-size:8px;color:#9ca3af;font-weight:400;">${dayToDate(v.target_day,true)}</span></th>`);fs+='</tr></thead><tbody>';
  getTMET().forEach(m=>{const a=p[m.k]||[];fs+='<tr><td>'+m.n+'</td>';
    for(let j=0;j<=li;j++){const v=a[j];
      if(v==null){fs+='<td class="ce">—</td>';continue;}
      const fmt=m.k==='steps'?Math.round(v).toLocaleString():m.k==='comp'||m.k==='app'?v.toFixed(0):v.toFixed(1);
      let cls='';if(j>0&&a[0]!=null){const dd=v-a[0];const ig=(m.d==='down'&&dd<-1)||(m.d==='up'&&dd>1);const ib=(m.d==='down'&&dd>1)||(m.d==='up'&&dd<-1);cls=ig?'fg':ib?'fb':'';}
      if(j===li)cls+=' fc';
      fs+=`<td class="${cls}">${fmt}</td>`;
    }
    fs+='</tr>';
  });
  fs+='</tbody></table>';

  targetEl.innerHTML = headerHTML + `<div class="dp-body" style="flex:1;overflow-y:auto;padding:12px;">${ch}${fs}</div>`;

  // Wire up close button
  targetEl.querySelector('.split-dp-close').addEventListener('click', ()=>{ closeSplitDetail(); });
  // Wire up prev/next
  targetEl.querySelector('.split-dp-prev').addEventListener('click', ()=>{ if(selIdx>0)openDetail(selIdx-1); });
  targetEl.querySelector('.split-dp-next').addEventListener('click', ()=>{ if(selIdx<ALL.length-1)openDetail(selIdx+1); });

  // Draw charts
  setTimeout(()=>{
    dpMetrics.forEach(m=>{
      const cv=document.getElementById(`sdp-${m.k}-${idx}`);if(!cv)return;
      const ctx2=cv.getContext('2d');const dpr=window.devicePixelRatio||1;
      const rect=cv.parentElement.getBoundingClientRect();if(rect.width<10)return;
      cv.width=rect.width*dpr;cv.height=rect.height*dpr;
      cv.style.width=rect.width+'px';cv.style.height=rect.height+'px';
      ctx2.setTransform(1,0,0,1,0,0);ctx2.scale(dpr,dpr);
      const a=p[m.k]||[];
      let future=[];
      if(a.length>1&&a[li]!=null&&a[li-1]!=null){
        const slope=a[li]-a[li-1];
        future=Array.from({length:FUTURE_VISITS.length},(_,fi)=>Math.round((a[li]+slope*(fi+1))*10)/10);
      }
      const allV=[...a,...future].filter(v=>v!=null);if(allV.length<2)return;
      let mn2=Math.min(...allV),mx2=Math.max(...allV);const mg2=(mx2-mn2)*0.15||5;mn2-=mg2;mx2+=mg2;
      const W=rect.width,H=rect.height,pad={t:4,b:4,l:4,r:4};
      const cw2=W-pad.l-pad.r,ch3=H-pad.t-pad.b;
      const nTotal=a.length+future.length;
      function xP2(ii){return pad.l+(ii/(nTotal-1||1))*cw2;}
      function yP2(v){return pad.t+(1-(v-mn2)/(mx2-mn2))*ch3;}
      ctx2.clearRect(0,0,W,H);
      const nowX=xP2(li+0.5);
      ctx2.fillStyle='rgba(0,114,178,.02)';ctx2.fillRect(pad.l,pad.t,nowX-pad.l,ch3);
      ctx2.strokeStyle=C.vermillion;ctx2.lineWidth=1;ctx2.globalAlpha=0.3;
      ctx2.beginPath();ctx2.moveTo(nowX,pad.t);ctx2.lineTo(nowX,pad.t+ch3);ctx2.stroke();ctx2.globalAlpha=1;
      ctx2.beginPath();ctx2.strokeStyle=m.sc;ctx2.lineWidth=1.5;ctx2.lineJoin='round';
      let s2=false;a.forEach((v,ii)=>{if(v==null)return;if(!s2){ctx2.moveTo(xP2(ii),yP2(v));s2=true;}else ctx2.lineTo(xP2(ii),yP2(v));});ctx2.stroke();
      if(future.length>0){
        ctx2.setLineDash([3,3]);ctx2.globalAlpha=0.5;ctx2.beginPath();
        if(a[li]!=null)ctx2.moveTo(xP2(li),yP2(a[li]));
        future.forEach((v,fi)=>{if(v!=null)ctx2.lineTo(xP2(a.length+fi),yP2(v));});
        ctx2.stroke();ctx2.setLineDash([]);ctx2.globalAlpha=1;
      }
    });
  },50);
}

function closeSplitDetail(){
  const container = document.getElementById('splitContainer');
  // Restore all panes
  container.querySelectorAll('.split-pane').forEach(p => p.classList.remove('hidden-arm'));
  const diffStrip = container.querySelector('.split-diff');
  if(diffStrip) diffStrip.style.display = '';
  // Remove inline detail
  const inlinePanel = container.querySelector('.split-detail-inline');
  if(inlinePanel) inlinePanel.style.display = 'none';
  // Clear selection
  container.querySelectorAll('tr[data-idx]').forEach(tr => tr.classList.remove('selected'));
  selIdx = null;
}

function openDetail(i){
  selIdx=i;const p=ALL[i];const li=PAST_VISITS.length-1;
  tBody.querySelectorAll('tr').forEach((r,ri)=>r.classList.toggle('selected',ri===i));

  // Split mode: hide other arm, show detail inline
  if(_splitMode){
    const container = document.getElementById('splitContainer');
    const panes = container.querySelectorAll('.split-pane');
    const diffStrip = container.querySelector('.split-diff');
    const patientArm = p.g; // 'exp' or 'ctrl'
    // Determine which pane index is the clicked arm
    // panes[0] = exp, panes[1] = ctrl (if exists)
    panes.forEach((pane, pi) => {
      const isClicked = (pi === 0 && patientArm === 'exp') || (pi === 1 && patientArm === 'ctrl');
      if(isClicked){
        pane.classList.remove('hidden-arm');
      } else {
        pane.classList.add('hidden-arm');
      }
    });
    if(diffStrip) diffStrip.style.display = 'none';
    // Highlight clicked row in split pane
    container.querySelectorAll('tr[data-idx]').forEach(tr => {
      tr.classList.toggle('selected', parseInt(tr.dataset.idx) === i);
    });
    // Create or reuse inline detail panel in split container
    let inlinePanel = container.querySelector('.split-detail-inline');
    if(!inlinePanel){
      inlinePanel = document.createElement('div');
      inlinePanel.className = 'split-detail-inline';
      container.appendChild(inlinePanel);
    }
    inlinePanel.style.display = '';
    // Render detail content into inline panel
    _renderDetailContent(p, li, inlinePanel);
    return;
  }

  panel.classList.add('open');
  const stBadge=p.st?`<span class="status-badge ${p.st}">${ST_LABELS[p.st]||p.st}</span>`:'';
  dpTitle.innerHTML=`<span class="sv ${p.sv}"></span>${p.id} ${p.nm} <span class="gb ${p.g}">${p.g==='exp'?STUDY_CONFIG.design.arm_labels[0]:(STUDY_CONFIG.design.arm_labels[1]||'대조군')}</span>${stBadge}`;

  const dpMetrics=getTMET().slice(0,3);
  let ch='';
  dpMetrics.forEach(m=>{
    const a=p[m.k]||[];const d=dl(a);
    const ds=d!=null?(d>0?'+':'')+(m.k==='steps'?Math.round(d).toLocaleString():d.toFixed(1)+m.u):'—';
    ch+=`<div class="chart-card">
      <div class="chart-card-title">${m.n} (${PAST_VISITS[0].id}→${PAST_VISITS[li].id}: ${ds})</div>
      <div class="mini-chart"><canvas id="dp-${m.k}-${i}"></canvas></div>
      <div class="chart-x">${VISIT_LABELS.map((l,vi)=>'<span'+(vi===li?' style="color:'+C.vermillion+';font-weight:600;"':vi>li?' style="color:#d1d5db;"':'')+'>'+l+'</span>').join('')}</div>
    </div>`;
  });

  let fs=`<div class="fs-title">📋 플로우시트 (${PAST_VISITS[0].id}~${PAST_VISITS[li].id})</div><table class="fs-table"><thead><tr><th>지표</th>`;
  PAST_VISITS.forEach(v=>fs+=`<th>${v.id}<br><span style="font-size:8px;color:#9ca3af;font-weight:400;">${dayToDate(v.target_day,true)}</span></th>`);fs+='</tr></thead><tbody>';
  getTMET().forEach(m=>{const a=p[m.k]||[];fs+='<tr><td>'+m.n+'</td>';
    for(let j=0;j<=li;j++){const v=a[j];
      if(v==null){fs+='<td class="ce">—</td>';continue;}
      const fmt=m.k==='steps'?Math.round(v).toLocaleString():m.k==='comp'||m.k==='app'?v.toFixed(0):v.toFixed(1);
      let cls='';if(j>0&&a[0]!=null){const dd=v-a[0];const ig=(m.d==='down'&&dd<-1)||(m.d==='up'&&dd>1);const ib=(m.d==='down'&&dd>1)||(m.d==='up'&&dd<-1);cls=ig?'fg':ib?'fb':'';}
      if(j===li)cls+=' fc';
      fs+=`<td class="${cls}">${fmt}</td>`;
    }
    fs+='</tr>';
  });
  fs+='</tbody></table>';
  dpBody.innerHTML=ch+fs;

  setTimeout(()=>{
    dpMetrics.forEach(m=>{
      const cv=document.getElementById(`dp-${m.k}-${i}`);if(!cv)return;
      const ctx=cv.getContext('2d');const dpr=window.devicePixelRatio||1;
      const rect=cv.parentElement.getBoundingClientRect();if(rect.width<10)return;
      cv.width=rect.width*dpr;cv.height=rect.height*dpr;
      cv.style.width=rect.width+'px';cv.style.height=rect.height+'px';
      ctx.setTransform(1,0,0,1,0,0);ctx.scale(dpr,dpr);
      const a=p[m.k]||[];
      let future=[];
      if(a.length>1&&a[li]!=null&&a[li-1]!=null){
        const slope=a[li]-a[li-1];
        future=Array.from({length:FUTURE_VISITS.length},(_,fi)=>Math.round((a[li]+slope*(fi+1))*10)/10);
      }
      const allV=[...a,...future].filter(v=>v!=null);if(allV.length<2)return;
      let mn=Math.min(...allV),mx=Math.max(...allV);const mg=(mx-mn)*0.15||5;mn-=mg;mx+=mg;
      const W=rect.width,H=rect.height,pad={t:4,b:4,l:4,r:4};
      const cw=W-pad.l-pad.r,ch2=H-pad.t-pad.b;
      const nTotal=a.length+future.length;
      function xP(ii){return pad.l+(ii/(nTotal-1||1))*cw;}
      function yP(v){return pad.t+(1-(v-mn)/(mx-mn))*ch2;}
      ctx.clearRect(0,0,W,H);
      const nowX=xP(li+0.5);
      ctx.fillStyle='rgba(0,114,178,.02)';ctx.fillRect(pad.l,pad.t,nowX-pad.l,ch2);
      ctx.strokeStyle=C.vermillion;ctx.lineWidth=1;ctx.globalAlpha=0.3;
      ctx.beginPath();ctx.moveTo(nowX,pad.t);ctx.lineTo(nowX,pad.t+ch2);ctx.stroke();ctx.globalAlpha=1;
      ctx.beginPath();ctx.strokeStyle=m.sc;ctx.lineWidth=1.5;ctx.lineJoin='round';
      let s=false;a.forEach((v,ii)=>{if(v==null)return;if(!s){ctx.moveTo(xP(ii),yP(v));s=true;}else ctx.lineTo(xP(ii),yP(v));});ctx.stroke();
      if(future.length>0){
        ctx.setLineDash([3,3]);ctx.globalAlpha=0.5;ctx.beginPath();
        if(a[li]!=null)ctx.moveTo(xP(li),yP(a[li]));
        future.forEach((v,fi)=>{if(v!=null)ctx.lineTo(xP(a.length+fi),yP(v));});
        ctx.stroke();ctx.setLineDash([]);ctx.globalAlpha=1;
      }
    });
  },50);
}
document.getElementById('dpClose').addEventListener('click',()=>{
  panel.classList.remove('open');
  tBody.querySelectorAll('tr').forEach(r=>r.classList.remove('selected'));
  if(_splitMode) closeSplitDetail();
  selIdx=null;
});
document.getElementById('dpPrev').addEventListener('click',()=>{if(selIdx>0)openDetail(selIdx-1);});
document.getElementById('dpNext').addEventListener('click',()=>{if(selIdx<ALL.length-1)openDetail(selIdx+1);});

// ===============================================
// CLEAN ROOM TAB (carried from v9, enhanced)
// ===============================================
const CR_SCHEMA=[
  {name:'data_points',domain:'health',server:'health_db',icon:'📊',cols:[{n:'id',t:'uuid',pk:true},{n:'user_id',t:'uuid',fk:'users'},{n:'category',t:'varchar'},{n:'sub_category',t:'varchar'},{n:'value',t:'jsonb'},{n:'source',t:'varchar'},{n:'measured_at',t:'ts'},{n:'visit_id',t:'varchar'},{n:'data_hash',t:'varchar'},{n:'xrpl_anchored',t:'bool'},{n:'quality_score',t:'decimal'}]},
  {name:'users',domain:'auth',server:'health_db',icon:'👤',cols:[{n:'id',t:'uuid',pk:true},{n:'email',t:'varchar'},{n:'display_name',t:'varchar'},{n:'role',t:'enum'},{n:'status',t:'varchar'},{n:'created_at',t:'ts'}]},
  {name:'user_profiles',domain:'auth',server:'health_db',icon:'📋',cols:[{n:'id',t:'uuid',pk:true},{n:'user_id',t:'uuid',fk:'users'},{n:'birth_date',t:'date'},{n:'gender',t:'varchar'},{n:'height_cm',t:'decimal'},{n:'weight_kg',t:'decimal'},{n:'medications',t:'jsonb'}]},
  {name:'consents',domain:'consent',server:'health_db',icon:'✅',cols:[{n:'id',t:'uuid',pk:true},{n:'user_id',t:'uuid',fk:'users'},{n:'consent_type',t:'varchar'},{n:'status',t:'varchar'},{n:'project_id',t:'uuid'},{n:'irb_number',t:'varchar'},{n:'version',t:'int'}]},
  {name:'study_config',domain:'research',server:'uniqdata_db',icon:'⚙️',cols:[{n:'id',t:'uuid',pk:true},{n:'project_id',t:'uuid',fk:'projects'},{n:'study_type',t:'enum'},{n:'has_control_arm',t:'bool'},{n:'num_arms',t:'int'},{n:'duration_days',t:'int'},{n:'visit_windows',t:'jsonb'},{n:'metric_templates',t:'jsonb'}]},
  {name:'visit_windows',domain:'research',server:'uniqdata_db',icon:'📅',cols:[{n:'id',t:'uuid',pk:true},{n:'study_config_id',t:'uuid',fk:'study_config'},{n:'visit_id',t:'varchar'},{n:'target_day',t:'int'},{n:'window_min',t:'int'},{n:'window_max',t:'int'},{n:'label',t:'varchar'}]},
  {name:'projects',domain:'research',server:'uniqdata_db',icon:'🔬',cols:[{n:'id',t:'uuid',pk:true},{n:'title',t:'varchar'},{n:'project_type',t:'enum'},{n:'status',t:'varchar'},{n:'pi_user_id',t:'uuid'},{n:'irb_number',t:'varchar'},{n:'target_participant_count',t:'int'}]},
  {name:'participants',domain:'research',server:'uniqdata_db',icon:'🧑‍🔬',cols:[{n:'id',t:'uuid',pk:true},{n:'project_id',t:'uuid',fk:'projects'},{n:'user_id',t:'uuid'},{n:'status',t:'varchar'},{n:'group_assignment',t:'varchar'},{n:'reward_earned',t:'decimal'}]},
  {name:'adverse_events',domain:'safety',server:'health_db',icon:'🛡️',cols:[{n:'id',t:'uuid',pk:true},{n:'participant_id',t:'uuid',fk:'participants'},{n:'visit_id',t:'varchar'},{n:'ae_term',t:'varchar'},{n:'severity',t:'enum'},{n:'related',t:'bool'},{n:'serious',t:'bool'},{n:'outcome',t:'varchar'},{n:'reported_at',t:'ts'}]},
  {name:'metric_templates',domain:'research',server:'uniqdata_db',icon:'📐',cols:[{n:'id',t:'uuid',pk:true},{n:'study_config_id',t:'uuid',fk:'study_config'},{n:'metric_key',t:'varchar'},{n:'name',t:'varchar'},{n:'unit',t:'varchar'},{n:'direction',t:'enum'},{n:'renderer',t:'varchar'},{n:'derive_from',t:'jsonb'}]},
  {name:'project_milestones',domain:'research',server:'uniqdata_db',icon:'🎯',cols:[{n:'id',t:'uuid',pk:true},{n:'project_id',t:'uuid',fk:'projects'},{n:'milestone_type',t:'varchar'},{n:'status',t:'varchar'},{n:'target_date',t:'date'},{n:'completed_at',t:'ts'}]},
  {name:'data_access_logs',domain:'health',server:'health_db',icon:'📝',cols:[{n:'id',t:'uuid',pk:true},{n:'accessor_id',t:'uuid'},{n:'project_id',t:'uuid'},{n:'record_count',t:'int'},{n:'pseudonymized',t:'bool'},{n:'agg_tier',t:'varchar'}]},
];

const PSEUDO_MAP={};let pseudoCounter=1;
function pseudonymize(uid){if(!PSEUDO_MAP[uid])PSEUDO_MAP[uid]='SUB-'+String(pseudoCounter++).padStart(3,'0');return PSEUDO_MAP[uid];}
function fakeUUID(){return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{const r=Math.random()*16|0;return(c==='x'?r:r&0x3|0x8).toString(16);});}
function fakeHash(){return'0x'+Array.from({length:12},()=>Math.random().toString(16)[2]).join('');}
function fakeDate(base,off){const d=new Date(base);d.setDate(d.getDate()+off+Math.random()*3);return d.toISOString().replace('T',' ').slice(0,19);}

const CR_PATIENT_IDS=Array.from({length:10},()=>fakeUUID());
const CR_PROJECT_ID=fakeUUID();
const CR_CATEGORIES=['weight','sbp','dbp','heart_rate','steps','sleep_duration','compliance','app_usage'];
const CR_SOURCES=['EMR_SNUH','Fitbit_Charge5','EMA_App','Manual_Input'];

function crGenDataPoints(count){
  const rows=[];const visitIds=VISITS.map(v=>v.id);
  for(let i=0;i<count;i++){
    const uid=CR_PATIENT_IDS[Math.floor(Math.random()*CR_PATIENT_IDS.length)];
    const cat=CR_CATEGORIES[Math.floor(Math.random()*CR_CATEGORIES.length)];
    const src=cat==='weight'||cat==='sbp'||cat==='dbp'?'EMR_SNUH':cat==='heart_rate'||cat==='steps'||cat==='sleep_duration'?'Fitbit_Charge5':'EMA_App';
    const dayOff=Math.floor(Math.random()*42);
    const vid=visitIds[Math.min(Math.floor(dayOff/14),visitIds.length-1)];
    let val;
    switch(cat){
      case'weight':val={value:75+Math.random()*20,unit:'kg'};break;
      case'sbp':val={value:110+Math.random()*35,unit:'mmHg'};break;
      case'dbp':val={value:65+Math.random()*20,unit:'mmHg'};break;
      case'heart_rate':val={value:58+Math.random()*25,unit:'bpm'};break;
      case'steps':val={value:Math.round(2000+Math.random()*10000),unit:'steps'};break;
      case'sleep_duration':val={value:Math.round((4+Math.random()*5)*10)/10,unit:'hours'};break;
      case'compliance':val={value:Math.round(Math.random()*100),type:'medication_adherence'};break;
      case'app_usage':val={value:Math.round(Math.random()*120),unit:'minutes'};break;
    }
    rows.push({id:fakeUUID(),user_id:uid,category:cat,sub_category:cat,value:val,source:src,measured_at:fakeDate(STUDY_CONFIG.timeline.base_date,dayOff),visit_id:vid,data_hash:fakeHash(),xrpl_anchored:Math.random()>0.3,quality_score:Math.round((0.7+Math.random()*0.3)*100)/100});
  }
  return rows.sort((a,b)=>b.measured_at.localeCompare(a.measured_at));
}
function crGenAllTables(){
  const pts = ALL.map(p=>({id:fakeUUID(),project_id:CR_PROJECT_ID,user_id:CR_PATIENT_IDS[ALL.indexOf(p)%10],status:p.al?'at_risk':'active',group_assignment:p.g==='exp'?'experimental':'control',reward_earned:Math.round(Math.random()*50000)}));
  const users = CR_PATIENT_IDS.map((uid,i)=>({id:uid,email:pseudonymize(uid).toLowerCase()+'@masked.uniq',display_name:pseudonymize(uid),role:i===0?'PI':'participant',status:'active',created_at:fakeDate(STUDY_CONFIG.timeline.base_date,-7)}));
  const profiles = CR_PATIENT_IDS.map(uid=>({id:fakeUUID(),user_id:uid,birth_date:'19'+(70+Math.floor(Math.random()*25))+'-0'+Math.ceil(Math.random()*9)+'-'+String(Math.ceil(Math.random()*28)).padStart(2,'0'),gender:Math.random()>0.5?'M':'F',height_cm:Math.round(155+Math.random()*30),weight_kg:Math.round((55+Math.random()*35)*10)/10,medications:JSON.stringify(Math.random()>0.5?['Metformin']:['None'])}));
  const consents = CR_PATIENT_IDS.map(uid=>({id:fakeUUID(),user_id:uid,consent_type:'research_participation',status:'signed',project_id:CR_PROJECT_ID,irb_number:STUDY_CONFIG.irb_number||'IRB-2025-0847',version:1}));
  const scfg = [{id:fakeUUID(),project_id:CR_PROJECT_ID,study_type:STUDY_CONFIG.research_type,has_control_arm:STUDY_CONFIG.design.has_control_arm,num_arms:STUDY_CONFIG.design.arm_labels.length,duration_days:STUDY_CONFIG.timeline.total_days,visit_windows:JSON.stringify(VISITS.length),metric_templates:JSON.stringify(STUDY_CONFIG.metrics.length)}];
  const vw = VISITS.map((v,i)=>({id:fakeUUID(),study_config_id:scfg[0].id,visit_id:v.id,target_day:v.day,window_min:v.day-3,window_max:v.day+3,label:v.id}));
  const proj = [{id:CR_PROJECT_ID,title:STUDY_CONFIG.title,project_type:STUDY_CONFIG.research_type==='prospective'?'interventional':'observational',status:'active',pi_user_id:CR_PATIENT_IDS[0],irb_number:STUDY_CONFIG.irb_number||'IRB-2025-0847',target_participant_count:STUDY_CONFIG.n_target||30}];
  const AE_TERMS=['두통','오심','어지러움','피로감','소화불량','불면','발진','근육통'];
  const aes = [];
  ALL.filter(p=>p.al).forEach(p=>{
    const nae = 1+Math.floor(Math.random()*2);
    for(let k=0;k<nae;k++){
      aes.push({id:fakeUUID(),participant_id:pts[ALL.indexOf(p)]?.id||fakeUUID(),visit_id:VISITS[Math.floor(Math.random()*VISITS.length)].id,ae_term:AE_TERMS[Math.floor(Math.random()*AE_TERMS.length)],severity:Math.random()>0.8?'severe':Math.random()>0.5?'moderate':'mild',related:Math.random()>0.4,serious:Math.random()>0.85,outcome:Math.random()>0.3?'resolved':'ongoing',reported_at:fakeDate(STUDY_CONFIG.timeline.base_date,Math.floor(Math.random()*42))});
    }
  });
  const mtpls = STUDY_CONFIG.metrics.map(m=>({id:fakeUUID(),study_config_id:scfg[0].id,metric_key:m.key,name:m.name,unit:m.unit,direction:m.direction,renderer:m.renderer||'auto',derive_from:JSON.stringify(m.cdm_concept_hint||null)}));
  const milestones = [{id:fakeUUID(),project_id:CR_PROJECT_ID,milestone_type:'enrollment_start',status:'completed',target_date:'2026-01-01',completed_at:'2026-01-02 10:00:00'},{id:fakeUUID(),project_id:CR_PROJECT_ID,milestone_type:'enrollment_complete',status:'completed',target_date:'2026-01-15',completed_at:'2026-01-14 14:30:00'},{id:fakeUUID(),project_id:CR_PROJECT_ID,milestone_type:'interim_analysis',status:'in_progress',target_date:'2026-02-01',completed_at:null},{id:fakeUUID(),project_id:CR_PROJECT_ID,milestone_type:'study_complete',status:'pending',target_date:'2026-03-01',completed_at:null}];
  const accessLogs = Array.from({length:15},()=>({id:fakeUUID(),accessor_id:CR_PATIENT_IDS[0],project_id:CR_PROJECT_ID,record_count:Math.floor(10+Math.random()*200),pseudonymized:true,agg_tier:['raw','hourly','daily','visit'][Math.floor(Math.random()*4)]}));
  return {data_points:crGenDataPoints(50),users,user_profiles:profiles,consents,study_config:scfg,visit_windows:vw,projects:proj,participants:pts,adverse_events:aes,metric_templates:mtpls,project_milestones:milestones,data_access_logs:accessLogs};
}
const CR_DATA_CACHE=crGenAllTables();
let crQueryCount=0,crCurrentTable='data_points',crAggTier='raw';

// 시간 일반화 — agg tier에 따라 timestamp 해상도 조절
function generalizeTimestamp(ts, tier){
  if(!ts || ts==='—') return '—';
  switch(tier){
    case 'raw': return ts; // 전체: 2026-01-15 14:32:07
    case 'hourly': return ts.slice(0,13)+':00'; // 시간: 2026-01-15 14:00
    case 'daily': return ts.slice(0,10); // 날짜: 2026-01-15
    case 'visit': return null; // visit ID만 (timestamp 숨김)
    default: return ts;
  }
}

function buildSchemaPanel(){
  const list=document.getElementById('spList');let html='',curServer='';
  document.getElementById('spCount').textContent=CR_SCHEMA.length+' 테이블';
  CR_SCHEMA.forEach(s=>{
    if(s.server!==curServer){curServer=s.server;html+=`<div class="sp-server">${curServer==='health_db'?'🗄️ health_db':'🗄️ uniqdata_db'}</div>`;}
    const rc=CR_DATA_CACHE[s.name]?CR_DATA_CACHE[s.name].length:'—';
    html+=`<div class="sp-table${s.name===crCurrentTable?' active':''}" data-table="${s.name}"><span class="sp-icon">${s.icon}</span><span>${s.name}</span><span class="sp-count">${rc}</span></div>`;
  });
  list.innerHTML=html;
  list.querySelectorAll('.sp-table').forEach(el=>{
    el.addEventListener('click',()=>{crCurrentTable=el.dataset.table;list.querySelectorAll('.sp-table').forEach(e=>e.classList.remove('active'));el.classList.add('active');crRenderTable(crCurrentTable);});
  });
}

function crRenderTable(tableName){
  crQueryCount++;
  const schema=CR_SCHEMA.find(s=>s.name===tableName);if(!schema)return;
  const data=CR_DATA_CACHE[tableName]||[];
  document.getElementById('dgToolbar').innerHTML=`
    <div class="dg-title"><span class="t-icon">${schema.icon}</span>${schema.name}</div>
    <div class="dg-pills"><span class="dg-pill active">전체</span>${tableName==='data_points'?'<span class="dg-pill" data-cat="weight">weight</span><span class="dg-pill" data-cat="sbp">sbp</span>':''}</div>
    <div class="dg-privacy">${crAggTier==='raw'?'🔓 원본 · 감사 기록됨':crAggTier==='hourly'?'🔒 시간 단위 일반화':crAggTier==='daily'?'🔒 일 단위 일반화':'🛡️ 방문 단위 · 시간 완전 제거'} · user_id → SUB-XXX</div>
    <div class="agg-tier" id="aggTierBtns"><button class="${crAggTier==='raw'?'active':''}" data-tier="raw">raw</button><button class="${crAggTier==='hourly'?'active':''}" data-tier="hourly">hourly</button><button class="${crAggTier==='daily'?'active':''}" data-tier="daily">daily</button><button class="${crAggTier==='visit'?'active':''}" data-tier="visit">visit</button></div>
    <div class="dg-filter"><span style="font-size:9px;color:#9ca3af;">${schema.server} · ${schema.domain}</span></div>`;
  document.getElementById('dgToolbar').querySelectorAll('.dg-pill').forEach(p=>{
    p.addEventListener('click',()=>{document.getElementById('dgToolbar').querySelectorAll('.dg-pill').forEach(pp=>pp.classList.remove('active'));p.classList.add('active');const cat=p.dataset.cat;crRenderRows(schema,cat?data.filter(r=>r.category===cat):data);});
  });
  // agg-tier 버튼 — 시간 해상도 조절
  document.getElementById('aggTierBtns').querySelectorAll('button').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.getElementById('aggTierBtns').querySelectorAll('button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      crAggTier = btn.dataset.tier;
      // privacy indicator 업데이트
      const privEl = document.getElementById('dgToolbar').querySelector('.dg-privacy');
      const tierLabels = {raw:'🔓 원본 · 감사 기록됨',hourly:'🔒 시간 단위 일반화',daily:'🔒 일 단위 일반화',visit:'🛡️ 방문 단위 · 시간 완전 제거'};
      if(privEl) privEl.innerHTML = (tierLabels[crAggTier]||'🛡️ 가명화') + ' · user_id → SUB-XXX';
      crRenderRows(schema, data);
    });
  });
  document.getElementById('dgHead').innerHTML='<tr>'+schema.cols.map(c=>{
    let badge='';if(c.pk)badge='<span style="color:#E69F00;font-size:7px;">PK</span>';if(c.fk)badge='<span style="color:#0072B2;font-size:7px;">FK→'+c.fk+'</span>';
    return`<th>${c.n}${badge?'<br>'+badge:''}<span class="col-type">${c.t}</span></th>`;
  }).join('')+'</tr>';
  crRenderRows(schema,data);
}

function crRenderRows(schema,data){
  const body=document.getElementById('dgBody');
  if(!data.length){body.innerHTML=`<tr><td colspan="${schema.cols.length}" style="text-align:center;padding:40px;color:#9ca3af;">데이터 없음</td></tr>`;return;}
  body.innerHTML=data.map(row=>'<tr>'+schema.cols.map(c=>{
    const v=row[c.n];
    if(v===undefined||v===null)return'<td><span class="null-val">NULL</span></td>';
    if((c.n==='user_id'||c.n==='pi_user_id'||c.n==='accessor_id')&&c.t==='uuid')return`<td><span class="pseudo">${pseudonymize(v)}</span></td>`;
    if(c.t==='uuid')return`<td><span class="hash-val" title="${v}">${v.slice(0,8)}…</span></td>`;
    if(c.t==='jsonb'){const pre=JSON.stringify(v).slice(0,40);return`<td><span class="json-val" onclick="showJSON('${c.n}',this)" data-json='${JSON.stringify(v).replace(/'/g,"&#39;")}'>${pre}${JSON.stringify(v).length>40?'…':''}</span></td>`;}
    if(c.t==='bool')return`<td><span class="bool-val ${v?'true':'false'}">${v}</span></td>`;
    if(c.t==='ts'){
      if(crAggTier==='visit') return`<td><span class="ts-val" style="color:#d1d5db;font-style:italic;">숨김</span></td>`;
      const gv = generalizeTimestamp(v, crAggTier);
      const dimStyle = crAggTier!=='raw' ? 'opacity:.6;' : '';
      return`<td><span class="ts-val" style="${dimStyle}">${gv||'—'}</span></td>`;
    }
    if(c.t==='decimal'||c.t==='int')return`<td><span class="num-val">${typeof v==='number'?v.toFixed?v.toFixed(2):v:v}</span></td>`;
    return`<td>${v}</td>`;
  }).join('')+'</tr>').join('');
  document.getElementById('dgRowInfo').textContent=`${data.length} rows · ${schema.cols.length} columns · 쿼리 #${crQueryCount}`;
  document.getElementById('dgQueryBadge').textContent=`📝 쿼리 #${crQueryCount} 기록됨`;
}

function showJSON(colName,el){
  const data=JSON.parse(el.dataset.json);
  document.getElementById('jmTitle').textContent=colName+' (JSONB)';
  document.getElementById('jmContent').innerHTML=JSON.stringify(data,null,2).replace(/"([^"]+)":/g,'<span class="jk">"$1"</span>:').replace(/: "([^"]+)"/g,': <span class="js">"$1"</span>').replace(/: (\d+\.?\d*)/g,': <span class="jn">$1</span>').replace(/: (true|false)/g,': <span class="jb">$1</span>');
  document.getElementById('jsonModal').classList.add('open');
}
document.getElementById('jmClose').addEventListener('click',()=>document.getElementById('jsonModal').classList.remove('open'));
document.getElementById('jsonModal').addEventListener('click',e=>{if(e.target===e.currentTarget)e.currentTarget.classList.remove('open');});
document.getElementById('spSearch').addEventListener('input',function(){const q=this.value.toLowerCase();document.querySelectorAll('.sp-table').forEach(el=>{el.style.display=el.dataset.table.includes(q)?'':'none';});});

// Session timer
let crElapsed=0;
setInterval(()=>{crElapsed++;const m=Math.floor(crElapsed/60);const s=crElapsed%60;document.getElementById('crElapsed').textContent=String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');},1000);

// ===============================================
// PAGE HEADER — config-driven
// ===============================================
function initPageHeader(){
  const cfg=STUDY_CONFIG;
  document.getElementById('pageTitle').textContent=cfg.title;
  const sbn=document.getElementById('sidebarStudyName'); if(sbn) sbn.textContent=cfg.title;
  // 사이드바 3연구 구조에서는 현재 연구 헤더의 텍스트 업데이트
  const curStudyNav = document.getElementById('studyNav-'+_currentStudy);
  if(curStudyNav){ const nameSpan=curStudyNav.querySelectorAll('span')[1]; if(nameSpan) nameSpan.textContent=cfg.title; }
  const curPt=PAST_VISITS[PAST_VISITS.length-1];
  const totalPts=VISITS.length;
  // regulatory 조건부 표시
  const regLabel = cfg.regulatory.type==='none'?'규제 해당없음':cfg.regulatory.type==='irb_exempt'?'IRB 면제':cfg.regulatory.number||'심사 대기';
  const nTotal = PATIENT_PROFILES.exp.length + PATIENT_PROFILES.ctrl.length;
  const armInfo = cfg.design.has_control_arm ? `${cfg.design.arm_labels.join(' / ')} · ${PATIENT_PROFILES.exp.length}+${PATIENT_PROFILES.ctrl.length}명` : `${cfg.design.arm_labels[0]} · ${PATIENT_PROFILES.exp.length}명`;
  document.getElementById('pageSub').textContent=`${cfg.subtitle} · ${cfg.design.study_type.toUpperCase()} · ${armInfo} · ${regLabel}`;
  // 진행 상태: today_day 기준 수집된 visit까지만 표시
  const isRetroHeader = STUDY_CONFIG.research_type === 'retrospective';
  const _todayDayH = STUDY_CONFIG.timeline.today_day;
  const _hasTodayH = _todayDayH !== null && _todayDayH !== undefined;
  // 실제 수집 완료된 최신 visit (today_day 기준)
  const collectedVisits = _hasTodayH ? VISITS.filter(v=>v.target_day<=_todayDayH) : PAST_VISITS;
  const lastCollected = collectedVisits[collectedVisits.length-1] || curPt;
  document.getElementById('statusText').textContent = isRetroHeader ? '분석 완료' : '진행 중';
  document.getElementById('statusDetail').textContent = isRetroHeader
    ? `전체 ${totalPts}시점 수집완료`
    : `${lastCollected.id} / ${VISITS[totalPts-1].id}`;
  // 타임라인 config info (인라인)
  const tlInfo=document.getElementById('tlConfigInfo');
  if(tlInfo) tlInfo.textContent=`기준: ${tuRefLabel()} · ${tuBehaviorLabel()} · 분석: ${cfg.timeline.analysis_rule}`;
  // cbType (hidden badge 호환)
  const cbt=document.getElementById('cbType'); if(cbt) cbt.textContent=`${cfg.design.study_type.toUpperCase()} · ${tuLabel('axis')}`;
  // 클린룸 IRB 칩도 조건부
  const irbChip=document.getElementById('crIrb');
  if(irbChip){
    if(cfg.regulatory.type==='none'){irbChip.textContent='규제 해당없음';irbChip.style.borderColor='#94a3b8';}
    else if(cfg.regulatory.type==='irb_exempt'){irbChip.textContent='IRB 면제';irbChip.style.borderColor=C.amber;}
    else{irbChip.textContent=cfg.regulatory.number||'심사 대기';}
  }
}

// ===============================================
// STUDY SCENARIOS — 시간축은 연구설계가 결정한다 (사용자 선택 아님!)
// 사이드바 "데모 시나리오" = 다른 연구를 여는 것
// 타임라인 내부에 V/W/P/D 버튼 없음 → NO MODES, NO TOGGLING
// ===============================================

// 타임라인 자동 배지 업데이트 — 기존 TIME_UNIT_LABELS.axis 활용
function updateTimelineBadge(){
  const tu = STUDY_CONFIG.timeline.time_unit;
  const badge = document.getElementById('tlAutoLabel');
  if(badge){
    if(STUDY_CONFIG.research_type === 'retrospective'){
      badge.textContent = '후향적 · ' + tuLabel('axis');
      badge.parentElement.className = 'retro-badge';
    } else {
      badge.textContent = tuLabel('axis');
      badge.parentElement.className = 'tl-auto-badge';
    }
  }
}

const TIME_PRESETS = {
  visit: {
    title: '대사개선 약물 연구',
    time_unit: 'visit',
    reference_point: {type:'first_dose', label:'첫 투약일'},
    timing_behavior: 'participant-relative',
    analysis_rule: 'nearest-in-window',
    subtitle: '처방 약물(2.4mg)',
    study_type_label: 'RCT (방문 기반 임상시험)',
    research_type: 'prospective',
    points: [
      {id:'V1',label:'V1 (BL)',target_day:0,window:[-3,3],epoch:'baseline',planned:true},
      {id:'V2',label:'V2 (2주)',target_day:14,window:[-5,5],epoch:'treatment',planned:true},
      {id:'V3',label:'V3 (4주)',target_day:28,window:[-5,5],epoch:'treatment',planned:true},
      {id:'V4',label:'V4 (6주)',target_day:42,window:[-5,5],epoch:'treatment',planned:true},
      {id:'V5',label:'V5 (8주)',target_day:56,window:[-5,5],epoch:'treatment',planned:true},
      {id:'V6',label:'V6 (10주)',target_day:70,window:[-5,5],epoch:'treatment',planned:true},
      {id:'V7',label:'V7 (12주)',target_day:84,window:[-7,7],epoch:'treatment',planned:true},
    ],
    phases: [
      {name:'스크리닝',key:'screening',start:-57,end:-43,color:'#94a3b8'},
      {name:'등록',key:'enrollment',start:-42,end:-15,color:'#6366f1'},
      {name:'베이스라인',key:'baseline',start:-14,end:-1,color:C.blue},
      {name:'치료',key:'treatment',start:0,end:84,color:'#0ea5e9'},
      {name:'추적',key:'followup',start:85,end:168,color:C.green},
      {name:'분석',key:'analysis',start:169,end:227,color:'#8b5cf6'},
    ],
    metrics_override: null,
  },
  week: {
    time_unit: 'week',
    reference_point: {type:'enrollment', label:'등록일'},
    timing_behavior: 'calendar-fixed',
    analysis_rule: 'nearest-in-window',
    subtitle: '12주 체중관리 코호트',
    study_type_label: '코호트 (주간 기반 관찰연구)',
    research_type: 'prospective',
    points: [
      {id:'W0',label:'W0 (BL)',target_day:0,window:[-1,1],epoch:'baseline',planned:true},
      {id:'W2',label:'W2',target_day:14,window:[-3,3],epoch:'treatment',planned:true},
      {id:'W4',label:'W4',target_day:28,window:[-3,3],epoch:'treatment',planned:true},
      {id:'W6',label:'W6',target_day:42,window:[-3,3],epoch:'treatment',planned:true},
      {id:'W8',label:'W8',target_day:56,window:[-3,3],epoch:'treatment',planned:true},
      {id:'W10',label:'W10',target_day:70,window:[-3,3],epoch:'treatment',planned:true},
      {id:'W12',label:'W12 (종료)',target_day:84,window:[-3,3],epoch:'followup',planned:true},
    ],
    phases: [
      {name:'베이스라인',key:'baseline',start:-7,end:-1,color:C.blue},
      {name:'프로그램',key:'treatment',start:0,end:84,color:'#0ea5e9'},
      {name:'추적',key:'followup',start:85,end:168,color:C.green},
    ],
  },
  phase: {
    time_unit: 'phase',
    reference_point: {type:'first_dose', label:'첫 투약일'},
    timing_behavior: 'participant-relative',
    analysis_rule: 'nearest-after',
    subtitle: '항암 Phase I/II 용량탐색',
    study_type_label: 'Phase I/II (단계 기반 용량탐색)',
    research_type: 'prospective',
    points: [
      {id:'P1-D1',label:'P1 1일차',target_day:0,window:[0,0],epoch:'treatment',planned:true},
      {id:'P1-D8',label:'P1 8일차',target_day:8,window:[-1,1],epoch:'treatment',planned:true},
      {id:'P1-D15',label:'P1 15일차',target_day:15,window:[-1,1],epoch:'treatment',planned:true},
      {id:'P2-D1',label:'P2 1일차',target_day:28,window:[-1,1],epoch:'treatment',planned:true},
      {id:'P2-D8',label:'P2 8일차',target_day:36,window:[-1,1],epoch:'treatment',planned:true},
      {id:'P2-D15',label:'P2 15일차',target_day:43,window:[-1,1],epoch:'treatment',planned:true},
      {id:'P3-D1',label:'P3 1일차',target_day:56,window:[-1,1],epoch:'treatment',planned:true},
    ],
    phases: [
      {name:'Phase 1',key:'treatment',start:0,end:21,color:'#0ea5e9'},
      {name:'Phase 2',key:'treatment',start:22,end:49,color:'#6366f1'},
      {name:'Phase 3',key:'treatment',start:50,end:70,color:'#8b5cf6'},
    ],
    // v11: Phase I/II metrics — oncology specific
    metrics_override: [
      {k:'dose',name:'투여량',unit:'mg/m²',domain:'drug_exposure',concept_hint:'drug_dose',value_type:'numeric',direction:'monitor',priority:'primary',source:'EMR',renderer:null,color:C.blue,p_value:null,measurement_freq:'per_visit'},
      {k:'anc',name:'ANC',unit:'×10³/μL',domain:'measurement',concept_hint:'anc_count',value_type:'numeric',direction:'monitor',priority:'safety',source:'EMR',renderer:null,color:C.vermillion,p_value:0.04,measurement_freq:'per_visit'},
      {k:'plt',name:'혈소판',unit:'×10³/μL',domain:'measurement',concept_hint:'platelet_count',value_type:'numeric',direction:'monitor',priority:'safety',source:'EMR',renderer:null,color:C.amber,p_value:0.08,measurement_freq:'per_visit'},
      {k:'tumor',name:'종양크기',unit:'mm',domain:'measurement',concept_hint:'tumor_size',value_type:'numeric',direction:'down',priority:'primary',source:'영상',renderer:null,color:C.green,p_value:0.03,measurement_freq:'per_visit'},
      {k:'toxicity',name:'독성등급',unit:'G',domain:'condition_occurrence',concept_hint:'toxicity_grade',value_type:'ordinal',direction:'down',priority:'safety',source:'EMR',renderer:'severity_zone',color:'#ef4444',p_value:0.01,measurement_freq:'per_visit'},
      {k:'ecog',name:'ECOG PS',unit:'점',domain:'observation',concept_hint:'ecog_status',value_type:'ordinal',direction:'down',priority:'secondary',source:'EMR',renderer:'severity_zone',color:'#8b5cf6',p_value:0.15,measurement_freq:'per_visit'},
    ],
    patient_seeds_override: {
      exp: [
        {id:'P001',nm:'환자A',sv:'good',st:'verified',seeds:{dose:{s:100,sl:25,n:5},anc:{s:4.2,sl:-0.8,n:0.3},plt:{s:220,sl:-30,n:10},tumor:{s:45,sl:-5,n:2},toxicity:{s:1,sl:0.5,n:0.2},ecog:{s:1,sl:0.1,n:0.1}}},
        {id:'P002',nm:'환자B',sv:'good',st:'verified',seeds:{dose:{s:100,sl:25,n:5},anc:{s:3.8,sl:-0.6,n:0.4},plt:{s:200,sl:-25,n:12},tumor:{s:52,sl:-4,n:3},toxicity:{s:1,sl:0.4,n:0.3},ecog:{s:1,sl:0.15,n:0.1}}},
        {id:'P003',nm:'환자C',sv:'warn',st:'query',al:true,seeds:{dose:{s:100,sl:25,n:5},anc:{s:2.8,sl:-1.2,n:0.5},plt:{s:180,sl:-40,n:15},tumor:{s:38,sl:-3,n:4},toxicity:{s:2,sl:0.8,n:0.3},ecog:{s:2,sl:0.3,n:0.2}}},
        {id:'P004',nm:'환자D',sv:'good',st:'verified',seeds:{dose:{s:100,sl:25,n:5},anc:{s:5.1,sl:-0.5,n:0.2},plt:{s:240,sl:-20,n:8},tumor:{s:60,sl:-6,n:2},toxicity:{s:0,sl:0.3,n:0.2},ecog:{s:0,sl:0.05,n:0.05}}},
        {id:'P005',nm:'환자E',sv:'good',st:'verified',seeds:{dose:{s:100,sl:25,n:5},anc:{s:3.5,sl:-0.7,n:0.3},plt:{s:210,sl:-28,n:11},tumor:{s:42,sl:-4.5,n:2.5},toxicity:{s:1,sl:0.6,n:0.25},ecog:{s:1,sl:0.1,n:0.08}}},
      ],
      ctrl: [], // Phase I — single arm, no control
    },
  },
  day: {
    time_unit: 'day',
    reference_point: {type:'custom', label:'ICU 입실일'},
    timing_behavior: 'participant-relative',
    analysis_rule: 'last-before',
    subtitle: 'ICU 급성기 모니터링',
    study_type_label: '관찰 (일별 기반 집중 모니터링)',
    research_type: 'prospective',
    points: [
      {id:'D0',label:'D0 (입실)',target_day:0,window:[0,0],epoch:'baseline',planned:true},
      {id:'D1',label:'D1',target_day:1,window:[0,0],epoch:'treatment',planned:true},
      {id:'D3',label:'D3',target_day:3,window:[0,0],epoch:'treatment',planned:true},
      {id:'D7',label:'D7',target_day:7,window:[-1,1],epoch:'treatment',planned:true},
      {id:'D14',label:'D14',target_day:14,window:[-1,1],epoch:'treatment',planned:true},
      {id:'D28',label:'D28',target_day:28,window:[-2,2],epoch:'followup',planned:true},
      {id:'D42',label:'D42 (퇴원)',target_day:42,window:[-3,3],epoch:'followup',planned:true},
    ],
    phases: [
      {name:'입실',key:'baseline',start:0,end:0,color:C.blue},
      {name:'급성기',key:'treatment',start:1,end:14,color:'#ef4444'},
      {name:'회복기',key:'followup',start:15,end:42,color:C.green},
    ],
    // v11: ICU metrics — critical care specific
    metrics_override: [
      {k:'hr',name:'심박수',unit:'bpm',domain:'measurement',concept_hint:'heart_rate',value_type:'numeric',direction:'monitor',priority:'primary',source:'EMR',renderer:null,color:C.vermillion,p_value:null,measurement_freq:'continuous'},
      {k:'sbp',name:'혈압',unit:'mmHg',domain:'measurement',concept_hint:'systolic_bp',value_type:'numeric',direction:'monitor',priority:'primary',source:'EMR',renderer:null,color:C.blue,p_value:null,measurement_freq:'continuous'},
      {k:'spo2',name:'SpO₂',unit:'%',domain:'measurement',concept_hint:'oxygen_saturation',value_type:'proportion',direction:'up',priority:'primary',source:'EMR',renderer:'severity_zone',color:C.green,p_value:null,measurement_freq:'continuous'},
      {k:'temp',name:'체온',unit:'°C',domain:'measurement',concept_hint:'body_temperature',value_type:'numeric',direction:'monitor',priority:'secondary',source:'EMR',renderer:null,color:C.amber,p_value:null,measurement_freq:'continuous'},
      {k:'gcs',name:'GCS',unit:'점',domain:'observation',concept_hint:'gcs_score',value_type:'ordinal',direction:'up',priority:'primary',source:'EMR',renderer:'severity_zone',color:'#8b5cf6',p_value:null,measurement_freq:'per_visit'},
      {k:'fluid',name:'수액',unit:'mL/h',domain:'drug_exposure',concept_hint:'iv_fluid_rate',value_type:'numeric',direction:'monitor',priority:'secondary',source:'EMR',renderer:null,color:'#14b8a6',p_value:null,measurement_freq:'continuous'},
      {k:'urine',name:'소변량',unit:'mL/h',domain:'measurement',concept_hint:'urine_output',value_type:'numeric',direction:'up',priority:'safety',source:'EMR',renderer:null,color:C.pink,p_value:null,measurement_freq:'continuous'},
    ],
    patient_seeds_override: {
      exp: [
        {id:'ICU01',nm:'환자1',sv:'warn',st:'review',seeds:{hr:{s:95,sl:-3,n:2},sbp:{s:85,sl:4,n:3},spo2:{s:92,sl:1.5,n:1},temp:{s:38.5,sl:-0.3,n:0.2},gcs:{s:11,sl:0.5,n:0.3},fluid:{s:120,sl:-8,n:5},urine:{s:30,sl:5,n:3}}},
        {id:'ICU02',nm:'환자2',sv:'good',st:'verified',seeds:{hr:{s:82,sl:-2,n:1.5},sbp:{s:95,sl:3,n:2},spo2:{s:95,sl:0.8,n:0.5},temp:{s:37.8,sl:-0.2,n:0.15},gcs:{s:13,sl:0.3,n:0.2},fluid:{s:100,sl:-10,n:4},urine:{s:45,sl:3,n:2}}},
        {id:'ICU03',nm:'환자3',sv:'bad',st:'query',al:true,seeds:{hr:{s:110,sl:-1,n:3},sbp:{s:75,sl:2,n:4},spo2:{s:88,sl:2,n:1.5},temp:{s:39.2,sl:-0.15,n:0.3},gcs:{s:8,sl:0.8,n:0.4},fluid:{s:150,sl:-5,n:6},urine:{s:15,sl:4,n:3}}},
        {id:'ICU04',nm:'환자4',sv:'good',st:'verified',seeds:{hr:{s:78,sl:-1.5,n:1},sbp:{s:105,sl:2,n:1.5},spo2:{s:96,sl:0.5,n:0.3},temp:{s:37.2,sl:-0.1,n:0.1},gcs:{s:14,sl:0.2,n:0.1},fluid:{s:80,sl:-12,n:3},urine:{s:55,sl:2,n:2}}},
        {id:'ICU05',nm:'환자5',sv:'good',st:'verified',seeds:{hr:{s:88,sl:-2.5,n:1.8},sbp:{s:90,sl:3.5,n:2.5},spo2:{s:93,sl:1.2,n:0.8},temp:{s:38.1,sl:-0.25,n:0.18},gcs:{s:12,sl:0.4,n:0.25},fluid:{s:110,sl:-9,n:4.5},urine:{s:35,sl:4.5,n:2.5}}},
      ],
      ctrl: [
        {id:'ICU06',nm:'환자6',sv:'good',st:'verified',seeds:{hr:{s:85,sl:-1.8,n:1.2},sbp:{s:98,sl:2.5,n:2},spo2:{s:94,sl:0.9,n:0.6},temp:{s:37.5,sl:-0.18,n:0.12},gcs:{s:13,sl:0.3,n:0.15},fluid:{s:90,sl:-11,n:3.5},urine:{s:40,sl:3.5,n:2.2}}},
        {id:'ICU07',nm:'환자7',sv:'warn',st:'review',seeds:{hr:{s:100,sl:-2,n:2.5},sbp:{s:80,sl:3,n:3},spo2:{s:90,sl:1.5,n:1.2},temp:{s:38.8,sl:-0.2,n:0.25},gcs:{s:10,sl:0.6,n:0.3},fluid:{s:130,sl:-7,n:5},urine:{s:25,sl:4,n:2.8}}},
        {id:'ICU08',nm:'환자8',sv:'good',st:'verified',seeds:{hr:{s:80,sl:-1.5,n:1},sbp:{s:100,sl:2,n:1.5},spo2:{s:95,sl:0.7,n:0.4},temp:{s:37.3,sl:-0.12,n:0.1},gcs:{s:14,sl:0.2,n:0.1},fluid:{s:85,sl:-12,n:3},urine:{s:50,sl:2.5,n:1.8}}},
        {id:'ICU09',nm:'환자9',sv:'good',st:'verified',seeds:{hr:{s:76,sl:-1,n:0.8},sbp:{s:108,sl:1.5,n:1.2},spo2:{s:97,sl:0.4,n:0.3},temp:{s:37,sl:-0.05,n:0.08},gcs:{s:15,sl:0.1,n:0.05},fluid:{s:70,sl:-15,n:2.5},urine:{s:60,sl:2,n:1.5}}},
        {id:'ICU10',nm:'환자10',sv:'good',st:'verified',seeds:{hr:{s:83,sl:-1.8,n:1.3},sbp:{s:96,sl:2.8,n:1.8},spo2:{s:94,sl:0.8,n:0.5},temp:{s:37.6,sl:-0.15,n:0.12},gcs:{s:12,sl:0.35,n:0.2},fluid:{s:95,sl:-10,n:4},urine:{s:42,sl:3.2,n:2}}},
      ],
    },
  },

  // v11: NEW — Retrospective CDM scenario
  retro_cdm: {
    title: 'CDM 후향적 코호트',
    time_unit: 'month',
    reference_point: {type:'custom', label:'진단 기준일'},
    timing_behavior: 'calendar-fixed',
    analysis_rule: 'nearest-in-window',
    subtitle: 'CDM 기반 후향적 코호트 분석',
    study_type_label: 'Retrospective (CDM 후향적 분석)',
    regulatory: {type:'irb_exempt', number:null, status:'exempt'},
    research_type: 'retrospective',
    base_date: '2025-08-01',  // 후향적: 전체 기간이 과거 (Day0=2025-08, M+6=2026-01)
    today_day: null,           // 후향적: "오늘" 개념 없음 — 모든 데이터 이미 수집완료
    points: [
      {id:'M-12',label:'12개월 전',target_day:-365,window:[-15,15],epoch:'baseline',planned:true},
      {id:'M-6',label:'6개월 전',target_day:-180,window:[-15,15],epoch:'observation',planned:true},
      {id:'M-3',label:'3개월 전',target_day:-90,window:[-15,15],epoch:'observation',planned:true},
      {id:'M0',label:'기준시점',target_day:0,window:[-15,15],epoch:'index',planned:true},
      {id:'M+3',label:'3개월 후',target_day:90,window:[-15,15],epoch:'followup',planned:true},
      {id:'M+6',label:'6개월 후',target_day:180,window:[-15,15],epoch:'followup',planned:true},
    ],
    phases: [
      {name:'기저 관찰',key:'observation',start:-365,end:-181,color:'#94a3b8'},
      {name:'노출 기간',key:'index',start:-180,end:0,color:'#6366f1'},
      {name:'결과 기간',key:'outcome',start:1,end:180,color:'#0ea5e9'},
    ],
    metrics_override: [
      {k:'visit_n',name:'외래방문',unit:'회',domain:'measurement',concept_hint:'visit_count',value_type:'numeric',direction:'monitor',priority:'primary',source:'CDM',renderer:null,color:C.blue,p_value:0.04,measurement_freq:'per_visit'},
      {k:'drug_days',name:'약물노출',unit:'일',domain:'drug_exposure',concept_hint:'drug_exposure_days',value_type:'numeric',direction:'monitor',priority:'primary',source:'CDM',renderer:null,color:C.vermillion,p_value:0.02,measurement_freq:'per_visit'},
      {k:'cond_n',name:'진단코드',unit:'건',domain:'condition_occurrence',concept_hint:'condition_count',value_type:'numeric',direction:'monitor',priority:'secondary',source:'CDM',renderer:null,color:C.amber,p_value:0.12,measurement_freq:'per_visit'},
      {k:'lab_val',name:'검사결과',unit:'',domain:'measurement',concept_hint:'lab_result',value_type:'numeric',direction:'monitor',priority:'secondary',source:'CDM',renderer:null,color:C.green,p_value:0.08,measurement_freq:'per_visit'},
      {k:'proc_yn',name:'시술여부',unit:'',domain:'procedure_occurrence',concept_hint:'procedure_flag',value_type:'binary',direction:'monitor',priority:'exploratory',source:'CDM',renderer:'binary_strip',color:'#8b5cf6',p_value:0.22,measurement_freq:'per_visit'},
    ],
    patient_seeds_override: {
      exp: [
        {id:'CDM01',nm:'코호트A-1',sv:'good',st:'verified',seeds:{visit_n:{s:3,sl:0.5,n:0.3},drug_days:{s:28,sl:2,n:3},cond_n:{s:2,sl:0.3,n:0.2},lab_val:{s:5.8,sl:0.1,n:0.2},proc_yn:{s:0,sl:0.2,n:0.1}}},
        {id:'CDM02',nm:'코호트A-2',sv:'good',st:'verified',seeds:{visit_n:{s:4,sl:0.3,n:0.4},drug_days:{s:30,sl:1.5,n:2.5},cond_n:{s:3,sl:0.2,n:0.3},lab_val:{s:6.2,sl:0.15,n:0.25},proc_yn:{s:0,sl:0.15,n:0.1}}},
        {id:'CDM03',nm:'코호트A-3',sv:'warn',st:'query',al:true,seeds:{visit_n:{s:6,sl:0.8,n:0.5},drug_days:{s:25,sl:3,n:4},cond_n:{s:5,sl:0.5,n:0.4},lab_val:{s:7.1,sl:0.3,n:0.3},proc_yn:{s:1,sl:0.1,n:0.15}}},
        {id:'CDM04',nm:'코호트A-4',sv:'good',st:'verified',seeds:{visit_n:{s:2,sl:0.4,n:0.2},drug_days:{s:32,sl:1,n:2},cond_n:{s:1,sl:0.15,n:0.1},lab_val:{s:5.5,sl:0.05,n:0.15},proc_yn:{s:0,sl:0.1,n:0.08}}},
        {id:'CDM05',nm:'코호트A-5',sv:'good',st:'verified',seeds:{visit_n:{s:3,sl:0.6,n:0.35},drug_days:{s:29,sl:1.8,n:2.8},cond_n:{s:2,sl:0.25,n:0.25},lab_val:{s:6.0,sl:0.12,n:0.22},proc_yn:{s:0,sl:0.18,n:0.1}}},
      ],
      ctrl: [
        {id:'CDM06',nm:'코호트B-1',sv:'good',st:'verified',seeds:{visit_n:{s:2,sl:0.2,n:0.2},drug_days:{s:15,sl:0.5,n:2},cond_n:{s:1,sl:0.1,n:0.15},lab_val:{s:5.2,sl:0.02,n:0.1},proc_yn:{s:0,sl:0.05,n:0.05}}},
        {id:'CDM07',nm:'코호트B-2',sv:'good',st:'verified',seeds:{visit_n:{s:3,sl:0.15,n:0.25},drug_days:{s:18,sl:0.3,n:1.5},cond_n:{s:2,sl:0.08,n:0.12},lab_val:{s:5.4,sl:0.03,n:0.12},proc_yn:{s:0,sl:0.03,n:0.04}}},
        {id:'CDM08',nm:'코호트B-3',sv:'good',st:'verified',seeds:{visit_n:{s:2,sl:0.18,n:0.2},drug_days:{s:12,sl:0.4,n:1.8},cond_n:{s:1,sl:0.12,n:0.1},lab_val:{s:5.3,sl:0.04,n:0.11},proc_yn:{s:0,sl:0.04,n:0.05}}},
        {id:'CDM09',nm:'코호트B-4',sv:'good',st:'verified',seeds:{visit_n:{s:1,sl:0.1,n:0.15},drug_days:{s:10,sl:0.2,n:1},cond_n:{s:1,sl:0.05,n:0.08},lab_val:{s:5.1,sl:0.01,n:0.08},proc_yn:{s:0,sl:0.02,n:0.03}}},
        {id:'CDM10',nm:'코호트B-5',sv:'warn',st:'review',seeds:{visit_n:{s:5,sl:0.4,n:0.4},drug_days:{s:20,sl:0.8,n:2.5},cond_n:{s:3,sl:0.2,n:0.2},lab_val:{s:5.8,sl:0.08,n:0.18},proc_yn:{s:0,sl:0.08,n:0.06}}},
      ],
    },
  },

  // v11: 하이브리드 — 후향적 차트리뷰 + 전향적 추적
  hybrid: {
    title: '약물안전성 하이브리드',
    time_unit: 'visit',
    reference_point: {type:'custom', label:'등록일 (전환 시점)'},
    timing_behavior: 'participant-relative',
    analysis_rule: 'nearest-in-window',
    subtitle: '약물안전성 하이브리드 (후향+전향)',
    study_type_label: 'Hybrid (후향적 차트리뷰 → 전향적 추적)',
    regulatory: {type:'irb', number:'IRB-2025-1102', status:'approved'},
    research_type: 'hybrid',
    base_date: '2026-01-19',  // 하이브리드: BL=2026-01-19, D28≈오늘(2026-02-16)
    today_day: 28,             // "오늘" 고정 = V1 (4주) 시점
    points: [
      // 후향적 구간: 차트리뷰 (이미 수집된 데이터)
      {id:'R-6M',label:'6개월 전',target_day:-180,window:[-15,15],epoch:'retrospective',planned:true},
      {id:'R-3M',label:'3개월 전',target_day:-90,window:[-15,15],epoch:'retrospective',planned:true},
      {id:'BL',label:'등록 (BL)',target_day:0,window:[-3,3],epoch:'baseline',planned:true},
      // 전향적 구간: 새로 수집 중
      {id:'V1',label:'V1 (4주)',target_day:28,window:[-5,5],epoch:'treatment',planned:true},
      {id:'V2',label:'V2 (8주)',target_day:56,window:[-5,5],epoch:'treatment',planned:true},
      {id:'V3',label:'V3 (12주)',target_day:84,window:[-7,7],epoch:'treatment',planned:true},
      {id:'V4',label:'V4 (24주)',target_day:168,window:[-7,7],epoch:'followup',planned:true},
    ],
    phases: [
      {name:'차트리뷰 (후향)',key:'observation',start:-180,end:-1,color:'#94a3b8'},
      {name:'베이스라인',key:'baseline',start:0,end:0,color:'#0072B2'},
      {name:'치료 (전향)',key:'treatment',start:1,end:84,color:'#0ea5e9'},
      {name:'추적 (전향)',key:'followup',start:85,end:168,color:'#009E73'},
    ],
    metrics_override: [
      {k:'ae_count',name:'이상반응',unit:'건',domain:'condition_occurrence',concept_hint:'adverse_event',value_type:'numeric',direction:'monitor',priority:'primary',source:'EMR+CDM',renderer:null,color:'#ef4444',p_value:0.02,measurement_freq:'per_visit'},
      {k:'drug_dose',name:'투여량',unit:'mg',domain:'drug_exposure',concept_hint:'drug_dose',value_type:'numeric',direction:'monitor',priority:'primary',source:'EMR',renderer:null,color:'#0072B2',p_value:null,measurement_freq:'per_visit'},
      {k:'lab_alt',name:'ALT',unit:'U/L',domain:'measurement',concept_hint:'alt_level',value_type:'numeric',direction:'down',priority:'safety',source:'EMR',renderer:null,color:'#D55E00',p_value:0.04,measurement_freq:'per_visit'},
      {k:'lab_ast',name:'AST',unit:'U/L',domain:'measurement',concept_hint:'ast_level',value_type:'numeric',direction:'down',priority:'safety',source:'EMR',renderer:null,color:'#CC79A7',p_value:0.06,measurement_freq:'per_visit'},
      {k:'egfr',name:'eGFR',unit:'mL/min',domain:'measurement',concept_hint:'egfr',value_type:'numeric',direction:'up',priority:'secondary',source:'EMR',renderer:null,color:'#009E73',p_value:0.11,measurement_freq:'per_visit'},
      {k:'compliance',name:'순응도',unit:'%',domain:'observation',concept_hint:'compliance_rate',value_type:'numeric',direction:'up',priority:'operational',source:'EMA',renderer:null,color:'#E69F00',p_value:0.25,measurement_freq:'per_visit'},
    ],
    patient_seeds_override: {
      exp: [
        {id:'H001',nm:'피험자A',sv:'good',st:'verified',seeds:{ae_count:{s:0,sl:0.3,n:0.2},drug_dose:{s:100,sl:0,n:5},lab_alt:{s:25,sl:2,n:3},lab_ast:{s:22,sl:1.5,n:2.5},egfr:{s:85,sl:-0.5,n:1},compliance:{s:95,sl:-1,n:2}}},
        {id:'H002',nm:'피험자B',sv:'good',st:'verified',seeds:{ae_count:{s:1,sl:0.2,n:0.3},drug_dose:{s:100,sl:0,n:5},lab_alt:{s:30,sl:3,n:4},lab_ast:{s:28,sl:2,n:3},egfr:{s:78,sl:-0.8,n:1.2},compliance:{s:90,sl:-1.5,n:3}}},
        {id:'H003',nm:'피험자C',sv:'warn',st:'query',al:true,seeds:{ae_count:{s:2,sl:0.5,n:0.4},drug_dose:{s:100,sl:0,n:5},lab_alt:{s:45,sl:5,n:6},lab_ast:{s:40,sl:4,n:5},egfr:{s:65,sl:-1.2,n:1.5},compliance:{s:82,sl:-2,n:4}}},
        {id:'H004',nm:'피험자D',sv:'good',st:'verified',seeds:{ae_count:{s:0,sl:0.15,n:0.15},drug_dose:{s:100,sl:0,n:5},lab_alt:{s:20,sl:1,n:2},lab_ast:{s:18,sl:0.8,n:1.8},egfr:{s:92,sl:-0.3,n:0.8},compliance:{s:97,sl:-0.5,n:1.5}}},
        {id:'H005',nm:'피험자E',sv:'good',st:'verified',seeds:{ae_count:{s:1,sl:0.25,n:0.3},drug_dose:{s:100,sl:0,n:5},lab_alt:{s:28,sl:2.5,n:3.5},lab_ast:{s:25,sl:2,n:2.8},egfr:{s:80,sl:-0.6,n:1},compliance:{s:88,sl:-1.2,n:2.5}}},
      ],
      ctrl: [
        {id:'H006',nm:'대조A',sv:'good',st:'verified',seeds:{ae_count:{s:0,sl:0.1,n:0.1},drug_dose:{s:0,sl:0,n:0},lab_alt:{s:22,sl:0.5,n:2},lab_ast:{s:20,sl:0.3,n:1.5},egfr:{s:88,sl:-0.2,n:0.7},compliance:{s:96,sl:-0.8,n:1.5}}},
        {id:'H007',nm:'대조B',sv:'good',st:'verified',seeds:{ae_count:{s:0,sl:0.08,n:0.12},drug_dose:{s:0,sl:0,n:0},lab_alt:{s:24,sl:0.3,n:1.5},lab_ast:{s:21,sl:0.2,n:1.2},egfr:{s:90,sl:-0.15,n:0.5},compliance:{s:94,sl:-0.6,n:1.8}}},
        {id:'H008',nm:'대조C',sv:'good',st:'verified',seeds:{ae_count:{s:0,sl:0.05,n:0.08},drug_dose:{s:0,sl:0,n:0},lab_alt:{s:19,sl:0.2,n:1},lab_ast:{s:17,sl:0.15,n:0.8},egfr:{s:95,sl:-0.1,n:0.4},compliance:{s:98,sl:-0.3,n:1}}},
        {id:'H009',nm:'대조D',sv:'good',st:'verified',seeds:{ae_count:{s:1,sl:0.12,n:0.15},drug_dose:{s:0,sl:0,n:0},lab_alt:{s:26,sl:0.8,n:2.5},lab_ast:{s:23,sl:0.5,n:2},egfr:{s:82,sl:-0.4,n:0.9},compliance:{s:91,sl:-1,n:2}}},
        {id:'H010',nm:'대조E',sv:'warn',st:'review',seeds:{ae_count:{s:0,sl:0.1,n:0.1},drug_dose:{s:0,sl:0,n:0},lab_alt:{s:21,sl:0.4,n:1.8},lab_ast:{s:19,sl:0.25,n:1.3},egfr:{s:87,sl:-0.25,n:0.6},compliance:{s:93,sl:-0.7,n:1.6}}},
      ],
    },
  },
};

// switchStudyScenario — "다른 연구를 여는" 행위 (모드 전환 아님)
function switchStudyScenario(scenarioKey){
  const preset = TIME_PRESETS[scenarioKey];
  if(!preset) return;

  // 사이드바 시나리오 활성 표시
  document.querySelectorAll('.sc-item').forEach(b=>b.classList.toggle('active',b.dataset.scenario===scenarioKey));

  // STUDY_CONFIG 업데이트 — 연구 설계가 시간축을 결정
  STUDY_CONFIG.timeline.time_unit = preset.time_unit;
  STUDY_CONFIG.timeline.reference_point = preset.reference_point;
  STUDY_CONFIG.timeline.timing_behavior = preset.timing_behavior;
  STUDY_CONFIG.timeline.analysis_rule = preset.analysis_rule;
  STUDY_CONFIG.timeline.points = preset.points;
  // phases 리셋 — retro에서 auto-generate 후 다른 시나리오로 돌아올 때 필요
  STUDY_CONFIG.timeline.phases = preset.phases || null;
  STUDY_CONFIG.subtitle = preset.subtitle;
  if(preset.title) STUDY_CONFIG.title = preset.title;
  if(preset.study_type_label) STUDY_CONFIG.design.study_type = preset.study_type_label;
  // regulatory 업데이트 (preset에 있으면 교체, 없으면 기본 IRB)
  if(preset.regulatory) STUDY_CONFIG.regulatory = {...preset.regulatory};
  else STUDY_CONFIG.regulatory = {type:'irb', number:'IRB-2025-0847', status:'approved'};

  // v11: research_type 전환
  if(preset.research_type) STUDY_CONFIG.research_type = preset.research_type;
  else STUDY_CONFIG.research_type = 'prospective';

  // base_date 교체 (연구별 시간 기준)
  if(preset.base_date) STUDY_CONFIG.timeline.base_date = preset.base_date;
  else STUDY_CONFIG.timeline.base_date = '2026-01-05'; // 기본 전향적

  // today_day: "오늘" 고정 마커 (scrub과 별개)
  STUDY_CONFIG.timeline.today_day = preset.today_day !== undefined ? preset.today_day : 42;

  // research_type별 current_day (스크럽 시작 위치)
  if(STUDY_CONFIG.research_type === 'retrospective'){
    // 후향적: 모든 데이터 이미 존재 → 마지막 시점에서 시작
    const lastPoint = preset.points[preset.points.length - 1];
    STUDY_CONFIG.timeline.current_day = lastPoint.target_day;
  } else if(STUDY_CONFIG.research_type === 'hybrid'){
    // 하이브리드: "오늘" 위치에서 시작
    STUDY_CONFIG.timeline.current_day = preset.today_day || 28;
  } else {
    // 전향적: "오늘" 위치에서 시작
    STUDY_CONFIG.timeline.current_day = preset.today_day || 42;
  }

  // v11: metrics 교체 (metrics_override가 있으면 교체)
  if(preset.metrics_override){
    STUDY_CONFIG.metrics = preset.metrics_override;
  } else {
    // 기본 RCT metrics로 복원
    STUDY_CONFIG.metrics = [
      {k:'wt',name:'체중',unit:'kg',domain:'measurement',concept_hint:'body_weight',value_type:'numeric',direction:'down',priority:'primary',source:'EMR',renderer:null,color:C.blue,p_value:0.0001,measurement_freq:'per_visit'},
      {k:'sbp',name:'SBP',unit:'mmHg',domain:'measurement',concept_hint:'systolic_bp',value_type:'numeric',direction:'down',priority:'secondary',source:'EMR',renderer:null,color:'#6366f1',p_value:0.012,measurement_freq:'per_visit'},
      {k:'hr',name:'심박수',unit:'bpm',domain:'measurement',concept_hint:'heart_rate',value_type:'numeric',direction:'down',priority:'secondary',source:'웨어',renderer:null,color:C.green,p_value:0.034,measurement_freq:'continuous',agg_rule:'visit_mean'},
      {k:'steps',name:'걸음수',unit:'보',domain:'device_exposure',concept_hint:'step_count',value_type:'numeric',direction:'up',priority:'exploratory',source:'웨어',renderer:null,color:'#14b8a6',p_value:0.008,measurement_freq:'daily',agg_rule:'visit_sum'},
      {k:'comp',name:'순응도',unit:'%',domain:'observation',concept_hint:'compliance_rate',value_type:'numeric',direction:'monitor',priority:'operational',source:'EMA',renderer:null,color:C.pink,p_value:0.342,measurement_freq:'daily',agg_rule:'visit_mean'},
      {k:'sleep',name:'수면',unit:'h',domain:'device_exposure',concept_hint:'sleep_duration',value_type:'numeric',direction:'up',priority:'exploratory',source:'웨어',renderer:null,color:C.amber,p_value:0.028,measurement_freq:'daily',agg_rule:'visit_mean'},
      {k:'skin',name:'피부 상태',unit:'점',domain:'observation',concept_hint:'skin_condition',value_type:'categorical',direction:'down',priority:'exploratory',source:'사진+AI',renderer:'image_gallery',color:'#a855f7',p_value:0.003,measurement_freq:'per_visit'},
      {k:'tir',name:'TIR',unit:'%',domain:'device_exposure',concept_hint:'time_in_range',value_type:'proportion',direction:'up',priority:'secondary',source:'CGM→파생',renderer:'severity_zone',color:'#10b981',p_value:0.019,measurement_freq:'continuous',agg_rule:'visit_pct',derived:{from:'cgm',fn:'time_in_range',params:{min:70,max:180}}},
    ];
  }

  // v11: patient seeds 교체 (없으면 기본 복원)
  if(preset.patient_seeds_override){
    PATIENT_PROFILES.exp = preset.patient_seeds_override.exp;
    PATIENT_PROFILES.ctrl = preset.patient_seeds_override.ctrl || [];
  } else {
    // 기본 RCT 환자로 복원
    PATIENT_PROFILES.exp = _DEFAULT_PATIENT_PROFILES.exp.map(p=>({...p}));
    PATIENT_PROFILES.ctrl = _DEFAULT_PATIENT_PROFILES.ctrl.map(p=>({...p}));
  }
  // design 업데이트
  STUDY_CONFIG.design.has_control_arm = PATIENT_PROFILES.ctrl.length > 0;
  STUDY_CONFIG.design.arm_labels = PATIENT_PROFILES.ctrl.length > 0 ? ['실험군','대조군'] : ['단일군'];

  // 런타임 상수 재계산
  VISITS.length = 0;
  preset.points.forEach(p=>VISITS.push(p));
  PAST_VISITS.length = 0;
  VISITS.filter(v=>v.target_day<=STUDY_CONFIG.timeline.current_day).forEach(p=>PAST_VISITS.push(p));
  FUTURE_VISITS.length = 0;
  VISITS.filter(v=>v.target_day>STUDY_CONFIG.timeline.current_day).forEach(p=>FUTURE_VISITS.push(p));
  VISIT_LABELS.length = 0;
  VISITS.forEach(v=>VISIT_LABELS.push(v.id));
  PAST_LABELS.length = 0;
  PAST_VISITS.forEach(v=>PAST_LABELS.push(v.id));
  TIME_UNIT = preset.time_unit;

  // 데이터 재생성
  const nPast = PAST_VISITS.length;
  EXP_DATA = generatePatientData(PATIENT_PROFILES.exp, nPast);
  CTRL_DATA = generatePatientData(PATIENT_PROFILES.ctrl, nPast);
  ALL = generateALL(nPast);

  // safety
  STUDY_CONFIG.safety.ae_by_visit = VISITS.map((_,i)=>i<nPast?Math.floor(Math.random()*5+1):0);

  // 자동 배지 + 전체 UI 리빌드
  updateTimelineBadge();
  initPageHeader();
  buildVerdictBadges();
  buildSafetyStrip();
  buildTimeline();
  buildMetricsGrid();
  buildActionCenter();
  updateSidePanelBadge();
  rebuildTable();
  buildMiniTimeline();
  buildAIStrip();
  updateDensityStrip(STUDY_CONFIG.timeline.current_day);
  // 집계 단위 + 시간 그리드 갱신
  if(typeof updateAggOptions === 'function') updateAggOptions();
  if(typeof buildTimeGrid === 'function') buildTimeGrid();

  // 클린룸 데이터 재생성
  const freshCR = crGenAllTables();
  Object.keys(freshCR).forEach(k=>{ CR_DATA_CACHE[k] = freshCR[k]; });
  buildSchemaPanel();
  crRenderTable(crCurrentTable);
  _splitMode = false;
  _armFilter = 'all';
  document.getElementById('splitToggle').classList.remove('active');
  document.getElementById('singleTableView').style.display = '';
  document.getElementById('splitTableView').style.display = 'none';
  buildArmTabs();

  // Detail panel 닫기
  const dp=document.getElementById('detailPanel');
  if(dp) dp.classList.remove('open');
  const ta=document.getElementById('tableArea');
  if(ta) ta.classList.remove('shrunk');
}

// 사이드바 시나리오 클릭 — "다른 연구 열기"
document.querySelectorAll('.sc-item').forEach(btn=>{
  btn.addEventListener('click',()=>switchStudyScenario(btn.dataset.scenario));
});

// ===============================================
// INIT — 시간축은 STUDY_CONFIG에서 자동 결정
// ===============================================
updateTimelineBadge();

// ===============================================
// SIDE PANEL — 토글 + 탭 전환
// ===============================================
function initSidePanel(){
  const panel = document.getElementById('sidePanel');
  const toggle = document.getElementById('spToggle');
  if(!panel||!toggle) return;
  toggle.addEventListener('click', ()=>{ panel.classList.toggle('open'); });
  panel.querySelectorAll('.sp-tab-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      panel.querySelectorAll('.sp-tab-btn').forEach(b=>b.classList.remove('active'));
      panel.querySelectorAll('.sp-pane').forEach(p=>p.classList.remove('active'));
      btn.classList.add('active');
      const t = btn.dataset.sp;
      document.getElementById(t==='action'?'spAction':'spAI').classList.add('active');
    });
  });
  // 기본: 닫힘 — 토글 버튼으로만 열기
}
function updateSidePanelBadge(){
  const badge = document.getElementById('spBadge');
  if(!badge) return;
  const n = ALL.filter(p=>p.al).length + ALL.filter(p=>p.st==='query').length;
  if(n>0){badge.textContent=n;badge.style.display='flex';}else{badge.style.display='none';}
}

initSidePanel();
initPageHeader();
buildVerdictBadges();
buildSafetyStrip();
buildTimeline();
buildMetricsGrid();
buildActionCenter();
updateSidePanelBadge();
buildAIStrip();
updateDensityStrip(STUDY_CONFIG.timeline.current_day);
buildSchemaPanel();
crRenderTable('data_points');
window.addEventListener('resize',()=>{if(document.getElementById('tc-ov').classList.contains('active'))buildMetricsGrid();});
</script>
</body>
</html>
