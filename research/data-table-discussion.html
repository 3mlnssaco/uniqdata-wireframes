<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>data-table — 원본 데이터 + 시간축 통합 테이블</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,'Pretendard',sans-serif;background:#0a0e1a;color:#e2e8f0;line-height:1.5;overflow:hidden;height:100vh}

/* ===== TOPBAR ===== */
.topbar{display:flex;align-items:center;padding:12px 24px;border-bottom:1px solid #1e293b;background:#0f1525;gap:14px;flex-shrink:0}
.topbar-title{font-size:15px;font-weight:700;color:#f1f5f9}
.topbar-sub{font-size:12px;color:#475569}
.topbar-right{margin-left:auto;display:flex;align-items:center;gap:14px;font-size:12px;color:#64748b}
.topbar-right strong{color:#e2e8f0}

/* ===== LEGEND ===== */
.legend-strip{display:flex;gap:14px;padding:6px 24px;border-bottom:1px solid #151d30;font-size:10px;color:#94a3b8;flex-shrink:0;align-items:center}
.legend-strip .leg{display:flex;align-items:center;gap:4px}
.legend-strip .dot{width:7px;height:7px;border-radius:50%}
.legend-strip .rule{color:#475569;font-size:9px}

/* ===== MAIN SPLIT LAYOUT ===== */
.main-split{display:flex;flex:1;overflow:hidden;height:calc(100vh - 82px)}

/* LEFT: TABLE */
.table-area{flex:1;min-width:0;overflow:hidden;display:flex;flex-direction:column;transition:flex .35s cubic-bezier(.4,0,.2,1)}
.table-area.shrunk{flex:0 0 42%}
.table-wrap{overflow:auto;flex:1}

table{border-collapse:collapse;min-width:1100px}
thead{position:sticky;top:0;z-index:10}

/* Group header row */
th.grp{padding:4px 0;font-size:8px;font-weight:800;text-transform:uppercase;letter-spacing:.5px;text-align:center;border-bottom:2px solid}
/* Metric header row */
th.met{padding:5px 6px;font-size:9px;font-weight:600;color:#64748b;text-align:center;background:#111827;border-bottom:1px solid #1e293b;white-space:nowrap}
th.met-patient{text-align:left;min-width:130px;position:sticky;left:0;z-index:11;background:#111827}

/* Data cells */
td{padding:0;text-align:center;border-bottom:1px solid #151d30;vertical-align:middle}
td.patient-cell{position:sticky;left:0;z-index:5;background:#0a0e1a;padding:6px 8px;text-align:left;min-width:130px;border-right:1px solid #1e293b}
tr:hover td.patient-cell{background:#131b2e}
tr:hover td{background:#131b2e}
tr.selected td{background:#1e293b !important}
tr.selected td.patient-cell{background:#1e293b !important}
tr.cohort-row td{background:#0f1525;border-bottom:2px solid #1e293b}
tr.cohort-row td.patient-cell{background:#0f1525}

/* ===== METRIC CELL: value + sparkline + delta ===== */
.mc{display:flex;flex-direction:column;align-items:center;padding:5px 4px;min-width:72px;cursor:default;position:relative}
.mc-val{font-family:'SF Mono',Monaco,monospace;font-size:11px;font-weight:700;line-height:1.2}
.mc-spark{margin:2px 0 1px;opacity:.7}
.mc-delta{font-size:8px;line-height:1}
.mc-sub{font-size:7px;color:#475569;margin-top:1px}

/* Heatmap backgrounds */
.mc.hm-g{background:rgba(74,222,128,.08)}.mc.hm-g .mc-val{color:#4ade80}
.mc.hm-y{background:rgba(251,191,36,.06)}.mc.hm-y .mc-val{color:#fbbf24}
.mc.hm-r{background:rgba(248,113,113,.08)}.mc.hm-r .mc-val{color:#f87171}
.mc.hm-n .mc-val{color:#94a3b8}

/* Patient info in sticky col */
.pi-id{font-family:'SF Mono',Monaco,monospace;font-size:10px;font-weight:700;color:#94a3b8}
.pi-id.alert{color:#fbbf24}
.pi-nm{font-size:11px;font-weight:600;color:#e2e8f0}
.pi-sub{font-size:8px;color:#475569;margin-top:1px}
.pi-badge{display:inline-block;padding:1px 5px;border-radius:3px;font-size:8px;font-weight:700;margin-top:2px}
.pi-badge.b-good{background:rgba(74,222,128,.12);color:#4ade80}
.pi-badge.b-warn{background:rgba(251,191,36,.12);color:#fbbf24}
.pi-badge.b-bad{background:rgba(248,113,113,.12);color:#f87171}

/* ===== RIGHT: DETAIL PANEL ===== */
.detail-panel{width:0;overflow:hidden;border-left:1px solid #1e293b;transition:width .35s cubic-bezier(.4,0,.2,1);flex-shrink:0;display:flex;flex-direction:column;background:#0c1120}
.detail-panel.open{width:58%}

.dp-header{display:flex;align-items:center;padding:12px 16px;border-bottom:1px solid #1e293b;gap:10px;flex-shrink:0}
.dp-close{background:none;border:none;color:#64748b;font-size:18px;cursor:pointer;padding:2px 6px;border-radius:4px}
.dp-close:hover{background:#1e293b;color:#e2e8f0}
.dp-title{font-size:14px;font-weight:700;color:#f1f5f9}
.dp-sub{font-size:11px;color:#475569}
.dp-nav{margin-left:auto;display:flex;gap:4px}
.dp-nav button{background:#1e293b;border:1px solid #334155;color:#94a3b8;padding:3px 8px;border-radius:4px;cursor:pointer;font-size:11px}
.dp-nav button:hover{background:#334155;color:#e2e8f0}

.dp-body{flex:1;overflow-y:auto;padding:16px}

/* Detail: Time-series table (flowsheet) */
.fs-table{width:100%;border-collapse:collapse;margin-bottom:16px}
.fs-table th{font-size:9px;font-weight:600;color:#475569;padding:4px 8px;text-align:center;border-bottom:1px solid #1e293b;position:sticky;top:0;background:#0c1120}
.fs-table th:first-child{text-align:left}
.fs-table td{font-family:'SF Mono',Monaco,monospace;font-size:10px;padding:5px 8px;text-align:center;border-bottom:1px solid #151d30}
.fs-table td:first-child{text-align:left;font-family:-apple-system,'Pretendard',sans-serif;font-size:10px;font-weight:600;color:#94a3b8}
.fs-table .fs-grp{font-size:8px;font-weight:800;color:#60a5fa;text-transform:uppercase;letter-spacing:.5px;padding:6px 8px;background:#111827;border-bottom:1px solid #1e293b}

/* Heatmap cell in flowsheet */
.fs-c{border-radius:3px;transition:background .1s}
.fs-g{background:rgba(74,222,128,.1);color:#4ade80}
.fs-y{background:rgba(251,191,36,.08);color:#fbbf24}
.fs-r{background:rgba(248,113,113,.1);color:#f87171}

/* Detail: Charts */
.detail-charts{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
.dc-card{background:#111827;border:1px solid #1e293b;border-radius:8px;padding:10px 12px}
.dc-title{font-size:10px;font-weight:600;color:#94a3b8;margin-bottom:6px}

/* Detail section headers */
.ds-hdr{font-size:11px;font-weight:700;color:#64748b;padding:8px 0 4px;border-bottom:1px solid #1e293b;margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px}
</style>
</head>
<body>

<div class="topbar">
  <span class="topbar-title">비만 중재 효과 연구</span>
  <span class="topbar-sub">· 6주차 (2/9~15)</span>
  <div class="topbar-right">
    <span>참여자 <strong id="pCount">10</strong>명</span>
    <span>수집률 <strong style="color:#4ade80">94%</strong></span>
  </div>
</div>

<div class="legend-strip">
  <div class="leg"><div class="dot" style="background:#4ade80"></div>정상</div>
  <div class="leg"><div class="dot" style="background:#fbbf24"></div>주의</div>
  <div class="leg"><div class="dot" style="background:#f87171"></div>위험</div>
  <span class="rule">셀: 현재값 + 6주 추이 + 기준선 대비 변화</span>
  <span class="rule" style="margin-left:auto">클릭: 개인 시계열 상세</span>
</div>

<div class="main-split">
  <!-- LEFT: TABLE -->
  <div class="table-area" id="tableArea">
    <div class="table-wrap">
      <table id="mainTable"></table>
    </div>
  </div>

  <!-- RIGHT: DETAIL PANEL -->
  <div class="detail-panel" id="detailPanel">
    <div class="dp-header">
      <button class="dp-close" onclick="closePanel()">✕</button>
      <span class="dp-title" id="dpTitle"></span>
      <span class="dp-sub" id="dpSub"></span>
      <div class="dp-nav">
        <button onclick="navPatient(-1)">▲ 이전</button>
        <button onclick="navPatient(1)">▼ 다음</button>
      </div>
    </div>
    <div class="dp-body" id="dpBody"></div>
  </div>
</div>

<script>
// ===== DATA =====
const WK=['W1','W2','W3','W4','W5','W6'];
const DAYS=['월','화','수','목','금','토','일'];

const P=[
  {id:'P001',nm:'김OO',grp:'exp',
   tr:{wt:[88,86.4,85.1,84,82.5,81.2],sbp:[148,146,143,141,138,136],dbp:[90,88,86,84,83,82],
       hr:[80,78,76,74,73,72],steps:[5200,6100,6800,7500,8000,8234],sleep:[6,6.3,6.5,6.8,7,7.2],
       ema:[72,78,82,88,92,95]},
   daily:{wt:[[88.2,88.1,88,87.9,87.8,87.7,87.5],[86.8,86.6,86.5,86.4,86.3,86.2,86],[85.5,85.4,85.2,85.1,85,84.9,84.7],[84.4,84.3,84.1,84,83.9,83.8,83.6],[83,82.8,82.7,82.6,82.5,82.4,82.2],[81.8,81.6,81.5,81.4,81.3,81.2,81]],
     hr:[[82,81,80,80,79,79,78],[79,78,78,77,77,76,76],[77,76,76,75,75,75,74],[75,74,74,73,73,73,72],[73,73,72,72,72,71,71],[72,72,72,71,71,71,70]],
     steps:[[4800,5100,5400,5200,5600,5800,4500],[5800,6200,6000,6300,6400,6100,5900],[6500,6800,7000,6700,7100,6900,6600],[7200,7500,7600,7400,7800,7600,7300],[7800,8100,8000,8200,8300,7900,7700],[8000,8300,8200,8400,8500,8100,8000]],
     sleep:[[5.8,6,6.2,5.9,6.1,6.3,5.7],[6.1,6.3,6.4,6.2,6.5,6.4,6],[6.3,6.5,6.6,6.4,6.7,6.6,6.2],[6.6,6.8,6.9,6.7,7,6.9,6.5],[6.8,7,7.1,6.9,7.2,7.1,6.7],[7,7.2,7.3,7.1,7.4,7.3,6.9]]}},
  {id:'P005',nm:'이OO',grp:'exp',
   tr:{wt:[89,87.8,86.9,86.2,85.4,84.7],sbp:[148,147,146,144,143,142],dbp:[91,90,89,88,87,86],
       hr:[82,80,79,78,77,76],steps:[4800,5200,5500,5800,6000,6102],sleep:[6,6.2,6.3,6.4,6.6,6.8],
       ema:[65,70,74,78,82,86]},
   daily:{wt:[[89.2,89.1,89,88.9,88.8,88.7,88.5],[88,87.9,87.8,87.7,87.6,87.5,87.3],[87.2,87.1,86.9,86.8,86.7,86.6,86.5],[86.5,86.4,86.2,86.1,86,85.9,85.8],[85.8,85.6,85.5,85.4,85.3,85.2,85],[85,84.9,84.8,84.7,84.6,84.5,84.3]],
     hr:[[83,82,82,81,81,80,80],[81,80,80,79,79,79,78],[80,79,79,78,78,78,77],[79,78,78,78,77,77,76],[78,77,77,76,76,76,75],[76,76,76,75,75,75,74]],
     steps:[[4500,4800,5000,4700,5100,4900,4600],[5000,5200,5300,5100,5400,5300,5000],[5300,5500,5600,5400,5700,5600,5300],[5600,5800,5900,5700,6000,5900,5600],[5800,6000,6100,5900,6200,6100,5800],[5900,6100,6200,6000,6300,6200,5900]],
     sleep:[[5.8,6,6.1,5.9,6.2,6.1,5.7],[6,6.2,6.3,6.1,6.4,6.3,5.9],[6.1,6.3,6.4,6.2,6.5,6.4,6],[6.2,6.4,6.5,6.3,6.6,6.5,6.1],[6.4,6.6,6.7,6.5,6.8,6.7,6.3],[6.6,6.8,6.9,6.7,7,6.9,6.5]]}},
  {id:'P011',nm:'박OO',grp:'exp',
   tr:{wt:[87,85.2,83.8,82.5,81,79.9],sbp:[148,146,143,141,139,138],dbp:[89,87,85,83,81,80],
       hr:[78,76,73,71,70,68],steps:[6000,7200,8100,8800,9200,9450],sleep:[6.2,6.5,6.8,7.2,7.5,7.8],
       ema:[80,85,90,95,98,100]},
   daily:{wt:[[87.3,87.1,87,86.8,86.7,86.5,86.3],[85.6,85.4,85.3,85.1,85,84.9,84.7],[84.2,84,83.9,83.7,83.6,83.4,83.2],[82.9,82.7,82.6,82.4,82.3,82.1,82],[81.4,81.2,81.1,80.9,80.8,80.6,80.4],[80.3,80.1,80,79.9,79.8,79.6,79.5]],
     hr:[[79,78,78,77,77,76,76],[77,76,75,75,74,74,73],[74,73,73,72,72,71,71],[72,71,71,70,70,69,69],[71,70,70,69,69,68,68],[69,68,68,67,67,67,66]],
     steps:[[5600,6000,6200,5900,6400,6200,5800],[6800,7200,7400,7100,7600,7400,7000],[7800,8100,8300,8000,8400,8200,7800],[8500,8800,9000,8700,9100,8900,8500],[9000,9200,9400,9100,9500,9300,8900],[9200,9500,9600,9400,9700,9500,9200]],
     sleep:[[6,6.2,6.3,6.1,6.4,6.3,5.9],[6.3,6.5,6.6,6.4,6.7,6.6,6.2],[6.6,6.8,6.9,6.7,7,6.9,6.5],[7,7.2,7.3,7.1,7.4,7.3,6.9],[7.3,7.5,7.6,7.4,7.7,7.6,7.2],[7.6,7.8,7.9,7.7,8,7.9,7.5]]}},
  {id:'P018',nm:'최OO',grp:'exp',alert:true,
   tr:{wt:[93,92.5,92,91.5,91.2,90.9],sbp:[148,149,150,150,151,152],dbp:[93,93,94,95,95,96],
       hr:[80,82,84,85,86,88],steps:[5500,5000,4500,4000,3600,3200],sleep:[6.5,6.2,5.8,5.5,5.3,5.1],
       ema:[70,65,58,52,48,43]},
   daily:{wt:[[93.2,93.1,93,92.9,92.8,92.7,92.6],[92.7,92.6,92.5,92.5,92.4,92.3,92.2],[92.3,92.2,92.1,92,91.9,91.8,91.7],[91.8,91.7,91.6,91.5,91.4,91.3,91.2],[91.4,91.3,91.3,91.2,91.1,91.1,91],[91.2,91.1,91,91,90.9,90.9,90.8]],
     hr:[[79,80,80,81,81,82,82],[81,82,82,83,83,83,84],[83,83,84,84,84,85,85],[84,85,85,85,86,86,86],[85,86,86,86,87,87,87],[87,87,88,88,88,89,89]],
     steps:[[5800,5600,5500,5400,5300,5200,5000],[5200,5000,4900,4800,4700,4600,4500],[4700,4500,4400,4300,4200,4100,4000],[4200,4000,3900,3800,3700,3600,3500],[3800,3600,3500,3400,3300,3200,3100],[3400,3200,3100,3000,2900,2800,2700]],
     sleep:[[6.6,6.5,6.5,6.4,6.4,6.3,6.3],[6.3,6.2,6.2,6.1,6.1,6,6],[6,5.9,5.8,5.8,5.7,5.7,5.6],[5.7,5.6,5.5,5.5,5.4,5.4,5.3],[5.5,5.4,5.3,5.3,5.2,5.2,5.1],[5.2,5.1,5.1,5,5,4.9,4.9]]}},
  {id:'P023',nm:'정OO',grp:'exp',
   tr:{wt:[88,86.8,85.5,84.5,83.4,82.5],sbp:[148,146,144,142,140,139],dbp:[90,88,87,85,84,84],
       hr:[80,78,77,76,75,74],steps:[5800,6400,6900,7200,7500,7800],sleep:[6.2,6.4,6.5,6.7,6.8,7],
       ema:[70,75,80,84,88,90]},
   daily:{wt:[[88.2,88,87.9,87.7,87.5,87.3,87.1],[87,86.8,86.7,86.5,86.3,86.2,86],[85.8,85.6,85.5,85.3,85.2,85,84.8],[84.8,84.6,84.5,84.3,84.2,84,83.8],[83.7,83.5,83.4,83.3,83.1,83,82.8],[82.8,82.6,82.5,82.4,82.3,82.1,82]],
     hr:[[81,80,80,79,79,79,78],[79,78,78,77,77,77,76],[78,77,77,76,76,76,75],[77,76,76,75,75,75,74],[76,75,75,75,74,74,74],[75,74,74,74,73,73,73]],
     steps:[[5500,5800,6000,5700,6100,5900,5600],[6100,6400,6500,6300,6600,6500,6200],[6600,6900,7000,6800,7100,7000,6700],[7000,7200,7300,7100,7400,7300,7000],[7300,7500,7600,7400,7700,7600,7300],[7600,7800,7900,7700,8000,7900,7600]],
     sleep:[[6,6.2,6.3,6.1,6.4,6.3,5.9],[6.2,6.4,6.5,6.3,6.6,6.5,6.1],[6.3,6.5,6.6,6.4,6.7,6.6,6.2],[6.5,6.7,6.8,6.6,6.9,6.8,6.4],[6.6,6.8,6.9,6.7,7,6.9,6.5],[6.8,7,7.1,6.9,7.2,7.1,6.7]]}},
  {id:'P032',nm:'한OO',grp:'ctrl',
   tr:{wt:[87,87.2,86.8,86.5,86.3,86.1],sbp:[148,147,147,146,146,145],dbp:[90,90,89,89,88,88],
       hr:[79,79,78,78,78,78],steps:[5000,5100,5200,5300,5350,5400],sleep:[6.3,6.3,6.4,6.4,6.5,6.5],
       ema:[68,70,70,71,71,72]},
   daily:{wt:[[87.1,87,87,86.9,86.9,86.8,86.8],[87.3,87.2,87.2,87.1,87.1,87,87],[87,86.9,86.9,86.8,86.7,86.7,86.6],[86.7,86.6,86.6,86.5,86.5,86.4,86.4],[86.5,86.4,86.4,86.3,86.3,86.2,86.2],[86.3,86.2,86.2,86.1,86.1,86,86]],
     hr:[[79,79,79,79,78,78,78],[79,79,79,78,78,78,78],[79,78,78,78,78,78,77],[78,78,78,78,78,77,77],[78,78,78,78,77,77,77],[78,78,78,77,77,77,77]],
     steps:[[4800,5000,5100,4900,5200,5100,4800],[4900,5100,5200,5000,5300,5200,4900],[5000,5200,5300,5100,5400,5300,5000],[5100,5300,5400,5200,5500,5400,5100],[5200,5350,5400,5300,5500,5400,5200],[5200,5400,5500,5300,5600,5500,5200]],
     sleep:[[6.2,6.3,6.4,6.2,6.4,6.3,6.1],[6.2,6.3,6.4,6.2,6.4,6.3,6.1],[6.3,6.4,6.5,6.3,6.5,6.4,6.2],[6.3,6.4,6.5,6.3,6.5,6.4,6.2],[6.4,6.5,6.6,6.4,6.6,6.5,6.3],[6.4,6.5,6.6,6.4,6.6,6.5,6.3]]}},
  {id:'P041',nm:'윤OO',grp:'exp',alert:true,
   tr:{wt:[96,95.8,95.6,95.5,95.3,95.2],sbp:[148,150,152,154,156,158],dbp:[92,93,94,96,97,98],
       hr:[82,84,86,88,90,92],steps:[4200,3800,3200,2800,2400,2100],sleep:[6,5.8,5.5,5.2,5,4.8],
       ema:[62,55,50,45,40,38]},
   daily:{wt:[[96.2,96.1,96,96,95.9,95.9,95.8],[95.9,95.8,95.8,95.7,95.7,95.6,95.6],[95.7,95.7,95.6,95.6,95.5,95.5,95.4],[95.6,95.5,95.5,95.5,95.4,95.4,95.3],[95.4,95.4,95.3,95.3,95.2,95.2,95.1],[95.3,95.2,95.2,95.2,95.1,95.1,95]],
     hr:[[81,82,82,83,83,84,84],[83,84,84,85,85,85,86],[85,85,86,86,86,87,87],[87,87,88,88,88,89,89],[89,89,90,90,90,91,91],[91,91,92,92,92,93,93]],
     steps:[[4400,4200,4100,4000,3900,3800,3600],[3900,3800,3700,3600,3500,3400,3200],[3400,3200,3100,3000,2900,2800,2600],[3000,2800,2700,2600,2500,2400,2300],[2600,2400,2300,2200,2100,2000,1900],[2300,2100,2000,1900,1800,1700,1600]],
     sleep:[[6.1,6,6,5.9,5.9,5.8,5.8],[5.9,5.8,5.8,5.7,5.7,5.6,5.6],[5.6,5.5,5.5,5.4,5.4,5.3,5.3],[5.3,5.2,5.2,5.1,5.1,5,5],[5.1,5,5,5,4.9,4.9,4.8],[4.9,4.8,4.8,4.8,4.7,4.7,4.6]]}},
  {id:'P055',nm:'서OO',grp:'ctrl',
   tr:{wt:[85,84.8,84.5,84.2,84,83.8],sbp:[148,146,144,143,142,141],dbp:[89,88,87,86,85,85],
       hr:[78,77,76,76,75,75],steps:[5500,5800,6100,6400,6600,6800],sleep:[6.2,6.4,6.5,6.7,6.8,6.9],
       ema:[65,70,74,76,80,82]},
   daily:{wt:[[85.1,85,85,84.9,84.9,84.8,84.8],[84.9,84.8,84.8,84.7,84.7,84.6,84.6],[84.6,84.5,84.5,84.4,84.4,84.3,84.3],[84.3,84.2,84.2,84.1,84.1,84,84],[84.1,84,84,83.9,83.9,83.8,83.8],[83.9,83.8,83.8,83.7,83.7,83.6,83.6]],
     hr:[[78,78,77,77,77,77,76],[77,77,77,76,76,76,76],[77,76,76,76,76,75,75],[76,76,76,75,75,75,75],[76,75,75,75,75,75,74],[75,75,75,75,74,74,74]],
     steps:[[5300,5500,5600,5400,5700,5600,5300],[5600,5800,5900,5700,6000,5900,5600],[5900,6100,6200,6000,6300,6200,5900],[6200,6400,6500,6300,6600,6500,6200],[6400,6600,6700,6500,6800,6700,6400],[6600,6800,6900,6700,7000,6900,6600]],
     sleep:[[6,6.2,6.3,6.1,6.4,6.3,5.9],[6.2,6.4,6.5,6.3,6.6,6.5,6.1],[6.3,6.5,6.6,6.4,6.7,6.6,6.2],[6.5,6.7,6.8,6.6,6.9,6.8,6.4],[6.6,6.8,6.9,6.7,7,6.9,6.5],[6.7,6.9,7,6.8,7.1,7,6.6]]}},
  {id:'P063',nm:'강OO',grp:'exp',
   tr:{wt:[86,83.5,81.8,80.2,78.8,77.5],sbp:[148,144,140,137,134,132],dbp:[88,86,83,81,79,78],
       hr:[78,76,72,70,68,66],steps:[5800,7000,8200,9000,9800,10200],sleep:[6.5,6.8,7.2,7.5,7.8,8.1],
       ema:[75,82,88,92,96,98]},
   daily:{wt:[[86.3,86.1,86,85.8,85.6,85.4,85.2],[84,83.8,83.6,83.4,83.2,83,82.8],[82.2,82,81.8,81.6,81.5,81.3,81.2],[80.6,80.4,80.2,80.1,79.9,79.8,79.6],[79.2,79,78.8,78.7,78.5,78.4,78.2],[77.9,77.7,77.6,77.4,77.3,77.2,77]],
     hr:[[79,78,78,77,77,76,76],[77,76,75,75,74,74,73],[73,72,72,71,71,70,70],[71,70,70,69,69,68,68],[69,68,68,67,67,67,66],[67,66,66,66,65,65,65]],
     steps:[[5500,5800,6000,5700,6100,5900,5600],[6700,7000,7200,6900,7300,7100,6800],[7900,8200,8400,8100,8500,8300,8000],[8700,9000,9200,8900,9300,9100,8800],[9500,9800,10000,9700,10100,9900,9600],[9900,10200,10400,10100,10500,10300,10000]],
     sleep:[[6.3,6.5,6.6,6.4,6.7,6.6,6.2],[6.6,6.8,6.9,6.7,7,6.9,6.5],[7,7.2,7.3,7.1,7.4,7.3,6.9],[7.3,7.5,7.6,7.4,7.7,7.6,7.2],[7.6,7.8,7.9,7.7,8,7.9,7.5],[7.9,8.1,8.2,8,8.3,8.2,7.8]]}},
  {id:'P078',nm:'조OO',grp:'ctrl',
   tr:{wt:[89,89,88.8,88.7,88.6,88.5],sbp:[148,148,147,147,146,146],dbp:[90,90,90,89,89,89],
       hr:[78,78,77,77,77,77],steps:[4800,4900,5000,5000,5050,5100],sleep:[6.2,6.2,6.3,6.3,6.3,6.3],
       ema:[60,62,64,65,66,68]},
   daily:{wt:[[89.1,89,89,89,88.9,88.9,88.9],[89.1,89,89,89,88.9,88.9,88.8],[88.9,88.9,88.8,88.8,88.8,88.7,88.7],[88.8,88.7,88.7,88.7,88.7,88.6,88.6],[88.7,88.6,88.6,88.6,88.6,88.5,88.5],[88.6,88.5,88.5,88.5,88.5,88.4,88.4]],
     hr:[[78,78,78,78,77,77,77],[78,78,78,77,77,77,77],[78,77,77,77,77,77,76],[77,77,77,77,77,76,76],[77,77,77,77,76,76,76],[77,77,77,76,76,76,76]],
     steps:[[4600,4800,4900,4700,5000,4900,4600],[4700,4900,5000,4800,5100,5000,4700],[4800,5000,5100,4900,5200,5100,4800],[4800,5000,5100,4900,5200,5100,4800],[4900,5050,5100,5000,5200,5100,4900],[4900,5100,5200,5000,5300,5200,4900]],
     sleep:[[6.1,6.2,6.3,6.1,6.3,6.2,6],[6.1,6.2,6.3,6.1,6.3,6.2,6],[6.2,6.3,6.4,6.2,6.4,6.3,6.1],[6.2,6.3,6.4,6.2,6.4,6.3,6.1],[6.2,6.3,6.4,6.2,6.4,6.3,6.1],[6.2,6.3,6.4,6.2,6.4,6.3,6.1]]}}
];

// Metric definitions
const METRICS=[
  {grp:'EMR',color:'#60a5fa',items:[
    {key:'wt',name:'체중',unit:'kg',get:p=>p.tr.wt,dir:'down',th:[82,90],fmt:v=>v.toFixed(1)},
    {key:'sbp',name:'수축기',unit:'mmHg',get:p=>p.tr.sbp,dir:'down',th:[130,140],fmt:v=>v.toFixed(0)},
    {key:'dbp',name:'이완기',unit:'mmHg',get:p=>p.tr.dbp,dir:'down',th:[80,90],fmt:v=>v.toFixed(0)},
  ]},
  {grp:'웨어러블',color:'#4ade80',items:[
    {key:'hr',name:'심박',unit:'bpm',get:p=>p.tr.hr,dir:'down',th:[65,85],fmt:v=>v.toFixed(0)},
    {key:'steps',name:'걸음',unit:'보',get:p=>p.tr.steps,dir:'up',th:[5000,8000],fmt:v=>v>=1000?(v/1000).toFixed(1)+'k':String(v)},
    {key:'sleep',name:'수면',unit:'h',get:p=>p.tr.sleep,dir:'up',th:[6,7.5],fmt:v=>v.toFixed(1)},
  ]},
  {grp:'EMA',color:'#a78bfa',items:[
    {key:'ema',name:'순응도',unit:'%',get:p=>p.tr.ema,dir:'up',th:[60,80],fmt:v=>v.toFixed(0)},
  ]},
];
const allItems=METRICS.flatMap(g=>g.items.map(m=>({...m,grpColor:g.color,grpName:g.grp})));

// State
let selectedIdx=null;

// ===== HELPERS =====
function hm(val,dir,th){
  if(!th)return'hm-n';
  const[lo,hi]=th;
  if(dir==='down')return val<=lo?'hm-g':val>=hi?'hm-r':'hm-y';
  return val>=hi?'hm-g':val<=lo?'hm-r':'hm-y';
}
function fsHm(val,dir,th){
  if(!th)return'';
  const[lo,hi]=th;
  if(dir==='down')return val<=lo?'fs-g':val>=hi?'fs-r':'fs-y';
  return val>=hi?'fs-g':val<=lo?'fs-r':'fs-y';
}

function spark(data,w,h,col){
  if(!data||data.length<2)return'';
  const mn=Math.min(...data),mx=Math.max(...data),r=mx-mn||1;
  const X=i=>(i/(data.length-1))*w,Y=v=>h-((v-mn)/r)*(h*.6)-h*.2;
  let p=`M${X(0)},${Y(data[0])}`;
  for(let i=1;i<data.length;i++)p+=`L${X(i)},${Y(data[i])}`;
  return `<svg class="mc-spark" viewBox="0 0 ${w} ${h}" width="${w}" height="${h}"><path d="${p}" fill="none" stroke="${col}" stroke-width="1.2" stroke-linecap="round"/><circle cx="${X(data.length-1)}" cy="${Y(data[data.length-1])}" r="1.5" fill="${col}"/></svg>`;
}

function bigChart(data,w,h,col,labels){
  const pad={t:10,r:10,b:18,l:32},iw=w-pad.l-pad.r,ih=h-pad.t-pad.b;
  const mn=Math.min(...data)*.97,mx=Math.max(...data)*1.03,rng=mx-mn||1;
  const X=i=>pad.l+(i/(data.length-1))*iw,Y=v=>pad.t+ih-((v-mn)/rng)*ih;
  let s=`<svg viewBox="0 0 ${w} ${h}" width="100%" height="${h}" style="display:block">`;
  for(let i=0;i<=2;i++){
    const gy=pad.t+(ih/2)*i;
    s+=`<line x1="${pad.l}" y1="${gy}" x2="${w-pad.r}" y2="${gy}" stroke="#1e293b" stroke-width=".5"/>`;
    s+=`<text x="${pad.l-4}" y="${gy+3}" text-anchor="end" fill="#475569" font-size="8" font-family="SF Mono,monospace">${(mx-(rng/2)*i).toFixed(mx>=100?0:1)}</text>`;
  }
  let lp=`M${X(0)},${Y(data[0])}`;for(let i=1;i<data.length;i++)lp+=`L${X(i)},${Y(data[i])}`;
  s+=`<path d="${lp}L${X(data.length-1)},${pad.t+ih}L${X(0)},${pad.t+ih}Z" fill="${col}" opacity=".08"/>`;
  s+=`<path d="${lp}" fill="none" stroke="${col}" stroke-width="1.5" stroke-linecap="round"/>`;
  data.forEach((v,i)=>{s+=`<circle cx="${X(i)}" cy="${Y(v)}" r="2.5" fill="#0a0e1a" stroke="${col}" stroke-width="1.5"/>`;});
  (labels||[]).forEach((l,i)=>{if(i<data.length)s+=`<text x="${X(i)}" y="${h-3}" text-anchor="middle" fill="#475569" font-size="7">${l}</text>`;});
  return s+'</svg>';
}

// ===== RENDER TABLE =====
function renderTable(){
  let h='<thead>';

  // Row 1: group headers
  h+='<tr><th class="grp" style="background:#111827;border-color:transparent" rowspan="2"></th>';
  METRICS.forEach(g=>{
    h+=`<th class="grp" colspan="${g.items.length}" style="background:#111827;border-color:${g.color};color:${g.color}">${g.grp}</th>`;
  });
  h+='</tr>';

  // Row 2: metric names
  h+='<tr>';
  allItems.forEach(m=>{
    h+=`<th class="met">${m.name}<span style="display:block;font-size:7px;color:#334155;font-weight:400">${m.unit}</span></th>`;
  });
  h+='</tr></thead><tbody>';

  // Cohort summary row
  h+='<tr class="cohort-row"><td class="patient-cell"><div style="font-size:10px;font-weight:700;color:#64748b">코호트 평균</div><div style="font-size:8px;color:#475569">N='+P.length+'</div></td>';
  allItems.forEach(m=>{
    const vals=P.map(p=>{const d=m.get(p);return d[d.length-1];});
    const avg=vals.reduce((a,b)=>a+b,0)/vals.length;
    const baseline=P.map(p=>m.get(p)[0]).reduce((a,b)=>a+b,0)/P.length;
    const delta=avg-baseline;
    const cls=hm(avg,m.dir,m.th);
    // Cohort sparkline (averages per week)
    const weekAvgs=WK.map((_,wi)=>{const wv=P.map(p=>m.get(p)[wi]);return wv.reduce((a,b)=>a+b,0)/wv.length;});
    const dCol=delta<0?(m.dir==='down'?'#4ade80':'#f87171'):delta>0?(m.dir==='down'?'#f87171':'#4ade80'):'#64748b';
    h+=`<td><div class="mc ${cls}">`;
    h+=`<span class="mc-val">${m.fmt(avg)}</span>`;
    h+=spark(weekAvgs,48,14,m.grpColor);
    h+=`<span class="mc-delta" style="color:${dCol}">${delta>0?'+':''}${m.fmt(delta)}</span>`;
    h+=`</div></td>`;
  });
  h+='</tr>';

  // Patient rows
  P.forEach((p,idx)=>{
    const sel=selectedIdx===idx?'selected':'';
    h+=`<tr class="${sel}" onclick="showDetail(${idx})" style="cursor:pointer">`;

    // Patient info (sticky)
    const abnCount=allItems.reduce((s,m)=>{const d=m.get(p);const v=d[d.length-1];const[lo,hi]=m.th;return s+((m.dir==='down'?v>=hi:v<=lo)?1:0);},0);
    const badge=abnCount>=2?'b-bad':abnCount>=1?'b-warn':'b-good';
    const badgeLabel=abnCount>=2?'위험':abnCount>=1?'주의':'정상';
    h+=`<td class="patient-cell"><div class="pi-id ${p.alert?'alert':''}">${p.id}</div><div class="pi-nm">${p.nm}</div><div class="pi-sub">${p.grp==='exp'?'실험군':'대조군'}</div><div class="pi-badge ${badge}">${badgeLabel}</div></td>`;

    // Metric cells
    allItems.forEach(m=>{
      const data=m.get(p);
      const cur=data[data.length-1];
      const baseline=data[0];
      const delta=cur-baseline;
      const cls=hm(cur,m.dir,m.th);
      const dCol=delta<0?(m.dir==='down'?'#4ade80':'#f87171'):delta>0?(m.dir==='down'?'#f87171':'#4ade80'):'#64748b';

      h+=`<td><div class="mc ${cls}">`;
      h+=`<span class="mc-val">${m.fmt(cur)}</span>`;
      h+=spark(data,48,14,m.grpColor);
      h+=`<span class="mc-delta" style="color:${dCol}">${delta>0?'+':''}${delta>=100||delta<=-100?Math.round(delta):delta.toFixed(1)}</span>`;
      h+=`<span class="mc-sub">W1: ${m.fmt(baseline)}</span>`;
      h+=`</div></td>`;
    });
    h+='</tr>';
  });

  h+='</tbody>';
  document.getElementById('mainTable').innerHTML=h;
}

// ===== DETAIL PANEL =====
function showDetail(idx){
  selectedIdx=idx;
  const p=P[idx];
  const panel=document.getElementById('detailPanel');
  const area=document.getElementById('tableArea');

  document.getElementById('dpTitle').textContent=`${p.id} ${p.nm}`;
  document.getElementById('dpSub').textContent=p.grp==='exp'?'실험군':'대조군';

  let h='';

  // Section 1: Flowsheet (raw time-series table)
  h+=`<div class="ds-hdr">원본 데이터 — 주간 시계열</div>`;
  h+=`<table class="fs-table"><thead><tr><th style="min-width:70px">지표</th>`;
  WK.forEach(w=>{h+=`<th>${w}</th>`;});
  h+=`<th>Δ총</th></tr></thead><tbody>`;

  METRICS.forEach(g=>{
    h+=`<tr><td class="fs-grp" colspan="${WK.length+2}" style="color:${g.color}">${g.grp}</td></tr>`;
    g.items.forEach(m=>{
      const data=m.get(p);
      const total=data[data.length-1]-data[0];
      const tCol=total<0?(m.dir==='down'?'#4ade80':'#f87171'):total>0?(m.dir==='down'?'#f87171':'#4ade80'):'#64748b';
      h+=`<tr><td>${m.name} <span style="color:#334155;font-size:8px">${m.unit}</span></td>`;
      data.forEach((v,wi)=>{
        const cls=fsHm(v,m.dir,m.th);
        h+=`<td class="fs-c ${cls}">${m.fmt(v)}</td>`;
      });
      h+=`<td style="color:${tCol};font-weight:700">${total>0?'+':''}${total>=100||total<=-100?Math.round(total):total.toFixed(1)}</td>`;
      h+=`</tr>`;
    });
  });
  h+=`</tbody></table>`;

  // Section 2: Charts (weekly)
  h+=`<div class="ds-hdr">추이 차트 — 6주</div>`;
  h+=`<div class="detail-charts">`;
  allItems.forEach(m=>{
    const data=m.get(p);
    h+=`<div class="dc-card"><div class="dc-title" style="color:${m.grpColor}">${m.name} (${m.unit})</div>`;
    h+=bigChart(data,240,90,m.grpColor,WK);
    h+=`</div>`;
  });
  h+=`</div>`;

  // Section 3: Daily detail (if available, show latest week)
  const dailyKeys=['wt','hr','steps','sleep'];
  const hasDailyData=p.daily&&dailyKeys.some(k=>p.daily[k]);
  if(hasDailyData){
    h+=`<div class="ds-hdr" style="margin-top:16px">일별 상세 — W6 (최근 7일)</div>`;
    h+=`<table class="fs-table"><thead><tr><th style="min-width:70px">지표</th>`;
    DAYS.forEach(d=>{h+=`<th>${d}</th>`;});
    h+=`</tr></thead><tbody>`;
    dailyKeys.forEach(key=>{
      if(!p.daily[key])return;
      const m=allItems.find(x=>x.key===key);
      if(!m)return;
      const dayData=p.daily[key][5]; // W6
      h+=`<tr><td>${m.name}</td>`;
      dayData.forEach(v=>{
        const cls=fsHm(v,m.dir,m.th);
        h+=`<td class="fs-c ${cls}">${m.fmt(v)}</td>`;
      });
      h+=`</tr>`;
    });
    h+=`</tbody></table>`;

    // Daily charts
    h+=`<div class="detail-charts">`;
    dailyKeys.forEach(key=>{
      if(!p.daily[key])return;
      const m=allItems.find(x=>x.key===key);
      if(!m)return;
      const dayData=p.daily[key][5];
      h+=`<div class="dc-card"><div class="dc-title" style="color:${m.grpColor}">${m.name} · W6 일별</div>`;
      h+=bigChart(dayData,240,90,m.grpColor,DAYS);
      h+=`</div>`;
    });
    h+=`</div>`;
  }

  document.getElementById('dpBody').innerHTML=h;
  panel.classList.add('open');
  area.classList.add('shrunk');
  renderTable(); // re-render to update selected state
}

function closePanel(){
  selectedIdx=null;
  document.getElementById('detailPanel').classList.remove('open');
  document.getElementById('tableArea').classList.remove('shrunk');
  renderTable();
}

function navPatient(dir){
  if(selectedIdx===null)return;
  const next=selectedIdx+dir;
  if(next>=0&&next<P.length)showDetail(next);
}

// Keyboard
document.addEventListener('keydown',e=>{
  if(e.key==='Escape')closePanel();
  if(e.key==='ArrowUp'&&selectedIdx!==null){e.preventDefault();navPatient(-1);}
  if(e.key==='ArrowDown'&&selectedIdx!==null){e.preventDefault();navPatient(1);}
});

// Init
renderTable();
</script>
</body>
</html>
