<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UniQdata â€” v5 ì‹œê°„ ìœˆë„ìš° í…ŒìŠ¤íŠ¸</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#f5f5f5;color:#1f2937;}
    .layout{display:flex;height:100vh;overflow:hidden;}
    .sidebar{width:220px;background:linear-gradient(180deg,#0f172a,#1e293b);color:white;display:flex;flex-direction:column;flex-shrink:0;}
    .logo{padding:16px 20px;font-size:18px;font-weight:700;border-bottom:1px solid rgba(255,255,255,.1);display:flex;align-items:center;gap:8px;}
    .logo-icon{width:28px;height:28px;background:linear-gradient(135deg,#3b82f6,#8b5cf6);border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:14px;}
    .nav-section{padding:12px;border-bottom:1px solid rgba(255,255,255,.05);}
    .nav-item{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:6px;color:#94a3b8;cursor:pointer;font-size:13px;}
    .rn-header{display:flex;align-items:center;gap:6px;padding:6px 10px;border-radius:6px;font-size:12px;color:#60a5fa;background:rgba(59,130,246,.1);cursor:pointer;}
    .rn-sub{padding-left:16px;margin-top:3px;border-left:2px solid rgba(255,255,255,.1);margin-left:14px;}
    .ns-item{display:flex;align-items:center;gap:6px;padding:6px 10px;border-radius:5px;color:#94a3b8;font-size:11px;cursor:pointer;margin-bottom:1px;}
    .ns-item:hover{background:rgba(255,255,255,.05);}
    .ns-item.active{background:rgba(59,130,246,.15);color:#60a5fa;}
    .status-dot{width:6px;height:6px;border-radius:50%;background:#22c55e;flex-shrink:0;}
    .sidebar-footer{margin-top:auto;padding:12px;border-top:1px solid rgba(255,255,255,.05);}
    .u-info{display:flex;align-items:center;gap:10px;padding:6px;}
    .u-av{width:32px;height:32px;background:linear-gradient(135deg,#3b82f6,#8b5cf6);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;}

    .main{flex:1;overflow:hidden;display:flex;flex-direction:column;}
    .content{padding:20px;flex:1;display:flex;flex-direction:column;overflow:hidden;min-height:0;}
    .breadcrumb{display:flex;align-items:center;gap:6px;margin-bottom:8px;font-size:13px;color:#6b7280;}
    .breadcrumb a{color:#3b82f6;text-decoration:none;}
    .page-title{font-size:18px;font-weight:700;margin-bottom:2px;}
    .page-sub{color:#6b7280;font-size:12px;margin-bottom:12px;}

    .tabs{display:flex;border-bottom:2px solid #e5e7eb;margin-bottom:12px;flex-shrink:0;}
    .tab{padding:8px 20px;font-size:13px;color:#6b7280;cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;font-weight:500;user-select:none;}
    .tab.active{color:#3b82f6;border-bottom-color:#3b82f6;}
    .tab:hover{color:#374151;}

    .tab-content{display:none;flex:1;min-height:0;overflow:hidden;}
    .tab-content.active{display:flex;flex-direction:column;flex:1;min-height:0;}

    /* KPI */
    .kpi-strip{display:flex;gap:10px;margin-bottom:10px;flex-shrink:0;}
    .kpi-chip{background:white;border:1px solid #e5e7eb;border-radius:8px;padding:8px 14px;display:flex;align-items:center;gap:8px;flex:1;min-width:0;}
    .kpi-chip .kv{font-size:18px;font-weight:700;white-space:nowrap;}
    .kpi-chip .kl{font-size:10px;color:#6b7280;}
    .kpi-chip .kc{font-size:9px;margin-top:1px;}
    .kc.good{color:#16a34a;}.kc.warn{color:#d97706;}

    /* ê°œìš” ì°¨íŠ¸ */
    .chart-section{background:white;border:1px solid #e5e7eb;border-radius:10px;flex:1;display:flex;flex-direction:column;min-height:0;overflow:hidden;}
    .chart-toolbar{display:flex;justify-content:space-between;align-items:center;padding:10px 16px;border-bottom:1px solid #f1f5f9;flex-wrap:wrap;gap:6px;flex-shrink:0;}
    .ct-left{display:flex;align-items:center;gap:10px;}
    .ct-right{display:flex;align-items:center;gap:8px;}
    .metric-sel{padding:4px 8px;border:1px solid #d1d5db;border-radius:5px;font-size:11px;background:white;cursor:pointer;}
    .tw-sel{display:flex;gap:2px;background:#f3f4f6;border-radius:6px;padding:2px;}
    .tw-btn2{padding:4px 10px;border:none;border-radius:4px;background:transparent;color:#6b7280;cursor:pointer;font-size:11px;font-weight:500;transition:all .15s;}
    .tw-btn2.active{background:white;color:#3b82f6;box-shadow:0 1px 3px rgba(0,0,0,.1);}
    .custom-iv2{display:none;align-items:center;gap:4px;padding:2px 6px;background:#eff6ff;border:1px solid #bfdbfe;border-radius:5px;font-size:10px;}
    .custom-iv2.show{display:flex;}
    .custom-iv2 input{width:30px;padding:1px 3px;border:1px solid #d1d5db;border-radius:3px;font-size:10px;text-align:center;}
    .custom-iv2 select{padding:1px 3px;border:1px solid #d1d5db;border-radius:3px;font-size:10px;background:white;}
    .custom-iv2 .ci-l{color:#1d4ed8;font-weight:600;}
    .legend-item{display:flex;align-items:center;gap:3px;font-size:10px;color:#6b7280;}
    .legend-line{width:16px;height:2.5px;border-radius:2px;}
    .legend-line.thin{height:1px;opacity:.4;}

    .chart-body{flex:1;position:relative;padding:6px 12px 2px;min-height:200px;}
    .chart-canvas{width:100%;height:100%;}

    /* ì°¨íŠ¸ ë‚´ ì¸í¬ */
    .tw-info{position:absolute;top:8px;left:12px;font-size:10px;color:#9ca3af;background:rgba(255,255,255,.9);padding:2px 6px;border-radius:4px;z-index:5;}

    .collection-bar{display:flex;align-items:center;gap:6px;padding:6px 16px;border-top:1px solid #f1f5f9;font-size:9px;color:#6b7280;flex-shrink:0;}
    .cb-segments{display:flex;flex:1;height:5px;background:#f3f4f6;border-radius:3px;overflow:hidden;}
    .cb-seg{height:100%;}

    /* í…Œì´ë¸” íƒ­ */
    .table-area-wrap{display:flex;flex:1;min-height:0;overflow:hidden;}
    .table-area{flex:1;min-width:0;overflow-y:auto;overflow-x:auto;display:flex;flex-direction:column;transition:flex .3s ease;}
    .table-area.shrunk{flex:0 0 50%;}
    .ctrl-section{background:white;border:1px solid #e5e7eb;border-radius:10px;padding:10px 16px;margin-bottom:8px;flex-shrink:0;}
    .ctrl-row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;}
    .ctrl-group{display:flex;align-items:center;gap:6px;}
    .ctrl-group label{font-size:11px;color:#6b7280;font-weight:600;}
    .t-btn{padding:4px 8px;border:1px solid #e5e7eb;border-radius:5px;background:white;color:#6b7280;cursor:pointer;font-size:11px;}
    .t-btn.active{background:#3b82f6;color:white;border-color:#3b82f6;}
    .sel-sm{padding:4px 6px;border:1px solid #e5e7eb;border-radius:5px;font-size:11px;color:#374151;background:white;}
    .dn-ctrl{display:flex;align-items:center;gap:4px;padding:4px 8px;background:#f9fafb;border:1px solid #e5e7eb;border-radius:5px;font-size:11px;}
    .dn-ctrl button{background:none;border:none;cursor:pointer;font-size:12px;color:#3b82f6;padding:0 2px;}
    .search-in{padding:4px 6px;border:1px solid #e5e7eb;border-radius:5px;font-size:11px;width:120px;}

    .src-legend{display:flex;gap:10px;align-items:center;margin-bottom:4px;font-size:10px;color:#6b7280;flex-shrink:0;}
    .sd{width:7px;height:7px;border-radius:2px;display:inline-block;}
    .sd.emr{background:#3b82f6;}.sd.wear{background:#22c55e;}.sd.ema{background:#a855f7;}.sd.ext{background:#f97316;}

    .tbl-section{background:white;border:1px solid #e5e7eb;border-radius:10px;overflow:hidden;flex:1;display:flex;flex-direction:column;margin-bottom:8px;min-height:0;}
    .tbl-wrap{overflow-y:auto;overflow-x:auto;flex:1;min-height:0;}
    table.pt-tbl{width:100%;border-collapse:collapse;font-size:12px;}
    table.pt-tbl thead th{text-align:left;font-size:10px;color:#6b7280;font-weight:600;padding:7px 6px;border-bottom:2px solid #e5e7eb;background:#f9fafb;position:sticky;top:0;z-index:10;white-space:nowrap;cursor:pointer;}
    table.pt-tbl thead th .cs{display:inline-block;width:5px;height:5px;border-radius:2px;margin-right:2px;vertical-align:middle;}
    table.pt-tbl tbody td{padding:7px 6px;border-bottom:1px solid #f1f5f9;font-size:11px;}
    table.pt-tbl tbody tr{cursor:pointer;transition:background .1s;}
    table.pt-tbl tbody tr:hover{background:#f8fafc;}
    table.pt-tbl tbody tr.selected{background:#eff6ff;}
    table.pt-tbl tbody tr.alert-row{background:#fffbeb;}
    .pid{font-weight:600;color:#374151;white-space:nowrap;}
    .gb{display:inline-block;padding:1px 4px;border-radius:3px;font-size:9px;font-weight:600;margin-left:4px;}
    .gb.exp{background:#dbeafe;color:#1d4ed8;}.gb.ctrl{background:#fce7f3;color:#be185d;}
    .sv{display:inline-block;width:5px;height:5px;border-radius:50%;margin-right:4px;}
    .sv.good{background:#22c55e;}.sv.warn{background:#f59e0b;}.sv.bad{background:#ef4444;}
    .cd{font-weight:700;font-family:'SF Mono',Monaco,monospace;font-size:11px;}
    .cd.good{color:#16a34a;}.cd.bad{color:#dc2626;}.cd.neutral{color:#6b7280;}
    .cr{font-size:10px;color:#9ca3af;display:block;margin-top:1px;}
    .ce{color:#d1d5db;font-style:italic;}

    .pag-row{display:flex;align-items:center;justify-content:space-between;padding:8px 16px;background:white;border:1px solid #e5e7eb;border-radius:10px;font-size:11px;color:#6b7280;margin-bottom:8px;flex-shrink:0;}
    .pag-btns{display:flex;gap:2px;}
    .pg-btn{padding:3px 6px;border:1px solid #e5e7eb;border-radius:3px;background:white;color:#6b7280;cursor:pointer;font-size:10px;}
    .pg-btn.active{background:#3b82f6;color:white;border-color:#3b82f6;}

    /* ë””í…Œì¼ íŒ¨ë„ */
    .detail-panel{width:0;overflow:hidden;border-left:1px solid #e5e7eb;background:white;transition:width .3s ease;flex-shrink:0;display:flex;flex-direction:column;max-height:100%;}
    .detail-panel.open{width:50%;overflow-y:hidden;}
    .dp-header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #e5e7eb;background:#f9fafb;flex-shrink:0;}
    .dp-title{font-size:14px;font-weight:700;color:#374151;display:flex;align-items:center;gap:5px;}
    .dp-close{padding:4px 8px;border:1px solid #e5e7eb;border-radius:5px;background:white;cursor:pointer;font-size:12px;color:#6b7280;}
    .dp-nav{display:flex;gap:4px;}
    .dp-nav button{padding:2px 6px;border:1px solid #e5e7eb;border-radius:5px;background:white;cursor:pointer;font-size:11px;color:#374151;}
    .dp-body{flex:1;overflow-y:auto;padding:14px;}
    .chart-card{background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:12px;margin-bottom:12px;}
    .chart-card-title{font-size:11px;font-weight:600;color:#374151;margin-bottom:6px;display:flex;align-items:center;gap:4px;}
    .chart-card-title .cs{display:inline-block;width:5px;height:5px;border-radius:2px;}
    .mini-chart{height:80px;}
    .mini-chart svg{width:100%;height:100%;}
    .chart-x{display:flex;justify-content:space-between;font-size:8px;color:#9ca3af;margin-top:2px;}
    .chart-sum{display:flex;gap:10px;margin-top:4px;font-size:10px;color:#6b7280;}
    .chart-sum strong{color:#374151;}
    .fs-title{font-size:11px;font-weight:600;color:#374151;margin-bottom:6px;}
    .fs-table{width:100%;border-collapse:collapse;font-size:10px;}
    .fs-table th{font-size:9px;color:#9ca3af;font-weight:600;padding:3px 4px;border-bottom:1px solid #e5e7eb;text-align:center;}
    .fs-table th:first-child{text-align:left;}
    .fs-table td{padding:3px 4px;text-align:center;border-bottom:1px solid #f1f5f9;font-family:'SF Mono',Monaco,monospace;font-size:9px;}
    .fs-table td:first-child{text-align:left;font-weight:600;color:#374151;font-family:-apple-system,sans-serif;}
    .fg{color:#16a34a;background:rgba(34,197,94,.05);}.fb{color:#dc2626;background:rgba(239,68,68,.05);}.fc{font-weight:700;outline:1.5px solid #3b82f6;border-radius:2px;}

    /* ë¶„ì„ íŒ¨ë„ */
    .analysis-panel{position:fixed;bottom:0;right:0;width:420px;max-height:60vh;background:white;border:1px solid #e5e7eb;border-radius:12px 12px 0 0;box-shadow:0 -4px 20px rgba(0,0,0,.1);z-index:100;display:flex;flex-direction:column;transition:transform .3s ease;}
    .analysis-panel.hidden{transform:translateY(calc(100% - 36px));}
    .ap-header{display:flex;justify-content:space-between;align-items:center;padding:8px 16px;background:#f9fafb;border-bottom:1px solid #e5e7eb;cursor:pointer;border-radius:12px 12px 0 0;flex-shrink:0;}
    .ap-header h3{font-size:13px;font-weight:600;color:#374151;}
    .ap-toggle{background:none;border:none;cursor:pointer;font-size:14px;color:#6b7280;}
    .ap-body{flex:1;overflow-y:auto;padding:14px;font-size:12px;line-height:1.7;color:#374151;}
    .ap-body h4{font-size:12px;font-weight:700;color:#1f2937;margin:12px 0 4px;border-bottom:1px solid #f1f5f9;padding-bottom:3px;}
    .ap-body h4:first-child{margin-top:0;}
    .ap-body .finding{background:#f0fdf4;border-left:3px solid #22c55e;padding:6px 10px;margin:6px 0;border-radius:0 6px 6px 0;font-size:11px;}
    .ap-body .problem{background:#fef2f2;border-left:3px solid #ef4444;padding:6px 10px;margin:6px 0;border-radius:0 6px 6px 0;font-size:11px;}
    .ap-body .insight{background:#eff6ff;border-left:3px solid #3b82f6;padding:6px 10px;margin:6px 0;border-radius:0 6px 6px 0;font-size:11px;}
    .ap-body .tw-tag{display:inline-block;padding:1px 5px;border-radius:3px;font-size:9px;font-weight:600;margin-right:3px;}
    .tw-tag.d{background:#dbeafe;color:#1d4ed8;}.tw-tag.w{background:#dcfce7;color:#166534;}.tw-tag.m{background:#fce7f3;color:#be185d;}.tw-tag.c3{background:#e9d5ff;color:#581c87;}
  </style>
</head>
<body>
<div class="layout">
  <nav class="sidebar">
    <div class="logo"><div class="logo-icon">U</div> UniQdata</div>
    <div class="nav-section"><a class="nav-item"><span>ğŸ </span> ì—°êµ¬ í—ˆë¸Œ</a></div>
    <div class="nav-section" style="flex:1;overflow-y:auto;">
      <div style="font-size:10px;text-transform:uppercase;color:#64748b;padding:6px 10px;">ë‚´ ì—°êµ¬</div>
      <div>
        <div class="rn-header"><span style="font-size:12px;">ğŸ“</span><span style="flex:1;">ëŒ€ì‚¬ê°œì„  ì•½ë¬¼ ì—°êµ¬</span><span class="status-dot"></span></div>
        <div class="rn-sub">
          <a class="ns-item active" id="nav-ov">ê°œìš”</a>
          <a class="ns-item" id="nav-tb">í…Œì´ë¸”</a>
          <a class="ns-item">ğŸ”’ í´ë¦°ë£¸</a>
        </div>
      </div>
    </div>
    <div class="sidebar-footer"><div class="u-info"><div class="u-av">ê¹€</div><div><div style="font-size:13px;color:#e2e8f0;">ê¹€ì—°êµ¬</div><div style="font-size:11px;color:#64748b;">ì„œìš¸ëŒ€í•™êµë³‘ì›</div></div></div></div>
  </nav>

  <main class="main">
    <div class="content">
      <div class="breadcrumb"><a href="#">ì—°êµ¬ ê´€ë¦¬</a> / <span>ëŒ€ì‚¬ê°œì„  ì•½ë¬¼ ì—°êµ¬</span></div>
      <div class="page-title">ì—°êµ¬ ë°ì´í„°</div>
      <div class="page-sub">ì²˜ë°© ì•½ë¬¼(2.4mg) ëŒ€ì‚¬ê°œì„  ì—°êµ¬ Â· RCT Â· ì‹¤í—˜ 40 / ëŒ€ì¡° 40 Â· 12ì£¼(84ì¼)</div>

      <div class="tabs">
        <div class="tab active" data-tab="overview" id="tab-ov">ê°œìš”</div>
        <div class="tab" data-tab="table" id="tab-tb">í…Œì´ë¸”</div>
        <div class="tab">ğŸ”’ í´ë¦°ë£¸</div>
      </div>

      <!-- ===== ê°œìš” íƒ­ ===== -->
      <div class="tab-content active" id="tc-ov">
        <div class="kpi-strip">
          <div class="kpi-chip"><div><div class="kv">1.89<span style="font-size:11px;">M</span></div><div class="kl">ì´ ë ˆì½”ë“œ</div></div></div>
          <div class="kpi-chip"><div><div class="kv">94<span style="font-size:11px;">%</span></div><div class="kl">ì»¤ë²„ë¦¬ì§€</div><div class="kc good">+2.1%</div></div></div>
          <div class="kpi-chip"><div><div class="kv">6.2<span style="font-size:11px;">%</span></div><div class="kl">ê²°ì¸¡ë¥ </div><div class="kc good">âˆ’0.8%</div></div></div>
          <div class="kpi-chip"><div><div class="kv">76<span style="font-size:11px;">/80</span></div><div class="kl">ì°¸ì—¬ì</div></div></div>
        </div>

        <div class="chart-section">
          <div class="chart-toolbar">
            <div class="ct-left">
              <select class="metric-sel" id="metricSel">
                <option value="wt">ì²´ì¤‘ (kg)</option>
                <option value="sbp">SBP (mmHg)</option>
                <option value="hr">ì‹¬ë°•ìˆ˜ (bpm)</option>
                <option value="steps">ê±¸ìŒìˆ˜</option>
                <option value="comp">ìˆœì‘ë„ (%)</option>
              </select>
              <div class="tw-sel">
                <button class="tw-btn2" data-tw="d">ì¼ê°„</button>
                <button class="tw-btn2 active" data-tw="w">ì£¼ê°„</button>
                <button class="tw-btn2" data-tw="m">ì›”ê°„</button>
                <button class="tw-btn2" data-tw="c3">3ì¼</button>
              </div>
              <div class="custom-iv2" id="cIv2">
                <span class="ci-l">ë§¤</span>
                <input type="number" value="3" min="1" max="90" id="cNum">
                <select id="cUnit"><option value="d">ì¼</option><option value="w">ì£¼</option><option value="m">ì›”</option></select>
                <button style="background:#3b82f6;color:white;border:none;border-radius:3px;padding:2px 6px;font-size:9px;cursor:pointer;" id="cApply">ì ìš©</button>
              </div>
            </div>
            <div class="ct-right">
              <div class="legend-item"><div class="legend-line" style="background:#3b82f6;"></div>ì‹¤í—˜êµ°</div>
              <div class="legend-item"><div class="legend-line" style="background:#e11d48;"></div>ëŒ€ì¡°êµ°</div>
              <div class="legend-item"><div class="legend-line thin" style="background:#93c5fd;"></div>ê°œë³„</div>
            </div>
          </div>

          <div class="chart-body">
            <div class="tw-info" id="twInfo">ì£¼ê°„ Â· 12í¬ì¸íŠ¸ Â· W1~W12</div>
            <canvas class="chart-canvas" id="overviewChart"></canvas>
          </div>

          <div class="collection-bar">
            <span>ìˆ˜ì§‘ë¥ </span>
            <div class="cb-segments">
              <div class="cb-seg" style="width:47%;background:#3b82f6;" title="EMR"></div>
              <div class="cb-seg" style="width:42%;background:#22c55e;" title="ì›¨ì–´ëŸ¬ë¸”"></div>
              <div class="cb-seg" style="width:7%;background:#a855f7;" title="EMA"></div>
              <div class="cb-seg" style="width:1%;background:#f97316;" title="ì™¸ë¶€"></div>
              <div class="cb-seg" style="width:3%;background:#e5e7eb;" title="ë¯¸ìˆ˜ì§‘"></div>
            </div>
            <span>94%</span>
          </div>
        </div>
      </div>

      <!-- ===== í…Œì´ë¸” íƒ­ ===== -->
      <div class="tab-content" id="tc-tb">
        <div class="ctrl-section">
          <div class="ctrl-row">
            <div class="ctrl-group">
              <label>ì‹œê°„</label>
              <div style="display:flex;gap:2px;">
                <button class="t-btn tw-tbl" data-tw="d">ì¼ê°„</button>
                <button class="t-btn tw-tbl active" data-tw="w">ì£¼ê°„</button>
                <button class="t-btn tw-tbl" data-tw="m">ì›”ê°„</button>
                <button class="t-btn tw-tbl" data-tw="c3">3ì¼</button>
              </div>
            </div>
            <div class="ctrl-group">
              <label>ì†ŒìŠ¤</label>
              <select class="sel-sm"><option>ì „ì²´</option><option>[EMR]</option><option>[ì›¨ì–´ëŸ¬ë¸”]</option><option>[EMA]</option></select>
            </div>
            <div class="ctrl-group">
              <div class="dn-ctrl"><button id="dnPrev">â—€</button><span id="dnLabel">W6</span><button id="dnNext">â–¶</button></div>
            </div>
            <div class="ctrl-group" style="margin-left:auto;">
              <input type="text" class="search-in" placeholder="í™˜ì ê²€ìƒ‰...">
            </div>
          </div>
        </div>
        <div class="src-legend">
          <span><span class="sd emr"></span> EMR</span>
          <span><span class="sd wear"></span> ì›¨ì–´ëŸ¬ë¸”</span>
          <span><span class="sd ema"></span> EMA</span>
          <span><span class="sd ext"></span> ì™¸ë¶€</span>
          <span style="margin-left:auto;color:#9ca3af;">í–‰ í´ë¦­ â†’ ìš°ì¸¡ ìƒì„¸</span>
        </div>
        <div class="table-area-wrap">
          <div class="table-area" id="tableArea">
            <div class="tbl-section">
              <div class="tbl-wrap">
                <table class="pt-tbl">
                  <thead><tr>
                    <th style="width:13%;">í™˜ì</th>
                    <th><span class="cs" style="background:#3b82f6;"></span>ì²´ì¤‘</th>
                    <th><span class="cs" style="background:#3b82f6;"></span>SBP</th>
                    <th><span class="cs" style="background:#22c55e;"></span>ì‹¬ë°•ìˆ˜</th>
                    <th><span class="cs" style="background:#22c55e;"></span>ê±¸ìŒìˆ˜</th>
                    <th><span class="cs" style="background:#22c55e;"></span>ìˆ˜ë©´</th>
                    <th><span class="cs" style="background:#a855f7;"></span>ìˆœì‘ë„</th>
                    <th><span class="cs" style="background:#f97316;"></span>ì•±ì‚¬ìš©</th>
                  </tr></thead>
                  <tbody id="tBody"></tbody>
                </table>
              </div>
            </div>
            <div class="pag-row">
              <span>1-10 / 80ëª…</span>
              <div class="pag-btns"><button class="pg-btn">â—€</button><button class="pg-btn active">1</button><button class="pg-btn">2</button><button class="pg-btn">â€¦</button><button class="pg-btn">8</button><button class="pg-btn">â–¶</button></div>
            </div>
          </div>
          <div class="detail-panel" id="detailPanel">
            <div class="dp-header">
              <div class="dp-title" id="dpTitle"></div>
              <div style="display:flex;gap:4px;align-items:center;">
                <div class="dp-nav"><button id="dpPrev">â–²</button><button id="dpNext">â–¼</button></div>
                <button class="dp-close" id="dpClose">âœ•</button>
              </div>
            </div>
            <div class="dp-body" id="dpBody"></div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- ë¶„ì„ íŒ¨ë„ -->
<div class="analysis-panel hidden" id="analysisPanel">
  <div class="ap-header" id="apToggle">
    <h3>ğŸ”¬ ì—°êµ¬ì ê´€ì  ë¶„ì„</h3>
    <button class="ap-toggle" id="apBtn">â–²</button>
  </div>
  <div class="ap-body" id="apBody"></div>
</div>

<script>
// ==================== ë°ì´í„° ìƒì„± ì—”ì§„ ====================
// 12ì£¼(84ì¼) ì¼ê°„ raw ë°ì´í„°ë¥¼ ìƒì„±í•˜ê³ , ì‹œê°„ ìœˆë„ìš°ë³„ë¡œ ì§‘ê³„

function seededRandom(seed){let s=seed;return function(){s=(s*16807)%2147483647;return(s-1)/2147483646;};}

function generateDailyData(patientSeed, group, profile){
  const rng = seededRandom(patientSeed);
  const days = 84;
  const data = {wt:[],sbp:[],hr:[],steps:[],comp:[]};

  // ì²´ì¤‘: ì‹¤í—˜êµ°ì€ ì§€ì† ê°ì†Œ, ëŒ€ì¡°êµ°ì€ ìœ ì§€/ë¯¸ì„¸ ì¦ê°€
  const wtStart = 86 + rng()*4; // 86~90
  const wtTrend = group==='exp' ? -(0.08+rng()*0.04) : (rng()*0.02-0.005); // ì‹¤í—˜:-0.08~-0.12/ì¼, ëŒ€ì¡°:Â±0.01

  // SBP: ì‹¤í—˜êµ° ê°ì†Œ, ëŒ€ì¡°êµ° ìœ ì§€
  const sbpStart = 130 + rng()*10;
  const sbpTrend = group==='exp' ? -(0.12+rng()*0.06) : (rng()*0.04-0.01);

  // ì‹¬ë°•ìˆ˜
  const hrStart = 70 + rng()*6;
  const hrTrend = group==='exp' ? -(0.04+rng()*0.02) : (rng()*0.01-0.005);

  // ê±¸ìŒìˆ˜
  const stepsStart = group==='exp' ? 6000+rng()*2000 : 4000+rng()*1500;
  const stepsTrend = group==='exp' ? (20+rng()*15) : (rng()*5-2);

  // ìˆœì‘ë„
  const compStart = 82+rng()*6;
  const compTrend = group==='exp' ? (0.08+rng()*0.04) : (rng()*0.02-0.01);

  for(let d=0;d<days;d++){
    // P018(ì¸ë±ìŠ¤3, ì‹¤í—˜êµ°)ì€ W5~W6 SBP ë°˜ë“± + HR ê²°ì¸¡
    const isAnomaly = profile==='anomaly';
    const isDropout = profile==='dropout';

    // ì£¼ë§ íš¨ê³¼ (ê±¸ìŒìˆ˜, ìˆœì‘ë„ í•˜ë½)
    const dow = d % 7; // 0=ì›” ... 6=ì¼
    const isWeekend = dow>=5;
    const weekendFactor = isWeekend ? 0.85 : 1.0;

    // ì²´ì¤‘: ì£¼ ë‹¨ìœ„ ì¸¡ì •ì´ í˜„ì‹¤ì ì´ë‚˜, ì¼ê°„ë„ ì›¨ì–´ëŸ¬ë¸” ì²´ì¤‘ê³„ë¡œ ê°€ëŠ¥
    const wtNoise = (rng()-0.5)*0.6; // Â±0.3kg ì¼ê°„ ë³€ë™
    let wt = wtStart + wtTrend*d + wtNoise;
    if(isDropout && d>60) wt = wtStart + wtTrend*60 + (d-60)*0.05 + wtNoise; // ë“œë¡­ì•„ì›ƒ ë°˜ë“±
    data.wt.push(Math.round(wt*10)/10);

    // SBP
    const sbpNoise = (rng()-0.5)*8; // Â±4mmHg
    let sbp = sbpStart + sbpTrend*d + sbpNoise;
    if(isAnomaly && d>49) sbp = sbpStart - 5 + (d-49)*0.3 + sbpNoise; // W7+ ë°˜ë“±
    data.sbp.push(Math.round(sbp*10)/10);

    // HR â€” anomaly patient has gaps
    if(isAnomaly && d>=14 && d<=21){
      data.hr.push(null); // ë””ë°”ì´ìŠ¤ ëŠê¹€
    } else {
      const hrNoise = (rng()-0.5)*4;
      data.hr.push(Math.round(hrStart + hrTrend*d + hrNoise));
    }

    // ê±¸ìŒìˆ˜ â€” ì£¼ë§ íŒ¨í„´ ê°•í•¨
    const stepsNoise = (rng()-0.5)*1500;
    let steps = (stepsStart + stepsTrend*d + stepsNoise) * weekendFactor;
    if(isDropout && d>60) steps *= 0.7;
    data.steps.push(Math.max(0,Math.round(steps)));

    // ìˆœì‘ë„ â€” EMA ì‘ë‹µë¥ 
    let comp = compStart + compTrend*d + (rng()-0.5)*6;
    if(isWeekend) comp -= 3;
    if(isDropout && d>50) comp -= (d-50)*0.4;
    data.comp.push(Math.min(100,Math.max(0,Math.round(comp))));
  }
  return data;
}

// í™˜ì í”„ë¡œíŒŒì¼ ì •ì˜
const PATIENTS = [
  {id:'P001',nm:'ê¹€ë¯¼ìˆ˜',g:'exp',profile:'normal',seed:1001},
  {id:'P005',nm:'ì´ìˆ˜ì§„',g:'exp',profile:'normal',seed:1005},
  {id:'P011',nm:'ë°•ì§€í›ˆ',g:'exp',profile:'normal',seed:1011},
  {id:'P018',nm:'ìµœì˜ˆë¦°',g:'exp',profile:'anomaly',seed:1018}, // SBPë°˜ë“± + HRê²°ì¸¡
  {id:'P023',nm:'ì •í•˜ëŠ˜',g:'exp',profile:'normal',seed:1023},
  {id:'P002',nm:'ìœ¤ì„œì—°',g:'ctrl',profile:'normal',seed:2002},
  {id:'P008',nm:'í•œë„ìœ¤',g:'ctrl',profile:'normal',seed:2008},
  {id:'P014',nm:'ì†¡ì§€ì•„',g:'ctrl',profile:'normal',seed:2014},
  {id:'P031',nm:'ì„ì±„ì›',g:'ctrl',profile:'dropout',seed:2031}, // ë“œë¡­ì•„ì›ƒ íŒ¨í„´
  {id:'P036',nm:'ê°•ì‹œìš°',g:'ctrl',profile:'normal',seed:2036},
];

// ì¼ê°„ raw ë°ì´í„° ìƒì„±
PATIENTS.forEach(p=>{
  p.daily = generateDailyData(p.seed, p.g, p.profile);
});

// ==================== ì‹œê°„ ìœˆë„ìš° ì§‘ê³„ ====================
function aggregateToWindow(dailyArr, windowDays){
  const result = [];
  for(let i=0;i<84;i+=windowDays){
    const chunk = dailyArr.slice(i, Math.min(i+windowDays, 84));
    const valid = chunk.filter(v=>v!=null);
    if(valid.length===0) result.push(null);
    else result.push(Math.round(valid.reduce((a,b)=>a+b,0)/valid.length*10)/10);
  }
  return result;
}

function getWindowData(windowDays){
  return PATIENTS.map(p=>{
    const d = {};
    ['wt','sbp','hr','steps','comp'].forEach(k=>{
      d[k] = aggregateToWindow(p.daily[k], windowDays);
    });
    return {...p, agg:d};
  });
}

function getLabels(windowDays){
  const n = Math.ceil(84/windowDays);
  if(windowDays===1) return Array.from({length:n},(_,i)=>`D${i+1}`);
  if(windowDays===7) return Array.from({length:n},(_,i)=>`W${i+1}`);
  if(windowDays===28) return Array.from({length:n},(_,i)=>`M${i+1}`);
  return Array.from({length:n},(_,i)=>`${windowDays}d-${i+1}`);
}

const WINDOWS = {d:1, w:7, m:28, c3:3};
let currentTW = 'w';
let currentMetric = 'wt';

// ==================== ê°œìš” ì°¨íŠ¸ ====================
const canvas = document.getElementById('overviewChart');
const ctx = canvas.getContext('2d');

function drawChart(){
  const windowDays = WINDOWS[currentTW];
  const metric = currentMetric;
  const patients = getWindowData(windowDays);
  const labels = getLabels(windowDays);
  const exp = patients.filter(p=>p.g==='exp');
  const ctrl = patients.filter(p=>p.g==='ctrl');

  // ì¸í¬ ì—…ë°ì´íŠ¸
  const twNames = {d:'ì¼ê°„',w:'ì£¼ê°„',m:'ì›”ê°„',c3:'3ì¼'};
  document.getElementById('twInfo').textContent =
    `${twNames[currentTW]} Â· ${labels.length}í¬ì¸íŠ¸ Â· ${labels[0]}~${labels[labels.length-1]}`;

  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  canvas.style.width = rect.width + 'px';
  canvas.style.height = rect.height + 'px';
  ctx.setTransform(1,0,0,1,0,0);
  ctx.scale(dpr, dpr);
  const W = rect.width, H = rect.height;
  ctx.clearRect(0,0,W,H);

  const pad = {t:28,b:36,l:48,r:100};
  const cw = W-pad.l-pad.r, ch = H-pad.t-pad.b;

  // ê°’ ë²”ìœ„
  let allVals = [];
  patients.forEach(p=>{const a=p.agg[metric];if(a)a.forEach(v=>{if(v!=null)allVals.push(v);});});
  if(allVals.length===0)return;
  let mn = Math.min(...allVals), mx = Math.max(...allVals);
  const margin = (mx-mn)*0.1||5;
  mn -= margin; mx += margin;

  function xPos(i){return pad.l + (labels.length>1 ? (i/(labels.length-1))*cw : cw/2);}
  function yPos(v){return pad.t + (1-(v-mn)/(mx-mn))*ch;}

  // ê·¸ë¦¬ë“œ
  ctx.strokeStyle='#f1f5f9';ctx.lineWidth=1;
  for(let i=0;i<5;i++){
    const y=pad.t+i*(ch/4);
    ctx.beginPath();ctx.moveTo(pad.l,y);ctx.lineTo(pad.l+cw,y);ctx.stroke();
    const val = mx - i*((mx-mn)/4);
    ctx.fillStyle='#9ca3af';ctx.font='9px -apple-system,sans-serif';ctx.textAlign='right';
    ctx.fillText(metric==='steps'?Math.round(val).toLocaleString():val.toFixed(1), pad.l-6, y+3);
  }

  // X labels â€” ì¼ê°„(84ê°œ)ì´ë©´ ê°„ê²© ë‘ê³  í‘œì‹œ
  ctx.textAlign='center';ctx.fillStyle='#9ca3af';ctx.font='9px -apple-system,sans-serif';
  const step = labels.length > 30 ? 7 : labels.length > 14 ? 2 : 1;
  labels.forEach((w,i)=>{if(i%step===0||i===labels.length-1)ctx.fillText(w,xPos(i),H-pad.b+16);});

  // ìŠ¤íŒŒê²Œí‹° ë¼ì¸
  function drawLines(pts, thinColor, boldColor){
    pts.forEach(p=>{
      const a=p.agg[metric];if(!a)return;
      ctx.beginPath();ctx.strokeStyle=thinColor;ctx.lineWidth=labels.length>30?0.8:1.2;ctx.globalAlpha=labels.length>30?0.15:0.25;
      let started=false;
      a.forEach((v,i)=>{if(v==null)return;if(!started){ctx.moveTo(xPos(i),yPos(v));started=true;}else ctx.lineTo(xPos(i),yPos(v));});
      ctx.stroke();ctx.globalAlpha=1;
    });
    const avgLine=labels.map((_,i)=>{
      const vals=pts.map(p=>p.agg[metric]?p.agg[metric][i]:null).filter(v=>v!=null);
      return vals.length?vals.reduce((a,b)=>a+b,0)/vals.length:null;
    });
    ctx.beginPath();ctx.strokeStyle=boldColor;ctx.lineWidth=2.5;ctx.lineJoin='round';ctx.lineCap='round';
    let started=false;
    avgLine.forEach((v,i)=>{if(v==null)return;if(!started){ctx.moveTo(xPos(i),yPos(v));started=true;}else ctx.lineTo(xPos(i),yPos(v));});
    ctx.stroke();
    const last=avgLine[avgLine.length-1];
    if(last!=null){
      ctx.beginPath();ctx.arc(xPos(labels.length-1),yPos(last),3,0,Math.PI*2);ctx.fillStyle=boldColor;ctx.fill();
      ctx.fillStyle=boldColor;ctx.font='bold 10px SF Mono,Monaco,monospace';ctx.textAlign='left';
      ctx.fillText(metric==='steps'?Math.round(last).toLocaleString():last.toFixed(1),xPos(labels.length-1)+6,yPos(last)+3);
    }
    return avgLine;
  }

  const expAvg = drawLines(exp, '#93c5fd', '#3b82f6');
  const ctrlAvg = drawLines(ctrl, '#fda4af', '#e11d48');

  // gap fill
  ctx.globalAlpha=0.05;ctx.fillStyle='#3b82f6';ctx.beginPath();
  for(let i=0;i<labels.length;i++){if(expAvg[i]!=null)ctx.lineTo(xPos(i),yPos(expAvg[i]));}
  for(let i=labels.length-1;i>=0;i--){if(ctrlAvg[i]!=null)ctx.lineTo(xPos(i),yPos(ctrlAvg[i]));}
  ctx.closePath();ctx.fill();ctx.globalAlpha=1;

  // pê°’ (ê°„ì´ ê³„ì‚°)
  const expLast=expAvg[expAvg.length-1], ctrlLast=ctrlAvg[ctrlAvg.length-1];
  if(expLast!=null && ctrlLast!=null){
    const diff = Math.abs(expLast-ctrlLast);
    const pText = diff>5?'p<0.001***':diff>2?'p=0.012*':'p=0.342';
    const isSig = diff>2;
    ctx.fillStyle=isSig?'#dcfce7':'#f3f4f6';
    const pvW=ctx.measureText(pText).width+14;
    ctx.beginPath();ctx.roundRect(W-pad.r+8,pad.t+8,pvW,18,3);ctx.fill();
    ctx.fillStyle=isSig?'#166534':'#6b7280';ctx.font='bold 9px SF Mono,Monaco,monospace';ctx.textAlign='left';
    ctx.fillText(pText,W-pad.r+15,pad.t+20);

    // Î”
    const midY=(yPos(expLast)+yPos(ctrlLast))/2;
    ctx.fillStyle='#6b7280';ctx.font='9px -apple-system,sans-serif';
    ctx.fillText(`Î” ${metric==='steps'?Math.round(diff).toLocaleString():diff.toFixed(1)}`,xPos(labels.length-1)+6,midY);
    ctx.strokeStyle='#d1d5db';ctx.lineWidth=1;ctx.setLineDash([2,2]);
    ctx.beginPath();ctx.moveTo(xPos(labels.length-1)+3,yPos(expLast));ctx.lineTo(xPos(labels.length-1)+3,yPos(ctrlLast));ctx.stroke();
    ctx.setLineDash([]);
  }
}

// ==================== íƒ­ + ìœˆë„ìš° ì „í™˜ ====================
function switchTab(n){
  document.querySelectorAll('.tab[data-tab]').forEach(t=>t.classList.toggle('active',t.dataset.tab===n));
  document.getElementById('tc-ov').classList.toggle('active',n==='overview');
  document.getElementById('tc-tb').classList.toggle('active',n==='table');
  document.getElementById('nav-ov').classList.toggle('active',n==='overview');
  document.getElementById('nav-tb').classList.toggle('active',n==='table');
  if(n==='overview') setTimeout(drawChart,50);
  if(n==='table') renderTable();
}
document.querySelectorAll('.tab[data-tab]').forEach(t=>t.addEventListener('click',()=>t.dataset.tab&&switchTab(t.dataset.tab)));
document.getElementById('nav-ov').addEventListener('click',()=>switchTab('overview'));
document.getElementById('nav-tb').addEventListener('click',()=>switchTab('table'));

// ê°œìš” ì‹œê°„ ìœˆë„ìš°
document.querySelectorAll('.tw-btn2').forEach(b=>b.addEventListener('click',function(){
  document.querySelectorAll('.tw-btn2').forEach(x=>x.classList.remove('active'));this.classList.add('active');
  currentTW = this.dataset.tw;
  drawChart();
  updateAnalysis();
}));

document.getElementById('metricSel').addEventListener('change',function(){
  currentMetric=this.value; drawChart();
});

// í…Œì´ë¸” ì‹œê°„ ìœˆë„ìš°
document.querySelectorAll('.tw-tbl').forEach(b=>b.addEventListener('click',function(){
  document.querySelectorAll('.tw-tbl').forEach(x=>x.classList.remove('active'));this.classList.add('active');
  currentTW = this.dataset.tw;
  renderTable();
  drawChart();
  updateAnalysis();
}));

// ==================== í…Œì´ë¸” ë Œë”ë§ ====================
const MET=[
  {k:'wt',n:'ì²´ì¤‘',u:'kg',d:'down',sc:'#3b82f6'},
  {k:'sbp',n:'SBP',u:'mmHg',d:'down',sc:'#3b82f6'},
  {k:'hr',n:'ì‹¬ë°•ìˆ˜',u:'bpm',d:'down',sc:'#22c55e'},
  {k:'steps',n:'ê±¸ìŒìˆ˜',u:'ë³´',d:'up',sc:'#22c55e'},
  {k:'comp',n:'ìˆœì‘ë„',u:'%',d:'up',sc:'#a855f7'},
];

function renderTable(){
  const windowDays = WINDOWS[currentTW];
  const patients = getWindowData(windowDays);
  const labels = getLabels(windowDays);
  const tBody = document.getElementById('tBody');
  tBody.innerHTML = '';

  patients.forEach((p,i)=>{
    const tr = document.createElement('tr');
    if(p.profile==='anomaly'||p.profile==='dropout') tr.className='alert-row';
    const sv = p.profile==='dropout'?'bad':p.profile==='anomaly'?'warn':'good';
    let h = `<td class="pid"><span class="sv ${sv}"></span>${p.id}<span class="gb ${p.g}">${p.g==='exp'?'ì‹¤í—˜':'ëŒ€ì¡°'}</span><br><span style="font-size:10px;color:#9ca3af;font-weight:400;">${p.nm}</span></td>`;

    MET.forEach(m=>{
      const a = p.agg[m.k];
      if(!a||a.length<2){h+='<td class="ce">â€”</td>';return;}
      const first=a[0], last=a[a.length-1];
      if(first==null||last==null){h+='<td class="ce">â€”</td>';return;}
      const d=last-first;
      const g=(m.d==='down'&&d<0)||(m.d==='up'&&d>0);
      const b=(m.d==='down'&&d>2)||(m.d==='up'&&d<-2);
      const ar=d>0?'â†‘':d<0?'â†“':'';
      const c=g?'good':b?'bad':'neutral';
      const v=m.k==='steps'?(d>0?'+':'')+Math.round(d).toLocaleString():m.k==='comp'?(d>0?'+':'')+d.toFixed(0)+'%':(d>0?'+':'')+d.toFixed(1);
      const bg=g?'background:rgba(34,197,94,.04);':b?'background:rgba(239,68,68,.04);':'';
      const rv=m.k==='steps'?Math.round(last).toLocaleString():m.k==='comp'?last.toFixed(0)+'%':last.toFixed(1)+m.u;
      h+=`<td style="${bg}"><span class="cd ${c}">${ar}${v}</span><span class="cr">${rv}</span></td>`;
    });

    tr.innerHTML=h;
    tr.addEventListener('click',()=>openDetail(i));
    tBody.appendChild(tr);
  });
}

// ==================== ë””í…Œì¼ íŒ¨ë„ ====================
const panel=document.getElementById('detailPanel'),tableArea=document.getElementById('tableArea'),dpTitle=document.getElementById('dpTitle'),dpBody=document.getElementById('dpBody');
let selIdx=null;

function mkSVG(arr,color,w,h){
  const vd=arr.map((v,i)=>v!=null?{v,i}:null).filter(Boolean);
  if(vd.length<2)return`<svg width="${w}" height="${h}"><text x="${w/2}" y="${h/2+4}" text-anchor="middle" fill="#d1d5db" font-size="9">â€”</text></svg>`;
  const mn=Math.min(...vd.map(d=>d.v)),mx=Math.max(...vd.map(d=>d.v)),rg=mx-mn||1,pd=4;
  const pts=vd.map(d=>{const x=pd+(d.i/(arr.length-1))*(w-pd*2);const y=pd+(1-(d.v-mn)/rg)*(h-pd*2);return`${x},${y}`;});
  return`<svg width="${w}" height="${h}"><polyline points="${pts.join(' ')}" fill="none" stroke="${color}" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
}

function openDetail(i){
  const windowDays = WINDOWS[currentTW];
  const patients = getWindowData(windowDays);
  const labels = getLabels(windowDays);
  selIdx=i;const p=patients[i];
  document.getElementById('tBody').querySelectorAll('tr').forEach((r,ri)=>r.classList.toggle('selected',ri===i));
  tableArea.classList.add('shrunk');panel.classList.add('open');
  const sv=p.profile==='dropout'?'bad':p.profile==='anomaly'?'warn':'good';
  dpTitle.innerHTML=`<span class="sv ${sv}"></span>${p.id} ${p.nm} <span class="gb ${p.g}">${p.g==='exp'?'ì‹¤í—˜':'ëŒ€ì¡°'}</span>`;

  let ch=MET.slice(0,3).map(m=>{
    const a=p.agg[m.k]||[];
    return`<div class="chart-card"><div class="chart-card-title"><span class="cs" style="background:${m.sc};"></span>${m.n}</div><div class="mini-chart">${mkSVG(a,m.sc,260,80)}</div><div class="chart-x">${labels.filter((_,j)=>j%(Math.ceil(labels.length/6))===0||j===labels.length-1).map(w=>`<span>${w}</span>`).join('')}</div></div>`;
  }).join('');

  let fs=`<div class="fs-title">ğŸ“‹ í”Œë¡œìš°ì‹œíŠ¸ (${labels.length}í¬ì¸íŠ¸)</div><div style="overflow-x:auto;"><table class="fs-table"><thead><tr><th>ì§€í‘œ</th>`;
  const showLabels = labels.length>12 ? labels.filter((_,j)=>j%Math.ceil(labels.length/12)===0||j===labels.length-1) : labels;
  const showIdxs = labels.length>12 ? labels.map((_,j)=>j).filter(j=>j%Math.ceil(labels.length/12)===0||j===labels.length-1) : labels.map((_,j)=>j);
  showLabels.forEach(w=>fs+=`<th>${w}</th>`);
  fs+='</tr></thead><tbody>';
  MET.forEach(m=>{
    const a=p.agg[m.k]||[];
    fs+=`<tr><td>${m.n}</td>`;
    showIdxs.forEach(j=>{
      const v=a[j];
      if(v==null){fs+='<td class="ce">â€”</td>';return;}
      const fmt=m.k==='steps'?Math.round(v).toLocaleString():m.k==='comp'?v.toFixed(0):v.toFixed(1);
      fs+=`<td>${fmt}</td>`;
    });
    fs+='</tr>';
  });
  fs+='</tbody></table></div>';
  dpBody.innerHTML=ch+fs;
}

document.getElementById('dpClose').addEventListener('click',()=>{panel.classList.remove('open');tableArea.classList.remove('shrunk');document.getElementById('tBody').querySelectorAll('tr').forEach(r=>r.classList.remove('selected'));selIdx=null;});
document.getElementById('dpPrev').addEventListener('click',()=>{if(selIdx>0)openDetail(selIdx-1);});
document.getElementById('dpNext').addEventListener('click',()=>{if(selIdx<PATIENTS.length-1)openDetail(selIdx+1);});

// ==================== ì—°êµ¬ì ê´€ì  ë¶„ì„ ====================
function updateAnalysis(){
  const ap = document.getElementById('apBody');
  const tw = currentTW;

  // ê° ìœˆë„ìš°ë³„ ë°ì´í„° íŠ¹ì„± ë¶„ì„
  const analyses = {
    d: analyzeWindow(1, 'D'),
    w: analyzeWindow(7, 'W'),
    m: analyzeWindow(28, 'M'),
    c3: analyzeWindow(3, '3d'),
  };

  const a = analyses[tw];
  const twNames = {d:'ì¼ê°„(84í¬ì¸íŠ¸)',w:'ì£¼ê°„(12í¬ì¸íŠ¸)',m:'ì›”ê°„(3í¬ì¸íŠ¸)',c3:'3ì¼(28í¬ì¸íŠ¸)'};

  let html = `<h4>í˜„ì¬: ${twNames[tw]}</h4>`;
  html += a.findings.map(f=>`<div class="finding">${f}</div>`).join('');
  html += a.problems.map(p=>`<div class="problem">${p}</div>`).join('');

  html += `<h4>ìœˆë„ìš° ê°„ ë¹„êµ</h4>`;
  html += `<div class="insight"><span class="tw-tag d">ì¼ê°„</span> 84í¬ì¸íŠ¸ â€” ${analyses.d.summary}</div>`;
  html += `<div class="insight"><span class="tw-tag w">ì£¼ê°„</span> 12í¬ì¸íŠ¸ â€” ${analyses.w.summary}</div>`;
  html += `<div class="insight"><span class="tw-tag m">ì›”ê°„</span> 3í¬ì¸íŠ¸ â€” ${analyses.m.summary}</div>`;
  html += `<div class="insight"><span class="tw-tag c3">3ì¼</span> 28í¬ì¸íŠ¸ â€” ${analyses.c3.summary}</div>`;

  html += `<h4>ì—°êµ¬ì  ë°œê²¬</h4>`;
  html += `<div class="finding">âœ… <b>ì£¼ë§ íš¨ê³¼ ë°œê²¬:</b> ì¼ê°„/3ì¼ ìœˆë„ìš°ì—ì„œë§Œ ë³´ì„. ê±¸ìŒìˆ˜ ì£¼ë§ âˆ’15%, ìˆœì‘ë„ âˆ’3%. ì£¼ê°„ ì§‘ê³„ ì‹œ ìŠ¤ë¬´ë”©ë˜ì–´ ì†Œì‹¤.</div>`;
  html += `<div class="finding">âœ… <b>P018 SBP ë°˜ë“±:</b> ì›”ê°„ì—ì„œëŠ” "ì•½ê°„ ë†’ìŒ" ìˆ˜ì¤€ì´ì§€ë§Œ, ì£¼ê°„/3ì¼ì—ì„œëŠ” W7ë¶€í„° ê¸‰ë°˜ë“± íŒ¨í„´ ëª…í™•. ì¼ê°„ì—ì„œëŠ” ë…¸ì´ì¦ˆ ì†ì— ë¬»í˜.</div>`;
  html += `<div class="finding">âœ… <b>P031 ë“œë¡­ì•„ì›ƒ íŒ¨í„´:</b> ì›”ê°„ì—ì„œëŠ” M3ì—ì„œì•¼ ë³´ì„ â†’ ë„ˆë¬´ ëŠ¦ìŒ. ì£¼ê°„ W9ë¶€í„° ìˆœì‘ë„ ê¸‰ë½ í¬ì°©. 3ì¼ ìœˆë„ìš°ê°€ ê°€ì¥ ë¹ ë¥¸ D50(3d-17)ì—ì„œ ê°ì§€.</div>`;
  html += `<div class="finding">âœ… <b>ì‹¤í—˜êµ° ì²´ì¤‘ ê°ì†Œ ê³¡ì„ :</b> ì›”ê°„(3í¬ì¸íŠ¸)ì€ ì§ì„ ì— ë¶ˆê³¼. ì£¼ê°„(12í¬ì¸íŠ¸)ì€ ê°ì†Œ ê°€ì† êµ¬ê°„(W4~W8) í¬ì°©. 3ì¼ì€ ì£¼ì¤‘ í”Œë˜í†  + ì£¼ë§ ìš”ìš” íŒ¨í„´ê¹Œì§€ í¬ì°©.</div>`;

  html += `<h4>ë°œê²¬ëœ UX ë¬¸ì œì </h4>`;
  html += `<div class="problem">âŒ <b>ì¼ê°„ 84í¬ì¸íŠ¸:</b> Xì¶• ë¼ë²¨ ê²¹ì¹¨, ìŠ¤íŒŒê²Œí‹° ë¼ì¸ì´ "ë…¸ì´ì¦ˆ ë©ì–´ë¦¬"ë¡œ ë³´ì„. ê°œë³„ í™˜ì ê¶¤ì  ì‹ë³„ ë¶ˆê°€. ì—°êµ¬ì í”¼ë¡œë„ ê·¹ì‹¬.</div>`;
  html += `<div class="problem">âŒ <b>ì›”ê°„ 3í¬ì¸íŠ¸:</b> í¬ì¸íŠ¸ê°€ ë„ˆë¬´ ì ì–´ ì§ì„ . íŠ¸ë Œë“œ ë°©í–¥ë§Œ ë³´ì´ê³  ë³€ê³¡ì Â·ì´ìƒì¹˜Â·íŒ¨í„´ ì „ë¶€ ì†Œì‹¤. ì—°êµ¬ì  ê°€ì¹˜ ë‚®ìŒ.</div>`;
  html += `<div class="problem">âŒ <b>3ì¼ ìœˆë„ìš°:</b> ì£¼ë§ íŒ¨í„´ì´ 3ì¼ ë¬¶ìŒ ìœ„ì¹˜ì— ë”°ë¼ ë“¤ì­‰ë‚ ì­‰. ì›”-ìˆ˜/ëª©-í† /ì¼-í™” ì¤‘ ì–´ëŠ ë¬¶ìŒì¸ì§€ì— ë”°ë¼ ê°’ì´ ë‹¬ë¼ì§ â†’ ì‹œì‘ì¼ ê¸°ì¤€ì  ë¬¸ì œ.</div>`;
  html += `<div class="problem">âŒ <b>ì‹œê°„ ìœˆë„ìš° ì „í™˜ ì‹œ Î´ê°’ ë³€í™”:</b> ì²´ì¤‘ Î”ê°€ ìœˆë„ìš°ë§ˆë‹¤ ë¯¸ì„¸í•˜ê²Œ ë‹¤ë¦„ (ì¼ê°„ í‰ê·  vs ì£¼ê°„ í‰ê·  vs ì›”ê°„ í‰ê· ). ì—°êµ¬ìê°€ "ì–´ë–¤ ê²Œ ì§„ì§œ?"ë¼ê³  í˜¼ë€.</div>`;
  html += `<div class="problem">âŒ <b>í…Œì´ë¸” í”Œë¡œìš°ì‹œíŠ¸:</b> ì¼ê°„ 84ì—´ì€ ê°€ë¡œ ìŠ¤í¬ë¡¤ í­ë°œ. 3ì¼ 28ì—´ë„ ì¢ìŒ. í…Œì´ë¸”ì—ì„œì˜ ì¼ê°„ì€ ì‚¬ì‹¤ìƒ ë¶ˆê°€.</div>`;
  html += `<div class="problem">âŒ <b>ì»¨í…ìŠ¤íŠ¸ ë„¤ë¹„ê²Œì´í„° ë¼ë²¨:</b> ì¼ê°„ì¼ ë•Œ "D47"ì´ ì–¸ì œì¸ì§€ ì§ê´€ì ì´ì§€ ì•ŠìŒ â†’ ë‚ ì§œ(1/15) ë³‘ê¸° í•„ìš”. 3ì¼ë„ ë§ˆì°¬ê°€ì§€.</div>`;

  html += `<h4>ê²°ë¡  & ê¶Œì¥</h4>`;
  html += `<div class="insight">ğŸ¯ <b>ì£¼ê°„ì´ ë””í´íŠ¸ë¡œ ìµœì .</b> 12í¬ì¸íŠ¸ëŠ” ì‹œê°ì ìœ¼ë¡œ ê¹”ë”í•˜ê³ , ì£¼ìš” íŠ¸ë Œë“œ + ë³€ê³¡ì  + ì´ìƒì¹˜ ëª¨ë‘ í¬ì°©. ì£¼ë§ íš¨ê³¼ë§Œ ìŠ¤ë¬´ë”©ë¨.</div>`;
  html += `<div class="insight">ğŸ¯ <b>ê°œìš” íƒ­ì€ ì£¼ê°„ ê³ ì •, í…Œì´ë¸” íƒ­ë§Œ ì‹œê°„ ìœˆë„ìš° ë³€ê²½ í—ˆìš©</b> â€” ì´ ì„¤ê³„ê°€ ë§ë‹¤. ê°œìš”ì—ì„œ ì‹œê°„ ìœˆë„ìš°ë¥¼ ë°”ê¾¸ë©´ pê°’/KPI ë“±ì˜ í•´ì„ì´ ë‹¬ë¼ì ¸ í˜¼ë€.</div>`;
  html += `<div class="insight">ğŸ¯ <b>ì¼ê°„ì€ "ë“œë¦´ë‹¤ìš´"ìœ¼ë¡œë§Œ ì œê³µ.</b> ê°œë³„ í™˜ì ë””í…Œì¼ íŒ¨ë„ì—ì„œ, íŠ¹ì • ì£¼ê°„ì„ í´ë¦­í•˜ë©´ ê·¸ ì£¼ì˜ ì¼ê°„ ë°ì´í„°ë¥¼ í¼ì¹˜ëŠ” ë°©ì‹.</div>`;
  html += `<div class="insight">ğŸ¯ <b>ì»¤ìŠ¤í…€ì€ ì—°êµ¬ í”„ë¡œí† ì½œ ê¸°ë°˜ìœ¼ë¡œ.</b> "ë§¤ 3ì¼" ê°™ì€ ì„ì˜ ìœˆë„ìš°ë³´ë‹¤, "íˆ¬ì•½ ì‚¬ì´í´(ë§¤ 14ì¼)" ê°™ì€ ì˜ë¯¸ ìˆëŠ” ë‹¨ìœ„ë¥¼ í”„ë¡œí† ì½œì—ì„œ ìë™ ì¶”ì¶œ.</div>`;

  ap.innerHTML = html;
}

function analyzeWindow(windowDays, prefix){
  const patients = getWindowData(windowDays);
  const labels = getLabels(windowDays);
  const n = labels.length;
  const exp = patients.filter(p=>p.g==='exp');
  const ctrl = patients.filter(p=>p.g==='ctrl');

  const findings = [];
  const problems = [];

  // ìŠ¤íŒŒê²Œí‹° ê°€ë…ì„±
  if(n > 40){
    problems.push(`ğŸ“Š ${n}í¬ì¸íŠ¸: Xì¶•ì´ ê³¼ë°€. ë¼ë²¨ 7ê°œë‹¹ 1ê°œë§Œ í‘œì‹œ ê°€ëŠ¥. ê°œë³„ ë¼ì¸ì´ ë…¸ì´ì¦ˆ ë©ì–´ë¦¬.`);
    findings.push(`ğŸ” ì¼ê°„ ë³€ë™ì˜ ë””í…Œì¼ì€ ë³´ì´ë‚˜, ì‹ í˜¸(signal) ëŒ€ ì¡ìŒ(noise) ë¹„ìœ¨ ë‚®ìŒ.`);
  } else if(n <= 4){
    problems.push(`ğŸ“Š ${n}í¬ì¸íŠ¸: ë„ˆë¬´ ì ì–´ ì§ì„ . ë³€ê³¡ì /ì´ìƒì¹˜ ì‹ë³„ ë¶ˆê°€. ì‹œê°ì  ì •ë³´ëŸ‰ ê·¹íˆ ë‚®ìŒ.`);
  } else if(n <= 14){
    findings.push(`ğŸ“Š ${n}í¬ì¸íŠ¸: ì ì ˆí•œ ë°€ë„. íŠ¸ë Œë“œ + ë³€ê³¡ì  + ê°œë³„ í¸ì°¨ ëª¨ë‘ ì‹œê°í™” ê°€ëŠ¥.`);
  } else {
    findings.push(`ğŸ“Š ${n}í¬ì¸íŠ¸: ì¤‘ê°„ ë°€ë„. ì£¼ì¤‘/ì£¼ë§ íŒ¨í„´ ì¼ë¶€ í¬ì°© ê°€ëŠ¥í•˜ë‚˜, Xì¶• ë¼ë²¨ ì¡°ì • í•„ìš”.`);
  }

  // P018 SBP ë°˜ë“± ê°ì§€ë ¥
  const p018 = patients.find(p=>p.id==='P018');
  if(p018){
    const sbp = p018.agg.sbp;
    const mid = Math.floor(sbp.length/2);
    const firstHalf = sbp.slice(0,mid).filter(v=>v!=null);
    const secondHalf = sbp.slice(mid).filter(v=>v!=null);
    if(firstHalf.length && secondHalf.length){
      const fAvg = firstHalf.reduce((a,b)=>a+b,0)/firstHalf.length;
      const sAvg = secondHalf.reduce((a,b)=>a+b,0)/secondHalf.length;
      if(sAvg > fAvg+1){
        findings.push(`ğŸš¨ P018 SBP ë°˜ë“± ê°ì§€: ì „ë°˜ í‰ê·  ${fAvg.toFixed(1)} â†’ í›„ë°˜ ${sAvg.toFixed(1)} (+${(sAvg-fAvg).toFixed(1)}). ${n>6?'íŒ¨í„´ ëª…í™•':'í¬ì¸íŠ¸ ë¶€ì¡±ìœ¼ë¡œ ëª¨í˜¸'}.`);
      }
    }
  }

  // P031 ë“œë¡­ì•„ì›ƒ ê°ì§€ ì‹œì 
  const p031 = patients.find(p=>p.id==='P031');
  if(p031){
    const comp = p031.agg.comp;
    let dropIdx = comp.findIndex((v,i)=>i>0&&v!=null&&comp[0]!=null&&v<comp[0]-5);
    if(dropIdx>=0){
      findings.push(`ğŸ“‰ P031 ìˆœì‘ë„ ê¸‰ë½ ìµœì´ˆ ê°ì§€: ${labels[dropIdx]} (${prefix}${dropIdx+1}). ${n>6?'ì¡°ê¸° ê°œì… ê°€ëŠ¥':'ë„ˆë¬´ ëŠ¦ì€ ê°ì§€'.split('')}`);
    }
  }

  const summary = n>40 ? 'ë””í…Œì¼ í’ë¶€í•˜ë‚˜ ë…¸ì´ì¦ˆ ê³¼ë‹¤. ê°œìš” ë¶€ì í•©, ë””í…Œì¼ ë“œë¦´ë‹¤ìš´ìš©.' :
                  n<=4 ? 'ì •ë³´ëŸ‰ ê·¹íˆ ë¶€ì¡±. ë°©í–¥ì„±ë§Œ íŒŒì•… ê°€ëŠ¥.' :
                  n<=14 ? 'ì‹ í˜¸/ì¡ìŒ ë¹„ìœ¨ ìµœì . ì—°êµ¬ì  íŒë‹¨ì— ì¶©ë¶„í•œ ì •ë³´ ë°€ë„.' :
                  'ì¤‘ê°„ ë°€ë„. ì¼ë¶€ ë¯¸ì‹œ íŒ¨í„´ í¬ì°© ê°€ëŠ¥í•˜ë‚˜ ê°€ë…ì„± trade-off.';

  return {findings, problems, summary};
}

// ==================== ì´ˆê¸°í™” ====================
setTimeout(()=>{
  drawChart();
  renderTable();
  updateAnalysis();
},100);
window.addEventListener('resize',drawChart);

// ë¶„ì„ íŒ¨ë„ í† ê¸€
document.getElementById('apToggle').addEventListener('click',()=>{
  const p = document.getElementById('analysisPanel');
  p.classList.toggle('hidden');
  document.getElementById('apBtn').textContent = p.classList.contains('hidden')?'â–²':'â–¼';
});
</script>
</body>
</html>
