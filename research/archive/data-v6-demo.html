<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UniQdata â€” v6 ê°œìš”(ë©€í‹°ê·¸ë˜í”„) + í…Œì´ë¸”</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#f5f5f5;color:#1f2937;}
.layout{display:flex;height:100vh;overflow:hidden;}

/* ì‚¬ì´ë“œë°” */
.sidebar{width:220px;background:linear-gradient(180deg,#0f172a,#1e293b);color:white;display:flex;flex-direction:column;flex-shrink:0;}
.logo{padding:16px 20px;font-size:18px;font-weight:700;border-bottom:1px solid rgba(255,255,255,.1);display:flex;align-items:center;gap:8px;}
.logo-icon{width:28px;height:28px;background:linear-gradient(135deg,#3b82f6,#8b5cf6);border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:14px;}
.nav-section{padding:12px;border-bottom:1px solid rgba(255,255,255,.05);}
.nav-item{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:6px;color:#94a3b8;cursor:pointer;font-size:13px;}
.rn-header{display:flex;align-items:center;gap:6px;padding:6px 10px;border-radius:6px;font-size:12px;color:#60a5fa;background:rgba(59,130,246,.1);}
.rn-sub{padding-left:16px;margin-top:3px;border-left:2px solid rgba(255,255,255,.1);margin-left:14px;}
.ns-item{display:flex;align-items:center;gap:6px;padding:6px 10px;border-radius:5px;color:#94a3b8;font-size:11px;cursor:pointer;margin-bottom:1px;}
.ns-item:hover{background:rgba(255,255,255,.05);}
.ns-item.active{background:rgba(59,130,246,.15);color:#60a5fa;}
.sidebar-footer{margin-top:auto;padding:12px;border-top:1px solid rgba(255,255,255,.05);}
.u-info{display:flex;align-items:center;gap:10px;padding:6px;}
.u-av{width:32px;height:32px;background:linear-gradient(135deg,#3b82f6,#8b5cf6);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;}

/* ë©”ì¸ */
.main{flex:1;overflow:hidden;display:flex;flex-direction:column;}
.content{padding:20px;flex:1;display:flex;flex-direction:column;overflow:hidden;min-height:0;}
.breadcrumb{display:flex;align-items:center;gap:6px;margin-bottom:6px;font-size:12px;color:#6b7280;flex-shrink:0;}
.breadcrumb a{color:#3b82f6;text-decoration:none;}
.page-title{font-size:18px;font-weight:700;margin-bottom:1px;flex-shrink:0;}
.page-sub{color:#6b7280;font-size:12px;margin-bottom:10px;flex-shrink:0;}

.tabs{display:flex;border-bottom:2px solid #e5e7eb;margin-bottom:10px;flex-shrink:0;}
.tab{padding:8px 20px;font-size:13px;color:#6b7280;cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;font-weight:500;user-select:none;}
.tab.active{color:#3b82f6;border-bottom-color:#3b82f6;}
.tab:hover{color:#374151;}

.tab-content{display:none;flex:1;min-height:0;overflow:hidden;}
.tab-content.active{display:flex;flex-direction:column;flex:1;min-height:0;}

/* ========== ê°œìš”: KPI ========== */
.kpi-strip{display:flex;gap:8px;margin-bottom:10px;flex-shrink:0;}
.kpi-chip{background:white;border:1px solid #e5e7eb;border-radius:8px;padding:7px 12px;display:flex;align-items:center;gap:8px;flex:1;min-width:0;}
.kpi-chip .kv{font-size:17px;font-weight:700;white-space:nowrap;}
.kpi-chip .kl{font-size:10px;color:#6b7280;}
.kpi-chip .kc{font-size:9px;margin-top:1px;}
.kc.good{color:#16a34a;}.kc.warn{color:#d97706;}

/* ========== ê°œìš”: ê·¸ë˜í”„ ê·¸ë¦¬ë“œ ========== */
.chart-grid{flex:1;display:grid;grid-template-columns:repeat(3,1fr);grid-template-rows:repeat(2,1fr);gap:8px;min-height:0;transition:all .3s ease;}
.chart-grid.has-expanded{grid-template-columns:1fr;grid-template-rows:1fr;}

.chart-cell{background:white;border:1px solid #e5e7eb;border-radius:10px;overflow:hidden;display:flex;flex-direction:column;cursor:pointer;transition:all .3s ease;min-height:0;position:relative;}
.chart-cell:hover{border-color:#93c5fd;box-shadow:0 2px 8px rgba(59,130,246,.1);}
.chart-cell.expanded{grid-column:1/-1;grid-row:1/-1;cursor:default;z-index:10;}
.chart-cell.collapsed{display:none;}

.cc-header{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;flex-shrink:0;}
.cc-title{font-size:12px;font-weight:600;color:#374151;display:flex;align-items:center;gap:5px;}
.cc-title .dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;}
.cc-badge{font-size:9px;font-weight:600;padding:2px 6px;border-radius:3px;white-space:nowrap;}
.cc-badge.sig{background:#dcfce7;color:#166534;}.cc-badge.ns{background:#f3f4f6;color:#6b7280;}
.cc-meta{display:flex;gap:6px;align-items:center;}
.cc-delta{font-size:10px;font-weight:600;font-family:'SF Mono',Monaco,monospace;}
.cc-delta.good{color:#16a34a;}.cc-delta.bad{color:#dc2626;}.cc-delta.neutral{color:#6b7280;}
.cc-close{display:none;padding:3px 7px;border:1px solid #e5e7eb;border-radius:5px;background:white;cursor:pointer;font-size:11px;color:#6b7280;}
.chart-cell.expanded .cc-close{display:block;}

.cc-body{flex:1;position:relative;min-height:0;padding:2px 8px 4px;}
.cc-canvas{width:100%;height:100%;}

.cc-footer{display:flex;justify-content:space-between;align-items:center;padding:4px 12px 6px;font-size:9px;color:#9ca3af;flex-shrink:0;}
.cc-legend{display:flex;gap:8px;align-items:center;}
.lg{display:flex;align-items:center;gap:2px;}
.lg-line{width:12px;height:2px;border-radius:1px;}
.lg-line.thin{height:1px;opacity:.4;}

/* ìˆ˜ì§‘ë¥  */
.collection-strip{display:flex;align-items:center;gap:6px;padding:6px 0;font-size:9px;color:#6b7280;flex-shrink:0;}
.cs-bar{display:flex;flex:1;height:4px;background:#f3f4f6;border-radius:2px;overflow:hidden;}
.cs-seg{height:100%;}

/* ========== í…Œì´ë¸” íƒ­ ========== */
.table-area-wrap{display:flex;flex:1;min-height:0;overflow:hidden;}
.table-area{flex:1;min-width:0;overflow-y:auto;overflow-x:auto;display:flex;flex-direction:column;transition:flex .3s ease;}
.table-area.shrunk{flex:0 0 50%;}
.ctrl-section{background:white;border:1px solid #e5e7eb;border-radius:10px;padding:10px 16px;margin-bottom:8px;flex-shrink:0;}
.ctrl-row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;}
.ctrl-group{display:flex;align-items:center;gap:6px;}
.ctrl-group label{font-size:11px;color:#6b7280;font-weight:600;}
.t-btn{padding:4px 8px;border:1px solid #e5e7eb;border-radius:5px;background:white;color:#6b7280;cursor:pointer;font-size:11px;}
.t-btn.active{background:#3b82f6;color:white;border-color:#3b82f6;}
.sel-sm{padding:4px 6px;border:1px solid #e5e7eb;border-radius:5px;font-size:11px;color:#374151;background:white;}
.dn-ctrl{display:flex;align-items:center;gap:4px;padding:4px 8px;background:#f9fafb;border:1px solid #e5e7eb;border-radius:5px;font-size:11px;}
.dn-ctrl button{background:none;border:none;cursor:pointer;font-size:12px;color:#3b82f6;padding:0 2px;}
.search-in{padding:4px 6px;border:1px solid #e5e7eb;border-radius:5px;font-size:11px;width:120px;}

.src-legend{display:flex;gap:10px;align-items:center;margin-bottom:4px;font-size:10px;color:#6b7280;flex-shrink:0;}
.sd{width:7px;height:7px;border-radius:2px;display:inline-block;}
.sd.emr{background:#3b82f6;}.sd.wear{background:#22c55e;}.sd.ema{background:#a855f7;}.sd.ext{background:#f97316;}

.tbl-section{background:white;border:1px solid #e5e7eb;border-radius:10px;overflow:hidden;flex:1;display:flex;flex-direction:column;margin-bottom:8px;min-height:0;}
.tbl-wrap{overflow-y:auto;overflow-x:auto;flex:1;min-height:0;}
table.pt-tbl{width:100%;border-collapse:collapse;font-size:12px;}
table.pt-tbl thead th{text-align:left;font-size:10px;color:#6b7280;font-weight:600;padding:7px 6px;border-bottom:2px solid #e5e7eb;background:#f9fafb;position:sticky;top:0;z-index:10;white-space:nowrap;}
table.pt-tbl thead th .cs{display:inline-block;width:5px;height:5px;border-radius:2px;margin-right:2px;vertical-align:middle;}
table.pt-tbl tbody td{padding:7px 6px;border-bottom:1px solid #f1f5f9;font-size:11px;}
table.pt-tbl tbody tr{cursor:pointer;transition:background .1s;}
table.pt-tbl tbody tr:hover{background:#f8fafc;}
table.pt-tbl tbody tr.selected{background:#eff6ff;}
table.pt-tbl tbody tr.alert-row{background:#fffbeb;}
.pid{font-weight:600;color:#374151;white-space:nowrap;}
.gb{display:inline-block;padding:1px 4px;border-radius:3px;font-size:9px;font-weight:600;margin-left:4px;}
.gb.exp{background:#dbeafe;color:#1d4ed8;}.gb.ctrl{background:#fce7f3;color:#be185d;}
.sv{display:inline-block;width:5px;height:5px;border-radius:50%;margin-right:4px;}
.sv.good{background:#22c55e;}.sv.warn{background:#f59e0b;}.sv.bad{background:#ef4444;}
.cd{font-weight:700;font-family:'SF Mono',Monaco,monospace;font-size:11px;}
.cd.good{color:#16a34a;}.cd.bad{color:#dc2626;}.cd.neutral{color:#6b7280;}
.cr{font-size:10px;color:#9ca3af;display:block;margin-top:1px;}
.ce{color:#d1d5db;font-style:italic;}
.pag-row{display:flex;align-items:center;justify-content:space-between;padding:8px 16px;background:white;border:1px solid #e5e7eb;border-radius:10px;font-size:11px;color:#6b7280;flex-shrink:0;}
.pag-btns{display:flex;gap:2px;}
.pg-btn{padding:3px 6px;border:1px solid #e5e7eb;border-radius:3px;background:white;color:#6b7280;cursor:pointer;font-size:10px;}
.pg-btn.active{background:#3b82f6;color:white;border-color:#3b82f6;}

/* ë””í…Œì¼ íŒ¨ë„ */
.detail-panel{width:0;overflow:hidden;border-left:1px solid #e5e7eb;background:white;transition:width .3s ease;flex-shrink:0;display:flex;flex-direction:column;max-height:100%;}
.detail-panel.open{width:50%;overflow-y:hidden;}
.dp-header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #e5e7eb;background:#f9fafb;flex-shrink:0;}
.dp-title{font-size:14px;font-weight:700;color:#374151;display:flex;align-items:center;gap:5px;}
.dp-close{padding:4px 8px;border:1px solid #e5e7eb;border-radius:5px;background:white;cursor:pointer;font-size:12px;color:#6b7280;}
.dp-nav{display:flex;gap:4px;}
.dp-nav button{padding:2px 6px;border:1px solid #e5e7eb;border-radius:5px;background:white;cursor:pointer;font-size:11px;color:#374151;}
.dp-body{flex:1;overflow-y:auto;padding:14px;}
.chart-card{background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:12px;margin-bottom:12px;}
.chart-card-title{font-size:11px;font-weight:600;color:#374151;margin-bottom:6px;}
.mini-chart{height:70px;}
.mini-chart svg{width:100%;height:100%;}
.chart-x{display:flex;justify-content:space-between;font-size:8px;color:#9ca3af;margin-top:2px;}
.chart-sum{display:flex;gap:10px;margin-top:4px;font-size:10px;color:#6b7280;}
.chart-sum strong{color:#374151;}
.fs-title{font-size:11px;font-weight:600;color:#374151;margin:12px 0 6px;}
.fs-table{width:100%;border-collapse:collapse;font-size:10px;}
.fs-table th{font-size:9px;color:#9ca3af;font-weight:600;padding:3px 4px;border-bottom:1px solid #e5e7eb;text-align:center;}
.fs-table th:first-child{text-align:left;}
.fs-table td{padding:3px 4px;text-align:center;border-bottom:1px solid #f1f5f9;font-family:'SF Mono',Monaco,monospace;font-size:9px;}
.fs-table td:first-child{text-align:left;font-weight:600;color:#374151;font-family:-apple-system,sans-serif;}
.fg{color:#16a34a;background:rgba(34,197,94,.05);}.fb{color:#dc2626;background:rgba(239,68,68,.05);}.fc{font-weight:700;outline:1.5px solid #3b82f6;border-radius:2px;}
</style>
</head>
<body>
<div class="layout">
  <nav class="sidebar">
    <div class="logo"><div class="logo-icon">U</div> UniQdata</div>
    <div class="nav-section"><a class="nav-item"><span>ğŸ </span> ì—°êµ¬ í—ˆë¸Œ</a></div>
    <div class="nav-section" style="flex:1;overflow-y:auto;">
      <div style="font-size:10px;text-transform:uppercase;color:#64748b;padding:6px 10px;">ë‚´ ì—°êµ¬</div>
      <div>
        <div class="rn-header"><span style="font-size:12px;">ğŸ“</span><span style="flex:1;">ëŒ€ì‚¬ê°œì„  ì•½ë¬¼ ì—°êµ¬</span></div>
        <div class="rn-sub">
          <a class="ns-item active" id="nav-ov">ê°œìš”</a>
          <a class="ns-item" id="nav-tb">í…Œì´ë¸”</a>
          <a class="ns-item">ğŸ”’ í´ë¦°ë£¸</a>
        </div>
      </div>
    </div>
    <div class="sidebar-footer"><div class="u-info"><div class="u-av">ê¹€</div><div><div style="font-size:13px;color:#e2e8f0;">ê¹€ì—°êµ¬</div><div style="font-size:11px;color:#64748b;">ì„œìš¸ëŒ€í•™êµë³‘ì›</div></div></div></div>
  </nav>

  <main class="main">
    <div class="content">
      <div class="breadcrumb"><a href="#">ì—°êµ¬ ê´€ë¦¬</a> / <span>ëŒ€ì‚¬ê°œì„  ì•½ë¬¼ ì—°êµ¬</span></div>
      <div class="page-title">ì—°êµ¬ ë°ì´í„°</div>
      <div class="page-sub">ì²˜ë°© ì•½ë¬¼(2.4mg) ëŒ€ì‚¬ê°œì„  ì—°êµ¬ Â· RCT Â· ì‹¤í—˜ 40 / ëŒ€ì¡° 40 Â· 12ì£¼</div>

      <div class="tabs">
        <div class="tab active" data-tab="overview" id="tab-ov">ê°œìš”</div>
        <div class="tab" data-tab="table" id="tab-tb">í…Œì´ë¸”</div>
        <div class="tab">ğŸ”’ í´ë¦°ë£¸</div>
      </div>

      <!-- ===== ê°œìš” íƒ­ ===== -->
      <div class="tab-content active" id="tc-ov">
        <div class="kpi-strip">
          <div class="kpi-chip"><div><div class="kv">1.89<span style="font-size:11px;">M</span></div><div class="kl">ì´ ë ˆì½”ë“œ</div></div></div>
          <div class="kpi-chip"><div><div class="kv">94<span style="font-size:11px;">%</span></div><div class="kl">ì»¤ë²„ë¦¬ì§€</div><div class="kc good">+2.1%</div></div></div>
          <div class="kpi-chip"><div><div class="kv">6.2<span style="font-size:11px;">%</span></div><div class="kl">ê²°ì¸¡ë¥ </div><div class="kc good">âˆ’0.8%</div></div></div>
          <div class="kpi-chip"><div><div class="kv">76<span style="font-size:11px;">/80</span></div><div class="kl">ì°¸ì—¬ì</div></div></div>
        </div>

        <!-- ê·¸ë˜í”„ ê·¸ë¦¬ë“œ: 3Ã—2 = 6ì¹¸ -->
        <div class="chart-grid" id="chartGrid"></div>

        <div class="collection-strip">
          <span>ìˆ˜ì§‘ë¥ </span>
          <div class="cs-bar">
            <div class="cs-seg" style="width:47%;background:#3b82f6;"></div>
            <div class="cs-seg" style="width:42%;background:#22c55e;"></div>
            <div class="cs-seg" style="width:7%;background:#a855f7;"></div>
            <div class="cs-seg" style="width:1%;background:#f97316;"></div>
            <div class="cs-seg" style="width:3%;background:#e5e7eb;"></div>
          </div>
          <span>94%</span>
        </div>
      </div>

      <!-- ===== í…Œì´ë¸” íƒ­ ===== -->
      <div class="tab-content" id="tc-tb">
        <div class="ctrl-section">
          <div class="ctrl-row">
            <div class="ctrl-group">
              <label>ì‹œê°„</label>
              <div style="display:flex;gap:2px;">
                <button class="t-btn tw-tbl active" data-tw="w">ì£¼ê°„</button>
                <button class="t-btn tw-tbl" data-tw="m">ì›”ê°„</button>
              </div>
            </div>
            <div class="ctrl-group">
              <label>ì†ŒìŠ¤</label>
              <select class="sel-sm"><option>ì „ì²´</option><option>[EMR]</option><option>[ì›¨ì–´ëŸ¬ë¸”]</option><option>[EMA]</option></select>
            </div>
            <div class="ctrl-group">
              <div class="dn-ctrl"><button>â—€</button><span>2ì›” 2ì£¼ (W6)</span><button>â–¶</button></div>
            </div>
            <div class="ctrl-group" style="margin-left:auto;">
              <input type="text" class="search-in" placeholder="í™˜ì ê²€ìƒ‰...">
            </div>
          </div>
        </div>
        <div class="src-legend">
          <span><span class="sd emr"></span> EMR</span>
          <span><span class="sd wear"></span> ì›¨ì–´ëŸ¬ë¸”</span>
          <span><span class="sd ema"></span> EMA</span>
          <span><span class="sd ext"></span> ì™¸ë¶€</span>
          <span style="margin-left:auto;color:#9ca3af;">í–‰ í´ë¦­ â†’ ìš°ì¸¡ ìƒì„¸</span>
        </div>
        <div class="table-area-wrap">
          <div class="table-area" id="tableArea">
            <div class="tbl-section">
              <div class="tbl-wrap">
                <table class="pt-tbl">
                  <thead><tr>
                    <th style="width:13%;">í™˜ì</th>
                    <th><span class="cs" style="background:#3b82f6;"></span>ì²´ì¤‘</th>
                    <th><span class="cs" style="background:#3b82f6;"></span>SBP</th>
                    <th><span class="cs" style="background:#22c55e;"></span>ì‹¬ë°•ìˆ˜</th>
                    <th><span class="cs" style="background:#22c55e;"></span>ê±¸ìŒìˆ˜</th>
                    <th><span class="cs" style="background:#22c55e;"></span>ìˆ˜ë©´</th>
                    <th><span class="cs" style="background:#a855f7;"></span>ìˆœì‘ë„</th>
                    <th><span class="cs" style="background:#f97316;"></span>ì•±ì‚¬ìš©</th>
                  </tr></thead>
                  <tbody id="tBody"></tbody>
                </table>
              </div>
            </div>
            <div class="pag-row">
              <span>1-10 / 80ëª…</span>
              <div class="pag-btns"><button class="pg-btn">â—€</button><button class="pg-btn active">1</button><button class="pg-btn">2</button><button class="pg-btn">â€¦</button><button class="pg-btn">8</button><button class="pg-btn">â–¶</button></div>
            </div>
          </div>
          <div class="detail-panel" id="detailPanel">
            <div class="dp-header">
              <div class="dp-title" id="dpTitle"></div>
              <div style="display:flex;gap:4px;align-items:center;">
                <div class="dp-nav"><button id="dpPrev">â–²</button><button id="dpNext">â–¼</button></div>
                <button class="dp-close" id="dpClose">âœ•</button>
              </div>
            </div>
            <div class="dp-body" id="dpBody"></div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<script>
// ==================== ë°ì´í„° ====================
const WK=['W1','W2','W3','W4','W5','W6'];
const METRICS=[
  {k:'wt',  n:'ì²´ì¤‘',   u:'kg',   d:'down', src:'EMR',  sc:'#3b82f6', dotC:'#3b82f6'},
  {k:'sbp', n:'ìˆ˜ì¶•ê¸° í˜ˆì••', u:'mmHg', d:'down', src:'EMR',  sc:'#6366f1', dotC:'#6366f1'},
  {k:'hr',  n:'ì‹¬ë°•ìˆ˜',  u:'bpm',  d:'down', src:'ì›¨ì–´', sc:'#22c55e', dotC:'#22c55e'},
  {k:'steps',n:'ê±¸ìŒìˆ˜', u:'ë³´',   d:'up',   src:'ì›¨ì–´', sc:'#14b8a6', dotC:'#14b8a6'},
  {k:'comp',n:'ìˆœì‘ë„',  u:'%',    d:'up',   src:'EMA',  sc:'#a855f7', dotC:'#a855f7'},
  {k:'sleep',n:'ìˆ˜ë©´ì‹œê°„',u:'h',   d:'up',   src:'ì›¨ì–´', sc:'#f59e0b', dotC:'#f59e0b'},
];

const EXP=[
  {id:'P001',nm:'ê¹€ë¯¼ìˆ˜',wt:[87.3,85.8,84.2,82.5,80.8,79.2],sbp:[134,132,128,126,124,122],hr:[72,71,69,68,67,66],steps:[7340,7800,8200,8600,8900,9104],comp:[86,88,90,92,93,94],sleep:[6.2,6.5,6.8,7.0,7.1,7.3]},
  {id:'P005',nm:'ì´ìˆ˜ì§„',wt:[88.3,87.1,85.8,84.5,83.2,82.1],sbp:[132.5,131,129,127,125.5,124],hr:[72,71,70,70,69,69],steps:[6800,7100,7400,7600,7800,7812],comp:[85,87,88,89,90,90],sleep:[6.0,6.2,6.5,6.7,6.9,7.0]},
  {id:'P011',nm:'ë°•ì§€í›ˆ',wt:[88.3,86.8,85.2,83.5,82,80.8],sbp:[134.2,132,130,128,126.5,125],hr:[72,71,69,68,68,67],steps:[7000,7500,7800,8100,8300,8512],comp:[86,88,90,91,92,92],sleep:[6.5,6.6,6.8,7.0,7.2,7.4]},
  {id:'P018',nm:'ìµœì˜ˆë¦°',wt:[87.4,86.2,85,83.8,82.6,81.6],sbp:[137.9,136,135,138,139,140],hr:[70,69,null,null,68,null],steps:[5800,6000,6100,6200,6200,6234],comp:[82,84,86,88,89,89],sleep:[5.8,6.0,6.2,6.0,5.9,5.8]},
  {id:'P023',nm:'ì •í•˜ëŠ˜',wt:[87.6,86.4,85,83.6,82.4,81.2],sbp:[134.1,132,130,129,128,127],hr:[72,71,70,69,68,68],steps:[6900,7200,7500,7800,8000,8234],comp:[85,87,89,90,91,91],sleep:[6.3,6.5,6.7,6.9,7.1,7.2]},
];
const CTRL=[
  {id:'P002',nm:'ìœ¤ì„œì—°',wt:[87.7,87.8,87.9,88,88.1,88.2],sbp:[135.9,136,136.5,137,137.5,138],hr:[72,72,71,71,70,70],steps:[4600,4650,4700,4750,4800,4821],comp:[85,86,86,87,87,88],sleep:[6.1,6.0,6.0,5.9,5.9,5.8]},
  {id:'P008',nm:'í•œë„ìœ¤',wt:[87.9,87.8,87.6,87.4,87.2,87.1],sbp:[133.1,133.5,133.8,134,134.2,134],hr:[72,72,72,72,72,72],steps:[4200,4200,4180,4190,4200,4201],comp:[85,85,86,86,86,86],sleep:[6.5,6.4,6.4,6.3,6.3,6.2]},
  {id:'P014',nm:'ì†¡ì§€ì•„',wt:[87.9,87.8,87.8,87.8,87.8,87.8],sbp:[134.5,134.5,135,135,135,135],hr:[72,72,71,71,71,71],steps:[4500,4520,4550,4580,4600,4621],comp:[85,85,86,86,87,87],sleep:[6.2,6.2,6.1,6.1,6.0,6.0]},
  {id:'P031',nm:'ì„ì±„ì›',wt:[87.9,88,88.3,88.5,88.8,89.1],sbp:[134.2,135,136,137,137.5,138],hr:[73,73,74,74,75,75],steps:[4100,4000,3900,3850,3820,3821],comp:[84,82,80,78,75,72],sleep:[5.8,5.7,5.5,5.4,5.3,5.2]},
  {id:'P036',nm:'ê°•ì‹œìš°',wt:[87,87,86.9,86.9,86.8,86.8],sbp:[131.8,132,132.5,132.8,133,133],hr:[74,74,73,73,72,72],steps:[4400,4420,4450,4480,4500,4521],comp:[85,86,86,87,88,88],sleep:[6.4,6.3,6.3,6.2,6.2,6.1]},
];

const PVALS={wt:'p<0.001***',sbp:'p=0.012*',hr:'p=0.034*',steps:'p=0.008**',comp:'p=0.342',sleep:'p=0.028*'};
const PVALCLS={wt:'sig',sbp:'sig',hr:'sig',steps:'sig',comp:'ns',sleep:'sig'};

// ==================== ê°œìš”: ë©€í‹° ê·¸ë˜í”„ ê·¸ë¦¬ë“œ ====================
const grid = document.getElementById('chartGrid');
let expandedMetric = null;
const canvasMap = {};

function buildGrid(){
  grid.innerHTML='';
  METRICS.forEach(m=>{
    const cell = document.createElement('div');
    cell.className = 'chart-cell';
    cell.dataset.metric = m.k;

    // ë¸íƒ€ ê³„ì‚°
    const expAvgFirst = EXP.map(p=>p[m.k]?p[m.k][0]:null).filter(v=>v!=null);
    const expAvgLast = EXP.map(p=>p[m.k]?p[m.k][5]:null).filter(v=>v!=null);
    const ctrlAvgLast = CTRL.map(p=>p[m.k]?p[m.k][5]:null).filter(v=>v!=null);
    const eFirst = expAvgFirst.length?expAvgFirst.reduce((a,b)=>a+b,0)/expAvgFirst.length:0;
    const eLast = expAvgLast.length?expAvgLast.reduce((a,b)=>a+b,0)/expAvgLast.length:0;
    const cLast = ctrlAvgLast.length?ctrlAvgLast.reduce((a,b)=>a+b,0)/ctrlAvgLast.length:0;
    const expDelta = eLast - eFirst;
    const isGood = (m.d==='down'&&expDelta<0)||(m.d==='up'&&expDelta>0);
    const dStr = m.k==='steps'?(expDelta>0?'+':'')+Math.round(expDelta).toLocaleString():m.k==='comp'?(expDelta>0?'+':'')+expDelta.toFixed(0)+'%':(expDelta>0?'+':'')+expDelta.toFixed(1);

    cell.innerHTML=`
      <div class="cc-header">
        <div class="cc-title"><span class="dot" style="background:${m.dotC};"></span>${m.n} <span style="font-size:9px;color:#9ca3af;font-weight:400;">(${m.u}) [${m.src}]</span></div>
        <div class="cc-meta">
          <span class="cc-delta ${isGood?'good':'bad'}">${dStr}</span>
          <span class="cc-badge ${PVALCLS[m.k]}">${PVALS[m.k]}</span>
          <button class="cc-close" data-metric="${m.k}">âœ•</button>
        </div>
      </div>
      <div class="cc-body"><canvas class="cc-canvas" id="cv-${m.k}"></canvas></div>
      <div class="cc-footer">
        <div class="cc-legend">
          <span class="lg"><span class="lg-line" style="background:#3b82f6;"></span>ì‹¤í—˜</span>
          <span class="lg"><span class="lg-line" style="background:#e11d48;"></span>ëŒ€ì¡°</span>
          <span class="lg"><span class="lg-line thin" style="background:#93c5fd;"></span>ê°œë³„</span>
        </div>
        <span>W1~W6 ì£¼ê°„</span>
      </div>
    `;
    grid.appendChild(cell);

    // í´ë¦­ â†’ í™•ëŒ€
    cell.addEventListener('click',function(e){
      if(e.target.closest('.cc-close'))return;
      if(expandedMetric===m.k)return;
      expandMetric(m.k);
    });
    cell.querySelector('.cc-close').addEventListener('click',function(e){
      e.stopPropagation();
      collapseAll();
    });
  });
  setTimeout(drawAllCharts,50);
}

function expandMetric(k){
  expandedMetric = k;
  grid.classList.add('has-expanded');
  document.querySelectorAll('.chart-cell').forEach(c=>{
    if(c.dataset.metric===k){c.classList.add('expanded');c.classList.remove('collapsed');}
    else{c.classList.add('collapsed');c.classList.remove('expanded');}
  });
  setTimeout(()=>drawSingleChart(k),50);
}

function collapseAll(){
  expandedMetric = null;
  grid.classList.remove('has-expanded');
  document.querySelectorAll('.chart-cell').forEach(c=>{
    c.classList.remove('expanded','collapsed');
  });
  setTimeout(drawAllCharts,50);
}

function drawAllCharts(){
  METRICS.forEach(m=>drawSingleChart(m.k));
}

function drawSingleChart(metricKey){
  const m = METRICS.find(x=>x.k===metricKey);
  const cvEl = document.getElementById('cv-'+m.k);
  if(!cvEl)return;
  const cvCtx = cvEl.getContext('2d');
  const dpr = window.devicePixelRatio||1;
  const rect = cvEl.parentElement.getBoundingClientRect();
  if(rect.width<10||rect.height<10)return;
  cvEl.width = rect.width*dpr;
  cvEl.height = rect.height*dpr;
  cvEl.style.width = rect.width+'px';
  cvEl.style.height = rect.height+'px';
  cvCtx.setTransform(1,0,0,1,0,0);
  cvCtx.scale(dpr,dpr);
  const W=rect.width, H=rect.height;
  cvCtx.clearRect(0,0,W,H);

  const isExpanded = expandedMetric===m.k;
  const pad = isExpanded ? {t:24,b:32,l:44,r:90} : {t:8,b:20,l:30,r:10};
  const cw=W-pad.l-pad.r, ch=H-pad.t-pad.b;

  let allVals=[];
  [...EXP,...CTRL].forEach(p=>{const a=p[m.k];if(a)a.forEach(v=>{if(v!=null)allVals.push(v);});});
  if(!allVals.length)return;
  let mn=Math.min(...allVals),mx=Math.max(...allVals);
  const mg=(mx-mn)*0.12||5; mn-=mg; mx+=mg;

  function xP(i){return pad.l+(i/5)*cw;}
  function yP(v){return pad.t+(1-(v-mn)/(mx-mn))*ch;}

  // ê·¸ë¦¬ë“œ (í™•ëŒ€ì‹œë§Œ ìƒì„¸)
  cvCtx.strokeStyle='#f1f5f9';cvCtx.lineWidth=1;
  const gridN=isExpanded?5:3;
  for(let i=0;i<gridN;i++){
    const y=pad.t+i*(ch/(gridN-1));
    cvCtx.beginPath();cvCtx.moveTo(pad.l,y);cvCtx.lineTo(pad.l+cw,y);cvCtx.stroke();
    if(isExpanded){
      const val=mx-i*((mx-mn)/(gridN-1));
      cvCtx.fillStyle='#9ca3af';cvCtx.font='9px -apple-system,sans-serif';cvCtx.textAlign='right';
      cvCtx.fillText(m.k==='steps'?Math.round(val).toLocaleString():val.toFixed(1),pad.l-5,y+3);
    }
  }

  // X labels
  if(isExpanded){
    cvCtx.textAlign='center';cvCtx.fillStyle='#9ca3af';cvCtx.font='10px -apple-system,sans-serif';
    WK.forEach((w,i)=>cvCtx.fillText(w,xP(i),H-pad.b+14));
  } else {
    cvCtx.textAlign='center';cvCtx.fillStyle='#d1d5db';cvCtx.font='8px -apple-system,sans-serif';
    cvCtx.fillText('W1',xP(0),H-pad.b+12);
    cvCtx.fillText('W6',xP(5),H-pad.b+12);
  }

  // ìŠ¤íŒŒê²Œí‹°
  function drawLines(patients,thinC,boldC){
    patients.forEach(p=>{
      const a=p[m.k];if(!a)return;
      cvCtx.beginPath();cvCtx.strokeStyle=thinC;cvCtx.lineWidth=isExpanded?1.2:0.8;cvCtx.globalAlpha=isExpanded?0.25:0.15;
      let s=false;
      a.forEach((v,i)=>{if(v==null)return;if(!s){cvCtx.moveTo(xP(i),yP(v));s=true;}else cvCtx.lineTo(xP(i),yP(v));});
      cvCtx.stroke();cvCtx.globalAlpha=1;
    });
    const avg=WK.map((_,i)=>{const vs=patients.map(p=>p[m.k]?p[m.k][i]:null).filter(v=>v!=null);return vs.length?vs.reduce((a,b)=>a+b,0)/vs.length:null;});
    cvCtx.beginPath();cvCtx.strokeStyle=boldC;cvCtx.lineWidth=isExpanded?2.5:1.8;cvCtx.lineJoin='round';cvCtx.lineCap='round';
    let s=false;avg.forEach((v,i)=>{if(v==null)return;if(!s){cvCtx.moveTo(xP(i),yP(v));s=true;}else cvCtx.lineTo(xP(i),yP(v));});
    cvCtx.stroke();

    if(isExpanded){
      const last=avg[5];
      if(last!=null){
        cvCtx.beginPath();cvCtx.arc(xP(5),yP(last),3,0,Math.PI*2);cvCtx.fillStyle=boldC;cvCtx.fill();
        cvCtx.fillStyle=boldC;cvCtx.font='bold 10px SF Mono,Monaco,monospace';cvCtx.textAlign='left';
        cvCtx.fillText(m.k==='steps'?Math.round(last).toLocaleString():last.toFixed(1),xP(5)+6,yP(last)+3);
      }
    }
    return avg;
  }

  const expAvg=drawLines(EXP,'#93c5fd','#3b82f6');
  const ctrlAvg=drawLines(CTRL,'#fda4af','#e11d48');

  // gap fill
  cvCtx.globalAlpha=0.05;cvCtx.fillStyle='#3b82f6';cvCtx.beginPath();
  for(let i=0;i<6;i++){if(expAvg[i]!=null)cvCtx.lineTo(xP(i),yP(expAvg[i]));}
  for(let i=5;i>=0;i--){if(ctrlAvg[i]!=null)cvCtx.lineTo(xP(i),yP(ctrlAvg[i]));}
  cvCtx.closePath();cvCtx.fill();cvCtx.globalAlpha=1;

  // í™•ëŒ€ì‹œ ì–´ë…¸í…Œì´ì…˜
  if(isExpanded && expAvg[5]!=null && ctrlAvg[5]!=null){
    const diff=Math.abs(expAvg[5]-ctrlAvg[5]);
    const midY=(yP(expAvg[5])+yP(ctrlAvg[5]))/2;
    cvCtx.fillStyle='#6b7280';cvCtx.font='9px -apple-system,sans-serif';cvCtx.textAlign='left';
    cvCtx.fillText(`Î” ${m.k==='steps'?Math.round(diff).toLocaleString():diff.toFixed(1)}`,xP(5)+6,midY);
    cvCtx.strokeStyle='#d1d5db';cvCtx.lineWidth=1;cvCtx.setLineDash([2,2]);
    cvCtx.beginPath();cvCtx.moveTo(xP(5)+3,yP(expAvg[5]));cvCtx.lineTo(xP(5)+3,yP(ctrlAvg[5]));cvCtx.stroke();
    cvCtx.setLineDash([]);

    // pê°’
    const pv=PVALS[m.k];const isSig=PVALCLS[m.k]==='sig';
    cvCtx.fillStyle=isSig?'#dcfce7':'#f3f4f6';
    const pvW=cvCtx.measureText(pv).width+12;
    cvCtx.beginPath();cvCtx.roundRect(W-pad.r+6,pad.t+6,pvW,16,3);cvCtx.fill();
    cvCtx.fillStyle=isSig?'#166534':'#6b7280';cvCtx.font='bold 9px SF Mono,Monaco,monospace';cvCtx.textAlign='left';
    cvCtx.fillText(pv,W-pad.r+12,pad.t+17);

    // AI ë§ˆì»¤
    if(m.k==='hr'){
      cvCtx.fillStyle='#fef3c7';cvCtx.beginPath();cvCtx.roundRect(xP(2)-26,pad.t-2,82,15,3);cvCtx.fill();
      cvCtx.fillStyle='#92400e';cvCtx.font='bold 8px -apple-system,sans-serif';cvCtx.textAlign='left';
      cvCtx.fillText('âš ï¸ P018 ë””ë°”ì´ìŠ¤ ëŠê¹€',xP(2)-22,pad.t+9);
    }
    if(m.k==='sbp'){
      cvCtx.fillStyle='#fef3c7';cvCtx.beginPath();cvCtx.roundRect(xP(4)-20,pad.t-2,72,15,3);cvCtx.fill();
      cvCtx.fillStyle='#92400e';cvCtx.font='bold 8px -apple-system,sans-serif';cvCtx.textAlign='left';
      cvCtx.fillText('âš ï¸ P018 ë°˜ë“±',xP(4)-16,pad.t+9);
    }
  }
}

// ==================== íƒ­ ì „í™˜ ====================
function switchTab(n){
  document.querySelectorAll('.tab[data-tab]').forEach(t=>t.classList.toggle('active',t.dataset.tab===n));
  document.getElementById('tc-ov').classList.toggle('active',n==='overview');
  document.getElementById('tc-tb').classList.toggle('active',n==='table');
  document.getElementById('nav-ov').classList.toggle('active',n==='overview');
  document.getElementById('nav-tb').classList.toggle('active',n==='table');
  if(n==='overview') setTimeout(()=>{if(expandedMetric)drawSingleChart(expandedMetric);else drawAllCharts();},50);
}
document.querySelectorAll('.tab[data-tab]').forEach(t=>t.addEventListener('click',()=>t.dataset.tab&&switchTab(t.dataset.tab)));
document.getElementById('nav-ov').addEventListener('click',()=>switchTab('overview'));
document.getElementById('nav-tb').addEventListener('click',()=>switchTab('table'));

// ==================== í…Œì´ë¸” ====================
const ALL=[
  {id:'P001',nm:'ê¹€ë¯¼ìˆ˜',g:'exp',sv:'good',wt:[87.3,85.8,84.2,82.5,80.8,79.2],sbp:[134,132,128,126,124,122],hr:[72,71,69,68,67,66],steps:[7340,7800,8200,8600,8900,9104],sleep:[6.2,6.5,6.8,7,7.1,7.3],comp:[86,88,90,92,93,94],app:[40,42,48,52,56,62]},
  {id:'P005',nm:'ì´ìˆ˜ì§„',g:'exp',sv:'good',wt:[88.3,87.1,85.8,84.5,83.2,82.1],sbp:[132.5,131,129,127,125.5,124],hr:[72,71,70,70,69,69],steps:[6800,7100,7400,7600,7800,7812],sleep:[6,6.2,6.5,6.7,6.9,7],comp:[85,87,88,89,90,90],app:[32,35,38,40,42,45]},
  {id:'P011',nm:'ë°•ì§€í›ˆ',g:'exp',sv:'good',wt:[88.3,86.8,85.2,83.5,82,80.8],sbp:[134.2,132,130,128,126.5,125],hr:[72,71,69,68,68,67],steps:[7000,7500,7800,8100,8300,8512],sleep:[6.5,6.6,6.8,7,7.2,7.4],comp:[86,88,90,91,92,92],app:[36,40,44,48,52,54]},
  {id:'P018',nm:'ìµœì˜ˆë¦°',g:'exp',sv:'warn',al:true,wt:[87.4,86.2,85,83.8,82.6,81.6],sbp:[137.9,136,135,138,139,140],hr:[70,69,null,null,68,null],steps:[5800,6000,6100,6200,6200,6234],sleep:[5.8,6,6.2,6,5.9,5.8],comp:[82,84,86,88,89,89],app:[28,30,34,36,40,42]},
  {id:'P023',nm:'ì •í•˜ëŠ˜',g:'exp',sv:'good',wt:[87.6,86.4,85,83.6,82.4,81.2],sbp:[134.1,132,130,129,128,127],hr:[72,71,70,69,68,68],steps:[6900,7200,7500,7800,8000,8234],sleep:[6.3,6.5,6.7,6.9,7.1,7.2],comp:[85,87,89,90,91,91],app:[34,36,40,44,46,48]},
  {id:'P002',nm:'ìœ¤ì„œì—°',g:'ctrl',sv:'warn',wt:[87.7,87.8,87.9,88,88.1,88.2],sbp:[135.9,136,136.5,137,137.5,138],hr:[72,72,71,71,70,70],steps:[4600,4650,4700,4750,4800,4821],sleep:[6.1,6,6,5.9,5.9,5.8],comp:[85,86,86,87,87,88],app:[null,null,null,null,null,null]},
  {id:'P008',nm:'í•œë„ìœ¤',g:'ctrl',sv:'good',wt:[87.9,87.8,87.6,87.4,87.2,87.1],sbp:[133.1,133.5,133.8,134,134.2,134],hr:[72,72,72,72,72,72],steps:[4200,4200,4180,4190,4200,4201],sleep:[6.5,6.4,6.4,6.3,6.3,6.2],comp:[85,85,86,86,86,86],app:[40,39,38,38,38,38]},
  {id:'P014',nm:'ì†¡ì§€ì•„',g:'ctrl',sv:'good',wt:[87.9,87.8,87.8,87.8,87.8,87.8],sbp:[134.5,134.5,135,135,135,135],hr:[72,72,71,71,71,71],steps:[4500,4520,4550,4580,4600,4621],sleep:[6.2,6.2,6.1,6.1,6,6],comp:[85,85,86,86,87,87],app:[34,34,33,33,32,32]},
  {id:'P031',nm:'ì„ì±„ì›',g:'ctrl',sv:'bad',al:true,wt:[87.9,88,88.3,88.5,88.8,89.1],sbp:[134.2,135,136,137,137.5,138],hr:[73,73,74,74,75,75],steps:[4100,4000,3900,3850,3820,3821],sleep:[5.8,5.7,5.5,5.4,5.3,5.2],comp:[84,82,80,78,75,72],app:[28,26,25,24,23,22]},
  {id:'P036',nm:'ê°•ì‹œìš°',g:'ctrl',sv:'good',wt:[87,87,86.9,86.9,86.8,86.8],sbp:[131.8,132,132.5,132.8,133,133],hr:[74,74,73,73,72,72],steps:[4400,4420,4450,4480,4500,4521],sleep:[6.4,6.3,6.3,6.2,6.2,6.1],comp:[85,86,86,87,88,88],app:[40,39,38,38,38,38]},
];

const TMET=[
  {k:'wt',n:'ì²´ì¤‘',u:'kg',d:'down',sc:'#3b82f6'},{k:'sbp',n:'SBP',u:'mmHg',d:'down',sc:'#3b82f6'},
  {k:'hr',n:'ì‹¬ë°•ìˆ˜',u:'bpm',d:'down',sc:'#22c55e'},{k:'steps',n:'ê±¸ìŒìˆ˜',u:'ë³´',d:'up',sc:'#22c55e'},
  {k:'sleep',n:'ìˆ˜ë©´',u:'h',d:'up',sc:'#22c55e'},{k:'comp',n:'ìˆœì‘ë„',u:'%',d:'up',sc:'#a855f7'},
  {k:'app',n:'ì•±ì‚¬ìš©',u:'ë¶„',d:'up',sc:'#f97316'},
];

function dl(a){if(!a||a[0]==null||a[5]==null)return null;return a[5]-a[0];}
function fD(d,m){if(d==null)return'<span class="ce">â€”</span>';const g=(m.d==='down'&&d<0)||(m.d==='up'&&d>0);const b=(m.d==='down'&&d>2)||(m.d==='up'&&d<-2);const ar=d>0?'â†‘':d<0?'â†“':'';const c=g?'good':b?'bad':'neutral';const v=m.k==='steps'?(d>0?'+':'')+Math.round(d).toLocaleString():m.k==='comp'||m.k==='app'?(d>0?'+':'')+d.toFixed(0)+'%':(d>0?'+':'')+d.toFixed(1);return`<span class="cd ${c}">${ar}${v}</span>`;}
function fR(v,m){if(v==null)return'';if(m.k==='steps')return`<span class="cr">${Math.round(v).toLocaleString()}</span>`;if(m.k==='comp'||m.k==='app')return`<span class="cr">${v.toFixed(0)}${m.u}</span>`;return`<span class="cr">${v.toFixed(1)}${m.u}</span>`;}
function cBg(d,m){if(d==null)return'';const g=(m.d==='down'&&d<-2)||(m.d==='up'&&d>2);const b=(m.d==='down'&&d>2)||(m.d==='up'&&d<-5);if(g)return'background:rgba(34,197,94,.04);';if(b)return'background:rgba(239,68,68,.04);';return'';}

const tBody=document.getElementById('tBody');
let selIdx=null;
ALL.forEach((p,i)=>{
  const tr=document.createElement('tr');if(p.al)tr.className='alert-row';
  let h=`<td class="pid"><span class="sv ${p.sv}"></span>${p.id}${p.al?'âš ï¸':''}<span class="gb ${p.g}">${p.g==='exp'?'ì‹¤í—˜':'ëŒ€ì¡°'}</span><br><span style="font-size:10px;color:#9ca3af;font-weight:400;">${p.nm}</span></td>`;
  TMET.forEach(m=>{const d=dl(p[m.k]);const v=p[m.k]?p[m.k][5]:null;h+=`<td style="${cBg(d,m)}">${fD(d,m)}${fR(v,m)}</td>`;});
  tr.innerHTML=h;tr.addEventListener('click',()=>openDetail(i));tBody.appendChild(tr);
});

// ë””í…Œì¼ íŒ¨ë„
const panel=document.getElementById('detailPanel'),tableArea=document.getElementById('tableArea'),dpTitle=document.getElementById('dpTitle'),dpBody=document.getElementById('dpBody');

function mkSVG(arr,color,w,h){
  const vd=arr.map((v,i)=>v!=null?{v,i}:null).filter(Boolean);
  if(vd.length<2)return`<svg width="${w}" height="${h}"><text x="${w/2}" y="${h/2+4}" text-anchor="middle" fill="#d1d5db" font-size="9">â€”</text></svg>`;
  const mn=Math.min(...vd.map(d=>d.v)),mx=Math.max(...vd.map(d=>d.v)),rg=mx-mn||1,pd=4;
  const pts=vd.map(d=>{const x=pd+(d.i/(arr.length-1))*(w-pd*2);const y=pd+(1-(d.v-mn)/rg)*(h-pd*2);return`${x},${y}`;});
  return`<svg width="${w}" height="${h}"><polyline points="${pts.join(' ')}" fill="none" stroke="${color}" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
}

function openDetail(i){
  selIdx=i;const p=ALL[i];
  tBody.querySelectorAll('tr').forEach((r,ri)=>r.classList.toggle('selected',ri===i));
  tableArea.classList.add('shrunk');panel.classList.add('open');
  dpTitle.innerHTML=`<span class="sv ${p.sv}"></span>${p.id} ${p.nm} <span class="gb ${p.g}">${p.g==='exp'?'ì‹¤í—˜':'ëŒ€ì¡°'}</span>`;
  const cms=[TMET[0],TMET[3],TMET[5]];
  let ch=cms.map(m=>{
    const a=p[m.k]||[];const d=dl(a);
    const ds=d!=null?(d>0?'+':'')+(m.k==='steps'?Math.round(d).toLocaleString():m.k==='comp'?d.toFixed(0)+'%':d.toFixed(1)+m.u):'â€”';
    return`<div class="chart-card"><div class="chart-card-title">${m.n} (${m.u})</div><div class="mini-chart">${mkSVG(a,m.sc,260,70)}</div><div class="chart-x">${WK.map(w=>`<span>${w}</span>`).join('')}</div><div class="chart-sum"><span>W1: <strong>${a[0]!=null?(m.k==='steps'?Math.round(a[0]).toLocaleString():a[0].toFixed(1)):'â€”'}</strong></span><span>W6: <strong>${a[5]!=null?(m.k==='steps'?Math.round(a[5]).toLocaleString():a[5].toFixed(1)):'â€”'}</strong></span><span>Î”: <strong>${ds}</strong></span></div></div>`;
  }).join('');
  let fs='<div class="fs-title">ğŸ“‹ í”Œë¡œìš°ì‹œíŠ¸</div><table class="fs-table"><thead><tr><th>ì§€í‘œ</th>';
  WK.forEach(w=>fs+=`<th>${w}</th>`);fs+='</tr></thead><tbody>';
  TMET.forEach(m=>{const a=p[m.k]||[];fs+=`<tr><td>${m.n}</td>`;
    a.forEach((v,j)=>{if(v==null){fs+='<td class="ce">â€”</td>';return;}const fmt=m.k==='steps'?Math.round(v).toLocaleString():m.k==='comp'||m.k==='app'?v.toFixed(0):v.toFixed(1);let cls='';if(j>0&&a[0]!=null){const dd=v-a[0];const ig=(m.d==='down'&&dd<-1)||(m.d==='up'&&dd>1);const ib=(m.d==='down'&&dd>1)||(m.d==='up'&&dd<-1);cls=ig?'fg':ib?'fb':'';}if(j===5)cls+=' fc';fs+=`<td class="${cls}">${fmt}</td>`;});
    fs+='</tr>';});
  fs+='</tbody></table>';
  dpBody.innerHTML=ch+fs;
}

document.getElementById('dpClose').addEventListener('click',()=>{panel.classList.remove('open');tableArea.classList.remove('shrunk');tBody.querySelectorAll('tr').forEach(r=>r.classList.remove('selected'));selIdx=null;});
document.getElementById('dpPrev').addEventListener('click',()=>{if(selIdx>0)openDetail(selIdx-1);});
document.getElementById('dpNext').addEventListener('click',()=>{if(selIdx<ALL.length-1)openDetail(selIdx+1);});

// ==================== ì´ˆê¸°í™” ====================
buildGrid();
window.addEventListener('resize',()=>{if(expandedMetric)drawSingleChart(expandedMetric);else drawAllCharts();});
</script>
</body>
</html>
